{% extends "base.html" %}

{% block title %}Major Retailer Analytics - DOUANO{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2>
                        <i class="fas fa-star text-warning me-2"></i>
                        <span id="retailer-name">Major Retailer</span>
                        <span class="badge bg-warning text-dark ms-2" id="retailer-type">Retailer</span>
                    </h2>
                    <p class="text-muted mb-0">Comprehensive distribution analytics and insights</p>
                </div>
                <div>
                    <a href="/data" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left me-2"></i>Back
                    </a>
                    <button class="btn btn-primary" onclick="loadDetailedData()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3 text-muted">Loading detailed analytics...</p>
    </div>

    <!-- Error State -->
    <div id="error-message" class="alert alert-danger" style="display: none;">
        <h5><i class="fas fa-exclamation-triangle me-2"></i>Error</h5>
        <p class="mb-0" id="error-text"></p>
    </div>

    <!-- Main Content -->
    <div id="main-content" style="display: none;">
        <!-- Filters Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Year</label>
                                <select class="form-select" id="year-filter" onchange="applyFilters()">
                                    <option value="all">All Years</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Month</label>
                                <select class="form-select" id="month-filter" onchange="applyFilters()">
                                    <option value="all">All Months</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Product</label>
                                <select class="form-select" id="product-filter" onchange="applyFilters()">
                                    <option value="all">All Products</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Flavor</label>
                                <select class="form-select" id="flavor-filter" onchange="applyFilters()">
                                    <option value="all">All Flavors</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Chain</label>
                                <select class="form-select" id="chain-filter" onchange="applyFilters()">
                                    <option value="all">All Chains</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Province</label>
                                <select class="form-select" id="province-filter" onchange="applyFilters()">
                                    <option value="all">All Provinces</option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="search-filter" placeholder="Search customers, cities, codes..." onkeyup="applyFilters()">
                            </div>
                            <div class="col-md-8 text-end">
                                <button class="btn btn-outline-secondary" onclick="resetFilters()">
                                    <i class="fas fa-redo me-2"></i>Reset Filters
                                </button>
                                <button class="btn btn-outline-success" onclick="exportData()">
                                    <i class="fas fa-download me-2"></i>Export CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card border-0 shadow-sm text-center">
                    <div class="card-body">
                        <i class="fas fa-boxes fa-2x text-success mb-2"></i>
                        <h3 class="mb-0" id="kpi-total-units">-</h3>
                        <small class="text-muted">Total Units</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card border-0 shadow-sm text-center">
                    <div class="card-body">
                        <i class="fas fa-store fa-2x text-info mb-2"></i>
                        <h3 class="mb-0" id="kpi-customers">-</h3>
                        <small class="text-muted">Locations</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card border-0 shadow-sm text-center">
                    <div class="card-body">
                        <i class="fas fa-box fa-2x text-warning mb-2"></i>
                        <h3 class="mb-0" id="kpi-products">-</h3>
                        <small class="text-muted">Products</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card border-0 shadow-sm text-center">
                    <div class="card-body">
                        <i class="fas fa-ice-cream fa-2x text-primary mb-2"></i>
                        <h3 class="mb-0" id="kpi-flavors">-</h3>
                        <small class="text-muted">Flavors</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card border-0 shadow-sm text-center">
                    <div class="card-body">
                        <i class="fas fa-link fa-2x text-danger mb-2"></i>
                        <h3 class="mb-0" id="kpi-chains">-</h3>
                        <small class="text-muted">Chains</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card border-0 shadow-sm text-center">
                    <div class="card-body">
                        <i class="fas fa-map-marked-alt fa-2x text-secondary mb-2"></i>
                        <h3 class="mb-0" id="kpi-regions">-</h3>
                        <small class="text-muted">Regions</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4" id="analyticsTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">
                    <i class="fas fa-chart-line me-2"></i>Overview
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button">
                    <i class="fas fa-box me-2"></i>Products
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="locations-tab" data-bs-toggle="tab" data-bs-target="#locations" type="button">
                    <i class="fas fa-map-marker-alt me-2"></i>Locations
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline" type="button">
                    <i class="fas fa-calendar me-2"></i>Timeline
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="chains-tab" data-bs-toggle="tab" data-bs-target="#chains" type="button">
                    <i class="fas fa-link me-2"></i>Chains
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="detailed-tab" data-bs-toggle="tab" data-bs-target="#detailed" type="button">
                    <i class="fas fa-table me-2"></i>Detailed Data
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="analyticsTabContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-3"><i class="fas fa-chart-area me-2"></i>Units Over Time</h5>
                                <canvas id="timeline-chart" height="80"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-3"><i class="fas fa-chart-pie me-2"></i>Product Mix</h5>
                                <canvas id="product-pie-chart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title mb-3"><i class="fas fa-trophy me-2"></i>Top 10 Locations</h5>
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-hover">
                                        <thead class="sticky-top bg-white">
                                            <tr>
                                                <th>Rank</th>
                                                <th>Location</th>
                                                <th>City</th>
                                                <th class="text-end">Units</th>
                                            </tr>
                                        </thead>
                                        <tbody id="top-locations-table"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title mb-3"><i class="fas fa-ice-cream me-2"></i>Top 10 Flavors</h5>
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-hover">
                                        <thead class="sticky-top bg-white">
                                            <tr>
                                                <th>Rank</th>
                                                <th>Flavor</th>
                                                <th>Product</th>
                                                <th class="text-end">Units</th>
                                            </tr>
                                        </thead>
                                        <tbody id="top-flavors-table"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Tab -->
            <div class="tab-pane fade" id="products" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title mb-3"><i class="fas fa-chart-bar me-2"></i>Product Performance</h5>
                                <canvas id="product-bar-chart" height="80"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title mb-3"><i class="fas fa-box-open me-2"></i>Package Types</h5>
                                <canvas id="packaging-chart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3"><i class="fas fa-th-list me-2"></i>Product Details</h5>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Flavor</th>
                                        <th>Packaging</th>
                                        <th class="text-end">Total Units</th>
                                        <th class="text-end">Locations</th>
                                        <th class="text-end">Avg per Location</th>
                                    </tr>
                                </thead>
                                <tbody id="product-details-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Locations Tab -->
            <div class="tab-pane fade" id="locations" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title mb-3"><i class="fas fa-map me-2"></i>By Province</h5>
                                <canvas id="province-chart" height="150"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title mb-3"><i class="fas fa-city me-2"></i>Top Cities</h5>
                                <canvas id="city-chart" height="150"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3"><i class="fas fa-store-alt me-2"></i>All Locations</h5>
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-hover table-sm">
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th>Code</th>
                                        <th>Location Name</th>
                                        <th>Address</th>
                                        <th>City</th>
                                        <th>Province</th>
                                        <th>Chain</th>
                                        <th>Type</th>
                                        <th class="text-end">Total Units</th>
                                    </tr>
                                </thead>
                                <tbody id="locations-details-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timeline Tab -->
            <div class="tab-pane fade" id="timeline" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title mb-3"><i class="fas fa-chart-line me-2"></i>Monthly Trend</h5>
                                <canvas id="monthly-trend-chart" height="70"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title mb-3"><i class="fas fa-calendar-week me-2"></i>Weekly Performance</h5>
                                <canvas id="weekly-chart" height="120"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title mb-3"><i class="fas fa-calendar-alt me-2"></i>Year Comparison</h5>
                                <canvas id="year-comparison-chart" height="120"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chains Tab -->
            <div class="tab-pane fade" id="chains" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title mb-3"><i class="fas fa-network-wired me-2"></i>Chain Performance</h5>
                                <canvas id="chain-performance-chart" height="80"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title mb-3"><i class="fas fa-chart-pie me-2"></i>Chain Distribution</h5>
                                <canvas id="chain-pie-chart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3"><i class="fas fa-th me-2"></i>Chain Details</h5>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Chain</th>
                                        <th class="text-end">Total Units</th>
                                        <th class="text-end">Locations</th>
                                        <th class="text-end">Products</th>
                                        <th class="text-end">Avg per Location</th>
                                    </tr>
                                </thead>
                                <tbody id="chain-details-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Data Tab -->
            <div class="tab-pane fade" id="detailed" role="tabpanel">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0"><i class="fas fa-table me-2"></i>Complete Dataset</h5>
                            <span class="badge bg-primary" id="total-records-badge">0 records</span>
                        </div>
                        <div class="table-responsive" style="max-height: 700px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th>Code</th>
                                        <th>Customer</th>
                                        <th>City</th>
                                        <th>Province</th>
                                        <th>Product</th>
                                        <th>Flavor</th>
                                        <th>Package</th>
                                        <th>Chain</th>
                                        <th>Type</th>
                                        <th>Month</th>
                                        <th>Year</th>
                                        <th class="text-end">Units</th>
                                    </tr>
                                </thead>
                                <tbody id="detailed-data-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Assistant FAB -->
<button class="ai-fab" onclick="toggleAIAssistant()" title="Ask AI about this data">
    <i class="fas fa-robot"></i>
</button>

<!-- AI Assistant Sidepanel Overlay -->
<div class="ai-panel-overlay" id="aiPanelOverlay" onclick="toggleAIAssistant()"></div>

<!-- AI Assistant Sidepanel -->
<div class="ai-assistant-sidepanel" id="aiAssistantPanel">
    <div class="ai-assistant-header">
        <h5 class="mb-0">
            <i class="fas fa-robot me-2"></i>
            AI Data Assistant
        </h5>
        <button class="btn-close btn-close-white" onclick="toggleAIAssistant()"></button>
    </div>
    <div class="ai-assistant-body" id="aiChatBody">
        <div class="ai-welcome-message">
            <i class="fas fa-sparkles fa-2x mb-3" style="color: #667eea;"></i>
            <h6>Ask me anything about this data!</h6>
            <p class="text-muted small mb-3">I can help you analyze trends, find insights, and answer questions about products, locations, flavors, and more.</p>
            <div class="ai-suggestions">
                <div class="ai-suggestion" onclick="askAI('What are the top 5 products?')">
                    <i class="fas fa-box me-2"></i>What are the top 5 products?
                </div>
                <div class="ai-suggestion" onclick="askAI('Which provinces have the highest sales?')">
                    <i class="fas fa-map me-2"></i>Which provinces have the highest sales?
                </div>
                <div class="ai-suggestion" onclick="askAI('Show me the most popular flavors')">
                    <i class="fas fa-ice-cream me-2"></i>Show me the most popular flavors
                </div>
                <div class="ai-suggestion" onclick="askAI('Compare sales by year')">
                    <i class="fas fa-chart-line me-2"></i>Compare sales by year
                </div>
            </div>
        </div>
    </div>
    <div class="ai-assistant-footer">
        <div class="input-group">
            <input type="text" class="form-control" id="aiQueryInput" placeholder="Ask a question..." onkeypress="if(event.key==='Enter') askAI()">
            <button class="btn btn-primary" onclick="askAI()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const companyId = {{ company_id }};
let aggregatedData = {};
let charts = {};

document.addEventListener('DOMContentLoaded', function() {
    loadDetailedData();
});

async function loadDetailedData() {
    try {
        showLoading();
        
        console.log('ðŸ”„ Fetching retailer data...');
        const response = await fetch(`/api/major-retailer-detailed/${companyId}`);
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Failed to load data');
        }
        
        console.log(`âœ… Received aggregated data: ${result.total_records} records, ${result.total_quantity} units`);
        
        // Store aggregated data
        aggregatedData = result;
        
        document.getElementById('retailer-name').textContent = result.retailer_name;
        
        // Update UI with aggregated data
        updateKPIsFromAggregated();
        updateChartsFromAggregated();
        updateTablesFromAggregated();
        
        hideLoading();
        
    } catch (error) {
        console.error('âŒ Error:', error);
        showError(error.message);
    }
}

// New functions for aggregated data
function updateKPIsFromAggregated() {
    const data = aggregatedData;
    
    document.getElementById('kpi-total-units').textContent = (data.total_quantity || 0).toLocaleString();
    document.getElementById('kpi-customers').textContent = Object.keys(data.by_customer || {}).length;
    document.getElementById('kpi-products').textContent = Object.keys(data.by_product || {}).length;
    document.getElementById('kpi-flavors').textContent = Object.keys(data.by_flavor || {}).length;
    document.getElementById('kpi-chains').textContent = '-'; // Not available in aggregated
    document.getElementById('kpi-regions').textContent = Object.keys(data.by_city || {}).length;
    document.getElementById('total-records-badge').textContent = `${(data.total_records || 0).toLocaleString()} records (aggregated)`;
}

function updateTablesFromAggregated() {
    const data = aggregatedData;
    
    // Top Locations (customers)
    const topLocations = Object.entries(data.by_customer || {})
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
    const locTbody = document.getElementById('top-locations-table');
    locTbody.innerHTML = topLocations.map(([name, units], i) => `
        <tr>
            <td><span class="badge bg-${i < 3 ? 'warning' : 'secondary'}">#${i + 1}</span></td>
            <td><strong>${esc(name)}</strong></td>
            <td>-</td>
            <td class="text-end"><span class="badge bg-success">${units.toLocaleString()}</span></td>
        </tr>
    `).join('');
    
    // Top Flavors
    const topFlavors = Object.entries(data.by_flavor || {})
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
    const flavorTbody = document.getElementById('top-flavors-table');
    flavorTbody.innerHTML = topFlavors.map(([flavor, units], i) => `
        <tr>
            <td><span class="badge bg-${i < 3 ? 'warning' : 'secondary'}">#${i + 1}</span></td>
            <td><strong>${esc(flavor)}</strong></td>
            <td><small class="text-muted">-</small></td>
            <td class="text-end"><span class="badge bg-info">${units.toLocaleString()}</span></td>
        </tr>
    `).join('');
    
    // Product Details
    const productDetails = Object.entries(data.by_product || {})
        .sort((a, b) => b[1] - a[1]);
    const prodTbody = document.getElementById('product-details-table');
    prodTbody.innerHTML = productDetails.map(([product, units]) => `
        <tr>
            <td><strong>${esc(product)}</strong></td>
            <td>-</td>
            <td><span class="badge bg-secondary">-</span></td>
            <td class="text-end">${units.toLocaleString()}</td>
            <td class="text-end">-</td>
            <td class="text-end">-</td>
        </tr>
    `).join('');
    
    // City Details (locations)
    const cityDetails = Object.entries(data.by_city || {})
        .sort((a, b) => b[1] - a[1]);
    const cityTbody = document.getElementById('locations-details-table');
    cityTbody.innerHTML = cityDetails.map(([city, units]) => `
        <tr>
            <td><code>-</code></td>
            <td><strong>-</strong></td>
            <td><small>-</small></td>
            <td>${esc(city)}</td>
            <td>-</td>
            <td><span class="badge bg-primary">-</span></td>
            <td><small>-</small></td>
            <td class="text-end"><strong>${units.toLocaleString()}</strong></td>
        </tr>
    `).join('');
    
    // Chain details not available in aggregated view
    document.getElementById('chain-details-table').innerHTML = `
        <tr><td colspan="5" class="text-center text-muted"><em>Chain breakdown not available in aggregated view</em></td></tr>
    `;
    
    // Detailed data not available
    document.getElementById('detailed-data-table').innerHTML = `
        <tr><td colspan="12" class="text-center text-muted">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Raw data not available</strong><br>
            <small>This view shows aggregated summaries of ${(data.total_records || 0).toLocaleString()} records to improve performance.</small>
        </td></tr>
    `;
}

function updateChartsFromAggregated() {
    const data = aggregatedData;
    
    // Timeline chart (by month)
    const ctx1 = document.getElementById('timeline-chart');
    if (ctx1) {
        const monthData = data.by_month || {};
        const labels = Object.keys(monthData).sort();
        destroyChart('timeline-chart');
        charts['timeline-chart'] = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Units',
                    data: labels.map(l => monthData[l]),
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    fill: true,
                    backgroundColor: 'rgba(75, 192, 192, 0.1)'
                }]
            },
            options: { responsive: true, maintainAspectRatio: true }
        });
    }
    
    // Product pie chart
    const ctx2 = document.getElementById('product-pie-chart');
    if (ctx2) {
        const productData = data.by_product || {};
        destroyChart('product-pie-chart');
        charts['product-pie-chart'] = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: Object.keys(productData),
                datasets: [{
                    data: Object.values(productData),
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
                }]
            },
            options: { responsive: true, maintainAspectRatio: true }
        });
    }
    
    // Product bar chart
    const ctx3 = document.getElementById('product-bar-chart');
    if (ctx3) {
        const productData = data.by_product || {};
        destroyChart('product-bar-chart');
        charts['product-bar-chart'] = new Chart(ctx3, {
            type: 'bar',
            data: {
                labels: Object.keys(productData),
                datasets: [{
                    label: 'Units',
                    data: Object.values(productData),
                    backgroundColor: 'rgba(54, 162, 235, 0.8)'
                }]
            },
            options: { responsive: true, maintainAspectRatio: true }
        });
    }
    
    // City chart
    const ctx4 = document.getElementById('city-chart');
    if (ctx4) {
        const cityData = data.by_city || {};
        const sorted = Object.entries(cityData).sort((a, b) => b[1] - a[1]).slice(0, 10);
        destroyChart('city-chart');
        charts['city-chart'] = new Chart(ctx4, {
            type: 'bar',
            data: {
                labels: sorted.map(s => s[0]),
                datasets: [{
                    label: 'Units by City',
                    data: sorted.map(s => s[1]),
                    backgroundColor: 'rgba(255, 159, 64, 0.8)'
                }]
            },
            options: { responsive: true, maintainAspectRatio: true, indexAxis: 'y' }
        });
    }
    
    // Year comparison chart
    const ctx5 = document.getElementById('year-comparison-chart');
    if (ctx5) {
        const yearData = data.by_year || {};
        destroyChart('year-comparison-chart');
        charts['year-comparison-chart'] = new Chart(ctx5, {
            type: 'bar',
            data: {
                labels: Object.keys(yearData).sort(),
                datasets: [{
                    label: 'Units by Year',
                    data: Object.values(yearData),
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
                }]
            },
            options: { responsive: true, maintainAspectRatio: true }
        });
    }
    
    // Monthly trend
    const ctx6 = document.getElementById('monthly-trend-chart');
    if (ctx6) {
        const monthData = data.by_month || {};
        const labels = Object.keys(monthData).sort();
        destroyChart('monthly-trend-chart');
        charts['monthly-trend-chart'] = new Chart(ctx6, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Units per Month',
                    data: labels.map(l => monthData[l]),
                    borderColor: 'rgb(255, 99, 132)',
                    tension: 0.4,
                    fill: true,
                    backgroundColor: 'rgba(255, 99, 132, 0.1)'
                }]
            },
            options: { responsive: true, maintainAspectRatio: true }
        });
    }
}

// Old filter functions - now mostly disabled since we have aggregated data
function populateFilters() {
    // Filters don't work with aggregated data
    console.log('Filters disabled - using aggregated data');
}

function populateSelect(id, options) {
    // Disabled
}

function applyFilters() {
    // Filters don't work with aggregated data - just refresh
    console.log('Filters not available with aggregated view');
}

function updateUI() {
    updateKPIsFromAggregated();
    updateChartsFromAggregated();
    updateTablesFromAggregated();
}

function safeParseAantal(value) {
    if (value === null || value === 'NULL' || value === '' || value === undefined) {
        return 0;
    }
    const num = parseInt(value);
    return isNaN(num) ? 0 : num;
}

function updateKPIs() {
    updateKPIsFromAggregated();
}

function updateAllTables() {
    updateTopLocationsTable();
    updateTopFlavorsTable();
    updateProductDetailsTable();
    updateLocationsDetailsTable();
    updateChainDetailsTable();
    updateDetailedDataTable();
}

function updateTopLocationsTable() {
    const locationStats = {};
    filteredData.forEach(d => {
        const key = d.naam_klant;
        if (!locationStats[key]) {
            locationStats[key] = { name: d.naam_klant, city: d.stad, units: 0 };
        }
        locationStats[key].units += safeParseAantal(d.aantal);
    });
    
    const sorted = Object.values(locationStats).sort((a, b) => b.units - a.units).slice(0, 10);
    const tbody = document.getElementById('top-locations-table');
    tbody.innerHTML = sorted.map((loc, i) => `
        <tr>
            <td><span class="badge bg-${i < 3 ? 'warning' : 'secondary'}">#${i + 1}</span></td>
            <td><strong>${esc(loc.name)}</strong></td>
            <td>${esc(loc.city)}</td>
            <td class="text-end"><span class="badge bg-success">${loc.units.toLocaleString()}</span></td>
        </tr>
    `).join('');
}

function updateTopFlavorsTable() {
    const flavorStats = {};
    filteredData.forEach(d => {
        const key = d.smaak;
        if (!flavorStats[key]) {
            flavorStats[key] = { flavor: d.smaak, product: d.product, units: 0 };
        }
        flavorStats[key].units += safeParseAantal(d.aantal);
    });
    
    const sorted = Object.values(flavorStats).sort((a, b) => b.units - a.units).slice(0, 10);
    const tbody = document.getElementById('top-flavors-table');
    tbody.innerHTML = sorted.map((f, i) => `
        <tr>
            <td><span class="badge bg-${i < 3 ? 'warning' : 'secondary'}">#${i + 1}</span></td>
            <td><strong>${esc(f.flavor)}</strong></td>
            <td><small class="text-muted">${esc(f.product)}</small></td>
            <td class="text-end"><span class="badge bg-info">${f.units.toLocaleString()}</span></td>
        </tr>
    `).join('');
}

function updateProductDetailsTable() {
    const productStats = {};
    filteredData.forEach(d => {
        const key = `${d.product}-${d.smaak}-${d.verpakking}`;
        if (!productStats[key]) {
            productStats[key] = {
                product: d.product,
                flavor: d.smaak,
                packaging: d.verpakking,
                units: 0,
                locations: new Set()
            };
        }
        productStats[key].units += safeParseAantal(d.aantal);
        productStats[key].locations.add(d.naam_klant);
    });
    
    const tbody = document.getElementById('product-details-table');
    tbody.innerHTML = Object.values(productStats)
        .sort((a, b) => b.units - a.units)
        .map(p => `
            <tr>
                <td><strong>${esc(p.product)}</strong></td>
                <td>${esc(p.flavor)}</td>
                <td><span class="badge bg-secondary">${esc(p.packaging)}</span></td>
                <td class="text-end">${p.units.toLocaleString()}</td>
                <td class="text-end">${p.locations.size}</td>
                <td class="text-end">${Math.round(p.units / p.locations.size)}</td>
            </tr>
        `).join('');
}

function updateLocationsDetailsTable() {
    const locationStats = {};
    filteredData.forEach(d => {
        const key = d.code_klant;
        if (!locationStats[key]) {
            locationStats[key] = {
                code: d.code_klant,
                name: d.naam_klant,
                address: d.adres_straat_huisnr,
                city: d.stad,
                province: d.provincie,
                chain: d.keten,
                type: d.type_zaak,
                units: 0
            };
        }
        locationStats[key].units += safeParseAantal(d.aantal);
    });
    
    const tbody = document.getElementById('locations-details-table');
    tbody.innerHTML = Object.values(locationStats)
        .sort((a, b) => b.units - a.units)
        .map(l => `
            <tr>
                <td><code>${esc(l.code)}</code></td>
                <td><strong>${esc(l.name)}</strong></td>
                <td><small>${esc(l.address)}</small></td>
                <td>${esc(l.city)}</td>
                <td>${esc(l.province)}</td>
                <td><span class="badge bg-primary">${esc(l.chain)}</span></td>
                <td><small>${esc(l.type)}</small></td>
                <td class="text-end"><strong>${l.units.toLocaleString()}</strong></td>
            </tr>
        `).join('');
}

function updateChainDetailsTable() {
    const chainStats = {};
    filteredData.forEach(d => {
        if (!chainStats[d.keten]) {
            chainStats[d.keten] = {
                chain: d.keten,
                units: 0,
                locations: new Set(),
                products: new Set()
            };
        }
        chainStats[d.keten].units += safeParseAantal(d.aantal);
        chainStats[d.keten].locations.add(d.naam_klant);
        chainStats[d.keten].products.add(d.product);
    });
    
    const tbody = document.getElementById('chain-details-table');
    tbody.innerHTML = Object.values(chainStats)
        .sort((a, b) => b.units - a.units)
        .map(c => `
            <tr>
                <td><strong>${esc(c.chain)}</strong></td>
                <td class="text-end">${c.units.toLocaleString()}</td>
                <td class="text-end">${c.locations.size}</td>
                <td class="text-end">${c.products.size}</td>
                <td class="text-end">${Math.round(c.units / c.locations.size)}</td>
            </tr>
        `).join('');
}

function updateDetailedDataTable() {
    const tbody = document.getElementById('detailed-data-table');
    tbody.innerHTML = filteredData.slice(0, 500).map(d => `
        <tr>
            <td><code>${esc(d.code_klant)}</code></td>
            <td>${esc(d.naam_klant)}</td>
            <td>${esc(d.stad)}</td>
            <td>${esc(d.provincie)}</td>
            <td>${esc(d.product)}</td>
            <td>${esc(d.smaak)}</td>
            <td><span class="badge bg-secondary">${esc(d.verpakking)}</span></td>
            <td><span class="badge bg-primary">${esc(d.keten)}</span></td>
            <td><small>${esc(d.type_zaak)}</small></td>
            <td>${esc(d.maand)}</td>
            <td>${esc(d.jaar)}</td>
            <td class="text-end"><strong>${safeParseAantal(d.aantal).toLocaleString()}</strong></td>
        </tr>
    `).join('');
    
    if (filteredData.length > 500) {
        tbody.innerHTML += `<tr><td colspan="12" class="text-center text-muted"><em>Showing first 500 of ${filteredData.length} records. Apply more filters to see all.</em></td></tr>`;
    }
}

function updateAllCharts() {
    createTimelineChart();
    createProductPieChart();
    createProductBarChart();
    createPackagingChart();
    createProvinceChart();
    createCityChart();
    createMonthlyTrendChart();
    createWeeklyChart();
    createYearComparisonChart();
    createChainPerformanceChart();
    createChainPieChart();
}

function createTimelineChart() {
    const ctx = document.getElementById('timeline-chart');
    if (!ctx) return;
    
    const monthlyData = {};
    filteredData.forEach(d => {
        const key = `${d.jaar}-${d.maand}`;
        monthlyData[key] = (monthlyData[key] || 0) + (safeParseAantal(d.aantal));
    });
    
    const labels = Object.keys(monthlyData).sort();
    const data = labels.map(l => monthlyData[l]);
    
    destroyChart('timeline-chart');
    charts['timeline-chart'] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Units',
                data: data,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1,
                fill: true,
                backgroundColor: 'rgba(75, 192, 192, 0.1)'
            }]
        },
        options: { responsive: true, maintainAspectRatio: true }
    });
}

function createProductPieChart() {
    const ctx = document.getElementById('product-pie-chart');
    if (!ctx) return;
    
    const productData = {};
    filteredData.forEach(d => {
        productData[d.product] = (productData[d.product] || 0) + (safeParseAantal(d.aantal));
    });
    
    destroyChart('product-pie-chart');
    charts['product-pie-chart'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(productData),
            datasets: [{
                data: Object.values(productData),
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
            }]
        },
        options: { responsive: true, maintainAspectRatio: true }
    });
}

function createProductBarChart() {
    const ctx = document.getElementById('product-bar-chart');
    if (!ctx) return;
    
    const productData = {};
    filteredData.forEach(d => {
        productData[d.product] = (productData[d.product] || 0) + (safeParseAantal(d.aantal));
    });
    
    destroyChart('product-bar-chart');
    charts['product-bar-chart'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(productData),
            datasets: [{
                label: 'Units',
                data: Object.values(productData),
                backgroundColor: 'rgba(54, 162, 235, 0.8)'
            }]
        },
        options: { responsive: true, maintainAspectRatio: true }
    });
}

function createPackagingChart() {
    const ctx = document.getElementById('packaging-chart');
    if (!ctx) return;
    
    const packagingData = {};
    filteredData.forEach(d => {
        packagingData[d.verpakking] = (packagingData[d.verpakking] || 0) + (safeParseAantal(d.aantal));
    });
    
    destroyChart('packaging-chart');
    charts['packaging-chart'] = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(packagingData),
            datasets: [{
                data: Object.values(packagingData),
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56']
            }]
        },
        options: { responsive: true, maintainAspectRatio: true }
    });
}

function createProvinceChart() {
    const ctx = document.getElementById('province-chart');
    if (!ctx) return;
    
    const provinceData = {};
    filteredData.forEach(d => {
        provinceData[d.provincie] = (provinceData[d.provincie] || 0) + (safeParseAantal(d.aantal));
    });
    
    destroyChart('province-chart');
    charts['province-chart'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(provinceData),
            datasets: [{
                label: 'Units by Province',
                data: Object.values(provinceData),
                backgroundColor: 'rgba(153, 102, 255, 0.8)'
            }]
        },
        options: { responsive: true, maintainAspectRatio: true, indexAxis: 'y' }
    });
}

function createCityChart() {
    const ctx = document.getElementById('city-chart');
    if (!ctx) return;
    
    const cityData = {};
    filteredData.forEach(d => {
        cityData[d.stad] = (cityData[d.stad] || 0) + (safeParseAantal(d.aantal));
    });
    
    const sorted = Object.entries(cityData).sort((a, b) => b[1] - a[1]).slice(0, 10);
    
    destroyChart('city-chart');
    charts['city-chart'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sorted.map(s => s[0]),
            datasets: [{
                label: 'Units by City',
                data: sorted.map(s => s[1]),
                backgroundColor: 'rgba(255, 159, 64, 0.8)'
            }]
        },
        options: { responsive: true, maintainAspectRatio: true, indexAxis: 'y' }
    });
}

function createMonthlyTrendChart() {
    const ctx = document.getElementById('monthly-trend-chart');
    if (!ctx) return;
    
    const monthOrder = ['januari', 'februari', 'maart', 'april', 'mei', 'juni', 'juli', 'augustus', 'september', 'oktober', 'november', 'december'];
    const monthlyData = {};
    
    filteredData.forEach(d => {
        const month = d.maand;
        monthlyData[month] = (monthlyData[month] || 0) + (safeParseAantal(d.aantal));
    });
    
    const labels = monthOrder.filter(m => monthlyData[m]);
    const data = labels.map(l => monthlyData[l]);
    
    destroyChart('monthly-trend-chart');
    charts['monthly-trend-chart'] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Units per Month',
                data: data,
                borderColor: 'rgb(255, 99, 132)',
                tension: 0.4,
                fill: true,
                backgroundColor: 'rgba(255, 99, 132, 0.1)'
            }]
        },
        options: { responsive: true, maintainAspectRatio: true }
    });
}

function createWeeklyChart() {
    const ctx = document.getElementById('weekly-chart');
    if (!ctx) return;
    
    const weeklyData = {};
    filteredData.forEach(d => {
        if (d.week) {
            weeklyData[d.week] = (weeklyData[d.week] || 0) + (safeParseAantal(d.aantal));
        }
    });
    
    const sortedWeeks = Object.keys(weeklyData).sort((a, b) => parseInt(a) - parseInt(b));
    
    destroyChart('weekly-chart');
    charts['weekly-chart'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sortedWeeks.map(w => `Week ${w}`),
            datasets: [{
                label: 'Units per Week',
                data: sortedWeeks.map(w => weeklyData[w]),
                backgroundColor: 'rgba(54, 162, 235, 0.8)'
            }]
        },
        options: { responsive: true, maintainAspectRatio: true }
    });
}

function createYearComparisonChart() {
    const ctx = document.getElementById('year-comparison-chart');
    if (!ctx) return;
    
    const yearData = {};
    filteredData.forEach(d => {
        yearData[d.jaar] = (yearData[d.jaar] || 0) + (safeParseAantal(d.aantal));
    });
    
    destroyChart('year-comparison-chart');
    charts['year-comparison-chart'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(yearData).sort(),
            datasets: [{
                label: 'Units by Year',
                data: Object.values(yearData),
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
            }]
        },
        options: { responsive: true, maintainAspectRatio: true }
    });
}

function createChainPerformanceChart() {
    const ctx = document.getElementById('chain-performance-chart');
    if (!ctx) return;
    
    const chainData = {};
    filteredData.forEach(d => {
        chainData[d.keten] = (chainData[d.keten] || 0) + (safeParseAantal(d.aantal));
    });
    
    destroyChart('chain-performance-chart');
    charts['chain-performance-chart'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(chainData),
            datasets: [{
                label: 'Units by Chain',
                data: Object.values(chainData),
                backgroundColor: 'rgba(255, 206, 86, 0.8)'
            }]
        },
        options: { responsive: true, maintainAspectRatio: true }
    });
}

function createChainPieChart() {
    const ctx = document.getElementById('chain-pie-chart');
    if (!ctx) return;
    
    const chainData = {};
    filteredData.forEach(d => {
        chainData[d.keten] = (chainData[d.keten] || 0) + (safeParseAantal(d.aantal));
    });
    
    destroyChart('chain-pie-chart');
    charts['chain-pie-chart'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(chainData),
            datasets: [{
                data: Object.values(chainData),
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
            }]
        },
        options: { responsive: true, maintainAspectRatio: true }
    });
}

function destroyChart(id) {
    if (charts[id]) {
        charts[id].destroy();
    }
}

function resetFilters() {
    document.getElementById('year-filter').value = 'all';
    document.getElementById('month-filter').value = 'all';
    document.getElementById('product-filter').value = 'all';
    document.getElementById('flavor-filter').value = 'all';
    document.getElementById('chain-filter').value = 'all';
    document.getElementById('province-filter').value = 'all';
    document.getElementById('search-filter').value = '';
    applyFilters();
}

function exportData() {
    const headers = ['Code', 'Customer', 'Address', 'City', 'Province', 'Product', 'Flavor', 'Package', 'Chain', 'Type', 'Week', 'Month', 'Year', 'Units'];
    const rows = filteredData.map(d => [
        d.code_klant, d.naam_klant, d.adres_straat_huisnr, d.stad, d.provincie,
        d.product, d.smaak, d.verpakking, d.keten, d.type_zaak,
        d.week, d.maand, d.jaar, d.aantal
    ]);
    
    let csv = headers.join(',') + '\n';
    rows.forEach(row => {
        csv += row.map(cell => `"${cell || ''}"`).join(',') + '\n';
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `retailer-analytics-${companyId}-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
}

function esc(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showLoading() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('main-content').style.display = 'none';
    document.getElementById('error-message').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('main-content').style.display = 'block';
}

function showError(message) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error-message').style.display = 'block';
    document.getElementById('error-text').textContent = message;
}

// AI Assistant functions
function toggleAIAssistant() {
    const panel = document.getElementById('aiAssistantPanel');
    const overlay = document.getElementById('aiPanelOverlay');
    panel.classList.toggle('show');
    overlay.classList.toggle('show');
    
    if (panel.classList.contains('show')) {
        document.body.style.overflow = 'hidden';
    } else {
        document.body.style.overflow = '';
    }
}

async function askAI(question) {
    const input = document.getElementById('aiQueryInput');
    const query = question || input.value.trim();
    
    if (!query) return;
    
    // Clear input
    if (!question) input.value = '';
    
    // Add user message to chat
    addMessageToChat('user', query);
    
    // Show thinking indicator
    const thinkingId = addMessageToChat('assistant', '<div class="thinking-indicator"><div class="spinner-border spinner-border-sm me-2"></div>Analyzing data...</div>');
    
    try {
        // Send query to AI endpoint
        const response = await fetch('/api/ai-query-retailer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                company_id: companyId,
                question: query,
                current_filters: {
                    year: document.getElementById('year-filter').value,
                    month: document.getElementById('month-filter').value,
                    product: document.getElementById('product-filter').value,
                    flavor: document.getElementById('flavor-filter').value,
                    chain: document.getElementById('chain-filter').value,
                    province: document.getElementById('province-filter').value
                },
                filtered_data: filteredData
            })
        });
        
        const result = await response.json();
        
        // Remove thinking indicator
        document.getElementById(thinkingId).remove();
        
        if (result.success) {
            addMessageToChat('assistant', result.answer);
        } else {
            addMessageToChat('assistant', `Error: ${result.error}`);
        }
        
    } catch (error) {
        document.getElementById(thinkingId).remove();
        addMessageToChat('assistant', `Error: ${error.message}`);
    }
}

function addMessageToChat(role, content) {
    const chatBody = document.getElementById('aiChatBody');
    const messageId = 'msg-' + Date.now();
    
    // Remove welcome message if it exists
    const welcome = chatBody.querySelector('.ai-welcome-message');
    if (welcome) {
        welcome.remove();
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.id = messageId;
    messageDiv.className = `ai-message ${role}`;
    messageDiv.innerHTML = `
        <div class="ai-message-content">
            ${role === 'user' ? '<i class="fas fa-user me-2"></i>' : '<i class="fas fa-robot me-2"></i>'}
            <div class="ai-message-text">${content}</div>
        </div>
    `;
    
    chatBody.appendChild(messageDiv);
    chatBody.scrollTop = chatBody.scrollHeight;
    
    return messageId;
}
</script>

<style>
/* AI Assistant Styles */
.ai-fab {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    font-size: 1.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 1000;
}

.ai-fab:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.ai-panel-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    z-index: 1040;
}

.ai-panel-overlay.show {
    opacity: 1;
    visibility: visible;
}

.ai-assistant-sidepanel {
    position: fixed;
    top: 0;
    right: -500px;
    width: 500px;
    max-width: 90vw;
    height: 100%;
    background: white;
    box-shadow: -4px 0 16px rgba(0, 0, 0, 0.2);
    transition: right 0.3s ease;
    z-index: 1050;
    display: flex;
    flex-direction: column;
}

.ai-assistant-sidepanel.show {
    right: 0;
}

.ai-assistant-header {
    padding: 1.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.ai-assistant-body {
    flex: 1;
    padding: 1.5rem;
    overflow-y: auto;
    background: #f8f9fa;
}

.ai-assistant-footer {
    padding: 1.5rem;
    border-top: 1px solid #dee2e6;
    background: white;
}

.ai-welcome-message {
    text-align: center;
    padding: 2rem 1rem;
}

.ai-suggestions {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 1rem;
}

.ai-suggestion {
    padding: 0.75rem;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.875rem;
}

.ai-suggestion:hover {
    border-color: #667eea;
    background: #f0f4ff;
    transform: translateX(4px);
}

.ai-message {
    margin-bottom: 1rem;
}

.ai-message-content {
    display: flex;
    gap: 0.5rem;
}

.ai-message.user .ai-message-content {
    flex-direction: row-reverse;
}

.ai-message.user .ai-message-text {
    background: #667eea;
    color: white;
    border-radius: 1rem 1rem 0 1rem;
}

.ai-message.assistant .ai-message-text {
    background: white;
    color: #333;
    border-radius: 1rem 1rem 1rem 0;
}

.ai-message-text {
    padding: 0.75rem 1rem;
    max-width: 80%;
    word-wrap: break-word;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.thinking-indicator {
    display: flex;
    align-items: center;
    color: #667eea;
}
</style>
{% endblock %}
