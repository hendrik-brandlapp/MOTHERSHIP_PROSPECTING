{% extends "base.html" %}

{% block title %}My Routes - CRMinal{% endblock %}

{% block extra_head %}
<style>
    /* Routes Overview Layout */
    .routes-container {
        padding: var(--space-lg);
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Filter Bar */
    .routes-filter-bar {
        display: flex;
        gap: var(--space-md);
        margin-bottom: var(--space-lg);
        flex-wrap: wrap;
        align-items: center;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .filter-group label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .filter-group select,
    .filter-group input {
        min-width: 150px;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        background: var(--bg-surface);
        font-size: 0.875rem;
    }

    .filter-group input[type="date"] {
        min-width: 140px;
    }

    .filter-actions {
        display: flex;
        gap: var(--space-sm);
        margin-left: auto;
    }

    .btn-clear-filters {
        padding: 0.5rem 1rem;
        background: transparent;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 0.2s;
    }

    .btn-clear-filters:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
    }

    /* Routes Grid */
    .routes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: var(--space-lg);
    }

    /* Route Card */
    .route-card {
        background: var(--bg-surface);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
    }

    .route-card:hover {
        border-color: var(--accent);
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .route-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-md);
    }

    .route-card-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 0.25rem 0;
    }

    .route-card-date {
        font-size: 0.875rem;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    .route-status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius-full);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .route-status-badge.planned {
        background: var(--info-bg);
        color: var(--info);
    }

    .route-status-badge.in_progress {
        background: var(--warning-bg);
        color: var(--warning);
    }

    .route-status-badge.completed {
        background: var(--success-bg);
        color: var(--success);
    }

    .route-card-body {
        border-top: 1px solid var(--border-subtle);
        padding-top: var(--space-md);
    }

    .route-meta-row {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .route-meta-row i {
        width: 20px;
        color: var(--text-muted);
    }

    .route-meta-row strong {
        color: var(--text-primary);
    }

    .route-stops-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: var(--space-md);
    }

    .stop-preview-chip {
        background: var(--bg-primary);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-full);
        padding: 0.25rem 0.625rem;
        font-size: 0.75rem;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .stop-preview-chip .stop-num {
        background: var(--accent);
        color: white;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.625rem;
        font-weight: 600;
    }

    .more-stops-chip {
        background: var(--accent-subtle);
        color: var(--accent);
        border-color: var(--accent);
    }

    /* Empty State */
    .routes-empty-state {
        text-align: center;
        padding: var(--space-2xl);
        color: var(--text-secondary);
    }

    .routes-empty-state i {
        font-size: 4rem;
        margin-bottom: var(--space-lg);
        opacity: 0.3;
    }

    .routes-empty-state h5 {
        margin-bottom: var(--space-sm);
        color: var(--text-primary);
    }

    /* Quick Stats */
    .routes-stats {
        display: flex;
        gap: var(--space-lg);
        margin-bottom: var(--space-lg);
        flex-wrap: wrap;
    }

    .stat-card {
        background: var(--bg-surface);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        flex: 1;
        min-width: 200px;
    }

    .stat-card-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        font-family: 'Inter Tight', sans-serif;
    }

    .stat-card-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }

    .stat-card-icon {
        float: right;
        width: 40px;
        height: 40px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }

    .stat-card-icon.routes {
        background: var(--accent-subtle);
        color: var(--accent);
    }

    .stat-card-icon.stops {
        background: var(--info-bg);
        color: var(--info);
    }

    .stat-card-icon.upcoming {
        background: var(--warning-bg);
        color: var(--warning);
    }

    .stat-card-icon.completed {
        background: var(--success-bg);
        color: var(--success);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">My Routes</h1>
            <p class="page-subtitle">View and manage your planned visits</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('prospecting_map') }}" class="btn btn-outline-primary">
                <i class="fas fa-map-marked-alt me-2"></i>Prospecting Map
            </a>
            <a href="{{ url_for('planning') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Create New Route
            </a>
        </div>
    </div>
</div>

<div class="routes-container">
    <!-- Quick Stats -->
    <div class="routes-stats" id="routeStats">
        <div class="stat-card">
            <div class="stat-card-icon routes"><i class="fas fa-route"></i></div>
            <div class="stat-card-value" id="totalRoutes">-</div>
            <div class="stat-card-label">Total Routes</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon stops"><i class="fas fa-map-marker-alt"></i></div>
            <div class="stat-card-value" id="totalStops">-</div>
            <div class="stat-card-label">Total Stops</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon upcoming"><i class="fas fa-calendar-alt"></i></div>
            <div class="stat-card-value" id="upcomingRoutes">-</div>
            <div class="stat-card-label">Upcoming</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon completed"><i class="fas fa-check-circle"></i></div>
            <div class="stat-card-value" id="completedRoutes">-</div>
            <div class="stat-card-label">Completed</div>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="routes-filter-bar">
        <div class="filter-group">
            <label>Status</label>
            <select id="statusFilter" onchange="filterRoutes()">
                <option value="">All Statuses</option>
                <option value="planned">Planned</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Salesperson</label>
            <select id="salespersonFilter" onchange="filterRoutes()">
                <option value="">All Salespeople</option>
            </select>
        </div>
        <div class="filter-group">
            <label>From Date</label>
            <input type="date" id="dateFromFilter" onchange="filterRoutes()">
        </div>
        <div class="filter-group">
            <label>To Date</label>
            <input type="date" id="dateToFilter" onchange="filterRoutes()">
        </div>
        <div class="filter-group">
            <label>Region</label>
            <select id="regionFilter" onchange="filterRoutes()">
                <option value="">All Regions</option>
            </select>
        </div>
        <div class="filter-actions">
            <button class="btn-clear-filters" onclick="clearFilters()">
                <i class="fas fa-times me-1"></i>Clear Filters
            </button>
        </div>
    </div>

    <!-- Routes Grid -->
    <div class="routes-grid" id="routesGrid">
        <div class="routes-empty-state">
            <i class="fas fa-spinner fa-spin"></i>
            <h5>Loading routes...</h5>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let allRoutes = [];
let filteredRoutes = [];

// Load routes on page load
document.addEventListener('DOMContentLoaded', function() {
    loadRoutes();
});

async function loadRoutes() {
    try {
        const response = await fetch('/api/trips');
        const data = await response.json();

        if (data.success) {
            allRoutes = data.trips || [];

            // Load stops for each trip
            await Promise.all(allRoutes.map(async (route) => {
                try {
                    const detailResponse = await fetch(`/api/trips/${route.id}`);
                    const detailData = await detailResponse.json();
                    if (detailData.success) {
                        route.stops = detailData.trip.stops || [];
                    }
                } catch (e) {
                    route.stops = [];
                }
            }));

            populateFilters();
            updateStats();
            filterRoutes();
        } else {
            showEmptyState('Failed to load routes');
        }
    } catch (error) {
        console.error('Error loading routes:', error);
        showEmptyState('Error loading routes');
    }
}

function populateFilters() {
    // Populate salespeople dropdown
    const salespeople = [...new Set(allRoutes.map(r => r.created_by).filter(Boolean))];
    const salespersonSelect = document.getElementById('salespersonFilter');
    salespeople.forEach(sp => {
        const option = document.createElement('option');
        option.value = sp;
        option.textContent = sp;
        salespersonSelect.appendChild(option);
    });

    // Populate regions dropdown (extract from start_location)
    const regions = [...new Set(allRoutes.map(r => {
        if (r.start_location) {
            const parts = r.start_location.split(',');
            if (parts.length >= 2) {
                return parts[parts.length - 2].trim();
            }
        }
        return null;
    }).filter(Boolean))];

    const regionSelect = document.getElementById('regionFilter');
    regions.sort().forEach(region => {
        const option = document.createElement('option');
        option.value = region;
        option.textContent = region;
        regionSelect.appendChild(option);
    });
}

function updateStats() {
    const today = new Date().toISOString().split('T')[0];

    document.getElementById('totalRoutes').textContent = allRoutes.length;
    document.getElementById('totalStops').textContent = allRoutes.reduce((sum, r) => sum + (r.stops?.length || 0), 0);
    document.getElementById('upcomingRoutes').textContent = allRoutes.filter(r => r.trip_date >= today && r.status !== 'completed').length;
    document.getElementById('completedRoutes').textContent = allRoutes.filter(r => r.status === 'completed').length;
}

function filterRoutes() {
    const status = document.getElementById('statusFilter').value;
    const salesperson = document.getElementById('salespersonFilter').value;
    const dateFrom = document.getElementById('dateFromFilter').value;
    const dateTo = document.getElementById('dateToFilter').value;
    const region = document.getElementById('regionFilter').value;

    filteredRoutes = allRoutes.filter(route => {
        if (status && route.status !== status) return false;
        if (salesperson && route.created_by !== salesperson) return false;
        if (dateFrom && route.trip_date < dateFrom) return false;
        if (dateTo && route.trip_date > dateTo) return false;
        if (region && route.start_location && !route.start_location.includes(region)) return false;
        return true;
    });

    // Sort by date descending
    filteredRoutes.sort((a, b) => {
        if (a.trip_date === b.trip_date) return 0;
        return a.trip_date > b.trip_date ? -1 : 1;
    });

    renderRoutes();
}

function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('salespersonFilter').value = '';
    document.getElementById('dateFromFilter').value = '';
    document.getElementById('dateToFilter').value = '';
    document.getElementById('regionFilter').value = '';
    filterRoutes();
}

function renderRoutes() {
    const grid = document.getElementById('routesGrid');

    if (filteredRoutes.length === 0) {
        grid.innerHTML = `
            <div class="routes-empty-state" style="grid-column: 1 / -1;">
                <i class="fas fa-route"></i>
                <h5>No routes found</h5>
                <p>Create a new route from the Prospecting Map or adjust your filters</p>
            </div>
        `;
        return;
    }

    grid.innerHTML = filteredRoutes.map(route => `
        <div class="route-card" onclick="viewRoute('${route.id}')">
            <div class="route-card-header">
                <div>
                    <h5 class="route-card-title">${escapeHtml(route.name)}</h5>
                    <div class="route-card-date">
                        <i class="fas fa-calendar"></i>
                        ${formatDate(route.trip_date)}
                        ${route.start_time ? `<span class="ms-2"><i class="fas fa-clock"></i> ${route.start_time}</span>` : ''}
                    </div>
                </div>
                <span class="route-status-badge ${route.status}">${formatStatus(route.status)}</span>
            </div>
            <div class="route-card-body">
                ${route.created_by ? `
                    <div class="route-meta-row">
                        <i class="fas fa-user"></i>
                        <span>${escapeHtml(route.created_by)}</span>
                    </div>
                ` : ''}
                <div class="route-meta-row">
                    <i class="fas fa-map-marker-alt"></i>
                    <strong>${route.stops?.length || 0}</strong> stops
                    ${route.total_distance_km ? `<span class="ms-3"><i class="fas fa-road"></i> ${route.total_distance_km} km</span>` : ''}
                </div>
                ${route.start_location ? `
                    <div class="route-meta-row">
                        <i class="fas fa-play-circle"></i>
                        <span class="text-truncate">${escapeHtml(route.start_location.substring(0, 40))}${route.start_location.length > 40 ? '...' : ''}</span>
                    </div>
                ` : ''}
                ${route.stops && route.stops.length > 0 ? `
                    <div class="route-stops-preview">
                        ${route.stops.slice(0, 3).map((stop, i) => `
                            <div class="stop-preview-chip">
                                <span class="stop-num">${i + 1}</span>
                                ${escapeHtml((stop.company_name || 'Stop').substring(0, 15))}${(stop.company_name || '').length > 15 ? '...' : ''}
                            </div>
                        `).join('')}
                        ${route.stops.length > 3 ? `
                            <div class="stop-preview-chip more-stops-chip">
                                +${route.stops.length - 3} more
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
            </div>
        </div>
    `).join('');
}

function viewRoute(routeId) {
    window.location.href = `/trips/${routeId}`;
}

function showEmptyState(message) {
    document.getElementById('routesGrid').innerHTML = `
        <div class="routes-empty-state" style="grid-column: 1 / -1;">
            <i class="fas fa-exclamation-circle"></i>
            <h5>${escapeHtml(message)}</h5>
        </div>
    `;
}

// Utility functions
function formatDate(dateString) {
    if (!dateString) return 'No date';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        weekday: 'short',
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

function formatStatus(status) {
    const statusMap = {
        'planned': 'Planned',
        'in_progress': 'In Progress',
        'completed': 'Completed'
    };
    return statusMap[status] || status;
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
