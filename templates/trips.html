{% extends "base.html" %}

{% block title %}My Routes - CRMinal{% endblock %}

{% block extra_head %}
<style>
    .routes-container {
        padding: var(--space-lg);
        max-width: 1200px;
        margin: 0 auto;
    }

    /* Filter Bar */
    .routes-filter-bar {
        display: flex;
        gap: var(--space-md);
        margin-bottom: var(--space-lg);
        flex-wrap: wrap;
        align-items: flex-end;
        background: var(--bg-surface);
        padding: var(--space-md);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-color);
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .filter-group label {
        font-size: 0.6875rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .filter-group select,
    .filter-group input {
        min-width: 130px;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        background: var(--bg-primary);
        font-size: 0.875rem;
    }

    .filter-group input[type="date"] {
        min-width: 130px;
    }

    .btn-clear-filters {
        padding: 0.5rem 0.875rem;
        background: transparent;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 0.8125rem;
        transition: all 0.2s;
        margin-left: auto;
    }

    .btn-clear-filters:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
    }

    /* Routes List */
    .routes-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-md);
    }

    /* Route Card */
    .route-card {
        background: var(--bg-surface);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: var(--space-lg);
    }

    .route-card:hover {
        border-color: var(--accent);
        box-shadow: var(--shadow-sm);
    }

    .route-card-main {
        flex: 1;
        min-width: 0;
    }

    .route-card-header {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        margin-bottom: 0.5rem;
    }

    .route-card-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }

    .route-status-badge {
        padding: 0.2rem 0.5rem;
        border-radius: var(--radius-full);
        font-size: 0.6875rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .route-status-badge.planned {
        background: var(--info-bg);
        color: var(--info);
    }

    .route-status-badge.in_progress {
        background: var(--warning-bg);
        color: var(--warning);
    }

    .route-status-badge.completed {
        background: var(--success-bg);
        color: var(--success);
    }

    .route-card-meta {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-md);
        font-size: 0.8125rem;
        color: var(--text-secondary);
    }

    .route-card-meta-item {
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    .route-card-meta-item i {
        color: var(--text-muted);
        width: 14px;
    }

    .route-card-stops {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: var(--space-sm) var(--space-md);
        background: var(--bg-primary);
        border-radius: var(--radius-md);
        flex-shrink: 0;
    }

    .route-card-stops-count {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--accent);
    }

    .route-card-stops-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .route-card-arrow {
        color: var(--text-muted);
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    /* Empty State */
    .routes-empty-state {
        text-align: center;
        padding: var(--space-2xl);
        color: var(--text-secondary);
        background: var(--bg-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-color);
    }

    .routes-empty-state i {
        font-size: 3rem;
        margin-bottom: var(--space-md);
        opacity: 0.3;
    }

    .routes-empty-state h5 {
        margin-bottom: var(--space-sm);
        color: var(--text-primary);
    }

    /* Results count */
    .routes-results-count {
        font-size: 0.8125rem;
        color: var(--text-secondary);
        margin-bottom: var(--space-md);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">My Routes</h1>
            <p class="page-subtitle">View and manage your planned visits</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('prospecting_map') }}" class="btn btn-outline-primary">
                <i class="fas fa-map-marked-alt me-2"></i>Prospecting Map
            </a>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createRouteModal">
                <i class="fas fa-plus me-2"></i>Create New Route
            </button>
        </div>
    </div>
</div>

<div class="routes-container">
    <!-- Filter Bar -->
    <div class="routes-filter-bar">
        <div class="filter-group">
            <label>Status</label>
            <select id="statusFilter" onchange="filterRoutes()">
                <option value="">All</option>
                <option value="planned">Planned</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Salesperson</label>
            <select id="salespersonFilter" onchange="filterRoutes()">
                <option value="">All</option>
            </select>
        </div>
        <div class="filter-group">
            <label>From</label>
            <input type="date" id="dateFromFilter" onchange="filterRoutes()">
        </div>
        <div class="filter-group">
            <label>To</label>
            <input type="date" id="dateToFilter" onchange="filterRoutes()">
        </div>
        <button class="btn-clear-filters" onclick="clearFilters()">
            <i class="fas fa-times me-1"></i>Clear
        </button>
    </div>

    <!-- Create Route Modal -->
    <div class="modal fade" id="createRouteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Route</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Route Name</label>
                        <input type="text" class="form-control" id="newRouteName" placeholder="e.g. Brussels East - Week 6">
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" id="newRouteDate">
                        </div>
                        <div class="col">
                            <label class="form-label">Start Time</label>
                            <input type="time" class="form-control" id="newRouteTime" value="09:00">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Salesperson</label>
                        <select class="form-control" id="newRouteSalesperson">
                            <option value="">Select...</option>
                            <option value="Caitlin">Caitlin</option>
                            <option value="Kesha">Kesha</option>
                            <option value="Django">Django</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitCreateRoute()" id="createRouteSubmitBtn">
                        <i class="fas fa-plus me-2"></i>Create & Build Route
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Results count -->
    <div class="routes-results-count" id="routesResultsCount"></div>

    <!-- Routes List -->
    <div class="routes-list" id="routesList">
        <div class="routes-empty-state">
            <i class="fas fa-spinner fa-spin"></i>
            <h5>Loading routes...</h5>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let allRoutes = [];
let filteredRoutes = [];

document.addEventListener('DOMContentLoaded', function() {
    loadRoutes();

    // Set default date to today in the create modal
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('newRouteDate').value = today;
});

async function submitCreateRoute() {
    const name = document.getElementById('newRouteName').value.trim();
    const tripDate = document.getElementById('newRouteDate').value;
    const startTime = document.getElementById('newRouteTime').value;
    const salesperson = document.getElementById('newRouteSalesperson').value;

    if (!name) {
        alert('Please enter a route name');
        return;
    }
    if (!tripDate) {
        alert('Please select a date');
        return;
    }

    const btn = document.getElementById('createRouteSubmitBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating...';

    try {
        const response = await fetch('/api/trips/create-empty', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, trip_date: tripDate, start_time: startTime, salesperson })
        });
        const data = await response.json();

        if (data.success) {
            window.location.href = `/prospecting-map?route_id=${data.trip.id}`;
        } else {
            alert('Error: ' + (data.error || 'Failed to create route'));
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-plus me-2"></i>Create & Build Route';
        }
    } catch (error) {
        console.error('Error creating route:', error);
        alert('Error creating route');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-plus me-2"></i>Create & Build Route';
    }
}

async function loadRoutes() {
    try {
        const response = await fetch('/api/trips');
        const data = await response.json();

        if (data.success) {
            allRoutes = data.trips || [];

            // Load stops count for each trip
            await Promise.all(allRoutes.map(async (route) => {
                try {
                    const detailResponse = await fetch(`/api/trips/${route.id}`);
                    const detailData = await detailResponse.json();
                    if (detailData.success) {
                        route.stops = detailData.trip.stops || [];
                    }
                } catch (e) {
                    route.stops = [];
                }
            }));

            populateFilters();
            filterRoutes();
        } else {
            showEmptyState('Failed to load routes');
        }
    } catch (error) {
        console.error('Error loading routes:', error);
        showEmptyState('Error loading routes');
    }
}

function populateFilters() {
    const salespeople = [...new Set(allRoutes.map(r => r.created_by).filter(Boolean))];
    const salespersonSelect = document.getElementById('salespersonFilter');
    salespeople.forEach(sp => {
        const option = document.createElement('option');
        option.value = sp;
        option.textContent = sp;
        salespersonSelect.appendChild(option);
    });
}

function filterRoutes() {
    const status = document.getElementById('statusFilter').value;
    const salesperson = document.getElementById('salespersonFilter').value;
    const dateFrom = document.getElementById('dateFromFilter').value;
    const dateTo = document.getElementById('dateToFilter').value;

    filteredRoutes = allRoutes.filter(route => {
        if (status && route.status !== status) return false;
        if (salesperson && route.created_by !== salesperson) return false;
        if (dateFrom && route.trip_date < dateFrom) return false;
        if (dateTo && route.trip_date > dateTo) return false;
        return true;
    });

    filteredRoutes.sort((a, b) => (a.trip_date > b.trip_date ? -1 : 1));
    renderRoutes();
}

function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('salespersonFilter').value = '';
    document.getElementById('dateFromFilter').value = '';
    document.getElementById('dateToFilter').value = '';
    filterRoutes();
}

function renderRoutes() {
    const list = document.getElementById('routesList');
    const countEl = document.getElementById('routesResultsCount');

    countEl.textContent = `${filteredRoutes.length} route${filteredRoutes.length !== 1 ? 's' : ''}`;

    if (filteredRoutes.length === 0) {
        list.innerHTML = `
            <div class="routes-empty-state">
                <i class="fas fa-route"></i>
                <h5>No routes found</h5>
                <p>Create a new route from the Prospecting Map</p>
            </div>
        `;
        return;
    }

    list.innerHTML = filteredRoutes.map(route => `
        <div class="route-card" onclick="viewRoute('${route.id}')">
            <div class="route-card-main">
                <div class="route-card-header">
                    <h5 class="route-card-title">${escapeHtml(route.name)}</h5>
                    <span class="route-status-badge ${route.status}">${formatStatus(route.status)}</span>
                </div>
                <div class="route-card-meta">
                    <div class="route-card-meta-item">
                        <i class="fas fa-calendar"></i>
                        <span>${formatDate(route.trip_date)}</span>
                    </div>
                    ${route.start_time ? `
                        <div class="route-card-meta-item">
                            <i class="fas fa-clock"></i>
                            <span>${route.start_time}</span>
                        </div>
                    ` : ''}
                    ${route.created_by ? `
                        <div class="route-card-meta-item">
                            <i class="fas fa-user"></i>
                            <span>${escapeHtml(route.created_by)}</span>
                        </div>
                    ` : ''}
                    ${route.total_distance_km ? `
                        <div class="route-card-meta-item">
                            <i class="fas fa-road"></i>
                            <span>${route.total_distance_km} km</span>
                        </div>
                    ` : ''}
                </div>
            </div>
            <div class="route-card-stops">
                <div class="route-card-stops-count">${route.stops?.length || 0}</div>
                <div class="route-card-stops-label">stops</div>
            </div>
            <div class="route-card-arrow">
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>
    `).join('');
}

function viewRoute(routeId) {
    window.location.href = `/trips/${routeId}`;
}

function showEmptyState(message) {
    document.getElementById('routesList').innerHTML = `
        <div class="routes-empty-state">
            <i class="fas fa-exclamation-circle"></i>
            <h5>${escapeHtml(message)}</h5>
        </div>
    `;
}

function formatDate(dateString) {
    if (!dateString) return 'No date';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
}

function formatStatus(status) {
    return { 'planned': 'Planned', 'in_progress': 'In Progress', 'completed': 'Completed' }[status] || status;
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
