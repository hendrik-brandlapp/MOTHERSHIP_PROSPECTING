{% extends 'base.html' %}

{% block title %}Prospecting ¬∑ CRMinal{% endblock %}

{% block extra_head %}
<style>
    /* Map and Results Styling */
    #map {
        width: 100%;
        height: 680px;
        border-radius: 20px;
        box-shadow: var(--shadow-lg);
        overflow: hidden;
    }
    
    .gm-style .gm-style-iw-c {
        border-radius: 12px !important;
    }
    
    .results-scroll { 
        max-height: 600px; 
        overflow: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--primary-color) transparent;
    }
    
    .results-scroll::-webkit-scrollbar {
        width: 6px;
    }
    
    .results-scroll::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .results-scroll::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 3px;
    }
    
    .result-item { 
        cursor: pointer; 
        border-radius: 12px;
        transition: all 0.2s ease;
        border: 1px solid var(--border);
        margin-bottom: 0.5rem;
    }
    
    .result-item:hover { 
        background: var(--surface-alt);
        border-color: var(--primary-color);
        transform: translateY(-1px);
        box-shadow: var(--shadow);
    }
    
    .photo-grid { 
        display: grid; 
        grid-template-columns: repeat(3, 1fr); 
        gap: 12px; 
    }
    
    .photo-grid img { 
        width: 100%; 
        height: 120px; 
        object-fit: cover; 
        border-radius: 12px; 
    }
    
    .loading-overlay { 
        position: absolute; 
        inset: 0; 
        background: rgba(255,255,255,0.9); 
        backdrop-filter: blur(10px);
        display: none; 
        align-items: center; 
        justify-content: center; 
        z-index: 5; 
        border-radius: inherit; 
    }
    
    .loading-overlay.show { display: flex; }
    
    .spinner { 
        width: 32px; 
        height: 32px; 
        border: 3px solid var(--border); 
        border-top-color: var(--primary-color); 
        border-radius: 50%; 
        animation: spin 1s linear infinite; 
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Modern Prospect Cards */
    .prospect-card { 
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        background: white;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .prospect-card:hover { 
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
        border-color: var(--primary-color);
    }
    
    /* Enhanced Pipeline Status Badges - More Prominent */
    .prospect-status {
        font-size: 0.85rem;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-weight: 700;
        text-transform: none;
        letter-spacing: 0.3px;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        white-space: nowrap;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 2px solid rgba(255,255,255,0.3);
        position: relative;
        z-index: 1;
    }

    /* Status icons */
    .prospect-status .status-icon {
        font-size: 1.1rem;
        font-weight: bold;
    }
    
    .status-new_leads { 
        background: #e0f2fe; 
        color: #0277bd;
    }
    
    .status-first_contact { 
        background: #fff3e0; 
        color: #f57c00;
    }
    
    .status-meeting_planned { 
        background: #f3e5f5; 
        color: #7b1fa2;
    }
    
    .status-follow_up { 
        background: #e8f5e8; 
        color: #2e7d32;
    }
    
    .status-customer { 
        background: #e8f5e8; 
        color: #1b5e20;
    }
    
    .status-ex_customer { 
        background: #ffebee; 
        color: #c62828;
    }
    
    .status-contact_later { 
        background: #fff8e1; 
        color: #f9a825;
    }
    
    .status-unqualified { 
        background: #fafafa; 
        color: #424242;
    }
    
    /* Pipeline Overview Cards - Compact Design */
    .pipeline-overview {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e7eb;
    }
    
    .pipeline-stage {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 0.625rem 0.75rem;
        text-align: center;
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    
    .pipeline-stage:hover {
        background: #f1f5f9;
        border-color: #3b82f6;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .pipeline-stage.active {
        background: #eff6ff;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .pipeline-stage-inactive {
        background: #f9fafb;
        border-color: #d1d5db;
        opacity: 0.8;
    }
    
    .pipeline-stage-inactive:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
        opacity: 1;
    }
    
    .pipeline-stage-inactive .stage-icon {
        opacity: 0.7;
    }
    
    .pipeline-stage-inactive .stage-label {
        color: #6b7280;
        font-size: 0.75rem;
    }
    
    /* Active dropdown item styling */
    .dropdown-item.active {
        background-color: #e3f2fd;
        color: #1976d2;
        font-weight: 500;
    }
    
    .pipeline-stage .stage-icon {
        font-size: 1.25rem;
        margin-bottom: 0.375rem;
        display: block;
    }
    
    .pipeline-stage .stage-count {
        font-size: 1.375rem;
        font-weight: 700;
        margin-bottom: 0.125rem;
        color: #1f2937;
    }
    
    .pipeline-stage .stage-label {
        font-size: 0.7rem;
        color: #6b7280;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    
    .pipeline-stage::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #3b82f6, #8b5cf6);
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    
    .pipeline-stage:hover::before,
    .pipeline-stage.active::before {
        opacity: 1;
    }
    
    /* Tab Navigation - Enhanced Visibility */
    .nav-pills .nav-link {
        border-radius: 8px;
        font-weight: 600;
        padding: 0.875rem 1.75rem;
        transition: all 0.2s ease;
        color: #1f2937;
        background: #f9fafb;
        border: 2px solid #e5e7eb;
        margin-right: 0.5rem;
    }
    
    .nav-pills .nav-link:hover:not(.active) {
        background: #f3f4f6;
        color: #111827;
        border-color: #d1d5db;
        transform: translateY(-1px);
    }
    
    .nav-pills .nav-link.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
    }
    
    /* Notes Section */
    .notes-section {
        background: #f9fafb;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        border: 1px solid #e5e7eb;
    }
    
    .notes-textarea {
        border: none;
        background: transparent;
        resize: vertical;
        min-height: 80px;
        font-size: 0.95rem;
        line-height: 1.6;
        width: 100%;
        font-family: inherit;
    }
    
    .notes-textarea:focus {
        outline: none;
        box-shadow: none;
    }
    
    /* Action Buttons */
    .card-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 1.25rem;
    }
    
    .card-actions .btn {
        font-size: 0.875rem;
        padding: 0.625rem 1.25rem;
        border-radius: 12px;
        font-weight: 500;
    }
    
    
    /* Enrichment Status */
    .enrichment-status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-weight: 500;
    }
    
    .enrichment-status.completed {
        background: rgba(16, 185, 129, 0.1);
        color: #065f46;
    }
    
    .enrichment-status.in-progress {
        background: rgba(59, 130, 246, 0.1);
        color: #1e40af;
    }
    
    .enrichment-status.failed {
        background: rgba(239, 68, 68, 0.1);
        color: #991b1b;
    }
    
    .enrichment-status.pending {
        background: rgba(156, 163, 175, 0.1);
        color: #4b5563;
    }
    
    /* Clickable Elements */
    .clickable-text {
        color: #2563eb !important;
        text-decoration: underline;
        text-decoration-color: rgba(37, 99, 235, 0.4);
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
    }
    
    .clickable-text:hover {
        text-decoration-color: #2563eb;
        color: #1d4ed8 !important;
    }
    
    /* Responsive Design */
    @media (max-width: 992px) {
        #map { height: 450px; }
        .results-scroll { max-height: 400px; }
        .prospect-card { padding: 1.25rem; margin-bottom: 1.25rem; }
        .nav-pills .nav-link { padding: 0.75rem 1.5rem; }
    }
    
    @media (max-width: 576px) {
        .main-container { padding: 1.5rem; }
        .filter-controls { padding: 1.25rem; }
        .card-actions { gap: 0.5rem; }
        .card-actions .btn { font-size: 0.8rem; padding: 0.5rem 1rem; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1 fw-bold text-dark">Prospecting</h1>
            <p class="text-muted mb-0">Discover and manage potential business opportunities</p>
        </div>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-pills mb-4" id="prospectTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-content" type="button" role="tab">
                <i class="fas fa-search me-2"></i>Search Prospects
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="database-tab" data-bs-toggle="tab" data-bs-target="#database-content" type="button" role="tab">
                <i class="fas fa-database me-2"></i>Prospect Database
            </button>
        </li>
    </ul>
    
    <!-- Tab Content -->
    <div class="tab-content">
        <!-- Search Tab -->
        <div class="tab-pane active" id="search-content">
            <!-- Search Input -->
            <div class="d-flex align-items-center gap-3 mb-4">
                <i class="fas fa-search text-primary"></i>
                <input class="form-control" id="prospect-search" placeholder="Search e.g. 'vegan antwerp' (Google Places)" style="flex: 1;">
            </div>
            
            {% if not google_maps_api_key %}
            <div class="alert alert-warning">
                <strong>Warning:</strong> Google Maps API key not configured. Please set GOOGLE_MAPS_API_KEY in your .env file.
            </div>
            {% endif %}
            
            <div class="row g-4">
                <div class="col-lg-7">
                    <div class="position-relative">
                        <div id="map" style="background: #f8f9fa; display: flex; align-items: center; justify-content: center; min-height: 500px;">
                            <div class="text-center">
                                <div class="spinner mb-2"></div>
                                <p class="text-muted">Loading Google Maps...</p>
                            </div>
                        </div>
                        <div id="map-loading" class="loading-overlay"><div class="spinner"></div></div>
                    </div>
                </div>
                <div class="col-lg-5">
                    <div class="position-relative mb-3">
                        <div id="results-loading" class="loading-overlay"><div class="spinner"></div></div>
                        <div class="results-scroll list-group" id="result-list"></div>
                    </div>
                    <div id="selection-details" class="small text-muted mb-3">Type a query (e.g., 'vegan antwerp') and press Enter. Results will appear here and on the map.</div>
                    <div class="position-relative">
                        <div id="detail-loading" class="loading-overlay"><div class="spinner"></div></div>
                        <div id="detail-panel" class="p-3 border rounded bg-white">Click a result or marker to view details.</div>
                    </div>
                </div>
            </div>
        </div>
                    
        <!-- Database Tab -->
        <div class="tab-pane" id="database-content">
            <!-- Pipeline Overview -->
            <div class="pipeline-overview">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 fw-semibold text-dark" style="font-size: 0.9rem;">üìà Sales Pipeline</h6>
                    <button class="btn btn-outline-primary btn-sm py-1 px-2" onclick="refreshPipelineStats()" style="font-size: 0.75rem;">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <!-- Active Pipeline Stages -->
                <div class="mb-2">
                    <h6 class="mb-1 text-muted fw-normal" style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em;">Active Pipeline</h6>
                    <div class="row g-2" id="active-pipeline-stats">
                        <div class="col-6 col-lg-2">
                            <div class="pipeline-stage" onclick="filterByStatus('new_leads')">
                                <span class="stage-icon">üîç</span>
                                <div class="stage-count" id="count-new_leads">-</div>
                                <div class="stage-label">New Leads</div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-2">
                            <div class="pipeline-stage" onclick="filterByStatus('visited')">
                                <span class="stage-icon">üëÅÔ∏è</span>
                                <div class="stage-count" id="count-visited">-</div>
                                <div class="stage-label">Visited</div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-2">
                            <div class="pipeline-stage" onclick="filterByStatus('first_contact')">
                                <span class="stage-icon">ü§ù</span>
                                <div class="stage-count" id="count-first_contact">-</div>
                                <div class="stage-label">First Contact</div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-2">
                            <div class="pipeline-stage" onclick="filterByStatus('meeting_planned')">
                                <span class="stage-icon">üìÖ</span>
                                <div class="stage-count" id="count-meeting_planned">-</div>
                                <div class="stage-label">Meeting Planned</div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-2">
                            <div class="pipeline-stage" onclick="filterByStatus('follow_up')">
                                <span class="stage-icon">‚úçÔ∏è</span>
                                <div class="stage-count" id="count-follow_up">-</div>
                                <div class="stage-label">Follow-up</div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-2">
                            <div class="pipeline-stage" onclick="filterByStatus('customer')">
                                <span class="stage-icon">üå±</span>
                                <div class="stage-count" id="count-customer">-</div>
                                <div class="stage-label">Customer</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Inactive/Archive Stages -->
                <div>
                    <h6 class="mb-1 text-muted fw-normal" style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em;">Inactive & Archive</h6>
                    <div class="row g-2" id="inactive-pipeline-stats">
                        <div class="col-6 col-lg-4">
                            <div class="pipeline-stage pipeline-stage-inactive" onclick="filterByStatus('ex_customer')">
                                <span class="stage-icon">üîô</span>
                                <div class="stage-count" id="count-ex_customer">-</div>
                                <div class="stage-label">Ex-Customer</div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-4">
                            <div class="pipeline-stage pipeline-stage-inactive" onclick="filterByStatus('contact_later')">
                                <span class="stage-icon">‚è≥</span>
                                <div class="stage-count" id="count-contact_later">-</div>
                                <div class="stage-label">Contact Later</div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-4">
                            <div class="pipeline-stage pipeline-stage-inactive" onclick="filterByStatus('unqualified')">
                                <span class="stage-icon">‚ùå</span>
                                <div class="stage-count" id="count-unqualified">-</div>
                                <div class="stage-label">Unqualified</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Compact Filter Controls -->
            <div class="d-flex flex-wrap align-items-center gap-2 mb-3 p-2 bg-white rounded border" style="font-size: 0.875rem;">
                <input type="text" class="form-control form-control-sm" id="prospect-filter" placeholder="Search..." style="max-width: 200px;">
                <select class="form-select form-select-sm" id="status-filter" style="max-width: 160px;">
                    <option value="">All Statuses</option>
                    <option value="new_leads">üîç New Leads</option>
                    <option value="visited">üëÅÔ∏è Visited</option>
                    <option value="first_contact">ü§ù First Contact</option>
                    <option value="meeting_planned">üìÖ Meeting Planned</option>
                    <option value="follow_up">‚úçÔ∏è Follow-up</option>
                    <option value="customer">üå± Customer</option>
                    <option value="ex_customer">üîô Ex-Customer</option>
                    <option value="contact_later">‚è≥ Contact Later</option>
                    <option value="unqualified">‚ùå Unqualified</option>
                </select>
                <select class="form-select form-select-sm" id="region-filter" style="max-width: 130px;">
                    <option value="">All Regions</option>
                </select>
                <select class="form-select form-select-sm" id="prospect-type-filter" style="max-width: 130px;">
                    <option value="">All Types</option>
                </select>
                <select class="form-select form-select-sm" id="city-filter" style="max-width: 130px;">
                    <option value="">All Cities</option>
                </select>
                <select class="form-select form-select-sm" id="keyword-filter" style="max-width: 130px;">
                    <option value="">All Keywords</option>
                </select>
                <div class="ms-auto d-flex gap-1">
                    <button class="btn btn-outline-secondary btn-sm px-2 py-1" onclick="clearAllFilters()" title="Clear filters">
                        <i class="fas fa-times"></i>
                    </button>
                    <button class="btn btn-primary btn-sm px-2 py-1" onclick="refreshProspects()" title="Refresh">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-success btn-sm px-2 py-1" onclick="retryFailedEnrichments()" title="Enrich">
                        <i class="fas fa-sparkles"></i>
                    </button>
                </div>
            </div>
            
            <!-- Prospects Container -->
            <div id="prospects-container">
                <div class="text-center py-5">
                    <i class="fas fa-database fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Loading prospects...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let map, markers = [], placesService, autocomplete;

// Initialize map with error handling
function initMap() {
    try {
        const mapElement = document.getElementById('map');
        if (!mapElement) {
            console.error('Map element not found');
            return;
        }
        
        // Clear loading content
        mapElement.innerHTML = '';
        mapElement.style.background = '';
        mapElement.style.display = '';
        mapElement.style.alignItems = '';
        mapElement.style.justifyContent = '';
        
        map = new google.maps.Map(mapElement, {
            center: { lat: 50.8503, lng: 4.3517 },
            zoom: 8,
            mapTypeControl: false,
            streetViewControl: false
        });
        
        console.log('Google Maps initialized successfully');
    } catch (error) {
        console.error('Error initializing Google Maps:', error);
        const mapElement = document.getElementById('map');
        if (mapElement) {
            mapElement.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                    <p class="text-muted">Google Maps failed to load</p>
                    <small class="text-muted">Check console for details</small>
                </div>
            `;
        }
        return;
    }

    // Places Autocomplete + Text Search
    const input = document.getElementById('prospect-search');
    autocomplete = new google.maps.places.Autocomplete(input, { fields: ['place_id', 'geometry', 'name', 'website', 'formatted_address'] });
    autocomplete.bindTo('bounds', map);
    placesService = new google.maps.places.PlacesService(map);

    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place || !place.place_id) return;
        placesService.getDetails({ placeId: place.place_id, fields: ['name', 'website', 'geometry', 'formatted_address'] }, (details, status) => {
            if (status !== google.maps.places.PlacesServiceStatus.OK || !details) return;
            const pos = details.geometry && details.geometry.location ? { lat: details.geometry.location.lat(), lng: details.geometry.location.lng() } : null;
            if (pos) {
                map.setCenter(pos);
                map.setZoom(14);
                addProspectMarker(pos, details.name || 'Prospect', `<div><strong>${details.name || ''}</strong><br><small>${details.formatted_address || ''}</small></div>`);
            }
            // Populate selection details and inputs for flows
            const info = document.getElementById('selection-details');
            info.innerHTML = `<strong>${details.name || ''}</strong><br><small>${details.formatted_address || ''}</small>${details.website ? `<br><a href="${details.website}" target="_blank" rel="noopener">${details.website}</a>` : ''}`;
            window.__prospect = { name: details.name || '', website: details.website || '' };
        });
    });

    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); runTextSearch(input.value.trim()); }
    });
}

function addProspectMarker(pos, title, infoHtml) {
    const marker = new google.maps.Marker({ position: pos, map, title });
    const info = new google.maps.InfoWindow({ content: infoHtml });
    marker.addListener('click', () => {
        info.open({ anchor: marker, map });
        showDetailsByLatLng(title, pos);
    });
    markers.push(marker);
}

function clearMarkers() {
    markers.forEach(m => m.setMap(null));
    markers = [];
}

function runTextSearch(query) {
    if (!query) return;
    document.getElementById('results-loading').classList.add('show');
    document.getElementById('map-loading').classList.add('show');
    const request = { query };
    const bounds = map.getBounds();
    if (bounds) request.bounds = bounds;
    placesService.textSearch(request, (results, status) => {
        document.getElementById('results-loading').classList.remove('show');
        document.getElementById('map-loading').classList.remove('show');
        const list = document.getElementById('result-list');
        list.innerHTML = '';
        document.getElementById('selection-details').textContent = `Results for "${query}"`;
        if (status !== google.maps.places.PlacesServiceStatus.OK || !results || !results.length) {
            clearMarkers();
            return;
        }
        clearMarkers();
        const fit = new google.maps.LatLngBounds();
        results.slice(0, 20).forEach((r, idx) => {
            const loc = r.geometry && r.geometry.location;
            if (!loc) return;
            const pos = { lat: loc.lat(), lng: loc.lng() };
            addProspectMarker(pos, r.name || 'Result', `<div><strong>${r.name || ''}</strong><br><small>${r.formatted_address || ''}</small></div>`);
            fit.extend(loc);
            const el = document.createElement('div');
            el.className = 'list-group-item result-item';
            el.innerHTML = `
                <div class="d-flex w-100 justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex w-100 justify-content-between">
                            <strong>${r.name || ''}</strong>
                            <small>${r.rating ? `‚≠ê ${r.rating}` : ''}</small>
                        </div>
                        <small class="text-muted">${r.formatted_address || ''}</small>
                    </div>
                    <div class="ms-2">
                        <button class="btn btn-sm btn-outline-success" onclick="quickSaveProspect('${r.name || ''}', '${r.formatted_address || ''}', '')" title="Save to Prospects">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                </div>
            `;
            // Add click handler for the main content area (excluding the save button)
            el.addEventListener('click', (e) => {
                // Don't trigger if clicking on the save button
                if (e.target.closest('button')) return;
                
                map.setCenter(pos);
                map.setZoom(15);
                window.__prospect = { name: r.name || '', website: '' };
                showDetailsByPlaceId(r.place_id);
            });
            list.appendChild(el);
        });
        try { map.fitBounds(fit); } catch (e) {}
    });
}

function showDetailsByLatLng(title, pos) {
    const request = { query: title, locationBias: new google.maps.LatLng(pos.lat, pos.lng) };
    placesService.textSearch(request, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && results && results[0]) {
            showDetailsByPlaceId(results[0].place_id);
        }
    });
}

function renderDetails(details) {
    const panel = document.getElementById('detail-panel');
    const photos = (details.photos || []).slice(0, 6).map(p => `<img src="${p.getUrl({maxWidth: 600, maxHeight: 400})}" alt="photo">`).join('');
    const url = details.website || (details.url || '');
    const rating = details.rating ? `‚≠ê ${details.rating} (${details.user_ratings_total || ''})` : '';
    const encodedQuery = encodeURIComponent(`${details.name || ''}`);
    
    panel.innerHTML = `
        <div class="prospect-detail-header mb-3">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h5 class="mb-1">${details.name || ''}</h5>
                    <p class="text-muted mb-1">${details.formatted_address || ''}</p>
                    <div class="mb-2">${rating}</div>
                    <div class="btn-group btn-group-sm">
                        ${url ? `<a class="btn btn-outline-primary" href="${url}" target="_blank" rel="noopener">Website</a>` : ''}
                        <a class="btn btn-outline-secondary" href="https://www.companyweb.be/en?q=${encodedQuery}" target="_blank" rel="noopener">Companyweb</a>
                        <button class="btn btn-success" onclick="saveProspectWithEnrichment('${details.name || ''}', '${details.formatted_address || ''}', '${details.website || ''}')">
                            <i class="fas fa-save me-1"></i>Save to Prospects
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        ${photos ? `<div class="photo-grid mb-3">${photos}</div>` : ''}
        
        <div class="mt-3">
            <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Click "Save to Prospects" to save this company. AI enrichment will happen automatically in the background.
            </small>
        </div>
    `;
    // Store current prospect details for enrichment
    window.__currentProspect = details;
}

function showDetailsByPlaceId(placeId) {
    if (!placeId) return;
    document.getElementById('detail-loading').classList.add('show');
    placesService.getDetails({ placeId, fields: ['name','formatted_address','website','url','rating','user_ratings_total','photos'] }, (details, status) => {
        document.getElementById('detail-loading').classList.remove('show');
        if (status !== google.maps.places.PlacesServiceStatus.OK || !details) return;
        renderDetails(details);
        window.__prospect = { name: details.name || (window.__prospect && window.__prospect.name) || '', website: details.website || '' };
    });
}

async function checkVAT(vat) {
    const q = new URLSearchParams({ vat_number: (vat || document.getElementById('vat-input').value).trim() });
    const res = await fetch('/api/prospecting/check-vat?' + q.toString());
    const data = await res.json();
    const box = document.getElementById('duano-results');
    const items = (data.result && data.result.data) || [];
    if (!items.length) { box.textContent = 'No matches found in DOUANO.'; return; }
    box.innerHTML = items.map(c => {
        const name = (c.public_name || c.name || 'Unknown');
        const vat = (c.vat_number || '');
        const city = (c.city || '');
        const id = c.id;
        return `<div class="mb-2"><strong>${name}</strong><br><small>${vat} ${city}</small></div>`;
    }).join('');
}

// Removed AI enrich and Extract VAT buttons per request

document.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-vat]');
    if (btn) { checkVAT(btn.getAttribute('data-vat')); }
});

// Tab functionality
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('[data-bs-toggle="tab"]');
    tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove active class from all tabs and content
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked tab
            this.classList.add('active');
            
            // Show corresponding content
            const target = this.getAttribute('data-bs-target');
            document.querySelector(target).classList.add('active');
            
                    // Load prospects if database tab is clicked
        if (target === '#database-content') {
            loadProspects();
            // Removed auto-refresh to prevent continuous polling
        }
        });
    });
    
    // Load prospects on page load (but don't wait for it to complete)
    setTimeout(() => {
        loadProspects();
        loadPipelineStats();
    }, 1000);
});

// Save prospect with background AI enrichment (non-blocking)
async function saveProspectWithEnrichment(name, address, website) {
    const saveBtn = event.target;
    const originalText = saveBtn.innerHTML;
    
    try {
        // Update button state immediately
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
        saveBtn.disabled = true;
        
        // Save prospect immediately with basic data
        await saveProspect(name, address, website, {});
        
        // Update button to show saved
        saveBtn.innerHTML = '<i class="fas fa-check me-1"></i>Saved!';
        saveBtn.classList.remove('btn-success');
        saveBtn.classList.add('btn-success');
        
        showToast('Prospect saved! AI enrichment in progress...', 'success');
        
        // Start background enrichment (non-blocking)
        performBackgroundEnrichment(name, address, website);
        
    } catch (error) {
        console.error('Error saving prospect:', error);
        saveBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Error';
        saveBtn.classList.remove('btn-success');
        saveBtn.classList.add('btn-danger');
        showToast('Failed to save prospect: ' + error.message, 'error');
    } finally {
        setTimeout(() => {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
            saveBtn.classList.remove('btn-danger');
            saveBtn.classList.add('btn-success');
        }, 3000);
    }
}

// Perform background enrichment without blocking UI
async function performBackgroundEnrichment(name, address, website) {
    try {
        console.log(`Starting background enrichment for: ${name}`);
        
        // The backend enrichment is already running automatically when we save the prospect
        // We just need to wait for it to complete and refresh the data
        console.log(`Backend enrichment started automatically for: ${name}`);
        
        // Show notification if user is on database tab
        if (document.querySelector('#database-content').classList.contains('active')) {
            showToast(`Enrichment started for ${name}!`, 'info');
        }
        
    } catch (error) {
        console.error(`Background enrichment failed for ${name}:`, error);
        
        // Don't show error toast to avoid interrupting user experience
        // The data will be updated when they next refresh the database tab
    }
}

// Update prospect with enriched data (handled by backend automatically)
async function updateProspectWithEnrichment(name, enrichmentData) {
    console.log(`Enrichment update for ${name} is handled by backend automatically`);
}

// AI enrichment is now handled by the backend automatically
// This function is kept for compatibility but not used
async function performAIEnrichment(companyName, address) {
    console.log(`AI enrichment for ${companyName} is handled by backend automatically`);
    return {};
}

// Display enriched data in dropdown
function displayEnrichedData(enrichmentData, originalAddress) {
    const enrichmentContent = document.getElementById('enrichment-content');
    
    // Check if we have meaningful data
    const hasData = (enrichmentData.vat || enrichmentData.site || enrichmentData.email || 
                    enrichmentData.phone || enrichmentData.directors || 
                    (enrichmentData.registered && enrichmentData.registered !== originalAddress));
    
    if (!hasData) {
        enrichmentContent.innerHTML = `
            <div class="alert alert-info">
                <strong>Limited enrichment data found</strong><br>
                <small>The AI search found minimal additional information for this company.</small>
            </div>
        `;
        return;
    }
    
    enrichmentContent.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                ${enrichmentData.vat ? `<div class="mb-2"><strong>VAT:</strong> ${enrichmentData.vat}</div>` : ''}
                ${enrichmentData.email ? `<div class="mb-2"><strong>Email:</strong> ${enrichmentData.email}</div>` : ''}
                ${enrichmentData.phone ? `<div class="mb-2"><strong>Phone:</strong> ${enrichmentData.phone}</div>` : ''}
            </div>
            <div class="col-md-6">
                ${enrichmentData.site ? `<div class="mb-2"><strong>Website:</strong> <a href="${enrichmentData.site}" target="_blank">${enrichmentData.site}</a></div>` : ''}
                ${enrichmentData.directors ? `<div class="mb-2"><strong>Directors:</strong> ${enrichmentData.directors}</div>` : ''}
                ${enrichmentData.registered && enrichmentData.registered !== originalAddress ? 
                    `<div class="mb-2"><strong>Registered Address:</strong> ${enrichmentData.registered}</div>` : ''}
            </div>
        </div>
        <div class="mt-3">
            <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                This data was automatically enriched using AI web search.
            </small>
        </div>
    `;
}

// Quick save prospect from search results (with background enrichment)
async function quickSaveProspect(name, address, website) {
    const saveBtn = event.target;
    const originalHTML = saveBtn.innerHTML;
    
    try {
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        saveBtn.disabled = true;
        
        // Save prospect with basic information
        await saveProspect(name, address, website, {});
        
        saveBtn.innerHTML = '<i class="fas fa-check"></i>';
        saveBtn.classList.remove('btn-outline-success');
        saveBtn.classList.add('btn-success');
        
        showToast('Prospect saved! AI enrichment in progress...', 'success');
        
        // Start background enrichment (non-blocking)
        performBackgroundEnrichment(name, address, website);
        
    } catch (error) {
        console.error('Error saving prospect:', error);
        saveBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
        saveBtn.classList.remove('btn-outline-success');
        saveBtn.classList.add('btn-danger');
        showToast('Failed to save prospect: ' + error.message, 'error');
    } finally {
        setTimeout(() => {
            saveBtn.innerHTML = originalHTML;
            saveBtn.disabled = false;
            saveBtn.classList.remove('btn-success', 'btn-danger');
            saveBtn.classList.add('btn-outline-success');
        }, 3000);
    }
}

// Legacy function for backward compatibility
function saveProspectFromDetails() {
    const saveBtn = document.getElementById('save-prospect-btn');
    if (!saveBtn) return;
    
    try {
        const companyData = JSON.parse(saveBtn.getAttribute('data-company-data') || '{}');
        saveProspect(companyData.name, companyData.address, companyData.website, companyData.enriched);
    } catch (error) {
        console.error('Error parsing company data:', error);
        showToast('Error saving prospect: Invalid data', 'error');
    }
}

// Save prospect function
async function saveProspect(name, address, website, enrichedData) {
    const saveBtn = document.getElementById('save-prospect-btn');
    const originalText = saveBtn ? saveBtn.innerHTML : '';
    
    try {
        if (saveBtn) {
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
            saveBtn.disabled = true;
        }
        
        // Capture the current search query for tagging
        const searchInput = document.getElementById('prospect-search');
        const searchQuery = searchInput ? searchInput.value.trim() : '';
        
        const prospectData = {
            name: name,
            address: address,
            website: website,
            status: 'new',
            enriched_data: enrichedData || {},
            google_place_id: window.__prospect?.place_id || null,
            search_query: searchQuery,
            created_at: new Date().toISOString()
        };
        
        const response = await fetch('/api/prospects', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(prospectData)
        });
        
        if (response.ok) {
            const result = await response.json();
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-check me-2"></i>Saved!';
                saveBtn.classList.remove('btn-success');
                saveBtn.classList.add('btn-success');
            }
            
            // Show success message
            showToast('Prospect saved successfully!', 'success');
            
            // Refresh prospects if database tab is active
            if (document.querySelector('#database-content').classList.contains('active')) {
                loadProspects();
            }
        } else {
            const error = await response.json();
            if (error.setup_required) {
                throw new Error(`Database setup required: ${error.error}. Please run the fix_rls_policy.sql script in your Supabase SQL editor.`);
            }
            throw new Error(error.error || 'Failed to save prospect');
        }
    } catch (error) {
        console.error('Error saving prospect:', error);
        if (saveBtn) {
            saveBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error';
            saveBtn.classList.remove('btn-success');
            saveBtn.classList.add('btn-danger');
        }
        showToast('Failed to save prospect: ' + error.message, 'error');
    } finally {
        if (saveBtn) {
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                saveBtn.classList.remove('btn-danger');
                saveBtn.classList.add('btn-success');
            }, 3000);
        }
    }
}

// Load prospects from database
async function loadProspects() {
    const container = document.getElementById('prospects-container');
    
    try {
        container.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner"></div>
                <p class="text-muted mt-2">Loading prospects...</p>
            </div>
        `;
        
        const response = await fetch('/api/prospects');
        
        if (response.ok) {
            const data = await response.json();
            displayProspects(data.prospects || []);
        } else {
            const errorData = await response.json();
            if (errorData.setup_required) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-database fa-3x text-warning mb-3"></i>
                        <h5 class="text-warning">Database Setup Required</h5>
                        <p class="text-muted">${errorData.error}</p>
                        <div class="mt-3">
                            <p class="small text-muted">To set up the database:</p>
                            <ol class="text-start small text-muted" style="max-width: 400px; margin: 0 auto;">
                                <li>Go to your Supabase project dashboard</li>
                                <li>Navigate to the SQL Editor</li>
                                <li>Copy and paste the contents of <code>supabase_setup.sql</code></li>
                                <li>Run the SQL script</li>
                                <li>Click "Test Connection" to verify</li>
                            </ol>
                        </div>
                    </div>
                `;
                return;
            }
            throw new Error(errorData.error || 'Failed to load prospects');
        }
    } catch (error) {
        console.error('Error loading prospects:', error);
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <p class="text-danger">Error loading prospects: ${error.message}</p>
                <button class="btn btn-primary" onclick="loadProspects()">Retry</button>
            </div>
        `;
    }
}


// Display prospects in the database tab
function displayProspects(prospects) {
    const container = document.getElementById('prospects-container');
    
    console.log('Displaying prospects:', prospects.length);
    console.log('Prospect statuses:', prospects.map(p => p.status));
    
    
    if (prospects.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <p class="text-muted">No prospects found. Start searching to add some!</p>
            </div>
        `;
        return;
    }
    
    const prospectsHtml = prospects.map(prospect => `
        <div class="prospect-card" data-id="${prospect.id}" data-status="${prospect.status || 'new_leads'}">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="flex-grow-1">
                    <!-- PROMINENT STATUS BADGE with Quick Change - Now at the top -->
                    <div class="mb-2 d-flex align-items-center gap-2">
                        <span class="prospect-status status-${prospect.status || 'new_leads'}">
                            <span class="status-icon">${getStatusIcon(prospect.status || 'new_leads')}</span>
                            ${getStatusDisplay(prospect.status || 'new_leads')}
                        </span>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Change Status">
                                <i class="fas fa-edit"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="updateProspectStatus('${prospect.id}', 'new_leads', event)">üîç New Leads</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateProspectStatus('${prospect.id}', 'visited', event)">üëÅÔ∏è Visited</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateProspectStatus('${prospect.id}', 'first_contact', event)">ü§ù First Contact</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateProspectStatus('${prospect.id}', 'meeting_planned', event)">üìÖ Meeting Planned</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateProspectStatus('${prospect.id}', 'follow_up', event)">‚úçÔ∏è Follow-up</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateProspectStatus('${prospect.id}', 'customer', event)">üå± Customer</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateProspectStatus('${prospect.id}', 'ex_customer', event)">üîô Ex-Customer</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="showContactLaterModal('${prospect.id}'); event.preventDefault();">‚è≥ Contact Later</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showUnqualifiedModal('${prospect.id}'); event.preventDefault();">‚ùå Unqualified</a></li>
                            </ul>
                        </div>
                    </div>

                    <h6 class="mb-1">
                        <span class="clickable-text"
                              onclick="searchCompanyByName('${(prospect.name || 'Unnamed Prospect').replace(/'/g, "\\'")}'"
                              title="Click to search in Companies">${prospect.name || 'Unnamed Prospect'}</span>
                    </h6>
                    <small class="text-muted">${prospect.address || 'No address'}</small>

                    <!-- Tags Section -->
                    <div class="mt-2">
                        ${prospect.tags?.city?.length ? prospect.tags.city.map(city =>
                            `<span class="badge bg-primary me-1 mb-1 rounded-pill" style="font-size: 10px;">
                                <i class="fas fa-map-marker-alt me-1"></i>${city}
                            </span>`
                        ).join('') : ''}
                        ${prospect.tags?.keywords?.length ? prospect.tags.keywords.slice(0, 3).map(keyword =>
                            `<span class="badge bg-info me-1 mb-1 rounded-pill" style="font-size: 10px;">
                                <i class="fas fa-tag me-1"></i>${keyword}
                            </span>`
                        ).join('') : ''}
                        ${prospect.search_query ?
                            `<span class="badge bg-secondary me-1 mb-1 rounded-pill" style="font-size: 9px;" title="Search Query">
                                <i class="fas fa-search me-1"></i>${prospect.search_query.length > 15 ? prospect.search_query.substring(0, 15) + '...' : prospect.search_query}
                            </span>` : ''}
                        
                        <!-- Less prominent status tags -->
                        <div class="mt-1">
                            ${prospect.status === 'contact_later' ? 
                                `<span class="badge bg-light text-dark border me-1 mb-1" style="font-size: 8px; opacity: 0.7;" title="Contact Later">
                                    <i class="fas fa-clock me-1"></i>Contact Later
                                </span>` : ''}
                            ${prospect.status === 'unqualified' ? 
                                `<span class="badge bg-light text-dark border me-1 mb-1" style="font-size: 8px; opacity: 0.7;" title="Unqualified">
                                    <i class="fas fa-times me-1"></i>Unqualified
                                </span>` : ''}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row g-3 mt-2">
                <div class="col-md-6">
                    ${prospect.enriched_data?.vat ? `<div class="d-flex align-items-center justify-content-between mb-2">
                        <span><strong>VAT:</strong> 
                            <span class="clickable-text" 
                                  onclick="searchCompanyByVat('${prospect.enriched_data.vat}')" 
                                  title="Click to search in Companies">${prospect.enriched_data.vat}</span>
                        </span>
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="searchCompanyByVat('${prospect.enriched_data.vat}')" 
                                title="Search VAT in Companies">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>` : ''}
                    ${prospect.enriched_data?.email ? `<div><strong>Email:</strong> ${prospect.enriched_data.email}</div>` : ''}
                    ${prospect.enriched_data?.phone ? `<div><strong>Phone:</strong> ${prospect.enriched_data.phone}</div>` : ''}
                </div>
                <div class="col-md-6">
                    ${prospect.website ? `<div><strong>Website:</strong> <a href="${prospect.website}" target="_blank">${prospect.website}</a></div>` : ''}
                    ${prospect.enriched_data?.directors ? `<div><strong>Directors:</strong> ${
                        Array.isArray(prospect.enriched_data.directors) 
                            ? prospect.enriched_data.directors.map(director => 
                                director && typeof director === 'string' 
                                    ? `<span class="director-link text-primary text-decoration-underline" 
                                          style="cursor: pointer;" 
                                          onclick="searchDirectorInCrm('${director.replace(/'/g, "\\'")}')" 
                                          title="Search in CRM">${director}</span>`
                                    : `<span>${director || 'Unknown'}</span>`
                              ).join(', ')
                            : prospect.enriched_data.directors && typeof prospect.enriched_data.directors === 'string'
                                ? `<span class="director-link text-primary text-decoration-underline" 
                                         style="cursor: pointer;" 
                                         onclick="searchDirectorInCrm('${prospect.enriched_data.directors.replace(/'/g, "\\'")}')" 
                                         title="Search in CRM">${prospect.enriched_data.directors}</span>`
                                : `<span>${prospect.enriched_data.directors || 'Unknown'}</span>`
                    }</div>` : ''}
                    <div class="small text-muted mt-2">Added: ${new Date(prospect.created_at).toLocaleDateString()}</div>
                </div>
            </div>
            
            ${(() => {
                const status = prospect.enrichment_status || 'pending';
                const hasEnrichedData = prospect.enriched_data && Object.keys(prospect.enriched_data).length > 0 && 
                    Object.values(prospect.enriched_data).some(v => {
                        if (!v) return false;
                        if (typeof v === 'string') return v.trim() && v !== 'empty';
                        if (Array.isArray(v)) return v.length > 0;
                        return true;
                    });
                
                switch(status) {
                    case 'completed':
                        return `<div class="mt-2">
                            <small class="text-success">
                                <i class="fas fa-check-circle me-1"></i>AI enriched
                            </small>
                        </div>`;
                    case 'in_progress':
                        return `<div class="mt-2">
                            <small class="text-info">
                                <i class="fas fa-spinner fa-spin me-1"></i>AI enrichment in progress...
                            </small>
                        </div>`;
                    case 'no_data':
                        return `<div class="mt-2">
                            <small class="text-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i>No data found
                            </small>
                        </div>`;
                    case 'failed':
                        return `<div class="mt-2">
                            <small class="text-danger">
                                <i class="fas fa-times-circle me-1"></i>Enrichment failed
                            </small>
                        </div>`;
                    case 'pending':
                    default:
                        return `<div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>Pending enrichment
                            </small>
                        </div>`;
                }
            })()}
            
            <div class="notes-section">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted fw-semibold">
                        <i class="fas fa-sticky-note me-1"></i>Notes
                    </small>
                    <button class="btn btn-sm btn-outline-secondary rounded-pill" 
                            onclick="toggleNotes('${prospect.id}')" 
                            style="font-size: 11px; padding: 2px 8px;">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                <div class="notes-display" id="notes-display-${prospect.id}">
                    ${prospect.notes ? `<div class="text-muted small">${prospect.notes}</div>` : '<div class="text-muted small fst-italic">No notes yet...</div>'}
                </div>
                <div class="notes-edit d-none" id="notes-edit-${prospect.id}">
                    <textarea class="notes-textarea form-control" 
                              placeholder="Add your notes here..."
                              id="notes-textarea-${prospect.id}">${prospect.notes || ''}</textarea>
                    <div class="mt-2 d-flex gap-2">
                        <button class="btn btn-sm btn-primary rounded-pill" onclick="saveNotes('${prospect.id}')">
                            <i class="fas fa-save me-1"></i>Save
                        </button>
                        <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="cancelNotes('${prospect.id}')">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card-actions">
                ${generateStatusActions(prospect)}
                <button class="btn btn-outline-danger rounded-pill" onclick="deleteProspect('${prospect.id}')">
                    <i class="fas fa-trash me-1"></i>Delete
                </button>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = prospectsHtml;
    
    // Update filter dropdowns with available tags
    updateFilterDropdowns(prospects);
}

// Update filter dropdowns based on available prospects
function updateFilterDropdowns(prospects) {
    const cityFilter = document.getElementById('city-filter');
    const keywordFilter = document.getElementById('keyword-filter');
    
    if (!cityFilter || !keywordFilter) return;
    
    // Collect all unique cities and keywords
    const cities = new Set();
    const keywords = new Set();
    
    prospects.forEach(prospect => {
        if (prospect.tags?.city) {
            prospect.tags.city.forEach(city => cities.add(city));
        }
        if (prospect.tags?.keywords) {
            prospect.tags.keywords.forEach(keyword => keywords.add(keyword));
        }
    });
    
    // Update city filter
    const currentCityValue = cityFilter.value;
    cityFilter.innerHTML = '<option value="">All Cities</option>';
    [...cities].sort().forEach(city => {
        const option = document.createElement('option');
        option.value = city;
        option.textContent = city;
        if (city === currentCityValue) option.selected = true;
        cityFilter.appendChild(option);
    });
    
    // Update keyword filter
    const currentKeywordValue = keywordFilter.value;
    keywordFilter.innerHTML = '<option value="">All Keywords</option>';
    [...keywords].sort().forEach(keyword => {
        const option = document.createElement('option');
        option.value = keyword;
        option.textContent = keyword;
        if (keyword === currentKeywordValue) option.selected = true;
        keywordFilter.appendChild(option);
    });
}

// Update prospect status

// Delete prospect
async function deleteProspect(prospectId) {
    if (!confirm('Are you sure you want to delete this prospect?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/prospects/${prospectId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showToast('Prospect deleted successfully', 'success');
            loadProspects(); // Refresh the list
        } else {
            throw new Error('Failed to delete prospect');
        }
    } catch (error) {
        console.error('Error deleting prospect:', error);
        showToast('Failed to delete prospect', 'error');
    }
}

// Auto-refresh variables
// Auto-refresh removed to prevent continuous polling and improve performance

// Refresh prospects
function refreshProspects() {
    loadProspects();
}

// Retry failed enrichments
async function retryFailedEnrichments() {
    const retryBtn = event.target;
    const originalText = retryBtn.innerHTML;
    
    try {
        retryBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Retrying...';
        retryBtn.disabled = true;
        
        // Get all prospects
        const response = await fetch('/api/prospects');
        if (!response.ok) throw new Error('Failed to fetch prospects');
        
        const data = await response.json();
        const prospects = data.prospects || [];
        
        // Find prospects that need enrichment
        const needsEnrichment = prospects.filter(p => 
            !p.enriched_data || 
            Object.keys(p.enriched_data).length === 0 ||
            p.enriched_data.enrichment_failed
        );
        
        if (needsEnrichment.length === 0) {
            showToast('No prospects need enrichment!', 'info');
            return;
        }
        
        showToast(`Retrying enrichment for ${needsEnrichment.length} prospects...`, 'info');
        
        // For prospects that need enrichment, we need to trigger backend enrichment
        // Since we can't directly call the backend enrichment, we'll show a message
        showToast(`Found ${needsEnrichment.length} prospects needing enrichment. Backend enrichment runs automatically.`, 'info');
        
        // Refresh the list to see current status
        loadProspects();
        
        // Refresh the list after a delay
        setTimeout(() => {
            loadProspects();
        }, 5000);
        
    } catch (error) {
        console.error('Error retrying enrichments:', error);
        showToast('Failed to retry enrichments: ' + error.message, 'error');
    } finally {
        retryBtn.innerHTML = originalText;
        retryBtn.disabled = false;
    }
}

// Notes functionality
function toggleNotes(prospectId) {
    const displayDiv = document.getElementById(`notes-display-${prospectId}`);
    const editDiv = document.getElementById(`notes-edit-${prospectId}`);
    
    displayDiv.classList.toggle('d-none');
    editDiv.classList.toggle('d-none');
    
    if (!editDiv.classList.contains('d-none')) {
        // Focus on textarea when editing
        const textarea = document.getElementById(`notes-textarea-${prospectId}`);
        setTimeout(() => textarea.focus(), 100);
    }
}

async function saveNotes(prospectId) {
    const textarea = document.getElementById(`notes-textarea-${prospectId}`);
    const notes = textarea.value.trim();
    
    try {
        const response = await fetch(`/api/prospects/${prospectId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ notes: notes })
        });
        
        if (response.ok) {
            // Update the display
            const displayDiv = document.getElementById(`notes-display-${prospectId}`);
            displayDiv.innerHTML = notes ? 
                `<div class="text-muted small">${notes}</div>` : 
                '<div class="text-muted small fst-italic">No notes yet...</div>';
            
            // Hide edit mode
            toggleNotes(prospectId);
            
            showToast('Notes saved successfully!', 'success');
        } else {
            throw new Error('Failed to save notes');
        }
    } catch (error) {
        console.error('Error saving notes:', error);
        showToast('Failed to save notes', 'error');
    }
}

function cancelNotes(prospectId) {
    // Reset textarea to original value
    const textarea = document.getElementById(`notes-textarea-${prospectId}`);
    const displayDiv = document.getElementById(`notes-display-${prospectId}`);
    const currentNotes = displayDiv.querySelector('.text-muted')?.textContent;
    
    if (currentNotes && currentNotes !== 'No notes yet...') {
        textarea.value = currentNotes;
    } else {
        textarea.value = '';
    }
    
    toggleNotes(prospectId);
}

// Filter prospects (client-side filtering)
document.addEventListener('DOMContentLoaded', function() {
    const filterInput = document.getElementById('prospect-filter');
    const statusFilter = document.getElementById('status-filter');
    
    if (filterInput) {
        filterInput.addEventListener('input', filterProspects);
    }
    
    if (statusFilter) {
        statusFilter.addEventListener('change', filterProspects);
    }
    
    const cityFilter = document.getElementById('city-filter');
    if (cityFilter) {
        cityFilter.addEventListener('change', filterProspects);
    }
    
    const keywordFilter = document.getElementById('keyword-filter');
    if (keywordFilter) {
        keywordFilter.addEventListener('change', filterProspects);
    }
    
    const regionFilter = document.getElementById('region-filter');
    if (regionFilter) {
        regionFilter.addEventListener('change', filterProspects);
    }
    
    const prospectTypeFilter = document.getElementById('prospect-type-filter');
    if (prospectTypeFilter) {
        prospectTypeFilter.addEventListener('change', filterProspects);
    }
    

});

function filterProspects() {
    const filterText = document.getElementById('prospect-filter')?.value.toLowerCase() || '';
    const statusFilter = document.getElementById('status-filter')?.value || '';
    const cityFilter = document.getElementById('city-filter')?.value || '';
    const keywordFilter = document.getElementById('keyword-filter')?.value || '';
    const regionFilter = document.getElementById('region-filter')?.value || '';
    const prospectTypeFilter = document.getElementById('prospect-type-filter')?.value || '';
    const prospects = document.querySelectorAll('.prospect-card');
    
    prospects.forEach(card => {
        const name = card.querySelector('h6')?.textContent.toLowerCase() || '';
        const address = card.querySelector('.text-muted')?.textContent.toLowerCase() || '';
        // Use data attribute instead of parsing text
        const status = card.getAttribute('data-status') || '';
        
        // Debug: log what we're matching
        if (statusFilter === 'new_leads') {
            console.log('Card data-status:', status);
            console.log('Looking for:', statusFilter);
            console.log('Match:', status === statusFilter);
        }
        
        // Get tag badges for city and keyword filtering
        const cityBadges = card.querySelectorAll('.badge.bg-primary');
        const keywordBadges = card.querySelectorAll('.badge.bg-info');
        
        const cities = Array.from(cityBadges).map(badge => badge.textContent.replace('üìç', '').trim());
        const keywords = Array.from(keywordBadges).map(badge => badge.textContent.replace('üè∑Ô∏è', '').trim());
        
        const matchesText = name.includes(filterText) || address.includes(filterText);
        const matchesStatus = !statusFilter || status === statusFilter;
        const matchesCity = !cityFilter || cities.some(city => city.includes(cityFilter));
        const matchesKeyword = !keywordFilter || keywords.some(keyword => keyword.includes(keywordFilter));
        
        // For region and prospect type, we'd need to add these to the card data attributes
        // For now, we'll implement basic matching
        const matchesRegion = !regionFilter; // TODO: implement region matching when data is available
        const matchesType = !prospectTypeFilter; // TODO: implement type matching when data is available
        
        card.style.display = matchesText && matchesStatus && matchesCity && matchesKeyword && matchesRegion && matchesType ? 'block' : 'none';
    });
    
    // Update visible count
    const visibleCount = document.querySelectorAll('.prospect-card[style*="block"], .prospect-card:not([style*="none"])').length;
    const totalCount = prospects.length;
    
    // Show filter summary if any filters are active
    const hasActiveFilters = filterText || statusFilter || cityFilter || keywordFilter || regionFilter || prospectTypeFilter;
    if (hasActiveFilters) {
        showFilterSummary(visibleCount, totalCount, {
            text: filterText,
            status: statusFilter,
            city: cityFilter,
            keyword: keywordFilter,
            region: regionFilter,
            type: prospectTypeFilter
        });
    }
}

// Clear all filters
function clearAllFilters() {
    document.getElementById('prospect-filter').value = '';
    document.getElementById('status-filter').value = '';
    document.getElementById('city-filter').value = '';
    document.getElementById('keyword-filter').value = '';
    document.getElementById('region-filter').value = '';
    document.getElementById('prospect-type-filter').value = '';
    filterProspects();
    hideFilterSummary();
}

// Show filter summary
function showFilterSummary(visible, total, filters) {
    let existingSummary = document.getElementById('filter-summary');
    if (existingSummary) {
        existingSummary.remove();
    }
    
    const activeFilters = [];
    if (filters.text) activeFilters.push(`Text: "${filters.text}"`);
    if (filters.status) activeFilters.push(`Status: ${filters.status}`);
    if (filters.city) activeFilters.push(`City: ${filters.city}`);
    if (filters.keyword) activeFilters.push(`Keyword: ${filters.keyword}`);
    if (filters.region) activeFilters.push(`Region: ${filters.region}`);
    if (filters.type) activeFilters.push(`Type: ${filters.type}`);
    
    const summary = document.createElement('div');
    summary.id = 'filter-summary';
    summary.className = 'alert alert-info alert-dismissible fade show mb-3';
    summary.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-filter me-2"></i>
            <span>Showing ${visible} of ${total} prospects</span>
            <span class="ms-2 text-muted">‚Ä¢ Filters: ${activeFilters.join(', ')}</span>
            <button type="button" class="btn-close ms-auto" onclick="hideFilterSummary(); clearAllFilters();"></button>
        </div>
    `;
    
    const container = document.getElementById('prospects-container');
    container.insertBefore(summary, container.firstChild);
}

// Hide filter summary
function hideFilterSummary() {
    const summary = document.getElementById('filter-summary');
    if (summary) {
        summary.remove();
    }
}

// Toast notification function
function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 5000);
}

// Fallback if Google Maps fails to load
window.setTimeout(function() {
    if (typeof google === 'undefined') {
        console.error('Google Maps API failed to load');
        const mapElement = document.getElementById('map');
        if (mapElement && mapElement.innerHTML.includes('Loading Google Maps')) {
            mapElement.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                    <p class="text-muted">Google Maps API failed to load</p>
                    <p class="small text-muted">Please check your API key configuration</p>
                </div>
            `;
        }
    }
}, 10000); // 10 second timeout

// Enhanced Pipeline Functions

// Status display mapping with icons
function getStatusDisplay(status) {
    const statusMap = {
        'new_leads': 'New Leads',
        'visited': 'Visited',
        'first_contact': 'First Contact',
        'meeting_planned': 'Meeting Planned',
        'follow_up': 'Follow-up',
        'customer': 'Customer',
        'ex_customer': 'Ex-Customer',
        'contact_later': 'Contact Later',
        'unqualified': 'Unqualified'
    };
    return statusMap[status] || status;
}

// Status icon mapping
function getStatusIcon(status) {
    const iconMap = {
        'new_leads': 'üîç',
        'visited': 'üëÅÔ∏è',
        'first_contact': 'ü§ù',
        'meeting_planned': 'üìÖ',
        'follow_up': '‚úçÔ∏è',
        'customer': 'üå±',
        'ex_customer': 'üîô',
        'contact_later': '‚è≥',
        'unqualified': '‚ùå'
    };
    return iconMap[status] || '‚ùì';
}

// Generate appropriate action buttons based on current status
function generateStatusActions(prospect) {
    const currentStatus = prospect.status || 'new_leads';
    let actions = [];
    
    switch(currentStatus) {
        case 'new_leads':
            actions = [
                `<button class="btn btn-outline-primary rounded-pill" onclick="updateProspectStatus('${prospect.id}', 'first_contact')">
                    ü§ù First Contact
                </button>`,
                `<button class="btn btn-outline-warning rounded-pill" onclick="showContactLaterModal('${prospect.id}')">
                    ‚è≥ Contact Later
                </button>`,
                `<button class="btn btn-outline-secondary rounded-pill" onclick="showUnqualifiedModal('${prospect.id}')">
                    ‚ùå Unqualified
                </button>`
            ];
            break;
        case 'first_contact':
            actions = [
                `<button class="btn btn-outline-success rounded-pill" onclick="updateProspectStatus('${prospect.id}', 'meeting_planned')">
                    üìÖ Schedule Meeting
                </button>`,
                `<button class="btn btn-outline-info rounded-pill" onclick="updateProspectStatus('${prospect.id}', 'follow_up')">
                    ‚úçÔ∏è Follow-up
                </button>`,
                `<button class="btn btn-outline-warning rounded-pill" onclick="showContactLaterModal('${prospect.id}')">
                    ‚è≥ Contact Later
                </button>`
            ];
            break;
        case 'meeting_planned':
            actions = [
                `<button class="btn btn-outline-info rounded-pill" onclick="updateProspectStatus('${prospect.id}', 'follow_up')">
                    ‚úçÔ∏è Follow-up
                </button>`,
                `<button class="btn btn-outline-success rounded-pill" onclick="updateProspectStatus('${prospect.id}', 'customer')">
                    üå± Convert to Customer
                </button>`
            ];
            break;
        case 'follow_up':
            actions = [
                `<button class="btn btn-outline-success rounded-pill" onclick="updateProspectStatus('${prospect.id}', 'customer')">
                    üå± Convert to Customer
                </button>`,
                `<button class="btn btn-outline-primary rounded-pill" onclick="updateProspectStatus('${prospect.id}', 'first_contact')">
                    ü§ù More Contact Needed
                </button>`
            ];
            break;
        case 'customer':
            actions = [
                `<button class="btn btn-outline-danger rounded-pill" onclick="updateProspectStatus('${prospect.id}', 'ex_customer')">
                    üîô Mark as Ex-Customer
                </button>`
            ];
            break;
        case 'ex_customer':
            actions = [
                `<button class="btn btn-outline-success rounded-pill" onclick="updateProspectStatus('${prospect.id}', 'customer')">
                    üå± Reactivate
                </button>`,
                `<button class="btn btn-outline-primary rounded-pill" onclick="updateProspectStatus('${prospect.id}', 'first_contact')">
                    ü§ù Re-contact
                </button>`
            ];
            break;
        case 'contact_later':
            actions = [
                `<button class="btn btn-outline-primary rounded-pill" onclick="updateProspectStatus('${prospect.id}', 'first_contact')">
                    ü§ù Contact Now
                </button>`,
                `<button class="btn btn-outline-info rounded-pill" onclick="showContactLaterModal('${prospect.id}')">
                    ‚è≥ Reschedule
                </button>`
            ];
            break;
        case 'unqualified':
            actions = [
                `<button class="btn btn-outline-primary rounded-pill" onclick="updateProspectStatus('${prospect.id}', 'new_leads')">
                    üîç Requalify
                </button>`
            ];
            break;
        default:
            actions = [
                `<button class="btn btn-outline-primary rounded-pill" onclick="updateProspectStatus('${prospect.id}', 'first_contact')">
                    ü§ù Contact
                </button>`
            ];
    }
    
    return actions.join('');
}

// Load pipeline statistics
async function loadPipelineStats() {
    try {
        console.log('Loading pipeline stats...');
        const response = await fetch('/api/prospects/pipeline-stats');
        console.log('Pipeline stats response:', response.status);

        if (response.ok) {
            const data = await response.json();
            console.log('Pipeline stats data:', data);
            updatePipelineDisplay(data.stats);
        } else {
            const errorText = await response.text();
            console.error('Failed to load pipeline stats:', response.status, errorText);
        }
    } catch (error) {
        console.error('Error loading pipeline stats:', error);
    }
}

// Update pipeline display with current stats
function updatePipelineDisplay(stats) {
    console.log('Updating pipeline display with stats:', stats);
    const stages = ['new_leads', 'visited', 'first_contact', 'meeting_planned', 'follow_up', 'customer', 'ex_customer', 'contact_later', 'unqualified'];

    stages.forEach(stage => {
        const countElement = document.getElementById(`count-${stage}`);
        if (countElement) {
            const stageStats = stats[stage] || { count: 0, percentage: 0 };
            console.log(`Setting ${stage}: ${stageStats.count}`);
            countElement.textContent = stageStats.count;
            countElement.parentElement.title = `${stageStats.count} prospects (${stageStats.percentage}%)`;
        } else {
            console.warn(`Element count-${stage} not found`);
        }
    });
}


// Refresh pipeline stats
function refreshPipelineStats() {
    loadPipelineStats();
}

// Filter prospects by status (from pipeline overview)
function filterByStatus(status) {
    const statusFilter = document.getElementById('status-filter');
    if (statusFilter) {
        statusFilter.value = status;
        filterProspects();
    }
}

// Show contact later modal
function showContactLaterModal(prospectId) {
    const modalHtml = `
        <div class="modal fade" id="contactLaterModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">‚è≥ Schedule Contact Later</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Contact Date</label>
                            <input type="date" class="form-control" id="contactLaterDate" min="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Reason / Notes</label>
                            <select class="form-select" id="contactLaterReason">
                                <option value="">Select a reason...</option>
                                <option value="Seasonal business">Seasonal business</option>
                                <option value="Budget constraints">Budget constraints</option>
                                <option value="Currently satisfied with supplier">Currently satisfied with supplier</option>
                                <option value="Expansion planned">Expansion planned</option>
                                <option value="Contract renewal period">Contract renewal period</option>
                                <option value="Management change expected">Management change expected</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Additional Notes</label>
                            <textarea class="form-control" id="contactLaterNotes" rows="3" placeholder="Any additional details..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Suggested contact timeframe</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="timeframe" id="timeframe2" value="2">
                                <label class="btn btn-outline-primary" for="timeframe2">2 months</label>
                                
                                <input type="radio" class="btn-check" name="timeframe" id="timeframe3" value="3" checked>
                                <label class="btn btn-outline-primary" for="timeframe3">3 months</label>
                                
                                <input type="radio" class="btn-check" name="timeframe" id="timeframe6" value="6">
                                <label class="btn btn-outline-primary" for="timeframe6">6 months</label>
                                
                                <input type="radio" class="btn-check" name="timeframe" id="timeframe12" value="12">
                                <label class="btn btn-outline-primary" for="timeframe12">12 months</label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-warning" onclick="saveContactLater('${prospectId}')">
                            <i class="fas fa-clock me-1"></i>Schedule Contact
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('contactLaterModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Set default date based on selected timeframe
    const updateDate = () => {
        const selectedTimeframe = document.querySelector('input[name="timeframe"]:checked')?.value || 3;
        const futureDate = new Date();
        futureDate.setMonth(futureDate.getMonth() + parseInt(selectedTimeframe));
        document.getElementById('contactLaterDate').value = futureDate.toISOString().split('T')[0];
    };
    
    // Update date when timeframe changes
    document.querySelectorAll('input[name="timeframe"]').forEach(radio => {
        radio.addEventListener('change', updateDate);
    });
    
    // Set initial date
    updateDate();
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('contactLaterModal'));
    modal.show();
}

// Save contact later
async function saveContactLater(prospectId) {
    const date = document.getElementById('contactLaterDate').value;
    const reason = document.getElementById('contactLaterReason').value;
    const notes = document.getElementById('contactLaterNotes').value;
    
    if (!date) {
        alert('Please select a contact date');
        return;
    }
    
    try {
        const response = await fetch(`/api/prospects/${prospectId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status: 'contact_later',
                contact_later_date: date,
                contact_later_reason: reason + (notes ? ' - ' + notes : ''),
                last_contact_date: new Date().toISOString().split('T')[0]
            })
        });
        
        if (response.ok) {
            showToast('‚è≥ Contact later scheduled successfully with automatic task created', 'success');
            bootstrap.Modal.getInstance(document.getElementById('contactLaterModal')).hide();
            loadProspects();
            loadPipelineStats();
            
            // Show notification about task creation
            setTimeout(() => {
                showToast('üìã Follow-up task automatically created in Tasks tab', 'info');
            }, 2000);
        } else {
            throw new Error('Failed to schedule contact');
        }
    } catch (error) {
        console.error('Error scheduling contact:', error);
        showToast('Failed to schedule contact: ' + error.message, 'error');
    }
}

// Show unqualified modal
function showUnqualifiedModal(prospectId) {
    // Load unqualified reasons first
    fetch('/api/unqualified-reasons')
        .then(response => response.json())
        .then(data => {
            const reasons = data.reasons || [];
            const reasonOptions = reasons.map(reason => 
                `<option value="${reason.reason_code}">${reason.reason_text}</option>`
            ).join('');
            
            const modalHtml = `
                <div class="modal fade" id="unqualifiedModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">‚ùå Mark as Unqualified</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">Why is this prospect unqualified?</label>
                                    <select class="form-select" id="unqualifiedReason" required>
                                        <option value="">Select a reason...</option>
                                        ${reasonOptions}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Additional Details</label>
                                    <textarea class="form-control" id="unqualifiedDetails" rows="3" placeholder="Provide more context about why this prospect is not suitable..."></textarea>
                                </div>
                                <div class="alert alert-info">
                                    <small>
                                        <i class="fas fa-info-circle me-1"></i>
                                        This information helps improve future prospecting efforts.
                                    </small>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" onclick="saveUnqualified('${prospectId}')">
                                    <i class="fas fa-times me-1"></i>Mark Unqualified
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('unqualifiedModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('unqualifiedModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error loading unqualified reasons:', error);
            showToast('Failed to load unqualified reasons', 'error');
        });
}

// Save unqualified
async function saveUnqualified(prospectId) {
    const reason = document.getElementById('unqualifiedReason').value;
    const details = document.getElementById('unqualifiedDetails').value;
    
    if (!reason) {
        alert('Please select a reason for marking as unqualified');
        return;
    }
    
    try {
        const response = await fetch(`/api/prospects/${prospectId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status: 'unqualified',
                unqualified_reason: reason,
                unqualified_details: details,
                last_contact_date: new Date().toISOString().split('T')[0]
            })
        });
        
        if (response.ok) {
            showToast('Prospect marked as unqualified', 'success');
            bootstrap.Modal.getInstance(document.getElementById('unqualifiedModal')).hide();
            loadProspects();
            loadPipelineStats();
        } else {
            throw new Error('Failed to mark as unqualified');
        }
    } catch (error) {
        console.error('Error marking as unqualified:', error);
        showToast('Failed to mark as unqualified: ' + error.message, 'error');
    }
}

// Update a specific prospect card's status without refreshing the entire list
function updateProspectCardStatus(prospectId, newStatus) {
    const prospectCard = document.querySelector(`[data-id="${prospectId}"]`);
    if (!prospectCard) {
        console.warn('Prospect card not found:', prospectId);
        return;
    }
    
    // Update the data-status attribute
    prospectCard.setAttribute('data-status', newStatus);
    
    // Find and update the status badge
    const statusBadge = prospectCard.querySelector('.prospect-status');
    if (statusBadge) {
        // Update the status badge classes
        statusBadge.className = `prospect-status status-${newStatus}`;
        
        // Update the icon and text
        const statusIcon = statusBadge.querySelector('.status-icon');
        const statusText = statusBadge.querySelector('.status-text') || statusBadge.childNodes[statusBadge.childNodes.length - 1];
        
        if (statusIcon) {
            statusIcon.textContent = getStatusIcon(newStatus);
        }
        
        // Update the text content (remove icon first, then add new text)
        const textContent = statusBadge.textContent.replace(/^[^\w\s]+\s*/, ''); // Remove existing icon
        statusBadge.innerHTML = `<span class="status-icon">${getStatusIcon(newStatus)}</span> ${getStatusDisplay(newStatus)}`;
    }
    
    // Update the dropdown selection to reflect the new status
    const dropdown = prospectCard.querySelector('.dropdown-menu');
    if (dropdown) {
        const dropdownItems = dropdown.querySelectorAll('.dropdown-item');
        dropdownItems.forEach(item => {
            item.classList.remove('active'); // Remove any existing active states
        });
        
        // Mark the new status as active (optional visual feedback)
        const newActiveItem = dropdown.querySelector(`[onclick*="'${newStatus}'"]`);
        if (newActiveItem) {
            newActiveItem.classList.add('active');
        }
    }
    
    console.log(`Updated prospect card ${prospectId} to status: ${newStatus}`);
    
    // Also update the prospect in the allProspects array to keep data in sync
    if (typeof allProspects !== 'undefined' && allProspects) {
        const prospectIndex = allProspects.findIndex(p => p.id === prospectId);
        if (prospectIndex !== -1) {
            allProspects[prospectIndex].status = newStatus;
            console.log(`Updated allProspects array for prospect ${prospectId}`);
        }
    }
}

// Enhanced update prospect status function
async function updateProspectStatus(prospectId, newStatus, event) {
    // Prevent dropdown from closing if called from dropdown
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    try {
        const updateData = {
            status: newStatus
        };
        
        console.log('Updating prospect:', prospectId, 'to status:', newStatus);
        
        const response = await fetch(`/api/prospects/${prospectId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'  // Add this header to indicate AJAX request
            },
            credentials: 'same-origin',  // Include cookies/session
            body: JSON.stringify(updateData)
        });
        
        if (response.ok) {
            showToast(`${getStatusIcon(newStatus)} Status updated to ${getStatusDisplay(newStatus)}`, 'success');
            
            // Show automated task notification for certain status changes
            if (newStatus === 'visited' || newStatus === 'first_contact') {
                setTimeout(() => {
                    showToast('ü§ñ Automated follow-up tasks created: Send email, Check reply, Call', 'info');
                }, 1500);
            } else if (newStatus === 'customer') {
                setTimeout(() => {
                    showToast('ü§ñ Customer success tasks scheduled: 1-month, 3-month, and 6-month check-ins. <a href="/tasks" class="text-white"><u>View in Tasks Calendar</u></a>', 'info');
                }, 1500);
                
                // Debug: Check if tasks were actually created
                setTimeout(() => {
                    console.log(`üîç Debug: Check tasks for prospect ${prospectId} at: /api/tasks/debug/${prospectId}`);
                }, 2000);
            }
            
            // Update the specific prospect card without refreshing the entire list
            updateProspectCardStatus(prospectId, newStatus);
            
            // Only refresh pipeline stats
            loadPipelineStats();
        } else {
            const errorText = await response.text();
            console.error('API Error:', response.status, errorText);
            throw new Error(`Failed to update prospect status: ${response.status} - ${errorText}`);
        }
    } catch (error) {
        console.error('Error updating prospect:', error);
        showToast('Failed to update prospect status', 'error');
    }
}

// No action buttons; user triggers search with Enter, clicks list items or markers
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initMap" onerror="handleMapError()"></script>
<script>
function handleMapError() {
    console.error('Google Maps script failed to load');
    const mapElement = document.getElementById('map');
    if (mapElement) {
        mapElement.innerHTML = `
            <div class="text-center">
                <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                <p class="text-muted">Google Maps script failed to load</p>
                <p class="small text-muted">Please check your internet connection and API key</p>
            </div>
        `;
    }
}



// Search company by VAT number
async function searchCompanyByVat(vatNumber) {
    try {
        // Navigate to the Companies page with VAT search parameter
        const companiesUrl = `/companies?search=${encodeURIComponent(vatNumber)}`;
        window.location.href = companiesUrl;
        
        showToast(`Navigating to Companies page to search for VAT ${vatNumber}`, 'info');
    } catch (error) {
        console.error('Error searching company by VAT:', error);
        showToast('Failed to search company: ' + error.message, 'error');
    }
}

// Search company by name
async function searchCompanyByName(companyName) {
    try {
        // Navigate to the Companies page with company name search parameter
        const companiesUrl = `/companies?search=${encodeURIComponent(companyName)}`;
        window.location.href = companiesUrl;
        
        showToast(`Navigating to Companies page to search for "${companyName}"`, 'info');
    } catch (error) {
        console.error('Error searching company by name:', error);
        showToast('Failed to search company: ' + error.message, 'error');
    }
}

// Search director in CRM
async function searchDirectorInCrm(directorName) {
    try {
        // Navigate to the CRM page with director search parameter
        const crmUrl = `/crm?search=${encodeURIComponent(directorName)}`;
        window.location.href = crmUrl;
        
        showToast(`Navigating to CRM to search for "${directorName}"`, 'info');
    } catch (error) {
        console.error('Error searching director in CRM:', error);
        showToast('Failed to search director: ' + error.message, 'error');
    }
}

// Show add company modal (placeholder)
function showAddCompanyModal() {
    showToast('Add Company functionality coming soon!', 'info');
}



</script>
{% endblock %}


