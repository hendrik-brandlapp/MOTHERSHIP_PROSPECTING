{% extends 'base.html' %}

{% block title %}Prospecting · DOUANO{% endblock %}

{% block extra_head %}
<style>
    #map {
        width: 100%;
        height: 680px;
        border-radius: 16px;
    }
    .gm-style .gm-style-iw-c {
        border-radius: 10px !important;
    }
    .list-group-item small { color: #64748b; }
    .results-scroll { max-height: 600px; overflow: auto; }
    .result-item { cursor: pointer; }
    .result-item:hover { background: #f8fafc; }
    .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .photo-grid img { width: 100%; height: 110px; object-fit: cover; border-radius: 8px; }
    .loading-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.75); display: none; align-items: center; justify-content: center; z-index: 5; border-radius: 12px; }
    .loading-overlay.show { display: flex; }
    .spinner { width: 28px; height: 28px; border: 3px solid #d1d5db; border-top-color: #111827; border-radius: 50%; animation: spin .9s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .prospect-card { 
        border: 1px solid #e5e7eb; 
        border-radius: 8px; 
        padding: 16px; 
        margin-bottom: 16px; 
        background: #fff;
    }
    .prospect-card:hover { 
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
        transform: translateY(-2px); 
        transition: all 0.2s ease;
    }
    .prospect-status { 
        font-size: 12px; 
        padding: 4px 8px; 
        border-radius: 4px; 
        font-weight: 500;
    }
    .status-new { background: #dbeafe; color: #1e40af; }
    .status-contacted { background: #fef3c7; color: #d97706; }
    .status-qualified { background: #d1fae5; color: #065f46; }
    .status-converted { background: #ecfdf5; color: #047857; }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }
    .nav-tabs .nav-link.active { background-color: #fff; border-color: #dee2e6 #dee2e6 #fff; }
    .enrichment-dropdown { 
        border-top: 1px solid #e9ecef; 
        margin-top: 1rem; 
        padding-top: 1rem; 
    }
    .prospect-detail-header h5 { 
        color: #495057; 
        font-weight: 600; 
    }
    @media (max-width: 992px) {
        #map { height: 420px; }
        .results-scroll { max-height: 360px; }
    }
    
    /* Enhanced UI Improvements */
    .btn {
        border-radius: 12px !important;
        font-weight: 500;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }
    
    .btn:hover::before {
        left: 100%;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .prospect-card {
        border-radius: 16px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        border: 1px solid #f1f5f9 !important;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
        background: rgba(255,255,255,0.9);
        backdrop-filter: blur(10px);
    }
    
    .prospect-card:hover {
        box-shadow: 0 12px 40px rgba(0,0,0,0.1) !important;
        transform: translateY(-4px) !important;
        border-color: #e2e8f0 !important;
    }
    
    .notes-section {
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border-radius: 12px;
        padding: 16px;
        margin-top: 16px;
        border: 1px solid #e2e8f0;
    }
    
    .notes-textarea {
        border: none;
        background: transparent;
        resize: vertical;
        min-height: 80px;
        font-size: 14px;
        line-height: 1.5;
        width: 100%;
    }
    
    .notes-textarea:focus {
        outline: none;
        box-shadow: none;
    }
    
    .form-control, .form-select {
        border-radius: 12px !important;
        border: 2px solid #f1f5f9;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .status-badge {
        border-radius: 20px;
        padding: 6px 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .card-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 12px;
    }
    
    .card-actions .btn {
        font-size: 0.875rem;
        padding: 6px 16px;
    }
    
    /* Navigation styling */
    .nav-pills .nav-link {
        border-radius: 12px;
        font-weight: 500;
        padding: 12px 24px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        color: #6b7280;
        background: transparent;
        border: 2px solid transparent;
    }
    
    .nav-pills .nav-link:hover:not(.active) {
        background-color: #f3f4f6;
        color: #374151;
        transform: translateY(-1px);
    }
    
    .nav-pills .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        border-color: transparent;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between bg-white rounded-3 shadow-sm p-3">
                <ul class="nav nav-pills" id="prospectTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-content" type="button" role="tab">
                            <i class="fas fa-search me-2"></i>Search Prospects
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="database-tab" data-bs-toggle="tab" data-bs-target="#database-content" type="button" role="tab">
                            <i class="fas fa-database me-2"></i>Prospect Database
                        </button>
                    </li>


                </ul>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
                <div class="tab-content">
                    <!-- Search Tab -->
                    <div class="tab-pane active" id="search-content">
                        <div class="d-flex align-items-center gap-3 mb-3">
                            <i class="fas fa-magnifying-glass"></i>
                            <input class="form-control" id="prospect-search" placeholder="Search e.g. 'vegan antwerp' (Google Places)" style="flex: 1;">
                        </div>
                        {% if not google_maps_api_key %}
                        <div class="alert alert-warning">
                            <strong>Warning:</strong> Google Maps API key not configured. Please set GOOGLE_MAPS_API_KEY in your .env file.
                        </div>
                        {% endif %}
                        <div class="row g-3">
                            <div class="col-lg-7">
                                <div class="position-relative">
                                    <div id="map" style="background: #f8f9fa; display: flex; align-items: center; justify-content: center; min-height: 400px;">
                                        <div class="text-center">
                                            <div class="spinner mb-2"></div>
                                            <p class="text-muted">Loading Google Maps...</p>
                                        </div>
                                    </div>
                                    <div id="map-loading" class="loading-overlay"><div class="spinner"></div></div>
                                </div>
                            </div>
                            <div class="col-lg-5">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <div class="position-relative">
                                            <div id="results-loading" class="loading-overlay"><div class="spinner"></div></div>
                                            <div class="results-scroll list-group" id="result-list"></div>
                                        </div>
                                        <div id="selection-details" class="mt-2 small text-muted">Type a query (e.g., 'vegan antwerp') and press Enter. Results will appear here and on the map.</div>
                                    </div>
                                    <div class="col-12">
                                        <div class="position-relative">
                                            <div id="detail-loading" class="loading-overlay"><div class="spinner"></div></div>
                                            <div id="detail-panel" class="p-3 border rounded-3 bg-white">Click a result or marker to view details.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Database Tab -->
                    <div class="tab-pane" id="database-content">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex align-items-center gap-3 flex-wrap">
                                <input type="text" class="form-control" id="prospect-filter" placeholder="Filter prospects..." style="width: 250px;">
                                <select class="form-select" id="status-filter" style="width: 130px;">
                                    <option value="">All Statuses</option>
                                    <option value="new">New</option>
                                    <option value="contacted">Contacted</option>
                                    <option value="qualified">Qualified</option>
                                    <option value="converted">Converted</option>
                                </select>
                                <select class="form-select" id="city-filter" style="width: 130px;">
                                    <option value="">All Cities</option>
                                </select>
                                <select class="form-select" id="keyword-filter" style="width: 150px;">
                                    <option value="">All Keywords</option>
                                </select>
                                <button class="btn btn-outline-secondary rounded-pill btn-sm" onclick="clearAllFilters()">
                                    <i class="fas fa-times me-1"></i>Clear Filters
                                </button>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-primary rounded-pill shadow-sm" onclick="refreshProspects()">
                                    <i class="fas fa-sync-alt me-2"></i>Refresh
                                </button>
                                <button class="btn btn-success rounded-pill shadow-sm" onclick="retryFailedEnrichments()">
                                    <i class="fas fa-magic me-2"></i>Retry Enrichment
                                </button>
                            </div>
                        </div>
                        <div id="prospects-container">
                            <div class="text-center py-5">
                                <i class="fas fa-database fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Loading prospects...</p>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let map, markers = [], placesService, autocomplete;

// Initialize map with error handling
function initMap() {
    try {
        const mapElement = document.getElementById('map');
        if (!mapElement) {
            console.error('Map element not found');
            return;
        }
        
        // Clear loading content
        mapElement.innerHTML = '';
        mapElement.style.background = '';
        mapElement.style.display = '';
        mapElement.style.alignItems = '';
        mapElement.style.justifyContent = '';
        
        map = new google.maps.Map(mapElement, {
            center: { lat: 50.8503, lng: 4.3517 },
            zoom: 8,
            mapTypeControl: false,
            streetViewControl: false
        });
        
        console.log('Google Maps initialized successfully');
    } catch (error) {
        console.error('Error initializing Google Maps:', error);
        const mapElement = document.getElementById('map');
        if (mapElement) {
            mapElement.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                    <p class="text-muted">Google Maps failed to load</p>
                    <small class="text-muted">Check console for details</small>
                </div>
            `;
        }
        return;
    }

    // Places Autocomplete + Text Search
    const input = document.getElementById('prospect-search');
    autocomplete = new google.maps.places.Autocomplete(input, { fields: ['place_id', 'geometry', 'name', 'website', 'formatted_address'] });
    autocomplete.bindTo('bounds', map);
    placesService = new google.maps.places.PlacesService(map);

    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place || !place.place_id) return;
        placesService.getDetails({ placeId: place.place_id, fields: ['name', 'website', 'geometry', 'formatted_address'] }, (details, status) => {
            if (status !== google.maps.places.PlacesServiceStatus.OK || !details) return;
            const pos = details.geometry && details.geometry.location ? { lat: details.geometry.location.lat(), lng: details.geometry.location.lng() } : null;
            if (pos) {
                map.setCenter(pos);
                map.setZoom(14);
                addProspectMarker(pos, details.name || 'Prospect', `<div><strong>${details.name || ''}</strong><br><small>${details.formatted_address || ''}</small></div>`);
            }
            // Populate selection details and inputs for flows
            const info = document.getElementById('selection-details');
            info.innerHTML = `<strong>${details.name || ''}</strong><br><small>${details.formatted_address || ''}</small>${details.website ? `<br><a href="${details.website}" target="_blank" rel="noopener">${details.website}</a>` : ''}`;
            window.__prospect = { name: details.name || '', website: details.website || '' };
        });
    });

    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); runTextSearch(input.value.trim()); }
    });
}

function addProspectMarker(pos, title, infoHtml) {
    const marker = new google.maps.Marker({ position: pos, map, title });
    const info = new google.maps.InfoWindow({ content: infoHtml });
    marker.addListener('click', () => {
        info.open({ anchor: marker, map });
        showDetailsByLatLng(title, pos);
    });
    markers.push(marker);
}

function clearMarkers() {
    markers.forEach(m => m.setMap(null));
    markers = [];
}

function runTextSearch(query) {
    if (!query) return;
    document.getElementById('results-loading').classList.add('show');
    document.getElementById('map-loading').classList.add('show');
    const request = { query };
    const bounds = map.getBounds();
    if (bounds) request.bounds = bounds;
    placesService.textSearch(request, (results, status) => {
        document.getElementById('results-loading').classList.remove('show');
        document.getElementById('map-loading').classList.remove('show');
        const list = document.getElementById('result-list');
        list.innerHTML = '';
        document.getElementById('selection-details').textContent = `Results for "${query}"`;
        if (status !== google.maps.places.PlacesServiceStatus.OK || !results || !results.length) {
            clearMarkers();
            return;
        }
        clearMarkers();
        const fit = new google.maps.LatLngBounds();
        results.slice(0, 20).forEach((r, idx) => {
            const loc = r.geometry && r.geometry.location;
            if (!loc) return;
            const pos = { lat: loc.lat(), lng: loc.lng() };
            addProspectMarker(pos, r.name || 'Result', `<div><strong>${r.name || ''}</strong><br><small>${r.formatted_address || ''}</small></div>`);
            fit.extend(loc);
            const el = document.createElement('div');
            el.className = 'list-group-item result-item';
            el.innerHTML = `
                <div class="d-flex w-100 justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex w-100 justify-content-between">
                            <strong>${r.name || ''}</strong>
                            <small>${r.rating ? `⭐ ${r.rating}` : ''}</small>
                        </div>
                        <small class="text-muted">${r.formatted_address || ''}</small>
                    </div>
                    <div class="ms-2">
                        <button class="btn btn-sm btn-outline-success" onclick="quickSaveProspect('${r.name || ''}', '${r.formatted_address || ''}', '')" title="Save to Prospects">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                </div>
            `;
            // Add click handler for the main content area (excluding the save button)
            el.addEventListener('click', (e) => {
                // Don't trigger if clicking on the save button
                if (e.target.closest('button')) return;
                
                map.setCenter(pos);
                map.setZoom(15);
                window.__prospect = { name: r.name || '', website: '' };
                showDetailsByPlaceId(r.place_id);
            });
            list.appendChild(el);
        });
        try { map.fitBounds(fit); } catch (e) {}
    });
}

function showDetailsByLatLng(title, pos) {
    const request = { query: title, locationBias: new google.maps.LatLng(pos.lat, pos.lng) };
    placesService.textSearch(request, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && results && results[0]) {
            showDetailsByPlaceId(results[0].place_id);
        }
    });
}

function renderDetails(details) {
    const panel = document.getElementById('detail-panel');
    const photos = (details.photos || []).slice(0, 6).map(p => `<img src="${p.getUrl({maxWidth: 600, maxHeight: 400})}" alt="photo">`).join('');
    const url = details.website || (details.url || '');
    const rating = details.rating ? `⭐ ${details.rating} (${details.user_ratings_total || ''})` : '';
    const encodedQuery = encodeURIComponent(`${details.name || ''}`);
    
    panel.innerHTML = `
        <div class="prospect-detail-header mb-3">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h5 class="mb-1">${details.name || ''}</h5>
                    <p class="text-muted mb-1">${details.formatted_address || ''}</p>
                    <div class="mb-2">${rating}</div>
                    <div class="btn-group btn-group-sm">
                        ${url ? `<a class="btn btn-outline-primary" href="${url}" target="_blank" rel="noopener">Website</a>` : ''}
                        <a class="btn btn-outline-secondary" href="https://www.companyweb.be/en?q=${encodedQuery}" target="_blank" rel="noopener">Companyweb</a>
                        <button class="btn btn-success" onclick="saveProspectWithEnrichment('${details.name || ''}', '${details.formatted_address || ''}', '${details.website || ''}')">
                            <i class="fas fa-save me-1"></i>Save to Prospects
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        ${photos ? `<div class="photo-grid mb-3">${photos}</div>` : ''}
        
        <div class="mt-3">
            <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Click "Save to Prospects" to save this company. AI enrichment will happen automatically in the background.
            </small>
        </div>
    `;
    // Store current prospect details for enrichment
    window.__currentProspect = details;
}

function showDetailsByPlaceId(placeId) {
    if (!placeId) return;
    document.getElementById('detail-loading').classList.add('show');
    placesService.getDetails({ placeId, fields: ['name','formatted_address','website','url','rating','user_ratings_total','photos'] }, (details, status) => {
        document.getElementById('detail-loading').classList.remove('show');
        if (status !== google.maps.places.PlacesServiceStatus.OK || !details) return;
        renderDetails(details);
        window.__prospect = { name: details.name || (window.__prospect && window.__prospect.name) || '', website: details.website || '' };
    });
}

async function checkVAT(vat) {
    const q = new URLSearchParams({ vat_number: (vat || document.getElementById('vat-input').value).trim() });
    const res = await fetch('/api/prospecting/check-vat?' + q.toString());
    const data = await res.json();
    const box = document.getElementById('duano-results');
    const items = (data.result && data.result.data) || [];
    if (!items.length) { box.textContent = 'No matches found in DOUANO.'; return; }
    box.innerHTML = items.map(c => {
        const name = (c.public_name || c.name || 'Unknown');
        const vat = (c.vat_number || '');
        const city = (c.city || '');
        const id = c.id;
        return `<div class="mb-2"><strong>${name}</strong><br><small>${vat} ${city}</small></div>`;
    }).join('');
}

// Removed AI enrich and Extract VAT buttons per request

document.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-vat]');
    if (btn) { checkVAT(btn.getAttribute('data-vat')); }
});

// Tab functionality
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('[data-bs-toggle="tab"]');
    tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove active class from all tabs and content
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked tab
            this.classList.add('active');
            
            // Show corresponding content
            const target = this.getAttribute('data-bs-target');
            document.querySelector(target).classList.add('active');
            
                    // Load prospects if database tab is clicked
        if (target === '#database-content') {
            loadProspects();
            // Removed auto-refresh to prevent continuous polling
        }
        });
    });
    
    // Load prospects on page load (but don't wait for it to complete)
    setTimeout(() => {
        loadProspects();
    }, 1000);
});

// Save prospect with background AI enrichment (non-blocking)
async function saveProspectWithEnrichment(name, address, website) {
    const saveBtn = event.target;
    const originalText = saveBtn.innerHTML;
    
    try {
        // Update button state immediately
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
        saveBtn.disabled = true;
        
        // Save prospect immediately with basic data
        await saveProspect(name, address, website, {});
        
        // Update button to show saved
        saveBtn.innerHTML = '<i class="fas fa-check me-1"></i>Saved!';
        saveBtn.classList.remove('btn-success');
        saveBtn.classList.add('btn-success');
        
        showToast('Prospect saved! AI enrichment in progress...', 'success');
        
        // Start background enrichment (non-blocking)
        performBackgroundEnrichment(name, address, website);
        
    } catch (error) {
        console.error('Error saving prospect:', error);
        saveBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Error';
        saveBtn.classList.remove('btn-success');
        saveBtn.classList.add('btn-danger');
        showToast('Failed to save prospect: ' + error.message, 'error');
    } finally {
        setTimeout(() => {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
            saveBtn.classList.remove('btn-danger');
            saveBtn.classList.add('btn-success');
        }, 3000);
    }
}

// Perform background enrichment without blocking UI
async function performBackgroundEnrichment(name, address, website) {
    try {
        console.log(`Starting background enrichment for: ${name}`);
        
        // The backend enrichment is already running automatically when we save the prospect
        // We just need to wait for it to complete and refresh the data
        console.log(`Backend enrichment started automatically for: ${name}`);
        
        // Show notification if user is on database tab
        if (document.querySelector('#database-content').classList.contains('active')) {
            showToast(`Enrichment started for ${name}!`, 'info');
        }
        
    } catch (error) {
        console.error(`Background enrichment failed for ${name}:`, error);
        
        // Don't show error toast to avoid interrupting user experience
        // The data will be updated when they next refresh the database tab
    }
}

// Update prospect with enriched data (handled by backend automatically)
async function updateProspectWithEnrichment(name, enrichmentData) {
    console.log(`Enrichment update for ${name} is handled by backend automatically`);
}

// AI enrichment is now handled by the backend automatically
// This function is kept for compatibility but not used
async function performAIEnrichment(companyName, address) {
    console.log(`AI enrichment for ${companyName} is handled by backend automatically`);
    return {};
}

// Display enriched data in dropdown
function displayEnrichedData(enrichmentData, originalAddress) {
    const enrichmentContent = document.getElementById('enrichment-content');
    
    // Check if we have meaningful data
    const hasData = (enrichmentData.vat || enrichmentData.site || enrichmentData.email || 
                    enrichmentData.phone || enrichmentData.directors || 
                    (enrichmentData.registered && enrichmentData.registered !== originalAddress));
    
    if (!hasData) {
        enrichmentContent.innerHTML = `
            <div class="alert alert-info">
                <strong>Limited enrichment data found</strong><br>
                <small>The AI search found minimal additional information for this company.</small>
            </div>
        `;
        return;
    }
    
    enrichmentContent.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                ${enrichmentData.vat ? `<div class="mb-2"><strong>VAT:</strong> ${enrichmentData.vat}</div>` : ''}
                ${enrichmentData.email ? `<div class="mb-2"><strong>Email:</strong> ${enrichmentData.email}</div>` : ''}
                ${enrichmentData.phone ? `<div class="mb-2"><strong>Phone:</strong> ${enrichmentData.phone}</div>` : ''}
            </div>
            <div class="col-md-6">
                ${enrichmentData.site ? `<div class="mb-2"><strong>Website:</strong> <a href="${enrichmentData.site}" target="_blank">${enrichmentData.site}</a></div>` : ''}
                ${enrichmentData.directors ? `<div class="mb-2"><strong>Directors:</strong> ${enrichmentData.directors}</div>` : ''}
                ${enrichmentData.registered && enrichmentData.registered !== originalAddress ? 
                    `<div class="mb-2"><strong>Registered Address:</strong> ${enrichmentData.registered}</div>` : ''}
            </div>
        </div>
        <div class="mt-3">
            <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                This data was automatically enriched using AI web search.
            </small>
        </div>
    `;
}

// Quick save prospect from search results (with background enrichment)
async function quickSaveProspect(name, address, website) {
    const saveBtn = event.target;
    const originalHTML = saveBtn.innerHTML;
    
    try {
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        saveBtn.disabled = true;
        
        // Save prospect with basic information
        await saveProspect(name, address, website, {});
        
        saveBtn.innerHTML = '<i class="fas fa-check"></i>';
        saveBtn.classList.remove('btn-outline-success');
        saveBtn.classList.add('btn-success');
        
        showToast('Prospect saved! AI enrichment in progress...', 'success');
        
        // Start background enrichment (non-blocking)
        performBackgroundEnrichment(name, address, website);
        
    } catch (error) {
        console.error('Error saving prospect:', error);
        saveBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
        saveBtn.classList.remove('btn-outline-success');
        saveBtn.classList.add('btn-danger');
        showToast('Failed to save prospect: ' + error.message, 'error');
    } finally {
        setTimeout(() => {
            saveBtn.innerHTML = originalHTML;
            saveBtn.disabled = false;
            saveBtn.classList.remove('btn-success', 'btn-danger');
            saveBtn.classList.add('btn-outline-success');
        }, 3000);
    }
}

// Legacy function for backward compatibility
function saveProspectFromDetails() {
    const saveBtn = document.getElementById('save-prospect-btn');
    if (!saveBtn) return;
    
    try {
        const companyData = JSON.parse(saveBtn.getAttribute('data-company-data') || '{}');
        saveProspect(companyData.name, companyData.address, companyData.website, companyData.enriched);
    } catch (error) {
        console.error('Error parsing company data:', error);
        showToast('Error saving prospect: Invalid data', 'error');
    }
}

// Save prospect function
async function saveProspect(name, address, website, enrichedData) {
    const saveBtn = document.getElementById('save-prospect-btn');
    const originalText = saveBtn ? saveBtn.innerHTML : '';
    
    try {
        if (saveBtn) {
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
            saveBtn.disabled = true;
        }
        
        // Capture the current search query for tagging
        const searchInput = document.getElementById('prospect-search');
        const searchQuery = searchInput ? searchInput.value.trim() : '';
        
        const prospectData = {
            name: name,
            address: address,
            website: website,
            status: 'new',
            enriched_data: enrichedData || {},
            google_place_id: window.__prospect?.place_id || null,
            search_query: searchQuery,
            created_at: new Date().toISOString()
        };
        
        const response = await fetch('/api/prospects', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(prospectData)
        });
        
        if (response.ok) {
            const result = await response.json();
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-check me-2"></i>Saved!';
                saveBtn.classList.remove('btn-success');
                saveBtn.classList.add('btn-success');
            }
            
            // Show success message
            showToast('Prospect saved successfully!', 'success');
            
            // Refresh prospects if database tab is active
            if (document.querySelector('#database-content').classList.contains('active')) {
                loadProspects();
            }
        } else {
            const error = await response.json();
            if (error.setup_required) {
                throw new Error(`Database setup required: ${error.error}. Please run the fix_rls_policy.sql script in your Supabase SQL editor.`);
            }
            throw new Error(error.error || 'Failed to save prospect');
        }
    } catch (error) {
        console.error('Error saving prospect:', error);
        if (saveBtn) {
            saveBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error';
            saveBtn.classList.remove('btn-success');
            saveBtn.classList.add('btn-danger');
        }
        showToast('Failed to save prospect: ' + error.message, 'error');
    } finally {
        if (saveBtn) {
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                saveBtn.classList.remove('btn-danger');
                saveBtn.classList.add('btn-success');
            }, 3000);
        }
    }
}

// Load prospects from database
async function loadProspects() {
    const container = document.getElementById('prospects-container');
    
    try {
        container.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner"></div>
                <p class="text-muted mt-2">Loading prospects...</p>
            </div>
        `;
        
        const response = await fetch('/api/prospects');
        
        if (response.ok) {
            const data = await response.json();
            displayProspects(data.prospects || []);
        } else {
            const errorData = await response.json();
            if (errorData.setup_required) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-database fa-3x text-warning mb-3"></i>
                        <h5 class="text-warning">Database Setup Required</h5>
                        <p class="text-muted">${errorData.error}</p>
                        <div class="mt-3">
                            <p class="small text-muted">To set up the database:</p>
                            <ol class="text-start small text-muted" style="max-width: 400px; margin: 0 auto;">
                                <li>Go to your Supabase project dashboard</li>
                                <li>Navigate to the SQL Editor</li>
                                <li>Copy and paste the contents of <code>supabase_setup.sql</code></li>
                                <li>Run the SQL script</li>
                                <li>Click "Test Connection" to verify</li>
                            </ol>
                        </div>
                    </div>
                `;
                return;
            }
            throw new Error(errorData.error || 'Failed to load prospects');
        }
    } catch (error) {
        console.error('Error loading prospects:', error);
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <p class="text-danger">Error loading prospects: ${error.message}</p>
                <button class="btn btn-primary" onclick="loadProspects()">Retry</button>
            </div>
        `;
    }
}

// Display prospects in the database tab
function displayProspects(prospects) {
    const container = document.getElementById('prospects-container');
    
    if (prospects.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <p class="text-muted">No prospects found. Start searching to add some!</p>
            </div>
        `;
        return;
    }
    
    const prospectsHtml = prospects.map(prospect => `
        <div class="prospect-card" data-id="${prospect.id}">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="flex-grow-1">
                    <h6 class="mb-1">${prospect.name || 'Unnamed Prospect'}</h6>
                    <small class="text-muted">${prospect.address || 'No address'}</small>
                    
                    <!-- Tags Section -->
                    <div class="mt-2">
                        ${prospect.tags?.city?.length ? prospect.tags.city.map(city => 
                            `<span class="badge bg-primary me-1 mb-1 rounded-pill" style="font-size: 10px;">
                                <i class="fas fa-map-marker-alt me-1"></i>${city}
                            </span>`
                        ).join('') : ''}
                        ${prospect.tags?.keywords?.length ? prospect.tags.keywords.slice(0, 3).map(keyword => 
                            `<span class="badge bg-info me-1 mb-1 rounded-pill" style="font-size: 10px;">
                                <i class="fas fa-tag me-1"></i>${keyword}
                            </span>`
                        ).join('') : ''}
                        ${prospect.search_query ? 
                            `<span class="badge bg-secondary me-1 mb-1 rounded-pill" style="font-size: 9px;" title="Search Query">
                                <i class="fas fa-search me-1"></i>${prospect.search_query.length > 15 ? prospect.search_query.substring(0, 15) + '...' : prospect.search_query}
                            </span>` : ''}
                    </div>
                </div>
                <span class="prospect-status status-${prospect.status || 'new'}">${(prospect.status || 'new').toUpperCase()}</span>
            </div>
            
            <div class="row g-3 mt-2">
                <div class="col-md-6">
                    ${prospect.enriched_data?.vat ? `<div class="d-flex align-items-center justify-content-between">
                        <span><strong>VAT:</strong> ${prospect.enriched_data.vat}</span>
                        <button class="btn btn-sm btn-outline-primary rounded-pill ms-2" 
                                onclick="searchCompanyByVat('${prospect.enriched_data.vat}')" 
                                title="Search VAT in Companies">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>` : ''}
                    ${prospect.enriched_data?.email ? `<div><strong>Email:</strong> ${prospect.enriched_data.email}</div>` : ''}
                    ${prospect.enriched_data?.phone ? `<div><strong>Phone:</strong> ${prospect.enriched_data.phone}</div>` : ''}
                </div>
                <div class="col-md-6">
                    ${prospect.website ? `<div><strong>Website:</strong> <a href="${prospect.website}" target="_blank">${prospect.website}</a></div>` : ''}
                    ${prospect.enriched_data?.directors ? `<div><strong>Directors:</strong> ${
                        Array.isArray(prospect.enriched_data.directors) 
                            ? prospect.enriched_data.directors.map(director => 
                                `<span class="director-link text-primary text-decoration-underline" 
                                      style="cursor: pointer;" 
                                      onclick="searchDirectorInCrm('${director.replace(/'/g, "\\'")}')" 
                                      title="Search in CRM">${director}</span>`
                              ).join(', ')
                            : `<span class="director-link text-primary text-decoration-underline" 
                                     style="cursor: pointer;" 
                                     onclick="searchDirectorInCrm('${prospect.enriched_data.directors.replace(/'/g, "\\'")}')" 
                                     title="Search in CRM">${prospect.enriched_data.directors}</span>`
                    }</div>` : ''}
                    <div class="small text-muted mt-2">Added: ${new Date(prospect.created_at).toLocaleDateString()}</div>
                </div>
            </div>
            
            ${(() => {
                const status = prospect.enrichment_status || 'pending';
                const hasEnrichedData = prospect.enriched_data && Object.keys(prospect.enriched_data).length > 0 && 
                    Object.values(prospect.enriched_data).some(v => {
                        if (!v) return false;
                        if (typeof v === 'string') return v.trim() && v !== 'empty';
                        if (Array.isArray(v)) return v.length > 0;
                        return true;
                    });
                
                switch(status) {
                    case 'completed':
                        return `<div class="mt-2">
                            <small class="text-success">
                                <i class="fas fa-check-circle me-1"></i>AI enriched
                            </small>
                        </div>`;
                    case 'in_progress':
                        return `<div class="mt-2">
                            <small class="text-info">
                                <i class="fas fa-spinner fa-spin me-1"></i>AI enrichment in progress...
                            </small>
                        </div>`;
                    case 'no_data':
                        return `<div class="mt-2">
                            <small class="text-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i>No data found
                            </small>
                        </div>`;
                    case 'failed':
                        return `<div class="mt-2">
                            <small class="text-danger">
                                <i class="fas fa-times-circle me-1"></i>Enrichment failed
                            </small>
                        </div>`;
                    case 'pending':
                    default:
                        return `<div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>Pending enrichment
                            </small>
                        </div>`;
                }
            })()}
            
            <div class="notes-section">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted fw-semibold">
                        <i class="fas fa-sticky-note me-1"></i>Notes
                    </small>
                    <button class="btn btn-sm btn-outline-secondary rounded-pill" 
                            onclick="toggleNotes('${prospect.id}')" 
                            style="font-size: 11px; padding: 2px 8px;">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                <div class="notes-display" id="notes-display-${prospect.id}">
                    ${prospect.notes ? `<div class="text-muted small">${prospect.notes}</div>` : '<div class="text-muted small fst-italic">No notes yet...</div>'}
                </div>
                <div class="notes-edit d-none" id="notes-edit-${prospect.id}">
                    <textarea class="notes-textarea form-control" 
                              placeholder="Add your notes here..."
                              id="notes-textarea-${prospect.id}">${prospect.notes || ''}</textarea>
                    <div class="mt-2 d-flex gap-2">
                        <button class="btn btn-sm btn-primary rounded-pill" onclick="saveNotes('${prospect.id}')">
                            <i class="fas fa-save me-1"></i>Save
                        </button>
                        <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="cancelNotes('${prospect.id}')">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card-actions">
                <button class="btn btn-outline-primary rounded-pill" onclick="updateProspectStatus('${prospect.id}', 'contacted')">
                    <i class="fas fa-phone me-1"></i>Contacted
                </button>
                <button class="btn btn-outline-success rounded-pill" onclick="updateProspectStatus('${prospect.id}', 'qualified')">
                    <i class="fas fa-check me-1"></i>Qualified
                </button>
                <button class="btn btn-outline-warning rounded-pill" onclick="updateProspectStatus('${prospect.id}', 'converted')">
                    <i class="fas fa-star me-1"></i>Converted
                </button>
                <button class="btn btn-outline-danger rounded-pill" onclick="deleteProspect('${prospect.id}')">
                    <i class="fas fa-trash me-1"></i>Delete
                </button>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = prospectsHtml;
    
    // Update filter dropdowns with available tags
    updateFilterDropdowns(prospects);
}

// Update filter dropdowns based on available prospects
function updateFilterDropdowns(prospects) {
    const cityFilter = document.getElementById('city-filter');
    const keywordFilter = document.getElementById('keyword-filter');
    
    if (!cityFilter || !keywordFilter) return;
    
    // Collect all unique cities and keywords
    const cities = new Set();
    const keywords = new Set();
    
    prospects.forEach(prospect => {
        if (prospect.tags?.city) {
            prospect.tags.city.forEach(city => cities.add(city));
        }
        if (prospect.tags?.keywords) {
            prospect.tags.keywords.forEach(keyword => keywords.add(keyword));
        }
    });
    
    // Update city filter
    const currentCityValue = cityFilter.value;
    cityFilter.innerHTML = '<option value="">All Cities</option>';
    [...cities].sort().forEach(city => {
        const option = document.createElement('option');
        option.value = city;
        option.textContent = city;
        if (city === currentCityValue) option.selected = true;
        cityFilter.appendChild(option);
    });
    
    // Update keyword filter
    const currentKeywordValue = keywordFilter.value;
    keywordFilter.innerHTML = '<option value="">All Keywords</option>';
    [...keywords].sort().forEach(keyword => {
        const option = document.createElement('option');
        option.value = keyword;
        option.textContent = keyword;
        if (keyword === currentKeywordValue) option.selected = true;
        keywordFilter.appendChild(option);
    });
}

// Update prospect status
async function updateProspectStatus(prospectId, newStatus) {
    try {
        const response = await fetch(`/api/prospects/${prospectId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        if (response.ok) {
            showToast(`Prospect status updated to ${newStatus}`, 'success');
            loadProspects(); // Refresh the list
        } else {
            throw new Error('Failed to update prospect status');
        }
    } catch (error) {
        console.error('Error updating prospect:', error);
        showToast('Failed to update prospect status', 'error');
    }
}

// Delete prospect
async function deleteProspect(prospectId) {
    if (!confirm('Are you sure you want to delete this prospect?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/prospects/${prospectId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showToast('Prospect deleted successfully', 'success');
            loadProspects(); // Refresh the list
        } else {
            throw new Error('Failed to delete prospect');
        }
    } catch (error) {
        console.error('Error deleting prospect:', error);
        showToast('Failed to delete prospect', 'error');
    }
}

// Auto-refresh variables
// Auto-refresh removed to prevent continuous polling and improve performance

// Refresh prospects
function refreshProspects() {
    loadProspects();
}

// Retry failed enrichments
async function retryFailedEnrichments() {
    const retryBtn = event.target;
    const originalText = retryBtn.innerHTML;
    
    try {
        retryBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Retrying...';
        retryBtn.disabled = true;
        
        // Get all prospects
        const response = await fetch('/api/prospects');
        if (!response.ok) throw new Error('Failed to fetch prospects');
        
        const data = await response.json();
        const prospects = data.prospects || [];
        
        // Find prospects that need enrichment
        const needsEnrichment = prospects.filter(p => 
            !p.enriched_data || 
            Object.keys(p.enriched_data).length === 0 ||
            p.enriched_data.enrichment_failed
        );
        
        if (needsEnrichment.length === 0) {
            showToast('No prospects need enrichment!', 'info');
            return;
        }
        
        showToast(`Retrying enrichment for ${needsEnrichment.length} prospects...`, 'info');
        
        // For prospects that need enrichment, we need to trigger backend enrichment
        // Since we can't directly call the backend enrichment, we'll show a message
        showToast(`Found ${needsEnrichment.length} prospects needing enrichment. Backend enrichment runs automatically.`, 'info');
        
        // Refresh the list to see current status
        loadProspects();
        
        // Refresh the list after a delay
        setTimeout(() => {
            loadProspects();
        }, 5000);
        
    } catch (error) {
        console.error('Error retrying enrichments:', error);
        showToast('Failed to retry enrichments: ' + error.message, 'error');
    } finally {
        retryBtn.innerHTML = originalText;
        retryBtn.disabled = false;
    }
}

// Notes functionality
function toggleNotes(prospectId) {
    const displayDiv = document.getElementById(`notes-display-${prospectId}`);
    const editDiv = document.getElementById(`notes-edit-${prospectId}`);
    
    displayDiv.classList.toggle('d-none');
    editDiv.classList.toggle('d-none');
    
    if (!editDiv.classList.contains('d-none')) {
        // Focus on textarea when editing
        const textarea = document.getElementById(`notes-textarea-${prospectId}`);
        setTimeout(() => textarea.focus(), 100);
    }
}

async function saveNotes(prospectId) {
    const textarea = document.getElementById(`notes-textarea-${prospectId}`);
    const notes = textarea.value.trim();
    
    try {
        const response = await fetch(`/api/prospects/${prospectId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ notes: notes })
        });
        
        if (response.ok) {
            // Update the display
            const displayDiv = document.getElementById(`notes-display-${prospectId}`);
            displayDiv.innerHTML = notes ? 
                `<div class="text-muted small">${notes}</div>` : 
                '<div class="text-muted small fst-italic">No notes yet...</div>';
            
            // Hide edit mode
            toggleNotes(prospectId);
            
            showToast('Notes saved successfully!', 'success');
        } else {
            throw new Error('Failed to save notes');
        }
    } catch (error) {
        console.error('Error saving notes:', error);
        showToast('Failed to save notes', 'error');
    }
}

function cancelNotes(prospectId) {
    // Reset textarea to original value
    const textarea = document.getElementById(`notes-textarea-${prospectId}`);
    const displayDiv = document.getElementById(`notes-display-${prospectId}`);
    const currentNotes = displayDiv.querySelector('.text-muted')?.textContent;
    
    if (currentNotes && currentNotes !== 'No notes yet...') {
        textarea.value = currentNotes;
    } else {
        textarea.value = '';
    }
    
    toggleNotes(prospectId);
}

// Filter prospects (client-side filtering)
document.addEventListener('DOMContentLoaded', function() {
    const filterInput = document.getElementById('prospect-filter');
    const statusFilter = document.getElementById('status-filter');
    
    if (filterInput) {
        filterInput.addEventListener('input', filterProspects);
    }
    
    if (statusFilter) {
        statusFilter.addEventListener('change', filterProspects);
    }
    
    const cityFilter = document.getElementById('city-filter');
    if (cityFilter) {
        cityFilter.addEventListener('change', filterProspects);
    }
    
    const keywordFilter = document.getElementById('keyword-filter');
    if (keywordFilter) {
        keywordFilter.addEventListener('change', filterProspects);
    }
    

});

function filterProspects() {
    const filterText = document.getElementById('prospect-filter')?.value.toLowerCase() || '';
    const statusFilter = document.getElementById('status-filter')?.value || '';
    const cityFilter = document.getElementById('city-filter')?.value || '';
    const keywordFilter = document.getElementById('keyword-filter')?.value || '';
    const prospects = document.querySelectorAll('.prospect-card');
    
    prospects.forEach(card => {
        const name = card.querySelector('h6')?.textContent.toLowerCase() || '';
        const address = card.querySelector('.text-muted')?.textContent.toLowerCase() || '';
        const status = card.querySelector('.prospect-status')?.textContent.toLowerCase() || '';
        
        // Get tag badges for city and keyword filtering
        const cityBadges = card.querySelectorAll('.badge.bg-primary');
        const keywordBadges = card.querySelectorAll('.badge.bg-info');
        
        const cities = Array.from(cityBadges).map(badge => badge.textContent.replace('📍', '').trim());
        const keywords = Array.from(keywordBadges).map(badge => badge.textContent.replace('🏷️', '').trim());
        
        const matchesText = name.includes(filterText) || address.includes(filterText);
        const matchesStatus = !statusFilter || status.includes(statusFilter);
        const matchesCity = !cityFilter || cities.some(city => city.includes(cityFilter));
        const matchesKeyword = !keywordFilter || keywords.some(keyword => keyword.includes(keywordFilter));
        
        card.style.display = matchesText && matchesStatus && matchesCity && matchesKeyword ? 'block' : 'none';
    });
    
    // Update visible count
    const visibleCount = document.querySelectorAll('.prospect-card[style*="block"], .prospect-card:not([style*="none"])').length;
    const totalCount = prospects.length;
    
    // Show filter summary if any filters are active
    const hasActiveFilters = filterText || statusFilter || cityFilter || keywordFilter;
    if (hasActiveFilters) {
        showFilterSummary(visibleCount, totalCount, {
            text: filterText,
            status: statusFilter,
            city: cityFilter,
            keyword: keywordFilter
        });
    }
}

// Clear all filters
function clearAllFilters() {
    document.getElementById('prospect-filter').value = '';
    document.getElementById('status-filter').value = '';
    document.getElementById('city-filter').value = '';
    document.getElementById('keyword-filter').value = '';
    filterProspects();
    hideFilterSummary();
}

// Show filter summary
function showFilterSummary(visible, total, filters) {
    let existingSummary = document.getElementById('filter-summary');
    if (existingSummary) {
        existingSummary.remove();
    }
    
    const activeFilters = [];
    if (filters.text) activeFilters.push(`Text: "${filters.text}"`);
    if (filters.status) activeFilters.push(`Status: ${filters.status}`);
    if (filters.city) activeFilters.push(`City: ${filters.city}`);
    if (filters.keyword) activeFilters.push(`Keyword: ${filters.keyword}`);
    
    const summary = document.createElement('div');
    summary.id = 'filter-summary';
    summary.className = 'alert alert-info alert-dismissible fade show mb-3';
    summary.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-filter me-2"></i>
            <span>Showing ${visible} of ${total} prospects</span>
            <span class="ms-2 text-muted">• Filters: ${activeFilters.join(', ')}</span>
            <button type="button" class="btn-close ms-auto" onclick="hideFilterSummary(); clearAllFilters();"></button>
        </div>
    `;
    
    const container = document.getElementById('prospects-container');
    container.insertBefore(summary, container.firstChild);
}

// Hide filter summary
function hideFilterSummary() {
    const summary = document.getElementById('filter-summary');
    if (summary) {
        summary.remove();
    }
}

// Toast notification function
function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 5000);
}

// Fallback if Google Maps fails to load
window.setTimeout(function() {
    if (typeof google === 'undefined') {
        console.error('Google Maps API failed to load');
        const mapElement = document.getElementById('map');
        if (mapElement && mapElement.innerHTML.includes('Loading Google Maps')) {
            mapElement.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                    <p class="text-muted">Google Maps API failed to load</p>
                    <p class="small text-muted">Please check your API key configuration</p>
                </div>
            `;
        }
    }
}, 10000); // 10 second timeout

// No action buttons; user triggers search with Enter, clicks list items or markers
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initMap" onerror="handleMapError()"></script>
<script>
function handleMapError() {
    console.error('Google Maps script failed to load');
    const mapElement = document.getElementById('map');
    if (mapElement) {
        mapElement.innerHTML = `
            <div class="text-center">
                <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                <p class="text-muted">Google Maps script failed to load</p>
                <p class="small text-muted">Please check your internet connection and API key</p>
            </div>
        `;
    }
}



// Search company by VAT number
async function searchCompanyByVat(vatNumber) {
    try {
        // Navigate to the Companies page with VAT search parameter
        const companiesUrl = `/companies?search=${encodeURIComponent(vatNumber)}`;
        window.location.href = companiesUrl;
        
        showToast(`Navigating to Companies page to search for VAT ${vatNumber}`, 'info');
    } catch (error) {
        console.error('Error searching company by VAT:', error);
        showToast('Failed to search company: ' + error.message, 'error');
    }
}

// Search director in CRM
async function searchDirectorInCrm(directorName) {
    try {
        // Navigate to the CRM page with director search parameter
        const crmUrl = `/crm?search=${encodeURIComponent(directorName)}`;
        window.location.href = crmUrl;
        
        showToast(`Navigating to CRM to search for "${directorName}"`, 'info');
    } catch (error) {
        console.error('Error searching director in CRM:', error);
        showToast('Failed to search director: ' + error.message, 'error');
    }
}

// Show add company modal (placeholder)
function showAddCompanyModal() {
    showToast('Add Company functionality coming soon!', 'info');
}



</script>
{% endblock %}


