{% extends "base.html" %}

{% block title %}Prospecting Map - CRMinal{% endblock %}

{% block content %}
<div class="prospecting-map-container">
    <!-- Map Container -->
    <div id="map"></div>

    <!-- Right Sidebar -->
    <div class="map-sidebar" id="mapSidebar">
        <!-- Tab Header -->
        <div class="tab-header">
            <button class="tab-btn active" data-tab="filter" onclick="switchTab('filter')">
                <i class="fas fa-filter"></i>
                <span>Filter</span>
            </button>
            <button class="tab-btn" data-tab="google" onclick="switchTab('google')">
                <i class="fab fa-google"></i>
                <span>Google</span>
            </button>
        </div>

        <!-- Filter Panel -->
        <div class="tab-content" id="filter-panel">
            <!-- Route Building Banner (shown when route_id param present) -->
            <div class="focus-banner" id="routeBuildBanner" style="display:none;background:var(--info-bg);border-color:var(--info);">
                <span><i class="fas fa-route me-2" style="color:var(--info)"></i>Building: <strong id="routeBuildName">Route</strong></span>
                <a id="routeBuildLink" href="/trips" style="font-size:0.75rem;color:var(--info);text-decoration:underline;">Done</a>
            </div>

            <!-- Focus Banner (shown when company selected) -->
            <div class="focus-banner" id="focusBanner" style="display:none">
                <span><i class="fas fa-crosshairs me-2"></i>Viewing: <strong id="focusedCompanyName">Company</strong></span>
                <button onclick="clearCompanyFocus()"><i class="fas fa-times me-1"></i>Show All</button>
            </div>

            <!-- Stats Bar -->
            <div class="stats-bar">
                <span class="stats-text">
                    <strong id="filtered-count">0</strong> of <strong id="total-count">0</strong> customers
                    <span id="delivery-count-badge" style="color:#6366f1;margin-left:6px;display:none">
                        <i class="fas fa-truck"></i> <strong id="delivery-count">0</strong>
                    </span>
                </span>
                <button class="btn-clear-filters" onclick="clearAllFilters()">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>

            <!-- Delivery Toggle -->
            <div class="filter-group" style="padding:0.5rem 1rem;display:flex;align-items:center;justify-content:space-between">
                <label class="filter-label" style="margin:0;display:flex;align-items:center;gap:6px">
                    <i class="fas fa-truck" style="color:#6366f1"></i> Show Delivery Locations
                </label>
                <div class="form-check form-switch" style="margin:0">
                    <input class="form-check-input" type="checkbox" id="deliveryToggle" checked onchange="toggleDeliveryMarkers()">
                </div>
            </div>

            <!-- Search -->
            <div class="filter-group">
                <label class="filter-label">Search</label>
                <div class="search-input-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="text" id="customerSearch" placeholder="Company name..." oninput="filterCustomers()">
                </div>
            </div>

            <!-- Category Filter -->
            <div class="filter-group">
                <label class="filter-label">Category</label>
                <div class="custom-dropdown" id="categoryDropdown">
                    <div class="dropdown-trigger" onclick="toggleCategoryDropdown()">
                        <span id="categoryTriggerText">All categories</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="dropdown-menu" id="categoryDropdownMenu">
                        <div class="dropdown-search">
                            <input type="text" placeholder="Search..." id="categorySearchInput" oninput="filterCategoryOptions(this.value)">
                        </div>
                        <div class="dropdown-options" id="categoryOptions"></div>
                    </div>
                </div>
            </div>

            <!-- Alert Filter -->
            <div class="filter-group">
                <label class="filter-label">Alert Type</label>
                <select id="alertFilter" class="filter-select" onchange="filterCustomers()">
                    <option value="">All companies</option>
                    <option value="any">Has any alert</option>
                    <option value="PATTERN_DISRUPTION">Pattern Break</option>
                    <option value="HIGH_VALUE_AT_RISK">High Value Risk</option>
                    <option value="DORMANT_CUSTOMER">Dormant</option>
                    <option value="DECLINING_VALUE">Declining</option>
                    <option value="INCREASING_GAP">Less Frequent</option>
                    <option value="ONE_TIME_CUSTOMER">One-Timer</option>
                </select>
            </div>

            <!-- Salesperson Filter -->
            <div class="filter-group">
                <label class="filter-label">Salesperson</label>
                <select id="salespersonFilter" class="filter-select" onchange="filterCustomers()">
                    <option value="">All</option>
                    <option value="unassigned">Unassigned</option>
                    <option value="Caitlin">Caitlin</option>
                    <option value="Kesha">Kesha</option>
                    <option value="Django">Django</option>
                </select>
            </div>

            <!-- Customer List -->
            <div class="results-list" id="customerList">
                <div class="loading-state">
                    <div class="spinner-border spinner-border-sm text-primary"></div>
                    <span>Loading customers...</span>
                </div>
            </div>
        </div>

        <!-- Google Search Panel -->
        <div class="tab-content" id="google-panel" style="display: none;">
            <!-- Search Box -->
            <div class="google-search-box">
                <div class="search-input-wrapper">
                    <i class="fab fa-google"></i>
                    <input type="text" id="googleSearchInput" placeholder="Search places..."
                           onkeypress="if(event.key==='Enter') searchGooglePlaces()">
                    <button class="btn-search" onclick="searchGooglePlaces()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <button class="btn-search-area" onclick="searchInCurrentArea()">
                    <i class="fas fa-map-marker-alt"></i> Search this area
                </button>
            </div>

            <!-- Search Results -->
            <div class="results-list" id="googleResultsList">
                <div class="empty-state">
                    <i class="fab fa-google fa-2x"></i>
                    <p>Search for businesses to find new prospects</p>
                </div>
            </div>

            <!-- Actions -->
            <div class="results-actions" id="googleResultsActions" style="display: none;">
                <button class="btn btn-outline-secondary btn-sm" onclick="clearGoogleResults()">
                    Clear Results
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Toggle -->
    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
        <i class="fas fa-filter"></i>
    </button>
</div>

<!-- Prospect Detail Modal -->
<div class="modal fade" id="prospectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="prospectModalTitle">Add Prospect</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="prospectModalBody">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveProspectBtn" onclick="saveProspect()">
                    <i class="fas fa-plus me-2"></i>Add as Prospect
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Route Selector Modal -->
<div class="modal fade" id="routeSelectorModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content route-modal">
            <div class="route-modal-header">
                <div class="route-modal-location">
                    <i class="fas fa-map-marker-alt"></i>
                    <div>
                        <h6 id="routeLocationName">Location Name</h6>
                        <p id="routeLocationAddress">Address</p>
                    </div>
                </div>
                <button type="button" class="route-modal-close" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="route-modal-body">
                <!-- Quick Actions -->
                <div class="route-quick-actions">
                    <button class="route-action-card active" onclick="showRouteTab('schedule')">
                        <i class="fas fa-calendar-plus"></i>
                        <span>Schedule Visit</span>
                    </button>
                    <button class="route-action-card" onclick="showRouteTab('add')">
                        <i class="fas fa-plus-circle"></i>
                        <span>Add to Route</span>
                    </button>
                </div>

                <!-- Schedule Visit Section -->
                <div class="route-tab-content" id="scheduleTab">
                    <div class="route-form-group">
                        <label>Salesperson</label>
                        <select id="scheduleVisitSalesperson">
                            <option value="">Select...</option>
                            <option value="Caitlin">Caitlin</option>
                            <option value="Kesha">Kesha</option>
                            <option value="Django">Django</option>
                        </select>
                    </div>
                    <div class="route-form-row">
                        <div class="route-form-group">
                            <label>Date</label>
                            <input type="date" id="scheduleVisitDate">
                        </div>
                        <div class="route-form-group">
                            <label>Time</label>
                            <input type="time" id="scheduleVisitTime" value="09:00">
                        </div>
                    </div>
                    <button class="route-submit-btn" onclick="scheduleVisit()">
                        <i class="fas fa-check me-2"></i>Schedule Visit
                    </button>
                </div>

                <!-- Add to Route Section -->
                <div class="route-tab-content" id="addTab" style="display:none;">
                    <div class="route-form-group">
                        <label>Select Existing Route</label>
                        <select id="selectRouteDropdown">
                            <option value="">Select a route...</option>
                        </select>
                    </div>
                    <p class="route-hint"><i class="fas fa-info-circle"></i> Only planned routes are shown</p>
                    <button class="route-submit-btn route-submit-success" onclick="addToExistingRoute()">
                        <i class="fas fa-plus me-2"></i>Add to Route
                    </button>
                </div>

                <!-- Existing Visits -->
                <div class="route-existing" id="existingVisitsSection" style="display:none;">
                    <div class="route-existing-header">
                        <span>Scheduled Visits</span>
                        <button class="route-remove-all" onclick="deleteAllVisits()" id="deleteAllVisitsBtn">
                            <i class="fas fa-trash"></i> Remove All
                        </button>
                    </div>
                    <div id="existingVisitsList"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<style>
    :root {
        --primary-color: #6366f1;
        --primary-soft: #e0e7ff;
        --success-color: #10b981;
        --success-soft: #d1fae5;
        --warning-color: #f59e0b;
        --danger-color: #dc3545;
        --text-main: #111827;
        --text-muted: #6b7280;
        --border-color: #e5e7eb;
        --surface-bg: #f9fafb;
    }

    /* Main Layout */
    .prospecting-map-container {
        display: flex;
        height: calc(100vh - 60px);
        position: relative;
        margin: -1.5rem;
    }

    #map {
        flex: 1;
        height: 100%;
    }

    /* Sidebar */
    .map-sidebar {
        width: 380px;
        background: white;
        border-left: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        z-index: 10;
        transition: transform 0.3s ease;
    }

    /* Tab Header */
    .tab-header {
        display: flex;
        border-bottom: 1px solid var(--border-color);
        background: var(--surface-bg);
    }

    .tab-btn {
        flex: 1;
        padding: 1rem;
        text-align: center;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-muted);
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .tab-btn:hover {
        color: var(--text-main);
        background: white;
    }

    .tab-btn.active {
        background: white;
        color: var(--primary-color);
        border-bottom: 2px solid var(--primary-color);
        margin-bottom: -1px;
    }

    .tab-btn i {
        font-size: 1rem;
    }

    /* Tab Content */
    .tab-content {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    /* Stats Bar */
    .stats-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: linear-gradient(to bottom, white, var(--surface-bg));
        border-bottom: 1px solid var(--border-color);
    }

    .stats-text {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .btn-clear-filters {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border: 1px solid var(--border-color);
        background: white;
        border-radius: 4px;
        cursor: pointer;
        color: var(--text-muted);
    }

    .btn-clear-filters:hover {
        background: var(--surface-bg);
        color: var(--danger-color);
        border-color: var(--danger-color);
    }

    /* Filter Groups */
    .filter-group {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .filter-label {
        display: block;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
    }

    .filter-select {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.875rem;
        background: white;
        cursor: pointer;
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-soft);
    }

    /* Custom Dropdown */
    .custom-dropdown {
        position: relative;
    }

    .dropdown-trigger {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.875rem;
        background: white;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .dropdown-trigger:hover {
        border-color: var(--primary-color);
    }

    .dropdown-trigger.active {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-soft);
    }

    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        z-index: 1000;
        display: none;
        max-height: 300px;
        overflow: hidden;
        flex-direction: column;
    }

    .dropdown-menu.show {
        display: flex;
    }

    .dropdown-search {
        padding: 0.5rem;
        border-bottom: 1px solid var(--border-color);
    }

    .dropdown-search input {
        width: 100%;
        padding: 0.4rem 0.6rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.8rem;
    }

    .dropdown-options {
        overflow-y: auto;
        max-height: 250px;
    }

    .dropdown-option {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        font-size: 0.875rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .dropdown-option:hover {
        background: var(--primary-soft);
    }

    .dropdown-option.selected {
        background: var(--primary-soft);
        color: var(--primary-color);
        font-weight: 500;
    }

    .dropdown-option i {
        color: var(--primary-color);
    }

    /* Search Input */
    .search-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .search-input-wrapper i {
        position: absolute;
        left: 0.75rem;
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    .search-input-wrapper input {
        width: 100%;
        padding: 0.5rem 0.75rem 0.5rem 2.25rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.875rem;
    }

    .search-input-wrapper input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-soft);
    }

    .search-input-wrapper .btn-search {
        position: absolute;
        right: 4px;
        padding: 0.35rem 0.6rem;
        border: none;
        background: var(--primary-color);
        color: white;
        border-radius: 4px;
        cursor: pointer;
    }

    /* Google Search Box */
    .google-search-box {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        background: var(--surface-bg);
    }

    .btn-search-area {
        width: 100%;
        margin-top: 0.5rem;
        padding: 0.5rem;
        border: 1px dashed var(--border-color);
        background: white;
        border-radius: 6px;
        font-size: 0.8rem;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-search-area:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
        background: var(--primary-soft);
    }

    /* Results List */
    .results-list {
        flex: 1;
        overflow-y: auto;
    }

    .result-item {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        transition: background 0.15s;
    }

    .result-item:hover {
        background: var(--surface-bg);
    }

    .result-item.active {
        background: var(--primary-soft);
        border-left: 3px solid var(--primary-color);
    }

    .result-item.focused {
        background: linear-gradient(to right, var(--primary-soft), white);
        border-left: 4px solid var(--primary-color);
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
    }

    .focus-banner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .focus-banner button {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        cursor: pointer;
    }

    .focus-banner button:hover {
        background: rgba(255,255,255,0.3);
    }

    .result-item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .result-item-name {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text-main);
        margin: 0;
    }

    .result-item-badge {
        font-size: 0.65rem;
        padding: 0.2rem 0.5rem;
        border-radius: 9999px;
        font-weight: 600;
    }

    .badge-alert {
        background: #fee2e2;
        color: #b91c1c;
    }

    .badge-healthy {
        background: var(--success-soft);
        color: var(--success-color);
    }

    .badge-google {
        background: #e8f0fe;
        color: #1967d2;
    }

    .result-item-address {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin: 0.25rem 0 0 0;
    }

    .result-item-meta {
        display: flex;
        gap: 0.75rem;
        margin-top: 0.35rem;
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .result-item-meta span {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .result-item-actions {
        margin-top: 0.5rem;
        display: flex;
        gap: 0.5rem;
    }

    .btn-add-prospect {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border: 1px solid var(--primary-color);
        background: white;
        color: var(--primary-color);
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-add-prospect:hover {
        background: var(--primary-color);
        color: white;
    }

    .btn-add-prospect.added {
        background: var(--success-soft);
        border-color: var(--success-color);
        color: var(--success-color);
    }

    /* Empty/Loading State */
    .empty-state, .loading-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem 1rem;
        color: var(--text-muted);
        text-align: center;
    }

    .empty-state i, .loading-state i {
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .loading-state {
        flex-direction: row;
        gap: 0.75rem;
    }

    /* Results Actions */
    .results-actions {
        padding: 0.75rem 1rem;
        border-top: 1px solid var(--border-color);
        background: var(--surface-bg);
    }

    /* Mobile Toggle */
    .sidebar-toggle {
        display: none;
        position: absolute;
        right: 1rem;
        top: 1rem;
        z-index: 20;
        padding: 0.75rem;
        border: none;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        cursor: pointer;
    }

    /* Google Maps InfoWindow Styles */
    .gm-style-iw {
        max-width: 280px !important;
    }

    .info-window {
        padding: 0.5rem;
    }

    .info-window h6 {
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
        font-weight: 600;
    }

    .info-window p {
        margin: 0.25rem 0;
        font-size: 0.85rem;
        color: #666;
    }

    .info-window .btn-add {
        margin-top: 0.75rem;
        padding: 0.5rem 1rem;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        width: 100%;
    }

    .info-window .btn-add:hover {
        background: #4f46e5;
    }

    .info-window-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.75rem;
    }

    .info-window-actions .btn-add {
        flex: 1;
        margin-top: 0;
        padding: 0.4rem 0.5rem;
        font-size: 0.75rem;
    }

    .info-window .btn-route {
        background: #10b981;
    }

    .info-window .btn-route:hover {
        background: #059669;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .map-sidebar {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            transform: translateX(100%);
        }

        .map-sidebar.open {
            transform: translateX(0);
        }

        .sidebar-toggle {
            display: flex;
        }
    }

    /* Route Modal Styles */
    .route-modal {
        border: none;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    }

    .route-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 20px;
        background: #f1f5f9;
        color: #1e293b;
    }

    .route-modal-location {
        display: flex;
        gap: 12px;
        align-items: flex-start;
    }

    .route-modal-location > i {
        font-size: 1.25rem;
        margin-top: 2px;
        opacity: 0.9;
    }

    .route-modal-location h6 {
        margin: 0 0 4px 0;
        font-size: 1.125rem;
        font-weight: 600;
    }

    .route-modal-location p {
        margin: 0;
        font-size: 0.8125rem;
        color: #64748b;
    }

    .route-modal-close {
        background: rgba(0,0,0,0.05);
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 8px;
        color: #64748b;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .route-modal-close:hover {
        background: rgba(0,0,0,0.1);
    }

    .route-modal-body {
        padding: 20px;
    }

    .route-quick-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 20px;
    }

    .route-action-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 16px;
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .route-action-card i {
        font-size: 1.5rem;
        color: #64748b;
    }

    .route-action-card span {
        font-size: 0.8125rem;
        font-weight: 500;
        color: #475569;
    }

    .route-action-card:hover {
        border-color: #6366f1;
        background: #f5f3ff;
    }

    .route-action-card:hover i {
        color: #6366f1;
    }

    .route-action-card.active {
        border-color: #6366f1;
        background: #f5f3ff;
    }

    .route-action-card.active i {
        color: #6366f1;
    }

    .route-tab-content {
        animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .route-form-group {
        margin-bottom: 16px;
    }

    .route-form-group label {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
    }

    .route-form-group select,
    .route-form-group input {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        font-size: 0.9375rem;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .route-form-group select:focus,
    .route-form-group input:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .route-form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    .route-submit-btn {
        width: 100%;
        padding: 14px 20px;
        background: #6366f1;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 0.9375rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }

    .route-submit-btn:hover {
        background: #4f46e5;
    }

    .route-submit-success {
        background: #10b981;
    }

    .route-submit-success:hover {
        background: #059669;
    }

    .route-hint {
        font-size: 0.8125rem;
        color: #94a3b8;
        margin-top: -4px;
        margin-bottom: 16px;
    }

    .route-hint i {
        margin-right: 4px;
    }

    .route-existing {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e2e8f0;
    }

    .route-existing-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .route-existing-header span {
        font-size: 0.8125rem;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .route-remove-all {
        background: none;
        border: none;
        color: #ef4444;
        font-size: 0.75rem;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 6px;
    }

    .route-remove-all:hover {
        background: #fef2f2;
    }

    .route-visit-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        background: #f8fafc;
        border-radius: 8px;
        margin-bottom: 8px;
        font-size: 0.875rem;
    }

    .route-visit-item-info {
        color: #475569;
    }

    .route-visit-item-date {
        color: #94a3b8;
        font-size: 0.8125rem;
    }
</style>

<!-- MarkerClusterer -->
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

<script>
// Global variables
let map;
let infoWindow;
let customerMarkers = [];
let deliveryMarkers = []; // Markers for delivery addresses
let googleMarkers = [];
let clusterer;
let allCustomers = [];
let filteredCustomers = [];
let googleResults = [];
let currentTab = 'filter';
let selectedPlaceForProspect = null;
let routeLocationData = {}; // Store location data for route buttons
let routeLocationIndex = 0; // Counter for unique keys
let showDeliveryAddresses = true; // Toggle for delivery address markers
let focusedCompanyId = null; // Currently focused company (null = show all)

// Cache settings - shared with Companies page
const CACHE_KEY = 'companies_shared_cache';
const CACHE_TIME_KEY = 'companies_shared_cache_time';
const CACHE_DURATION = 10 * 60 * 1000; // 10 minutes

function isCacheValid() {
    const cachedTime = localStorage.getItem(CACHE_TIME_KEY);
    if (!cachedTime) return false;
    return (Date.now() - parseInt(cachedTime)) < CACHE_DURATION;
}

function getCachedData() {
    const cached = localStorage.getItem(CACHE_KEY);
    if (!cached) return null;
    try {
        return JSON.parse(cached);
    } catch (e) {
        return null;
    }
}

function setCachedData(data) {
    try {
        localStorage.setItem(CACHE_KEY, JSON.stringify(data));
        localStorage.setItem(CACHE_TIME_KEY, String(Date.now()));
    } catch (e) {
        console.warn('Failed to cache data:', e);
    }
}

// Route building mode (from URL param)
let activeRouteId = new URLSearchParams(window.location.search).get('route_id') || null;

// Initialize Map
function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 50.8503, lng: 4.3517 }, // Belgium
        zoom: 8,
        styles: [
            { featureType: "poi", stylers: [{ visibility: "off" }] },
            { featureType: "transit", stylers: [{ visibility: "off" }] }
        ],
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true
    });

    infoWindow = new google.maps.InfoWindow();

    // If route_id param present, show the route building banner
    if (activeRouteId) {
        initRouteBuildMode(activeRouteId);
    }

    // Load customers
    loadCustomers();
}

async function initRouteBuildMode(routeId) {
    try {
        const response = await fetch(`/api/trips/${routeId}`);
        const data = await response.json();
        if (data.success && data.trip) {
            document.getElementById('routeBuildName').textContent = data.trip.name;
            document.getElementById('routeBuildBanner').style.display = 'flex';
        }
    } catch (e) {
        console.error('Failed to load route for build mode:', e);
    }
}

// Load customers from API (with caching)
async function loadCustomers(forceRefresh = false) {
    try {
        // Check cache first
        const cachedData = !forceRefresh ? getCachedData() : null;

        if (cachedData && isCacheValid()) {
            console.log('ðŸ“¦ Using cached customer data');
            allCustomers = cachedData.companies || [];
            filteredCustomers = [...allCustomers];

            document.getElementById('total-count').textContent = allCustomers.length;
            populateCategoryFilter();
            updateCustomerMarkers();
            updateCustomerList();
            updateDeliveryStats();
            return;
        }

        // Fetch fresh data
        console.log('ðŸ”„ Fetching fresh customer data...');
        document.getElementById('customerList').innerHTML = `
            <div class="loading-state">
                <div class="spinner-border spinner-border-sm text-primary"></div>
                <span>Loading customers...</span>
            </div>
        `;

        const response = await fetch('/api/companies-from-db?year=combined');
        const data = await response.json();

        // Cache the data
        setCachedData(data);

        allCustomers = data.companies || [];
        filteredCustomers = [...allCustomers];

        // Update stats
        document.getElementById('total-count').textContent = allCustomers.length;

        // Populate category filter
        populateCategoryFilter();

        // Display on map and list
        updateCustomerMarkers();
        updateCustomerList();
        updateDeliveryStats();

    } catch (error) {
        console.error('Error loading customers:', error);
        document.getElementById('customerList').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle fa-2x"></i>
                <p>Failed to load customers</p>
            </div>
        `;
    }
}

// Track selected category
let selectedCategory = '';
let allCategoryOptions = [];

// Populate category filter
function populateCategoryFilter() {
    const categories = new Set();

    allCustomers.forEach(c => {
        let cats = c.company_categories;
        if (typeof cats === 'string') {
            try {
                cats = JSON.parse(cats);
            } catch (e) {
                if (cats.includes(',')) {
                    cats = cats.split(',').map(s => s.trim());
                } else if (cats.trim()) {
                    cats = [cats.trim()];
                } else {
                    cats = [];
                }
            }
        }

        if (cats && Array.isArray(cats)) {
            cats.forEach(cat => {
                let catName = cat;
                if (typeof cat === 'object' && cat !== null) {
                    catName = cat.name || cat.category_name || cat.label || '';
                }
                if (catName && typeof catName === 'string' && catName.trim()) {
                    categories.add(catName.trim());
                }
            });
        }
    });

    allCategoryOptions = [...categories].sort();
    renderCategoryOptions(allCategoryOptions);
    console.log(`ðŸ“‚ Populated ${categories.size} categories`);
}

// Render category options
function renderCategoryOptions(categories) {
    const container = document.getElementById('categoryOptions');
    if (!container) return;

    let html = `
        <div class="dropdown-option ${!selectedCategory ? 'selected' : ''}" onclick="selectCategory('')">
            <span>All categories</span>
            ${!selectedCategory ? '<i class="fas fa-check"></i>' : ''}
        </div>
    `;

    categories.forEach(cat => {
        const isSelected = selectedCategory === cat;
        html += `
            <div class="dropdown-option ${isSelected ? 'selected' : ''}" onclick="selectCategory('${cat.replace(/'/g, "\\'")}')">
                <span>${cat}</span>
                ${isSelected ? '<i class="fas fa-check"></i>' : ''}
            </div>
        `;
    });

    container.innerHTML = html;
}

// Toggle category dropdown
function toggleCategoryDropdown() {
    const menu = document.getElementById('categoryDropdownMenu');
    const trigger = document.querySelector('#categoryDropdown .dropdown-trigger');
    menu.classList.toggle('show');
    trigger.classList.toggle('active');
    if (menu.classList.contains('show')) {
        document.getElementById('categorySearchInput').focus();
    }
}

// Select a category
function selectCategory(cat) {
    selectedCategory = cat;
    document.getElementById('categoryTriggerText').textContent = cat || 'All categories';
    document.getElementById('categoryDropdownMenu').classList.remove('show');
    document.querySelector('#categoryDropdown .dropdown-trigger').classList.remove('active');
    renderCategoryOptions(allCategoryOptions);
    filterCustomers();
}

// Filter category options by search
function filterCategoryOptions(searchTerm) {
    const filtered = allCategoryOptions.filter(cat =>
        cat.toLowerCase().includes(searchTerm.toLowerCase())
    );
    renderCategoryOptions(filtered);
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('categoryDropdown');
    if (dropdown && !dropdown.contains(e.target)) {
        document.getElementById('categoryDropdownMenu')?.classList.remove('show');
        document.querySelector('#categoryDropdown .dropdown-trigger')?.classList.remove('active');
    }
});

// Filter customers
function filterCustomers() {
    const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
    const category = selectedCategory;
    const alertType = document.getElementById('alertFilter').value;
    const salesperson = document.getElementById('salespersonFilter').value;

    filteredCustomers = allCustomers.filter(company => {
        // Search filter
        if (searchTerm) {
            const name = (company.name || '').toLowerCase();
            const publicName = (company.public_name || '').toLowerCase();
            const city = (company.address?.city || '').toLowerCase();
            if (!name.includes(searchTerm) && !publicName.includes(searchTerm) && !city.includes(searchTerm)) {
                return false;
            }
        }

        // Category filter
        if (category) {
            let cats = company.company_categories || [];
            // Parse if it's a JSON string
            if (typeof cats === 'string') {
                try {
                    cats = JSON.parse(cats);
                } catch (e) {
                    if (cats.includes(',')) {
                        cats = cats.split(',').map(s => s.trim());
                    } else if (cats.trim()) {
                        cats = [cats.trim()];
                    } else {
                        cats = [];
                    }
                }
            }
            if (!Array.isArray(cats)) cats = [];
            // Handle both string categories and object categories with 'name' property
            const hasCat = cats.some(cat => {
                let catName = cat;
                if (typeof cat === 'object' && cat !== null) {
                    catName = cat.name || cat.category_name || cat.label || '';
                }
                return catName === category;
            });
            if (!hasCat) return false;
        }

        // Alert filter
        if (alertType) {
            const alerts = company.alerts || [];
            if (alertType === 'any') {
                if (alerts.length === 0) return false;
            } else {
                if (!alerts.some(a => a.type === alertType)) return false;
            }
        }

        // Salesperson filter
        if (salesperson) {
            if (salesperson === 'unassigned') {
                if (company.assigned_salesperson) return false;
            } else {
                if (company.assigned_salesperson !== salesperson) return false;
            }
        }

        return true;
    });

    document.getElementById('filtered-count').textContent = filteredCustomers.length;
    updateCustomerMarkers();
    updateCustomerList();
    updateDeliveryStats();
}

// Clear all filters
function clearAllFilters() {
    // Clear focus if any
    if (focusedCompanyId) {
        focusedCompanyId = null;
        document.getElementById('focusBanner').style.display = 'none';
    }

    document.getElementById('customerSearch').value = '';
    selectedCategory = '';
    document.getElementById('categoryTriggerText').textContent = 'All categories';
    renderCategoryOptions(allCategoryOptions);
    document.getElementById('alertFilter').value = '';
    document.getElementById('salespersonFilter').value = '';
    filterCustomers();
}

// Toggle delivery address markers
function toggleDeliveryMarkers() {
    showDeliveryAddresses = document.getElementById('deliveryToggle').checked;
    updateCustomerMarkers();
    updateDeliveryStats();
}

// Update delivery stats display
function updateDeliveryStats() {
    let deliveryCount = 0;
    filteredCustomers.forEach(company => {
        if (company.addresses && Array.isArray(company.addresses)) {
            deliveryCount += company.addresses.filter(a => a.latitude && a.longitude).length;
        }
    });

    const badge = document.getElementById('delivery-count-badge');
    const countEl = document.getElementById('delivery-count');

    if (deliveryCount > 0 && showDeliveryAddresses) {
        badge.style.display = 'inline';
        countEl.textContent = deliveryCount;
    } else {
        badge.style.display = 'none';
    }
}

// Update customer markers on map
function updateCustomerMarkers() {
    // Clear existing
    customerMarkers.forEach(m => m.setMap(null));
    customerMarkers = [];

    // Clear delivery markers
    deliveryMarkers.forEach(m => m.setMap(null));
    deliveryMarkers = [];

    if (clusterer) {
        clusterer.clearMarkers();
    }

    const bounds = new google.maps.LatLngBounds();
    let validCount = 0;

    // Determine which companies to show
    const companiesToShow = focusedCompanyId
        ? filteredCustomers.filter(c => c.company_id === focusedCompanyId)
        : filteredCustomers;

    companiesToShow.forEach(company => {
        const lat = parseFloat(company.latitude);
        const lng = parseFloat(company.longitude);

        if (!lat || !lng || isNaN(lat) || isNaN(lng)) return;

        validCount++;
        const position = { lat, lng };
        bounds.extend(position);

        const hasAlerts = company.alerts && company.alerts.length > 0;
        const isFocused = focusedCompanyId === company.company_id;

        // Create marker - larger when focused
        const displayName = company.public_name || company.name;
        const marker = new google.maps.Marker({
            position,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: isFocused ? 14 : 10,
                fillColor: hasAlerts ? '#dc3545' : '#10b981',
                fillOpacity: 1,
                strokeColor: isFocused ? '#000' : 'white',
                strokeWeight: isFocused ? 3 : 2
            },
            title: displayName,
            zIndex: isFocused ? 1000 : 1
        });

        marker.addListener('click', () => {
            showCustomerInfoWindow(company, marker);
        });

        customerMarkers.push(marker);

        // Add delivery address markers if enabled
        if (showDeliveryAddresses && company.addresses && Array.isArray(company.addresses)) {
            company.addresses.forEach((addr, addrIndex) => {
                const addrLat = parseFloat(addr.latitude);
                const addrLng = parseFloat(addr.longitude);

                if (!addrLat || !addrLng || isNaN(addrLat) || isNaN(addrLng)) return;

                // Skip if same location as main company marker
                if (Math.abs(addrLat - lat) < 0.0001 && Math.abs(addrLng - lng) < 0.0001) return;

                const addrPosition = { lat: addrLat, lng: addrLng };
                bounds.extend(addrPosition);

                // Delivery markers - larger square markers with truck icon simulation
                const addrMarker = new google.maps.Marker({
                    position: addrPosition,
                    map: map,
                    icon: {
                        path: 'M-8,-8 L8,-8 L8,8 L-8,8 Z', // Square shape
                        scale: 1,
                        fillColor: '#6366f1',
                        fillOpacity: 1,
                        strokeColor: '#fff',
                        strokeWeight: 2,
                        anchor: new google.maps.Point(0, 0)
                    },
                    label: {
                        text: 'ðŸ“¦',
                        fontSize: '14px'
                    },
                    title: `${displayName} - Delivery`,
                    zIndex: isFocused ? 999 : 2
                });

                addrMarker.addListener('click', () => {
                    showDeliveryInfoWindow(company, addr, addrMarker, addrIndex);
                });

                deliveryMarkers.push(addrMarker);
            });
        }
    });

    // Add clustering using the markerClusterer library
    if (typeof markerClusterer !== 'undefined' && markerClusterer.MarkerClusterer) {
        clusterer = new markerClusterer.MarkerClusterer({
            map,
            markers: customerMarkers,
            renderer: {
                render: ({ count, position }) => {
                    const color = count > 10 ? '#f59e0b' : '#6366f1';
                    return new google.maps.Marker({
                        position,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 20 + Math.min(count, 50) / 5,
                            fillColor: color,
                            fillOpacity: 0.9,
                            strokeColor: 'white',
                            strokeWeight: 3
                        },
                        label: {
                            text: String(count),
                            color: 'white',
                            fontWeight: 'bold',
                            fontSize: '12px'
                        },
                        zIndex: Number(google.maps.Marker.MAX_ZINDEX) + count
                    });
                }
            }
        });
    } else {
        // Fallback: add markers directly without clustering
        customerMarkers.forEach(m => m.setMap(map));
    }

    // Fit bounds
    if (validCount > 0) {
        map.fitBounds(bounds, { padding: 50 });
        if (map.getZoom() > 14) map.setZoom(14);
    }
}

// Show delivery address info window
function showDeliveryInfoWindow(company, address, marker, addrIndex) {
    const displayName = company.public_name || company.name;
    const addressLine = [
        address.street_1,
        address.postal_code,
        address.city
    ].filter(Boolean).join(', ') || 'No address details';

    // Store location data for route scheduling
    const routeKey = `delivery_${company.company_id}_${addrIndex}`;
    routeLocationData[routeKey] = {
        name: `${displayName} - Delivery`,
        address: addressLine,
        lat: address.latitude,
        lng: address.longitude,
        company_id: company.company_id
    };

    const content = `
        <div class="info-window">
            <h6><i class="fas fa-truck" style="color:#6366f1;margin-right:6px"></i>${escapeHtml(displayName)}</h6>
            <p style="font-size:0.75rem;color:#6366f1;margin:0 0 0.5rem 0;font-weight:500">DELIVERY LOCATION</p>
            <p><i class="fas fa-map-marker-alt"></i> ${escapeHtml(addressLine)}</p>
            ${address.name ? `<p><i class="fas fa-tag"></i> ${escapeHtml(address.name)}</p>` : ''}
            <div class="info-window-actions">
                <button class="btn-add" onclick="window.location='/data?company=${company.company_id}'">
                    <i class="fas fa-eye"></i> View
                </button>
                <button class="btn-add btn-route" onclick="openRouteModal('${routeKey}', false)">
                    <i class="fas fa-route"></i> Route
                </button>
            </div>
        </div>
    `;

    infoWindow.setContent(content);
    infoWindow.open(map, marker);
}

// Show customer info window
function showCustomerInfoWindow(company, marker) {
    const hasAlerts = company.alerts && company.alerts.length > 0;
    const alertBadges = hasAlerts ? company.alerts.map(a =>
        `<span class="badge bg-danger">${getAlertLabel(a.type)}</span>`
    ).join(' ') : '';
    const displayName = company.public_name || company.name;

    // Store location data for route scheduling (avoids JSON escaping issues)
    const routeKey = `company_${company.company_id}`;
    routeLocationData[routeKey] = {
        name: displayName,
        address: company.address?.line1 || company.address?.city || '',
        lat: company.latitude,
        lng: company.longitude,
        company_id: company.company_id
    };

    const locationText = getCompanyLocation(company);
    const deliveryCount = (company.addresses && Array.isArray(company.addresses)) ? company.addresses.filter(a => a.latitude && a.longitude).length : 0;

    const content = `
        <div class="info-window">
            <h6>${escapeHtml(displayName)}</h6>
            <p><i class="fas fa-map-marker-alt"></i> ${escapeHtml(locationText)}</p>
            ${deliveryCount > 0 ? `<p><i class="fas fa-truck" style="color:#6366f1"></i> ${deliveryCount} delivery location${deliveryCount > 1 ? 's' : ''}</p>` : ''}
            ${company.assigned_salesperson ? `<p><i class="fas fa-user"></i> ${escapeHtml(company.assigned_salesperson)}</p>` : ''}
            ${alertBadges ? `<div style="margin-top:0.5rem">${alertBadges}</div>` : ''}
            <div class="info-window-actions">
                <button class="btn-add" onclick="window.location='/data?company=${company.company_id}'">
                    <i class="fas fa-eye"></i> View
                </button>
                <button class="btn-add btn-route" onclick="openRouteModal('${routeKey}', false)">
                    <i class="fas fa-route"></i> Route
                </button>
            </div>
        </div>
    `;

    infoWindow.setContent(content);
    infoWindow.open(map, marker);
}

// Update customer list in sidebar
function updateCustomerList() {
    const container = document.getElementById('customerList');

    if (filteredCustomers.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-building fa-2x"></i>
                <p>No customers match your filters</p>
            </div>
        `;
        return;
    }

    // Show first 100 for performance
    const displayCustomers = filteredCustomers.slice(0, 100);

    container.innerHTML = displayCustomers.map(company => {
        const hasAlerts = company.alerts && company.alerts.length > 0;
        const badgeClass = hasAlerts ? 'badge-alert' : 'badge-healthy';
        const badgeText = hasAlerts ? 'Alert' : 'Healthy';
        const displayName = company.public_name || company.name;
        const locationText = getCompanyLocation(company);
        const deliveryCount = (company.addresses && Array.isArray(company.addresses)) ? company.addresses.filter(a => a.latitude && a.longitude).length : 0;

        const isFocused = focusedCompanyId === company.company_id;
        return `
            <div class="result-item ${isFocused ? 'focused' : ''}" data-company-id="${company.company_id}" onclick="focusCustomer(${company.company_id})">
                <div class="result-item-header">
                    <h6 class="result-item-name">${escapeHtml(displayName)}</h6>
                    <span class="result-item-badge ${badgeClass}">${badgeText}</span>
                </div>
                <p class="result-item-address">${escapeHtml(locationText)}${deliveryCount > 0 ? ` <span style="color:#6366f1;font-size:0.7rem"><i class="fas fa-truck"></i> +${deliveryCount}</span>` : ''}</p>
                <div class="result-item-meta">
                    ${company.total_revenue ? `<span><i class="fas fa-euro-sign"></i> ${formatCurrency(company.total_revenue)}</span>` : ''}
                    ${company.assigned_salesperson ? `<span><i class="fas fa-user"></i> ${escapeHtml(company.assigned_salesperson)}</span>` : ''}
                </div>
            </div>
        `;
    }).join('');

    if (filteredCustomers.length > 100) {
        container.innerHTML += `
            <div class="empty-state" style="padding: 1rem;">
                <small>Showing 100 of ${filteredCustomers.length} results</small>
            </div>
        `;
    }
}

// Focus on a customer
function focusCustomer(companyId) {
    const company = filteredCustomers.find(c => c.company_id === companyId);
    if (!company || !company.latitude || !company.longitude) return;

    // Set focused company
    focusedCompanyId = companyId;

    // Show focus banner
    const displayName = company.public_name || company.name;
    document.getElementById('focusBanner').style.display = 'flex';
    document.getElementById('focusedCompanyName').textContent = displayName;

    // Rebuild markers to show only this company
    updateCustomerMarkers();
    updateDeliveryStats();

    // Fit bounds to show all locations for this company
    const bounds = new google.maps.LatLngBounds();
    bounds.extend({ lat: parseFloat(company.latitude), lng: parseFloat(company.longitude) });

    // Include delivery addresses in bounds
    if (company.addresses && Array.isArray(company.addresses)) {
        company.addresses.forEach(addr => {
            if (addr.latitude && addr.longitude) {
                bounds.extend({ lat: parseFloat(addr.latitude), lng: parseFloat(addr.longitude) });
            }
        });
    }

    map.fitBounds(bounds, { padding: 100 });
    if (map.getZoom() > 16) map.setZoom(16);

    // Find and click the marker
    const marker = customerMarkers.find(m => m.getTitle() === displayName);
    if (marker) {
        showCustomerInfoWindow(company, marker);
    }

    // Update sidebar to highlight selected
    updateCustomerListHighlight(companyId);
}

// Clear focus and show all companies
function clearCompanyFocus() {
    focusedCompanyId = null;

    // Hide focus banner
    document.getElementById('focusBanner').style.display = 'none';

    updateCustomerMarkers();
    updateCustomerListHighlight(null);
    updateDeliveryStats();

    // Fit to all markers
    const bounds = new google.maps.LatLngBounds();
    filteredCustomers.forEach(company => {
        if (company.latitude && company.longitude) {
            bounds.extend({ lat: parseFloat(company.latitude), lng: parseFloat(company.longitude) });
        }
    });
    if (!bounds.isEmpty()) {
        map.fitBounds(bounds, { padding: 50 });
        if (map.getZoom() > 14) map.setZoom(14);
    }
}

// Update sidebar highlight
function updateCustomerListHighlight(companyId) {
    document.querySelectorAll('.result-item').forEach(item => {
        item.classList.remove('focused');
    });
    if (companyId) {
        const focusedItem = document.querySelector(`.result-item[data-company-id="${companyId}"]`);
        if (focusedItem) {
            focusedItem.classList.add('focused');
        }
    }
}

// Tab switching
function switchTab(tab) {
    currentTab = tab;

    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
    });

    document.getElementById('filter-panel').style.display = tab === 'filter' ? 'flex' : 'none';
    document.getElementById('google-panel').style.display = tab === 'google' ? 'flex' : 'none';

    // Clear Google markers when switching to filter
    if (tab === 'filter') {
        clearGoogleMarkers();
    }
}

// Search Google Places
async function searchGooglePlaces(preserveZoom = false) {
    const query = document.getElementById('googleSearchInput').value.trim();
    if (!query) return;

    const bounds = map.getBounds();
    const boundsData = bounds ? {
        north: bounds.getNorthEast().lat(),
        south: bounds.getSouthWest().lat(),
        east: bounds.getNorthEast().lng(),
        west: bounds.getSouthWest().lng()
    } : null;

    document.getElementById('googleResultsList').innerHTML = `
        <div class="loading-state">
            <div class="spinner-border spinner-border-sm text-primary"></div>
            <span>Searching...</span>
        </div>
    `;

    try {
        const response = await fetch('/api/places/search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query, bounds: boundsData })
        });

        const data = await response.json();

        if (data.error) {
            throw new Error(data.error);
        }

        googleResults = data.results || [];
        displayGoogleResults();
        updateGoogleMarkers(preserveZoom);

    } catch (error) {
        console.error('Search error:', error);
        document.getElementById('googleResultsList').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle fa-2x"></i>
                <p>Search failed: ${error.message}</p>
            </div>
        `;
    }
}

// Search in current map area
function searchInCurrentArea() {
    const query = document.getElementById('googleSearchInput').value.trim();
    if (!query) {
        alert('Please enter a search term first');
        return;
    }
    // Pass true to indicate we should preserve the current zoom/position
    searchGooglePlaces(true);
}

// Display Google results
function displayGoogleResults() {
    const container = document.getElementById('googleResultsList');
    const actionsContainer = document.getElementById('googleResultsActions');

    if (googleResults.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-search fa-2x"></i>
                <p>No places found</p>
            </div>
        `;
        actionsContainer.style.display = 'none';
        return;
    }

    actionsContainer.style.display = 'block';

    container.innerHTML = googleResults.map((place, index) => `
        <div class="result-item" onclick="focusGooglePlace(${index})">
            <div class="result-item-header">
                <h6 class="result-item-name">${escapeHtml(place.name)}</h6>
                <span class="result-item-badge badge-google">Google</span>
            </div>
            <p class="result-item-address">${escapeHtml(place.formatted_address || place.vicinity || '')}</p>
            <div class="result-item-meta">
                ${place.rating ? `<span><i class="fas fa-star" style="color:#f59e0b"></i> ${place.rating}</span>` : ''}
                ${place.user_ratings_total ? `<span>(${place.user_ratings_total} reviews)</span>` : ''}
            </div>
            <div class="result-item-actions">
                <button class="btn-add-prospect" id="add-btn-${index}" onclick="event.stopPropagation(); showAddProspectModal(${index})">
                    <i class="fas fa-plus"></i> Add as Prospect
                </button>
            </div>
        </div>
    `).join('');
}

// Update Google markers on map
function updateGoogleMarkers(preserveZoom = false) {
    clearGoogleMarkers();

    const bounds = new google.maps.LatLngBounds();

    googleResults.forEach((place, index) => {
        if (!place.geometry?.location) return;

        const position = {
            lat: place.geometry.location.lat,
            lng: place.geometry.location.lng
        };
        bounds.extend(position);

        const marker = new google.maps.Marker({
            position,
            map,
            icon: {
                url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'
            },
            title: place.name
        });

        marker.addListener('click', () => {
            showGooglePlaceInfoWindow(place, marker, index);
        });

        googleMarkers.push(marker);
    });

    // Only fit bounds if not preserving zoom (e.g., when using "Search this area")
    if (googleResults.length > 0 && !preserveZoom) {
        map.fitBounds(bounds, { padding: 50 });
    }
}

// Clear Google markers
function clearGoogleMarkers() {
    googleMarkers.forEach(m => m.setMap(null));
    googleMarkers = [];
}

// Show Google place info window
function showGooglePlaceInfoWindow(place, marker, index) {
    // Store location data for route scheduling (avoids JSON escaping issues)
    const routeKey = `google_${index}`;
    routeLocationData[routeKey] = {
        name: place.name,
        address: place.formatted_address || place.vicinity || '',
        lat: place.geometry?.location?.lat,
        lng: place.geometry?.location?.lng,
        place_id: place.place_id
    };

    const content = `
        <div class="info-window">
            <h6>${escapeHtml(place.name)}</h6>
            <p><i class="fas fa-map-marker-alt"></i> ${escapeHtml(place.formatted_address || place.vicinity || '')}</p>
            ${place.rating ? `<p><i class="fas fa-star" style="color:#f59e0b"></i> ${place.rating} (${place.user_ratings_total || 0} reviews)</p>` : ''}
            <div class="info-window-actions">
                <button class="btn-add" onclick="showAddProspectModal(${index})">
                    <i class="fas fa-plus"></i> Prospect
                </button>
                <button class="btn-add btn-route" onclick="openRouteModal('${routeKey}', true)">
                    <i class="fas fa-route"></i> Route
                </button>
            </div>
        </div>
    `;

    infoWindow.setContent(content);
    infoWindow.open(map, marker);
}

// Focus on a Google place
function focusGooglePlace(index) {
    const place = googleResults[index];
    if (!place?.geometry?.location) return;

    map.setCenter({
        lat: place.geometry.location.lat,
        lng: place.geometry.location.lng
    });
    map.setZoom(17);

    const marker = googleMarkers[index];
    if (marker) {
        showGooglePlaceInfoWindow(place, marker, index);
    }
}

// Clear Google results
function clearGoogleResults() {
    googleResults = [];
    clearGoogleMarkers();
    document.getElementById('googleResultsList').innerHTML = `
        <div class="empty-state">
            <i class="fab fa-google fa-2x"></i>
            <p>Search for businesses to find new prospects</p>
        </div>
    `;
    document.getElementById('googleResultsActions').style.display = 'none';
}

// Show add prospect modal
function showAddProspectModal(index) {
    const place = googleResults[index];
    if (!place) return;

    selectedPlaceForProspect = { ...place, index };

    document.getElementById('prospectModalBody').innerHTML = `
        <div class="mb-3">
            <label class="form-label fw-bold">Business Name</label>
            <input type="text" class="form-control" id="prospectName" value="${escapeHtml(place.name)}">
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">Address</label>
            <input type="text" class="form-control" id="prospectAddress" value="${escapeHtml(place.formatted_address || place.vicinity || '')}">
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">Notes</label>
            <textarea class="form-control" id="prospectNotes" rows="3" placeholder="Add any notes about this prospect..."></textarea>
        </div>
        <div class="alert alert-info small">
            <i class="fas fa-info-circle me-2"></i>
            This will add the business to your prospects list for follow-up.
        </div>
    `;

    const modal = new bootstrap.Modal(document.getElementById('prospectModal'));
    modal.show();
}

// Save prospect
async function saveProspect() {
    if (!selectedPlaceForProspect) return;

    const place = selectedPlaceForProspect;
    const name = document.getElementById('prospectName').value.trim();
    const address = document.getElementById('prospectAddress').value.trim();
    const notes = document.getElementById('prospectNotes').value.trim();

    if (!name) {
        alert('Business name is required');
        return;
    }

    const saveBtn = document.getElementById('saveProspectBtn');
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

    try {
        const prospectData = {
            name,
            address,
            google_place_id: place.place_id,
            search_query: document.getElementById('googleSearchInput').value,
            enriched_data: {
                latitude: place.geometry?.location?.lat,
                longitude: place.geometry?.location?.lng,
                rating: place.rating,
                user_ratings_total: place.user_ratings_total,
                types: place.types,
                source: 'google_places'
            }
        };

        if (notes) {
            prospectData.notes = notes;
        }

        const response = await fetch('/api/prospects', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(prospectData)
        });

        const result = await response.json();

        if (result.error) {
            throw new Error(result.error);
        }

        // Update button state
        const addBtn = document.getElementById(`add-btn-${place.index}`);
        if (addBtn) {
            addBtn.classList.add('added');
            addBtn.innerHTML = '<i class="fas fa-check"></i> Added';
            addBtn.disabled = true;
        }

        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('prospectModal')).hide();

        // Show success
        showToast('Prospect added successfully!', 'success');

    } catch (error) {
        console.error('Error saving prospect:', error);
        showToast('Failed to save prospect: ' + error.message, 'error');
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-plus me-2"></i>Add as Prospect';
    }
}

// Toggle sidebar (mobile)
function toggleSidebar() {
    document.getElementById('mapSidebar').classList.toggle('open');
}

// Helper functions
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatCurrency(value) {
    return new Intl.NumberFormat('en-EU', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 0
    }).format(value || 0);
}

function getAlertLabel(type) {
    const labels = {
        'PATTERN_DISRUPTION': 'Pattern Break',
        'HIGH_VALUE_AT_RISK': 'High Value Risk',
        'DORMANT_CUSTOMER': 'Dormant',
        'DECLINING_VALUE': 'Declining',
        'INCREASING_GAP': 'Less Frequent',
        'ONE_TIME_CUSTOMER': 'One-Timer'
    };
    return labels[type] || type;
}

// Get the best available location text for a company
function getCompanyLocation(company) {
    // Try address.city first (main company address)
    if (company.address?.city) {
        return company.address.city;
    }

    // Try addresses array (delivery locations)
    if (company.addresses && Array.isArray(company.addresses) && company.addresses.length > 0) {
        const firstAddr = company.addresses[0];
        if (firstAddr.city) return firstAddr.city;
        if (firstAddr.postal_code) return firstAddr.postal_code;
    }

    // Try raw_company_data.invoice_address
    if (company.raw_company_data?.invoice_address?.city) {
        return company.raw_company_data.invoice_address.city;
    }

    // Try to build from address parts
    if (company.address) {
        if (company.address.postal_code) return company.address.postal_code;
        if (company.address.line1) return company.address.line1;
    }

    return 'No location';
}

function showToast(message, type = 'info') {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : 'success'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'} me-2"></i>
        ${message}
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// =====================================================
// ROUTE SCHEDULING FUNCTIONS
// =====================================================

let selectedRouteLocation = null;

// Open route modal using stored location data (avoids JSON escaping issues in onclick)
function openRouteModal(routeKey, isGooglePlace) {
    const location = routeLocationData[routeKey];
    if (!location) {
        console.error('Route location not found:', routeKey);
        showToast('Error: Location data not found', 'error');
        return;
    }
    showRouteSelectorModal(location, isGooglePlace);
}

// Show route selector modal
function showRouteTab(tab) {
    // Update action cards
    document.querySelectorAll('.route-action-card').forEach(card => card.classList.remove('active'));
    event.target.closest('.route-action-card')?.classList.add('active');

    // Show/hide tab content
    document.getElementById('scheduleTab').style.display = tab === 'schedule' ? 'block' : 'none';
    document.getElementById('addTab').style.display = tab === 'add' ? 'block' : 'none';
}

async function showRouteSelectorModal(location, isGooglePlace = false) {
    selectedRouteLocation = {
        name: location.name || location.company_name || 'Unknown',
        address: location.address || location.formatted_address || location.vicinity || '',
        lat: location.lat || location.latitude || (location.geometry?.location?.lat),
        lng: location.lng || location.longitude || (location.geometry?.location?.lng),
        company_id: location.company_id || null,
        google_place_id: location.place_id || null,
        isGooglePlace: isGooglePlace
    };

    // Update modal content
    document.getElementById('routeLocationName').textContent = selectedRouteLocation.name;
    document.getElementById('routeLocationAddress').textContent = selectedRouteLocation.address || 'No address available';

    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('scheduleVisitDate').value = today;

    // Default to "Add to Route" tab if actively building a route, otherwise "Schedule Visit"
    if (activeRouteId) {
        document.getElementById('scheduleTab').style.display = 'none';
        document.getElementById('addTab').style.display = 'block';
        document.querySelectorAll('.route-action-card').forEach((card, i) => {
            card.classList.toggle('active', i === 1);
        });
    } else {
        document.getElementById('scheduleTab').style.display = 'block';
        document.getElementById('addTab').style.display = 'none';
        document.querySelectorAll('.route-action-card').forEach((card, i) => {
            card.classList.toggle('active', i === 0);
        });
    }

    // Show modal FIRST, then populate dropdown while visible
    // (browsers don't re-render <select> changes inside display:none containers)
    const modalEl = document.getElementById('routeSelectorModal');
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();

    // Load data after modal is visible so browser renders the dropdown correctly
    await loadAvailableRoutes();
    await loadExistingVisits();
}

// Load available routes for dropdown
async function loadAvailableRoutes() {
    const dropdown = document.getElementById('selectRouteDropdown');
    if (!dropdown) {
        console.error('selectRouteDropdown element not found');
        return;
    }

    console.log('Fetching planned routes...');

    try {
        const response = await fetch('/api/trips?status=planned');

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('Routes loaded:', data);

        // Clear and rebuild dropdown
        while (dropdown.firstChild) {
            dropdown.removeChild(dropdown.firstChild);
        }

        // Add default option
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = 'Select a route...';
        dropdown.appendChild(defaultOpt);

        if (data.success && data.trips && data.trips.length > 0) {
            console.log(`Adding ${data.trips.length} routes to dropdown`);
            data.trips.forEach(trip => {
                const date = trip.trip_date ? new Date(trip.trip_date).toLocaleDateString('en-GB', {
                    day: 'numeric', month: 'short'
                }) : 'No date';
                const option = document.createElement('option');
                option.value = trip.id;
                option.textContent = `${trip.name} (${date})`;
                dropdown.appendChild(option);
            });
            // Auto-select route if activeRouteId is set, or if only one route
            if (activeRouteId) {
                dropdown.value = activeRouteId;
            } else if (data.trips.length === 1) {
                dropdown.value = data.trips[0].id;
            }
        } else {
            const option = document.createElement('option');
            option.value = '';
            option.disabled = true;
            option.textContent = 'No planned routes available';
            dropdown.appendChild(option);
        }
    } catch (error) {
        console.error('Error loading routes:', error);
        while (dropdown.firstChild) {
            dropdown.removeChild(dropdown.firstChild);
        }
        const errorOpt = document.createElement('option');
        errorOpt.value = '';
        errorOpt.textContent = 'Error loading routes';
        dropdown.appendChild(errorOpt);
    }
}

// Load existing visits for this location
async function loadExistingVisits() {
    const section = document.getElementById('existingVisitsSection');
    const container = document.getElementById('existingVisitsList');
    const deleteBtn = document.getElementById('deleteAllVisitsBtn');

    try {
        let url = '/api/trips/for-location?';
        if (selectedRouteLocation.company_id) {
            url += `company_id=${selectedRouteLocation.company_id}`;
        } else if (selectedRouteLocation.lat && selectedRouteLocation.lng) {
            url += `lat=${selectedRouteLocation.lat}&lng=${selectedRouteLocation.lng}`;
        } else {
            section.style.display = 'none';
            return;
        }

        const response = await fetch(url);
        const data = await response.json();

        if (data.trips && data.trips.length > 0) {
            section.style.display = 'block';
            container.innerHTML = data.trips.map(trip => {
                const date = trip.date ? new Date(trip.date).toLocaleDateString('en-GB', {
                    day: 'numeric', month: 'short', year: 'numeric'
                }) : '';
                return `
                    <div class="route-visit-item">
                        <div>
                            <div class="route-visit-item-info">${escapeHtml(trip.name)}</div>
                            <div class="route-visit-item-date">${date}${trip.salesperson ? ` - ${escapeHtml(trip.salesperson)}` : ''}</div>
                        </div>
                    </div>
                `;
            }).join('');
            deleteBtn.style.display = 'inline-block';
        } else {
            section.style.display = 'none';
        }
    } catch (error) {
        console.error('Error loading existing visits:', error);
        section.style.display = 'none';
    }
}

// Schedule a single visit (create new trip with one stop)
async function scheduleVisit() {
    const salesperson = document.getElementById('scheduleVisitSalesperson').value;
    const date = document.getElementById('scheduleVisitDate').value;
    const time = document.getElementById('scheduleVisitTime').value;

    if (!date) {
        showToast('Please select a date', 'error');
        return;
    }

    try {
        const response = await fetch('/api/trips/quick-create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: `Visit: ${selectedRouteLocation.name}`,
                trip_date: date,
                start_time: time,
                salesperson: salesperson,
                location: selectedRouteLocation
            })
        });

        const data = await response.json();

        if (data.success) {
            showToast('Visit scheduled successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('routeSelectorModal')).hide();
        } else {
            showToast(data.error || 'Failed to schedule visit', 'error');
        }
    } catch (error) {
        console.error('Error scheduling visit:', error);
        showToast('Error scheduling visit', 'error');
    }
}

// Add to existing route
async function addToExistingRoute() {
    const tripId = document.getElementById('selectRouteDropdown').value;

    if (!tripId) {
        showToast('Please select a route', 'error');
        return;
    }

    try {
        const response = await fetch(`/api/trips/${tripId}/add-stop`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ location: selectedRouteLocation })
        });

        const data = await response.json();

        if (data.success) {
            showToast(data.message || 'Added to route!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('routeSelectorModal')).hide();
        } else {
            showToast(data.error || 'Failed to add to route', 'error');
        }
    } catch (error) {
        console.error('Error adding to route:', error);
        showToast('Error adding to route', 'error');
    }
}

// Remove from a specific trip
async function removeFromTrip(tripId, stopId) {
    if (!confirm('Remove this location from the route?')) return;

    try {
        const response = await fetch(`/api/trips/${tripId}/stops/${stopId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            showToast('Removed from route', 'success');
            loadExistingVisits();
        } else {
            showToast(data.error || 'Failed to remove', 'error');
        }
    } catch (error) {
        console.error('Error removing from trip:', error);
        showToast('Error removing from route', 'error');
    }
}

// Delete all visits for this location
async function deleteAllVisits() {
    if (!confirm('Remove this location from ALL routes?')) return;

    try {
        let url = '/api/trips/by-location?';
        if (selectedRouteLocation.company_id) {
            url += `company_id=${selectedRouteLocation.company_id}`;
        } else if (selectedRouteLocation.lat && selectedRouteLocation.lng) {
            url += `lat=${selectedRouteLocation.lat}&lng=${selectedRouteLocation.lng}`;
        } else {
            showToast('Cannot identify location', 'error');
            return;
        }

        const response = await fetch(url, { method: 'DELETE' });
        const data = await response.json();

        if (data.success) {
            showToast(`Removed from ${data.deleted_count} route(s)`, 'success');
            loadExistingVisits();
        } else {
            showToast(data.error || 'Failed to remove visits', 'error');
        }
    } catch (error) {
        console.error('Error deleting visits:', error);
        showToast('Error removing visits', 'error');
    }
}
</script>

<!-- Google Maps - load AFTER initMap is defined -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initMap"></script>
{% endblock %}
