{% extends "base.html" %}

{% block title %}Visualize - DOUANO Dashboard{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  .dropdown-panel{position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:12px; max-height:280px; overflow:auto; z-index:1055; margin-top:6px; padding:6px;}
  .dropdown-item{padding:8px 10px; cursor:pointer; border-radius:8px;}
  .dropdown-item:hover{background:rgba(17,24,39,0.06);}  
  .dropdown-empty{padding:10px; color:#6b7280;}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h2 mb-1 fw-bold text-dark">Analytics</h1>
      <p class="text-muted mb-0">Visualize sales data and generate insights</p>
    </div>
  </div>

  <div class="row g-3 align-items-end mb-3">
    <div class="col-md-3">
      <label class="form-label">Company</label>
      <div class="position-relative" id="vizCompanyWrapper">
        <div class="input-group">
          <span class="input-group-text"><i class="fas fa-building"></i></span>
          <input id="vizCompany" class="form-control" placeholder="Search company name" autocomplete="off" />
          <button class="btn btn-outline-secondary" type="button" id="vizCompanyToggle" aria-label="Toggle company list"><i class="fas fa-caret-down"></i></button>
        </div>
        <div id="vizCompanyDropdown" class="dropdown-panel shadow" style="display:none;"></div>
      </div>
    </div>
    <div class="col-md-3">
      <label class="form-label">Product</label>
      <div class="position-relative" id="vizProductWrapper">
        <div class="input-group">
          <span class="input-group-text"><i class="fas fa-box"></i></span>
          <input id="vizProduct" class="form-control" placeholder="Search product name (optional)" autocomplete="off" />
          <button class="btn btn-outline-secondary" type="button" id="vizProductToggle" aria-label="Toggle product list"><i class="fas fa-caret-down"></i></button>
        </div>
        <div id="vizProductDropdown" class="dropdown-panel shadow" style="display:none;"></div>
      </div>
    </div>
    <div class="col-md-2">
      <label class="form-label">Start</label>
      <input id="vizStart" type="date" class="form-control" />
    </div>
    <div class="col-md-2">
      <label class="form-label">End</label>
      <input id="vizEnd" type="date" class="form-control" />
    </div>
    <div class="col-md-2">
      <label class="form-label">Group By</label>
      <select id="vizGroupBy" class="form-select">
        <option value="date" selected>Date</option>
        <option value="company">Company</option>
        <option value="product">Product</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Interval</label>
      <select id="vizInterval" class="form-select">
        <option value="day" selected>Day</option>
        <option value="week">Week</option>
        <option value="month">Month</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Chart</label>
      <select id="vizType" class="form-select">
        <option value="line" selected>Line</option>
        <option value="bar">Bar</option>
        <option value="pie">Pie</option>
        <option value="table">Table</option>
      </select>
    </div>
    <div class="col-md-2 d-flex align-items-center">
      <div class="form-check mt-4">
        <input class="form-check-input" type="checkbox" id="vizProductOnly">
        <label class="form-check-label" for="vizProductOnly">Product-only</label>
      </div>
    </div>
    <div class="col-md-2 d-flex align-items-end gap-2">
      <button id="vizLoad" class="btn btn-primary w-100"><i class="fas fa-plus me-1"></i>Add Chart</button>
      <button id="vizClear" class="btn btn-outline-secondary"><i class="fas fa-trash"></i></button>
    </div>
  </div>

  <div id="vizChartsContainer" class="d-flex flex-column gap-3"></div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
let charts = [];
// Build in-platform dropdowns like on Sales page
function attachDropdown({wrapperId, inputId, toggleId, panelId, source, onResolveMap}){
  const wrap = document.getElementById(wrapperId);
  const input = document.getElementById(inputId);
  const toggle = document.getElementById(toggleId);
  const panel = document.getElementById(panelId);
  const open = ()=> panel.style.display = 'block';
  const close = ()=> panel.style.display = 'none';
  let items = [];
  const render = (list)=>{
    panel.innerHTML = (list||[]).slice(0,500).map(x=>`<div class="dropdown-item" data-id="${x.id||''}">${x.name||''}</div>`).join('') || '<div class="dropdown-empty">No results</div>';
  };
  const seed = async()=>{ items = await source(''); render(items); };
  seed();
  input.addEventListener('input', async (ev)=>{
    ev.preventDefault(); ev.stopPropagation();
    const q = (input.value||'').toLowerCase();
    let filtered = q ? items.filter(x=>x.name && x.name.toLowerCase().includes(q)) : items;
    render(filtered);
    open();
    if (q.length>=2){
      const remote = await source(q);
      // Merge and render; also update resolve map
      if (onResolveMap) onResolveMap(remote);
      const merged=[...remote,...filtered].reduce((acc,cur)=>{if(!acc.find(a=>a.id===cur.id))acc.push(cur);return acc;},[]);
      render(merged);
    }
  });
  toggle.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); if(panel.style.display==='none'||panel.style.display==='') open(); else close();});
  // Prevent focus loss and default behaviors that can cause page jump
  panel.addEventListener('mousedown',(e)=>{ e.preventDefault(); });
  panel.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); const it=e.target.closest('.dropdown-item'); if(!it) return; input.value=it.textContent; input.dataset.selectedId = it.getAttribute('data-id')||''; close();});
  document.addEventListener('click',(e)=>{ if(!wrap.contains(e.target)) close();});
}
document.getElementById('vizLoad').addEventListener('click', async () => {
  const params = new URLSearchParams();
  const companyInput = document.getElementById('vizCompany');
  let companyName = companyInput.value.trim();
  let companyId = companyInput.dataset.selectedId || '';
  const product = document.getElementById('vizProduct').value.trim();
  const start = document.getElementById('vizStart').value;
  const end = document.getElementById('vizEnd').value;
  const groupBy = document.getElementById('vizGroupBy').value;
  const interval = document.getElementById('vizInterval').value;
  const type = document.getElementById('vizType').value;
  const productOnly = document.getElementById('vizProductOnly').checked;
  // Resolve company name -> id for API param, but keep the name for display
  if (!productOnly && (companyName || companyId)){
    let paramValue = '';
    if (companyId) {
      paramValue = String(companyId);
    } else {
      try{
        const mapJson = sessionStorage.getItem('duano_company_name_to_id');
        if (mapJson){
          const map = JSON.parse(mapJson);
          const id = map[companyName];
          if (id) paramValue = String(id);
        }
      }catch(_){ }
      if (!paramValue && /^\d+$/.test(companyName)) paramValue = companyName;
    }
    if (paramValue) params.set('filter_by_company', paramValue);
  }
  if (product) params.set('filter_by_product', product);
  if (start) params.set('filter_by_start_date', start);
  if (end) params.set('filter_by_end_date', end);
  params.set('group_by', productOnly ? 'product' : groupBy);
  params.set('interval', interval);

  const resp = await fetch(`/api/analytics/sales?${params.toString()}`);
  const data = await resp.json();
  const result = data.result || { labels: [], datasets: [] };

  // Create a new chart card
  const container = document.getElementById('vizChartsContainer');
  const card = document.createElement('div');
  card.className = 'card p-3';
  const title = document.createElement('div');
  title.className = 'd-flex justify-content-between align-items-center mb-2';
  const desc = document.createElement('div');
  const parts = [];
  if (!productOnly && (companyName || companyId)) {
    let displayCompany = companyName;
    if (!displayCompany && companyId) {
      try {
        const idMapJson = sessionStorage.getItem('duano_company_id_to_name');
        if (idMapJson) {
          const idMap = JSON.parse(idMapJson);
          displayCompany = idMap[String(companyId)] || String(companyId);
        } else {
          displayCompany = String(companyId);
        }
      } catch(_) { displayCompany = String(companyId); }
    }
    parts.push(`Company: ${displayCompany}`);
  }
  if (product) parts.push(`Product: ${product}`);
  if (start || end) parts.push(`Range: ${start||'‚Ä¶'} ‚Üí ${end||'‚Ä¶'}`);
  parts.push(`Group: ${(productOnly ? 'product' : groupBy)}`);
  parts.push(`Type: ${type}`);
  desc.textContent = parts.join('  ¬∑  ');
  const closeBtn = document.createElement('button');
  closeBtn.className = 'btn btn-sm btn-light';
  closeBtn.innerHTML = '<i class="fas fa-times"></i>';
  title.appendChild(desc);
  title.appendChild(closeBtn);
  card.appendChild(title);

  if (type === 'table') {
    const tableWrap = document.createElement('div');
    tableWrap.className = 'table-responsive';
    tableWrap.innerHTML = `<table class="table table-sm"><thead><tr><th>${(productOnly ? 'PRODUCT' : (groupBy||'').toUpperCase())}</th><th>Amount (‚Ç¨)</th></tr></thead><tbody>${result.labels.map((lbl,i)=>`<tr><td>${lbl}</td><td>${result.datasets[0]?.data[i] ?? ''}</td></tr>`).join('')}</tbody></table>`;
    card.appendChild(tableWrap);
    container.prepend(card);
    // allow closing
    closeBtn.addEventListener('click', ()=>{ card.remove(); });
    return;
  }

  const canvas = document.createElement('canvas');
  canvas.height = 120;
  card.appendChild(canvas);
  container.prepend(card);

  const chart = new Chart(canvas.getContext('2d'), {
    type: type === 'pie' ? 'pie' : (type === 'bar' ? 'bar' : 'line'),
    data: {
      labels: result.labels,
      datasets: result.datasets.map(ds => ({
        label: ds.label,
        data: ds.data,
        borderColor: '#111827',
        backgroundColor: type === 'pie' ? result.labels.map((_,i)=>`hsl(${i*37%360}deg 70% 55%)`) : 'rgba(17,24,39,0.15)',
        fill: type !== 'bar',
        tension: 0.25
      }))
    },
    options: {
      responsive: true,
      plugins: { legend: { display: type !== 'line' || result.datasets.length > 1 } },
      scales: { y: { beginAtZero: true } }
    }
  });
  charts.push({ chart, root: card });
  closeBtn.addEventListener('click', ()=>{
    try { chart.destroy(); } catch(_) {}
    card.remove();
  });
});

document.getElementById('vizClear').addEventListener('click', ()=>{
  charts.forEach(c=>{ try{ c.chart.destroy(); }catch(_){} });
  charts = [];
  document.getElementById('vizChartsContainer').innerHTML='';
});

// Data providers for dropdowns
async function companySource(q){
  try{
    if (!q){
      // from cache
      const cached = sessionStorage.getItem('duano_companies_cache_v1');
      const companies = cached ? JSON.parse(cached) : [];
      return (companies||[]).map(c=>({id:c.id,name:c.public_name||c.name||''})).filter(x=>x.name);
    } else {
      const resp = await fetch(`/api/companies?q=${encodeURIComponent(q)}&per_page=50`);
      const data = await resp.json();
      return (data.result?.data||[]).map(x=>({id:x.id,name:x.name})).filter(x=>x.name);
    }
  }catch(_){ return []; }
}
function updateCompanyMap(list){
  try{
    const mapJson = sessionStorage.getItem('duano_company_name_to_id');
    const idMapJson = sessionStorage.getItem('duano_company_id_to_name');
    const nameToId = mapJson ? JSON.parse(mapJson) : {};
    const idToName = idMapJson ? JSON.parse(idMapJson) : {};
    list.forEach(x=>{ nameToId[x.name]=x.id; idToName[String(x.id)] = x.name; });
    sessionStorage.setItem('duano_company_name_to_id', JSON.stringify(nameToId));
    sessionStorage.setItem('duano_company_id_to_name', JSON.stringify(idToName));
  }catch(_){ }
}
async function productSource(q){
  // use cached product catalog/hierarchy if present; else try to fetch hierarchy once
  try{
    let names=[];
    const cat = sessionStorage.getItem('duano_product_catalog_cache_v1');
    const hier = sessionStorage.getItem('duano_product_hierarchy_cache_v1');
    if (!cat && !hier){
      try{ await fetch('/api/products/hierarchy').then(r=>r.json()).then(d=>{sessionStorage.setItem('duano_product_hierarchy_cache_v1', JSON.stringify(d.result?.data||[]));}); }catch(_){ }
    }
    const cat2 = sessionStorage.getItem('duano_product_catalog_cache_v1');
    if (cat2){
      const prods = JSON.parse(cat2)||[]; names.push(...prods.map(p=>p.name||'').filter(Boolean));
    }
    const hier2 = sessionStorage.getItem('duano_product_hierarchy_cache_v1');
    if (hier2){
      const arr = JSON.parse(hier2)||[];
      arr.forEach(it=>{ if (it.composed_product?.name) names.push(it.composed_product.name); (it.components||[]).forEach(c=>{ if(c.product?.name) names.push(c.product.name); }); });
    }
    let uniq=[...new Set(names)].map(n=>({name:n}));
    if (q){ uniq = uniq.filter(x=>x.name.toLowerCase().includes(q.toLowerCase())); }
    return uniq;
  }catch(_){ return []; }
}

// Attach dropdowns on load
attachDropdown({wrapperId:'vizCompanyWrapper', inputId:'vizCompany', toggleId:'vizCompanyToggle', panelId:'vizCompanyDropdown', source:companySource, onResolveMap:updateCompanyMap});
attachDropdown({wrapperId:'vizProductWrapper', inputId:'vizProduct', toggleId:'vizProductToggle', panelId:'vizProductDropdown', source:productSource});

// Delivery Analytics Functions
async function loadDeliveryMethods() {
  console.log('üîÑ Loading delivery methods from DUANO API...');
  const select = document.getElementById('deliveryMethods');
  
  try {
    console.log('üì° Fetching from /api/delivery-methods');
    const response = await fetch('/api/delivery-methods?_=' + Date.now());
    
    if (!response.ok) {
      if (response.status === 401) {
        select.innerHTML = '<option value="">‚ùå Please log in to load delivery methods</option>';
        console.error('‚ùå Authentication required - user must log in first');
        return;
      }
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('üìä Received delivery methods data:', data);
    
    // Check if it's an authentication error in the response
    if (data.error && data.error.includes('authenticated')) {
      select.innerHTML = '<option value="">‚ùå Please log in to load delivery methods</option>';
      console.error('‚ùå Not authenticated - user must log in first');
      return;
    }
    
    select.innerHTML = '';
    if (data.result && Array.isArray(data.result) && data.result.length > 0) {
      data.result.forEach(method => {
        const option = document.createElement('option');
        option.value = method.value;
        option.textContent = method.label;
        select.appendChild(option);
      });
      console.log(`‚úÖ Successfully loaded ${data.result.length} real delivery methods from DUANO`);
      console.log('üìã Delivery methods:', data.result.map(m => m.label).join(', '));
      
      // Log any warnings from DUANO API
      if (data.warnings) {
        console.warn('‚ö†Ô∏è DUANO API warnings:', data.warnings);
      }
    } else {
      console.error('‚ùå Data structure issue:', data);
      console.error('‚ùå data.result type:', typeof data.result, data.result);
      
      // Try to show what we got
      if (data.result) {
        select.innerHTML = `<option value="">‚ùå Got ${data.result.length || 'unknown'} delivery methods but format is wrong</option>`;
      } else {
        select.innerHTML = '<option value="">‚ùå No delivery methods found in DUANO response</option>';
      }
      console.warn('‚ö†Ô∏è No delivery methods returned from DUANO API');
    }
    
  } catch (error) {
    console.error('‚ùå Failed to load delivery methods from DUANO:', error);
    select.innerHTML = '<option value="">‚ùå Failed to load delivery methods - check authentication</option>';
  }
}

function formatWeekLabel(weekStart) {
  const date = new Date(weekStart);
  const endDate = new Date(date);
  endDate.setDate(date.getDate() + 6);
  
  const options = { month: 'short', day: 'numeric' };
  return `${date.toLocaleDateString('en-US', options)} - ${endDate.toLocaleDateString('en-US', options)}`;
}

function createDeliveryTable(data) {
  const { delivery_methods, time_periods, data: deliveryData, summary } = data;
  
  if (!delivery_methods.length || !time_periods.length) {
    return '<div class="alert alert-info">No delivery data found for the selected criteria.</div>';
  }
  
  let html = '<table class="table table-striped table-hover">';
  
  // Header
  html += '<thead class="table-dark"><tr><th>Delivery Method</th>';
  time_periods.forEach(period => {
    const label = formatWeekLabel(period);
    html += `<th class="text-center">${label}</th>`;
  });
  html += '<th class="text-center">Total Addresses</th><th class="text-center">Total Amount</th></tr></thead>';
  
  // Body
  html += '<tbody>';
  delivery_methods.forEach(method => {
    html += `<tr><td><strong>${method}</strong></td>`;
    
    time_periods.forEach(period => {
      const addresses = deliveryData[method] && deliveryData[method][period] ? deliveryData[method][period] : [];
      
      if (addresses.length > 0) {
        // Create collapsible cell with address list
        const addressList = addresses.map(addr => 
          `<div class="small mb-1">
            <strong>${addr.customer}</strong><br>
            <span class="text-muted">${addr.address}</span><br>
            <small class="text-success">‚Ç¨${(addr.amount || 0).toFixed(2)} (#${addr.invoice_id || 'N/A'})</small>
            ${addr.source ? `<br><small class="text-info">Source: ${addr.source}</small>` : ''}
          </div>`
        ).join('');
        
        html += `<td class="text-center">
          <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${method.replace(/[^a-zA-Z0-9]/g, '')}-${period}" aria-expanded="false">
            ${addresses.length} address${addresses.length !== 1 ? 'es' : ''}
          </button>
          <div class="collapse mt-2" id="collapse-${method.replace(/[^a-zA-Z0-9]/g, '')}-${period}">
            <div class="card card-body small">
              ${addressList}
            </div>
          </div>
        </td>`;
      } else {
        html += '<td class="text-center text-muted">0</td>';
      }
    });
    
    // Total columns
    const totalAddresses = summary[method] ? summary[method].total_addresses : 0;
    
    // Calculate total amount for this method
    let totalAmount = 0;
    if (deliveryData[method]) {
      Object.values(deliveryData[method]).forEach(addresses => {
        addresses.forEach(addr => {
          totalAmount += (addr.amount || 0);
        });
      });
    }
    
    html += `<td class="text-center"><strong>${totalAddresses}</strong></td>`;
    html += `<td class="text-center"><strong>‚Ç¨${totalAmount.toFixed(2)}</strong></td>`;
    html += '</tr>';
  });
  html += '</tbody></table>';
  
  // Add summary stats
  const totalAddresses = Object.values(summary).reduce((sum, s) => sum + s.total_addresses, 0);
  
  // Calculate grand total amount
  let grandTotalAmount = 0;
  delivery_methods.forEach(method => {
    if (deliveryData[method]) {
      Object.values(deliveryData[method]).forEach(addresses => {
        addresses.forEach(addr => {
          grandTotalAmount += (addr.amount || 0);
        });
      });
    }
  });
  
  html += `<div class="mt-3 p-3 bg-light rounded">
    <div class="row">
      <div class="col-md-4">
        <strong>Summary:</strong> ${totalAddresses} total addresses across ${delivery_methods.length} delivery methods
      </div>
      <div class="col-md-4 text-center">
        <strong>Total Value:</strong> ‚Ç¨${grandTotalAmount.toFixed(2)}
      </div>
      <div class="col-md-4 text-end">
        <strong>Time Period:</strong> ${time_periods.length} ${document.getElementById('deliveryGroupBy').value}${time_periods.length !== 1 ? 's' : ''}
      </div>
    </div>`;
    
  // Add data sources information if available
  if (data.data_sources && data.data_sources.length > 0) {
    html += `<div class="row mt-2">
      <div class="col-12">
        <small class="text-muted">
          <strong>Data Sources:</strong> ${data.data_sources.join(', ')}
        </small>
      </div>
    </div>`;
  }
  
  html += `</div>`;
  
  return html;
}

// Delivery Load Button Event
document.getElementById('deliveryLoad').addEventListener('click', async () => {
  const methodsSelect = document.getElementById('deliveryMethods');
  const selectedMethods = Array.from(methodsSelect.selectedOptions).map(option => option.value);
  const startDate = document.getElementById('deliveryStart').value;
  const endDate = document.getElementById('deliveryEnd').value;
  const groupBy = document.getElementById('deliveryGroupBy').value;
  
  if (selectedMethods.length === 0) {
    alert('Please select at least one delivery method.');
    return;
  }
  
  const params = new URLSearchParams();
  params.set('filter_by_delivery_methods', selectedMethods.join(','));
  if (startDate) params.set('filter_by_start_date', startDate);
  if (endDate) params.set('filter_by_end_date', endDate);
  params.set('group_by', groupBy);
  
  try {
    document.getElementById('deliveryLoad').innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
    
    const response = await fetch(`/api/analytics/deliveries?${params.toString()}`);
    const data = await response.json();
    
    if (data.error) {
      alert('Error loading delivery data: ' + data.error);
      return;
    }
    
    const tableHtml = createDeliveryTable(data.result);
    document.getElementById('deliveryTableContainer').innerHTML = tableHtml;
    document.getElementById('deliveryResultsContainer').style.display = 'block';
    
  } catch (error) {
    console.error('Error loading delivery analytics:', error);
    alert('Error loading delivery data. Please try again.');
  } finally {
    document.getElementById('deliveryLoad').innerHTML = '<i class="fas fa-chart-table me-1"></i>Load Data';
  }
});

// Delivery Clear Button Event
document.getElementById('deliveryClear').addEventListener('click', () => {
  document.getElementById('deliveryResultsContainer').style.display = 'none';
  document.getElementById('deliveryTableContainer').innerHTML = '';
});


// Load delivery methods on page load
document.addEventListener('DOMContentLoaded', () => {
  loadDeliveryMethods();
});

// Orders by Delivery Method Chart Functions
let ordersByMethodChart = null;

async function loadOrdersByDeliveryMethod() {
  const startDate = document.getElementById('ordersByMethodStart').value;
  const endDate = document.getElementById('ordersByMethodEnd').value;
  
  const params = new URLSearchParams();
  if (startDate) params.set('filter_by_start_date', startDate);
  if (endDate) params.set('filter_by_end_date', endDate);
  
  try {
    document.getElementById('ordersByMethodLoad').innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
    
    const response = await fetch(`/api/orders-by-delivery-method?${params.toString()}`);
    const data = await response.json();
    
    if (data.error) {
      alert('Error loading orders data: ' + data.error);
      return;
    }
    
    createOrdersByMethodChart(data.result);
    createOrdersByMethodSummary(data.summary, data.warnings);
    createOrdersByMethodTable(data.result);
    
    document.getElementById('ordersByMethodResultsContainer').style.display = 'block';
    
  } catch (error) {
    console.error('Error loading orders by delivery method:', error);
    alert('Error loading orders data. Please try again.');
  } finally {
    document.getElementById('ordersByMethodLoad').innerHTML = '<i class="fas fa-chart-pie me-1"></i>Load Chart';
  }
}

function createOrdersByMethodChart(data) {
  const ctx = document.getElementById('ordersByMethodChart').getContext('2d');
  
  // Destroy existing chart if it exists
  if (ordersByMethodChart) {
    ordersByMethodChart.destroy();
  }
  
  // Prepare chart data
  const labels = data.map(item => item.delivery_method);
  const counts = data.map(item => item.order_count);
  const colors = [
    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
  ];
  
  ordersByMethodChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: counts,
        backgroundColor: colors.slice(0, labels.length),
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'Distribution of Orders by Delivery Method'
        },
        legend: {
          position: 'bottom'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.parsed;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((value / total) * 100).toFixed(1);
              return `${label}: ${value} orders (${percentage}%)`;
            }
          }
        }
      }
    }
  });
}

function createOrdersByMethodSummary(summary, warnings) {
  let html = `
    <div class="alert alert-info">
      <div class="row">
        <div class="col-md-4">
          <strong>Total Orders:</strong> ${summary.total_orders}
        </div>
        <div class="col-md-4">
          <strong>Delivery Methods:</strong> ${summary.total_delivery_methods}
        </div>
        <div class="col-md-4">
          <strong>Data Sources:</strong> ${summary.data_sources.join(', ')}
        </div>
      </div>
    </div>
  `;
  
  if (warnings && warnings.length > 0) {
    html += `
      <div class="alert alert-warning">
        <strong>Warnings:</strong>
        <ul class="mb-0">
          ${warnings.map(warning => `<li>${warning}</li>`).join('')}
        </ul>
      </div>
    `;
  }
  
  document.getElementById('ordersByMethodSummary').innerHTML = html;
}

function createOrdersByMethodTable(data) {
  let html = `
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>Delivery Method</th>
            <th class="text-end">Order Count</th>
            <th class="text-end">Percentage</th>
            <th class="text-end">Total Amount</th>
            <th>Sample Orders</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  data.forEach(item => {
    const sampleOrders = item.sample_orders.map(order => 
      `${order.customer} (${order.date || 'No date'}) - ‚Ç¨${order.amount || 0}`
    ).join('<br>');
    
    html += `
      <tr>
        <td><strong>${item.delivery_method}</strong></td>
        <td class="text-end"><span class="badge bg-primary">${item.order_count}</span></td>
        <td class="text-end">${item.percentage}%</td>
        <td class="text-end">‚Ç¨${item.total_amount.toFixed(2)}</td>
        <td><small>${sampleOrders || 'No sample orders'}</small></td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  document.getElementById('ordersByMethodTable').innerHTML = html;
}

// Event Listeners for Orders by Delivery Method
document.getElementById('ordersByMethodLoad').addEventListener('click', loadOrdersByDeliveryMethod);

document.getElementById('ordersByMethodClear').addEventListener('click', () => {
  document.getElementById('ordersByMethodResultsContainer').style.display = 'none';
  if (ordersByMethodChart) {
    ordersByMethodChart.destroy();
    ordersByMethodChart = null;
  }
  document.getElementById('ordersByMethodSummary').innerHTML = '';
  document.getElementById('ordersByMethodTable').innerHTML = '';
});
</script>
{% endblock %}

