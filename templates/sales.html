{% extends "base.html" %}

{% block title %}Sales Invoices - DUANO Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-receipt me-2"></i>Sales Invoices
                </h1>
                <button class="btn btn-outline-primary" onclick="refreshInvoices()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>

            <!-- Loading indicator -->
            <div id="loading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading sales invoices...</p>
            </div>

            <!-- Error message -->
            <div id="error-message" class="alert alert-danger" style="display: none;">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="error-text"></span>
            </div>

            <!-- Search and filters -->
            <div id="search-container" class="mb-4">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search invoices...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="position-relative" id="companyFilterWrapper">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-building"></i></span>
                                <input type="text" class="form-control" id="companyFilter" placeholder="Filter by company name" autocomplete="off">
                                <button class="btn btn-outline-secondary" type="button" id="companyDropdownToggle" aria-label="Toggle company list"><i class="fas fa-caret-down"></i></button>
                            </div>
                            <div id="companyDropdown" class="dropdown-panel shadow" style="display:none;"></div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                            <input type="date" class="form-control" id="startDate" placeholder="Start date">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                            <input type="date" class="form-control" id="endDate" placeholder="End date">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="statusFilter">
                            <option value="all">All Statuses</option>
                            <option value="draft">Draft</option>
                            <option value="sent">Sent</option>
                            <option value="paid">Paid</option>
                            <option value="overdue">Overdue</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="sortSelect">
                            <option value="date_desc">Date (Newest First)</option>
                            <option value="date_asc">Date (Oldest First)</option>
                            <option value="amount_desc">Amount (High to Low)</option>
                            <option value="amount_asc">Amount (Low to High)</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-box"></i></span>
                            <input type="text" class="form-control" id="productFilter" list="productSuggestions" placeholder="Product name or ID (optional)">
                            <datalist id="productSuggestions"></datalist>
                        </div>
                    </div>
                </div>
                <div class="d-flex align-items-center mt-3 gap-2">
                    <button class="btn btn-primary" id="applyFiltersBtn"><i class="fas fa-filter me-1"></i>Load invoices</button>
                    <button class="btn btn-outline-secondary" id="clearFiltersBtn"><i class="fas fa-eraser me-1"></i>Clear</button>
                    <div class="text-muted small ms-auto">
                        <span id="invoice-count">0</span> invoices
                    </div>
                </div>
            </div>

            <!-- Sales invoices container -->
            <div id="invoices-container" style="display: none;">
                <div class="row" id="invoices-list">
                    <!-- Invoices will be loaded here -->
                </div>

                <!-- Pagination -->
                <nav aria-label="Sales invoices pagination" class="mt-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted small">
                            Showing <span id="pagination-info"></span>
                        </div>
                        <ul class="pagination mb-0" id="pagination">
                            <!-- Pagination will be generated here -->
                        </ul>
                    </div>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Sales Invoice Details Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1" aria-labelledby="invoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="invoiceModalLabel">
                    <i class="fas fa-receipt me-2"></i>Sales Invoice Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="invoiceModalBody">
                <!-- Invoice details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
let allInvoices = [];
let filteredInvoices = [];
let displayedInvoices = [];
let currentFilter = 'all';
let currentSort = 'date_desc';
let currentPage = 1;
let invoicesPerPage = 20;
let totalPages = 1;

// Cache keys
const INVOICES_CACHE_KEY_BASE = 'duano_invoices_cache_v1';
const INVOICES_CACHE_TIME_KEY_BASE = 'duano_invoices_cache_time_v1';
let currentCacheKey = INVOICES_CACHE_KEY_BASE;

// Sanitize function to prevent XSS and handle malformed data
function sanitize(str) {
    if (typeof str !== 'string') return str;
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

async function loadInvoices() {
    try {
        // Try cache first (session-scoped): load once per tab session
        const query = (() => {
            const urlParams = new URLSearchParams(window.location.search);
            const companyParam = urlParams.get('company');
            if (companyParam) document.getElementById('companyFilter').value = companyParam;
            const built = new URLSearchParams();
            // Map company name to ID if needed
            let companyIdForQuery = companyParam;
            if (companyParam && isNaN(Number(companyParam))) {
                const mapJson = sessionStorage.getItem('duano_company_name_to_id');
                if (mapJson) {
                    const map = JSON.parse(mapJson);
                    companyIdForQuery = map[companyParam] || companyParam;
                }
            }
            if (companyIdForQuery) built.set('filter_by_company', companyIdForQuery);
            const start = document.getElementById('startDate')?.value;
            const end = document.getElementById('endDate')?.value;
            if (start) built.set('filter_by_start_date', start);
            if (end) built.set('filter_by_end_date', end);
            built.set('order_by_date', 'desc');
            return built.toString();
        })();
        currentCacheKey = `${INVOICES_CACHE_KEY_BASE}_${btoa(query || 'noquery')}`;
        const timeKey = `${INVOICES_CACHE_TIME_KEY_BASE}_${btoa(query || 'noquery')}`;

        // Require minimal filters before fetching
        const hasMinimal = Boolean((new URLSearchParams(window.location.search)).get('company') || (document.getElementById('startDate')?.value && document.getElementById('endDate')?.value));
        if (!hasMinimal) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('invoices-container').style.display = 'none';
            return;
        }

        const cached = sessionStorage.getItem(currentCacheKey);
        if (cached) {
            const cachedData = JSON.parse(cached);
            if (Array.isArray(cachedData) && cachedData.length >= 0) {
                allInvoices = cachedData;
                filteredInvoices = [...allInvoices];
                document.getElementById('loading').style.display = 'none';
                document.getElementById('invoices-container').style.display = 'block';
                calculatePagination();
                updateCounts();
                displayCurrentPage();
                updatePagination();
                return; // Skip network request
            }
        }

        // Fetch with timeout to avoid indefinite spinner
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 20000);
        const response = await fetch(`/api/sales-invoices${query ? `?${query}` : ''}` , { signal: controller.signal });
        clearTimeout(timeoutId);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        allInvoices = data.result?.data || [];
        
        // Debug: Log the structure of the first invoice to see available fields
        if (allInvoices.length > 0) {
            console.log('Sample invoice structure:', allInvoices[0]);
            console.log('Available fields:', Object.keys(allInvoices[0]));
            
            // Fetch detailed data for first few invoices to see full structure
            console.log('Fetching detailed invoice data for better pricing...');
            const detailedInvoices = await Promise.all(
                allInvoices.slice(0, 5).map(async (invoice) => {
                    try {
                        const detailResponse = await fetch(`/api/sales-invoices/${invoice.id}`);
                        if (detailResponse.ok) {
                            const detailData = await detailResponse.json();
                            console.log(`Detailed invoice ${invoice.id}:`, detailData);
                            return detailData.result || detailData;
                        }
                    } catch (error) {
                        console.error(`Error fetching invoice ${invoice.id} details:`, error);
                    }
                    return invoice;
                })
            );
            
            // Use detailed data if available
            if (detailedInvoices.length > 0 && detailedInvoices[0]) {
                console.log('Using detailed invoice data for better pricing');
                // Replace first few invoices with detailed data
                detailedInvoices.forEach((detailedInvoice, index) => {
                    if (detailedInvoice && allInvoices[index]) {
                        allInvoices[index] = detailedInvoice;
                    }
                });
            }
        }
        
        // Save to session cache for filter set
        sessionStorage.setItem(currentCacheKey, JSON.stringify(allInvoices));
        sessionStorage.setItem(timeKey, String(Date.now()));
        
        filteredInvoices = [...allInvoices];
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('search-container').style.display = 'block';
        document.getElementById('invoices-container').style.display = 'block';
        document.getElementById('error-message').style.display = 'none';
        
        calculatePagination();
        updateCounts();
        displayCurrentPage();
        updatePagination();
        
    } catch (error) {
        console.error('Error loading invoices:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-message').style.display = 'block';
        document.getElementById('error-text').textContent = `Failed to load sales invoices: ${error.message}`;
        document.getElementById('invoices-container').style.display = 'none';
    }
}

function refreshInvoices() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('invoices-container').style.display = 'none';
    document.getElementById('error-message').style.display = 'none';
    
    // Reset pagination and filters
    currentPage = 1;
    currentFilter = 'all';
    currentSort = 'date_desc';
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = 'all';
    document.getElementById('sortSelect').value = 'date_desc';
    
    // Bust cache for current filter set
    sessionStorage.removeItem(currentCacheKey);
    
    loadInvoices();
}

function filterInvoices() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    
    const companyFilterVal = document.getElementById('companyFilter').value.trim();
    filteredInvoices = allInvoices.filter(invoice => {
        // Search filter
        const matchesSearch = !searchTerm || 
            (invoice.invoice_number && invoice.invoice_number.toLowerCase().includes(searchTerm)) ||
            (invoice.buyer_name && invoice.buyer_name.toLowerCase().includes(searchTerm)) ||
            (invoice.seller_name && invoice.seller_name.toLowerCase().includes(searchTerm));
        
        // Status filter
        const matchesStatus = statusFilter === 'all' || 
            (getInvoiceStatus(invoice) && getInvoiceStatus(invoice).toLowerCase() === statusFilter);
        
        // Company filter (by buyer/company id)
        const matchesCompany = !companyFilterVal || String(invoice.company?.id || invoice.buyer_id || invoice.company_id || '').includes(companyFilterVal);
        
        return matchesSearch && matchesStatus && matchesCompany;
    });
    
    // Reset to first page when filtering
    currentPage = 1;
    calculatePagination();
    updateCounts();
    displayCurrentPage();
    updatePagination();
}

function sortInvoices() {
    const sortBy = document.getElementById('sortSelect').value;
    currentSort = sortBy;
    
    filteredInvoices.sort((a, b) => {
        switch (sortBy) {
            case 'date_desc':
                return new Date(b.created_at || 0) - new Date(a.created_at || 0);
            case 'date_asc':
                return new Date(a.created_at || 0) - new Date(b.created_at || 0);
            case 'amount_desc':
                return getInvoiceAmount(b) - getInvoiceAmount(a);
            case 'amount_asc':
                return getInvoiceAmount(a) - getInvoiceAmount(b);
            default:
                return 0;
        }
    });
    
    displayCurrentPage();
}

function calculatePagination() {
    totalPages = Math.ceil(filteredInvoices.length / invoicesPerPage);
    if (currentPage > totalPages) {
        currentPage = Math.max(1, totalPages);
    }
}

function displayCurrentPage() {
    const startIndex = (currentPage - 1) * invoicesPerPage;
    const endIndex = startIndex + invoicesPerPage;
    displayedInvoices = filteredInvoices.slice(startIndex, endIndex);
    
    const invoicesList = document.getElementById('invoices-list');
    invoicesList.innerHTML = '';
    
    if (displayedInvoices.length === 0) {
        invoicesList.innerHTML = `
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No sales invoices found</h5>
                    <p class="text-muted">Try adjusting your search or filter criteria.</p>
                </div>
            </div>
        `;
        return;
    }
    
    displayedInvoices.forEach(invoice => {
        const invoiceCard = createInvoiceCard(invoice);
        invoicesList.appendChild(invoiceCard);
        // Ensure product lines are shown on the card
        try { hydrateInvoiceCardProducts(invoice); } catch (e) { console.warn('hydrate products failed', e); }
    });
}

function createInvoiceCard(invoice) {
    const col = document.createElement('div');
    col.className = 'col-md-6 col-lg-4 mb-3';
    
    const statusBadge = getStatusBadge(getInvoiceStatus(invoice));
    const amount = formatCurrency(getInvoiceAmount(invoice), getInvoiceCurrency(invoice));
    const date = formatDate(invoice.created_at);
    const customerName = sanitize(
        (invoice.company && (invoice.company.public_name || invoice.company.name)) ||
        invoice.buyer_name ||
        (invoice.customer && (invoice.customer.public_name || invoice.customer.name)) ||
        invoice.company_name ||
        'N/A'
    );
    
    col.innerHTML = `
        <div class="card h-100 invoice-card" onclick="showInvoiceDetails(${sanitize(invoice.id)})" style="cursor: pointer;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-file-invoice me-1"></i>
                        ${sanitize(invoice.invoice_number || `Invoice #${invoice.id}`)}
                    </h6>
                    ${statusBadge}
                </div>
                
                <div class="mb-2">
                    <small class="text-muted">Date:</small>
                    <div>${date}</div>
                </div>
                
                <div class="mb-2">
                    <small class="text-muted">Amount:</small>
                    <div class="fw-bold">${amount}</div>
                </div>

                <div class="mb-2">
                    <small class="text-muted">Products:</small>
                    <div id="invoice-products-${sanitize(invoice.id)}" class="small text-body-secondary">Loading products…</div>
                </div>

                <div class="mb-0">
                    <small class="text-muted">Customer:</small>
                    <div>${customerName}</div>
                </div>
            </div>
        </div>
    `;
    
    return col;
}

// Extract line items from various possible shapes
function extractInvoiceLines(invoice) {
    if (!invoice || typeof invoice !== 'object') return [];
    const lines = invoice.invoice_line_items || invoice.items || invoice.line_items || [];
    return Array.isArray(lines) ? lines : [];
}

function summarizeProducts(lines) {
    if (!Array.isArray(lines) || lines.length === 0) return 'No product lines';
    const summaries = [];
    for (const line of lines.slice(0, 5)) {
        const prod = line.product || {};
        const name = prod.name || prod.product_name || line.description || line.name || (prod.sku ? `SKU ${prod.sku}` : 'Item');
        const qty = line.quantity || line.qty || 1;
        summaries.push(`${sanitize(String(name))} × ${sanitize(String(qty))}`);
    }
    if (lines.length > 5) summaries.push(`… +${lines.length - 5} more`);
    return summaries.join(', ');
}

async function hydrateInvoiceCardProducts(invoice) {
    const target = document.getElementById(`invoice-products-${invoice.id}`);
    if (!target) return;

    // If we already have lines, render immediately
    let lines = extractInvoiceLines(invoice);
    if (lines.length > 0) {
        target.textContent = summarizeProducts(lines);
        return;
    }

    // Otherwise fetch details lazily
    try {
        const resp = await fetch(`/api/sales-invoices/${invoice.id}`);
        if (resp.ok) {
            const data = await resp.json();
            const detailed = data.result || data || {};
            // Update in-memory cache so modal and other views benefit
            const idx = allInvoices.findIndex(inv => inv.id === invoice.id);
            if (idx !== -1) allInvoices[idx] = Object.assign({}, invoice, detailed);
            lines = extractInvoiceLines(detailed);
            target.textContent = summarizeProducts(lines);
        } else {
            target.textContent = 'Products unavailable';
        }
    } catch (e) {
        target.textContent = 'Products unavailable';
    }
}

// Robust helpers for line math
function getLineQuantity(line) {
    return line.quantity || line.qty || line.amount_quantity || 0;
}

function getLineUnitPrice(line) {
    return line.unit_price_incl_tax || line.price_incl_tax || line.unit_price || line.price || 0;
}

function getLineTotal(line) {
    const direct = line.total_incl_tax || line.total_excl_tax || line.line_total || line.total || line.amount;
    if (typeof direct === 'number' && !isNaN(direct)) return direct;
    const qty = getLineQuantity(line);
    const unit = getLineUnitPrice(line);
    const calc = (qty || 0) * (unit || 0);
    return isNaN(calc) ? 0 : calc;
}
function getStatusBadge(status) {
    if (!status) return '<span class="badge bg-secondary">Unknown</span>';
    
    const statusLower = status.toLowerCase();
    let badgeClass = 'bg-secondary';
    
    switch (statusLower) {
        case 'draft':
            badgeClass = 'bg-warning';
            break;
        case 'sent':
            badgeClass = 'bg-info';
            break;
        case 'paid':
            badgeClass = 'bg-success';
            break;
        case 'overdue':
            badgeClass = 'bg-danger';
            break;
    }
    
    return `<span class="badge ${badgeClass}">${sanitize(status)}</span>`;
}

// Helper functions for extracting invoice data
function getInvoiceAmount(invoice) {
    // Use actual DUANO API field names
    return invoice.payable_amount_without_financial_discount || 
           invoice.payable_amount_with_financial_discount ||
           invoice.balance ||
           // Calculate from line items if available (correct field name)
           (invoice.invoice_line_items && Array.isArray(invoice.invoice_line_items) ? 
               invoice.invoice_line_items.reduce((sum, line) => sum + getLineTotal(line), 0) : 0) ||
           // Fallback to other possible fields
           invoice.total_amount || 
           invoice.amount || 
           invoice.total || 
           invoice.value || 
           invoice.price || 
           0;
}

function getInvoiceStatus(invoice) {
    // Use actual DUANO API field names
    if (invoice.is_sent === true) return 'sent';
    if (invoice.balance === 0) return 'paid';
    if (invoice.balance > 0) return 'pending';
    
    // Fallback to other status fields
    return invoice.status || 
           invoice.state || 
           invoice.invoice_status || 
           invoice.payment_status ||
           invoice.document_status ||
           'pending';
}

function getInvoiceCurrency(invoice) {
    return invoice.currency || invoice.currency_code || 'EUR';
}

function getInvoiceNumber(invoice) {
    return invoice.invoice_number || invoice.number || `#${invoice.id}`;
}

function getInvoiceDate(invoice) {
    return invoice.created_at || invoice.date || invoice.invoice_date;
}

function formatCurrency(amount, currency = 'EUR') {
    if (!amount) return '€0.00';
    
    try {
        return new Intl.NumberFormat('en-EU', {
            style: 'currency',
            currency: currency || 'EUR'
        }).format(amount);
    } catch (e) {
        return `${currency || '€'} ${amount}`;
    }
}

function formatDate(dateString) {
    if (!dateString) return 'Unknown';
    
    try {
        return new Date(dateString).toLocaleDateString('en-EU', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    } catch (e) {
        return dateString;
    }
}

function updateCounts() {
    document.getElementById('invoice-count').textContent = filteredInvoices.length;
    
    const start = (currentPage - 1) * invoicesPerPage + 1;
    const end = Math.min(currentPage * invoicesPerPage, filteredInvoices.length);
    const total = filteredInvoices.length;
    
    document.getElementById('pagination-info').textContent = 
        total > 0 ? `${start}-${end} of ${total}` : '0 of 0';
}

function updatePagination() {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>`;
    pagination.appendChild(prevLi);
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        pagination.appendChild(li);
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>`;
    pagination.appendChild(nextLi);
}

function changePage(page) {
    if (page < 1 || page > totalPages || page === currentPage) return;
    
    currentPage = page;
    displayCurrentPage();
    updateCounts();
    updatePagination();
    
    // Scroll to top
    window.scrollTo(0, 0);
}

function showInvoiceDetails(invoiceId) {
    console.log('Showing details for invoice ID:', invoiceId);
    
    // Prevent multiple modals and freezing/backdrop issues
    const modalElement = document.getElementById('invoiceModal');
    document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
    document.body.classList.remove('modal-open');
    
    try {
        const invoice = allInvoices.find(inv => inv.id === invoiceId);
        if (!invoice) throw new Error('Invoice not found');

        const modalBody = document.getElementById('invoiceModalBody');
        // Prefer detailed invoice object if already fetched
        const lines = extractInvoiceLines(invoice);
        const currency = getInvoiceCurrency(invoice);
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-info-circle me-2"></i>Invoice Information</h6>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Invoice Number:</strong></td>
                            <td>${sanitize(invoice.invoice_number || `#${invoice.id}`)}</td>
                        </tr>
                        <tr>
                            <td><strong>Status:</strong></td>
                            <td>${getStatusBadge(getInvoiceStatus(invoice))}</td>
                        </tr>
                        <tr>
                            <td><strong>Date:</strong></td>
                            <td>${formatDate(invoice.created_at)}</td>
                        </tr>
                        <tr>
                            <td><strong>Due Date:</strong></td>
                            <td>${formatDate(invoice.due_date)}</td>
                        </tr>
                        <tr>
                            <td><strong>Amount:</strong></td>
                            <td class="fw-bold">${formatCurrency(getInvoiceAmount(invoice), getInvoiceCurrency(invoice))}</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-building me-2"></i>Customer Information</h6>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Customer:</strong></td>
                            <td>${sanitize((invoice.company && (invoice.company.public_name || invoice.company.name)) || invoice.buyer_name || 'N/A')}</td>
                        </tr>
                        <tr>
                            <td><strong>Business Number:</strong></td>
                            <td>${sanitize(invoice.buyer_business_number || 'N/A')}</td>
                        </tr>
                        <tr>
                            <td><strong>VAT Number:</strong></td>
                            <td>${sanitize(invoice.buyer_vat_number || 'N/A')}</td>
                        </tr>
                        <tr>
                            <td><strong>Address:</strong></td>
                            <td>${sanitize(invoice.buyer_address || 'N/A')}</td>
                        </tr>
                        <tr>
                            <td><strong>Email:</strong></td>
                            <td>${sanitize(invoice.buyer_email || 'N/A')}</td>
                        </tr>
                    </table>
                </div>
            </div>
            
            ${invoice.seller_name ? `
            <div class="row mt-3">
                <div class="col-12">
                    <h6><i class="fas fa-store me-2"></i>Seller Information</h6>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Seller:</strong></td>
                            <td>${sanitize(invoice.seller_name)}</td>
                        </tr>
                        <tr>
                            <td><strong>Business Number:</strong></td>
                            <td>${sanitize(invoice.seller_business_number || 'N/A')}</td>
                        </tr>
                        <tr>
                            <td><strong>VAT Number:</strong></td>
                            <td>${sanitize(invoice.seller_vat_number || 'N/A')}</td>
                        </tr>
                        <tr>
                            <td><strong>Address:</strong></td>
                            <td>${sanitize(invoice.seller_address || 'N/A')}</td>
                        </tr>
                    </table>
                </div>
            </div>
            ` : ''}
            
            ${lines && lines.length > 0 ? `
            <div class="row mt-3">
                <div class="col-12">
                    <h6><i class="fas fa-list me-2"></i>Invoice Items</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${lines.map(item => `
                                    <tr>
                                        <td>${sanitize(item.description || (item.product && (item.product.name || item.product.sku)) || item.name || 'N/A')}</td>
                                        <td>${sanitize((item.product && (item.product.name || item.product.sku)) || '')}</td>
                                        <td>${sanitize(item.quantity || item.qty || '1')}</td>
                                        <td>${formatCurrency(getLineUnitPrice(item), currency)}</td>
                                        <td>${formatCurrency(getLineTotal(item), currency)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="4" class="text-end">Grand Total</th>
                                    <th>${formatCurrency((() => { try { return (lines || []).reduce((s, ln) => s + getLineTotal(ln), 0); } catch (e) { return 0; } })(), currency)}</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            ` : ''}
        `;
        
        console.log('Modal content populated, showing modal...');
        const modal = new bootstrap.Modal(modalElement, { backdrop: true, keyboard: true, focus: true });
        // Remove any previous listener to avoid stacking
        modalElement.onhidden = null;
        modalElement.addEventListener('hidden.bs.modal', () => {
            document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }, { once: true });
        modalElement.addEventListener('shown.bs.modal', () => {
            // Ensure only one backdrop exists
            const backdrops = document.querySelectorAll('.modal-backdrop');
            if (backdrops.length > 1) backdrops.forEach((b, i) => { if (i > 0) b.remove(); });
        }, { once: true });
        modal.show();
        
    } catch (error) {
        console.error('Error showing invoice details:', error);
        alert(`Error loading invoice details: ${error.message}`);
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Ensure invoice modal lives under <body> to avoid stacking-context issues
    const invoiceModalEl = document.getElementById('invoiceModal');
    if (invoiceModalEl && invoiceModalEl.parentElement !== document.body) {
        document.body.appendChild(invoiceModalEl);
    }
    // Global safety cleanup in case a previous page left artifacts
    document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
    document.body.classList.remove('modal-open');
    // Only auto-load if URL has a company param; otherwise wait for user to apply filters
    const hasCompany = new URLSearchParams(window.location.search).get('company');
    if (hasCompany) loadInvoices(); else {
        document.getElementById('loading').style.display = 'none';
    }
    
    // Search and filter event listeners (client-side refinement after load)
    document.getElementById('searchInput').addEventListener('input', filterInvoices);
    document.getElementById('statusFilter').addEventListener('change', filterInvoices);
    document.getElementById('sortSelect').addEventListener('change', sortInvoices);

    // Apply filters button triggers server request
    const applyBtn = document.getElementById('applyFiltersBtn');
    const clearBtn = document.getElementById('clearFiltersBtn');
    if (applyBtn) applyBtn.addEventListener('click', () => {
        // Update URL for sharing/bookmarking
        const params = new URLSearchParams(window.location.search);
        const company = document.getElementById('companyFilter').value.trim();
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        if (company) params.set('company', company); else params.delete('company');
        if (start) params.set('start', start); else params.delete('start');
        if (end) params.set('end', end); else params.delete('end');
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        window.history.replaceState({}, '', newUrl);
        document.getElementById('loading').style.display = 'block';
        loadInvoices();
    });
    if (clearBtn) clearBtn.addEventListener('click', () => {
        document.getElementById('companyFilter').value = '';
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = 'all';
        // Clear URL
        window.history.replaceState({}, '', `${window.location.pathname}`);
        document.getElementById('invoices-container').style.display = 'none';
        document.getElementById('invoice-count').textContent = '0';
    });

    // Hydrate in-platform dropdown for companies (searchable panel) with fallback fetch
    (async () => {
        try {
            let companies = [];
            const cached = sessionStorage.getItem('duano_companies_cache_v1');
            if (cached) {
                companies = JSON.parse(cached) || [];
            } else {
                const resp = await fetch('/api/companies');
                if (resp.ok) {
                    const data = await resp.json();
                    companies = data.result?.data || [];
                    sessionStorage.setItem('duano_companies_cache_v1', JSON.stringify(companies));
                }
            }
            const nameToId = {};
            const normalized = companies.map(c => ({ id: c.id, name: c.public_name || c.name || '' })).filter(x => x.name);
            normalized.forEach(x => { nameToId[x.name] = x.id; });
            sessionStorage.setItem('duano_company_name_to_id', JSON.stringify(nameToId));

            const panel = document.getElementById('companyDropdown');
            const input = document.getElementById('companyFilter');
            const toggleBtn = document.getElementById('companyDropdownToggle');
            const render = (items) => {
                const top = items.slice(0, 500).map(x => `<div class=\"dropdown-item\" data-id=\"${x.id}\">${x.name}</div>`).join('');
                panel.innerHTML = top || '<div class=\"dropdown-empty\">No results</div>';
            };
            const open = () => { panel.style.display = 'block'; };
            const close = () => { panel.style.display = 'none'; };

            render(normalized);

            input.addEventListener('input', () => {
                const q = (input.value || '').toLowerCase();
                let filtered = q ? normalized.filter(x => x.name.toLowerCase().includes(q)) : normalized;
                render(filtered);
                open();
                // Server-side typeahead to widen results beyond cached page
                if (q.length >= 2) {
                    fetch(`/api/companies?q=${encodeURIComponent(q)}&per_page=50`).then(r => r.json()).then(d => {
                        const remote = (d.result?.data || []).map(x => ({ id: x.id, name: x.name })).filter(x => x.name);
                        // Update name→id map with remote
                        const mapJson = sessionStorage.getItem('duano_company_name_to_id');
                        const map = mapJson ? JSON.parse(mapJson) : {};
                        remote.forEach(x => { map[x.name] = x.id; });
                        sessionStorage.setItem('duano_company_name_to_id', JSON.stringify(map));
                        // Merge and render
                        const merged = [...remote, ...filtered].reduce((acc, cur) => { if (!acc.find(a => a.id === cur.id)) acc.push(cur); return acc; }, []);
                        render(merged);
                    }).catch(() => {});
                }
            });
            toggleBtn.addEventListener('click', () => {
                if (panel.style.display === 'none' || panel.style.display === '') open(); else close();
            });
            panel.addEventListener('click', (e) => {
                const item = e.target.closest('.dropdown-item');
                if (!item) return;
                const name = item.textContent;
                input.value = name;
                close();
            });
            document.addEventListener('click', (e) => {
                if (!document.getElementById('companyFilterWrapper').contains(e.target)) close();
            });
        } catch (e) { console.warn('Company suggestions load failed:', e); }
    })();

    try {
        const productHierarchy = sessionStorage.getItem('duano_product_hierarchy_cache_v1');
        const productCatalog = sessionStorage.getItem('duano_product_catalog_cache_v1');
        const list = document.getElementById('productSuggestions');
        const options = [];
        const addProduct = (p) => {
            if (!p) return;
            const name = p.name || p.product_name || '';
            const id = p.id || p.product_id;
            if (name) options.push(`<option value="${name}"></option>`);
        };
        if (productCatalog) {
            const prods = JSON.parse(productCatalog) || [];
            prods.slice(0, 2000).forEach(addProduct);
        }
        if (productHierarchy) {
            const hier = JSON.parse(productHierarchy) || [];
            hier.slice(0, 2000).forEach(item => {
                addProduct(item.composed_product);
                (item.components || []).forEach(comp => addProduct(comp.product));
            });
        }
        if (list) list.innerHTML = options.join('');
    } catch (e) { console.warn('Product suggestions load failed:', e); }
});
</script>

<style>
.dropdown-panel {
    position: absolute;
    z-index: 1050;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border-radius: 8px;
    max-height: 320px;
    overflow: auto;
}
.dropdown-item {
    padding: 8px 12px;
    cursor: pointer;
}
.dropdown-item:hover {
    background: #f5f5f5;
}
.dropdown-empty {
    padding: 10px 12px;
    color: #6c757d;
}
.invoice-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transition: all 0.2s ease-in-out;
}

.invoice-card {
    transition: all 0.2s ease-in-out;
}

.badge {
    font-size: 0.75em;
}

.table td {
    padding: 0.25rem 0.5rem;
}

.table th {
    padding: 0.5rem;
    background-color: #f8f9fa;
}
</style>
{% endblock %}
