{% extends "base.html" %}

{% block title %}Data Analysis - DOUANO{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-5">
                <div>
                    <h2 class="fw-bold text-dark mb-1">Data Analysis</h2>
                    <p class="text-muted mb-0">Overview of company performance and invoices</p>
                </div>
                <div class="d-flex gap-2">
                    {% if session.user_role == 'admin' %}
                    <button class="btn btn-modern btn-outline-secondary" onclick="syncLatestData()" 
                            data-bs-toggle="tooltip" data-bs-placement="bottom" 
                            title="Sync Latest Invoices">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-modern btn-outline-secondary" onclick="refreshCompanyMetrics()" 
                            data-bs-toggle="tooltip" data-bs-placement="bottom" 
                            title="Recalculate Metrics">
                        <i class="fas fa-calculator"></i>
                    </button>
                    <button class="btn btn-modern btn-outline-secondary" onclick="populateCompaniesDatabase()" 
                            data-bs-toggle="tooltip" data-bs-placement="bottom" 
                            title="Build Companies Database">
                        <i class="fas fa-database"></i>
                    </button>
                    {% endif %}
                    <button class="btn btn-modern-primary" onclick="forceRefreshData()" 
                            data-bs-toggle="tooltip" data-bs-placement="bottom" 
                            title="Refresh Data">
                        <i class="fas fa-refresh me-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Year Selection and Summary Stats -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="modern-card p-4">
                    <div class="row align-items-center">
                    <div class="col-md-4 border-end">
                        <label class="text-uppercase text-muted small fw-bold mb-3 d-block">Select Data View</label>
                            <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-outline-primary year-tag active rounded-pill px-4" data-year="2025" onclick="changeYear('2025')">
                                2025
                                </button>
                            <button class="btn btn-outline-primary year-tag rounded-pill px-4" data-year="2024" onclick="changeYear('2024')">
                                2024
                                </button>
                            <button class="btn btn-outline-success year-tag rounded-pill px-4" data-year="combined" onclick="changeYear('combined')">
                                Combined
                                </button>
                            </div>
                        </div>
                    <div class="col-md-8 ps-md-5">
                            <div class="row" id="year-stats" style="display: none;">
                                <div class="col-md-3">
                                    <div class="text-center">
                                    <div class="h3 fw-bold text-primary mb-1" id="stat-total-companies">-</div>
                                    <small class="text-muted fw-bold text-uppercase">Companies</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                    <div class="h3 fw-bold text-success mb-1" id="stat-total-revenue">-</div>
                                    <small class="text-muted fw-bold text-uppercase">Total Revenue</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                    <div class="h3 fw-bold text-info mb-1" id="stat-total-invoices">-</div>
                                    <small class="text-muted fw-bold text-uppercase">Invoices</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                    <div class="h3 fw-bold text-warning mb-1" id="stat-avg-revenue">-</div>
                                    <small class="text-muted fw-bold text-uppercase">Avg/Company</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Year Breakdown for Combined View -->
                        <div class="mt-4 pt-3 border-top" id="year-breakdown" style="display: none;">
                             <div class="row text-sm text-muted">
                                        <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <div class="badge bg-primary rounded-pill me-2">2024</div>
                                                        <span id="breakdown-2024">-</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <div class="badge bg-success rounded-pill me-2">2025</div>
                                                        <span id="breakdown-2025">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sync Status -->
    <div id="sync-status" class="alert alert-info" style="display: none;">
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-3" role="status">
                <span class="visually-hidden">Syncing...</span>
            </div>
            <div>
                <strong>Syncing latest data...</strong>
                <p class="mb-0" id="sync-message">Fetching latest invoices from DOUANO...</p>
            </div>
        </div>
    </div>

    <!-- Sync Results -->
    <div id="sync-results" style="display: none;"></div>

    <!-- Filters and Search -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="modern-card p-4">
                <div class="row g-4 align-items-end">
                    <div class="col-md-4 col-lg-3">
                        <label class="form-label text-muted small fw-bold text-uppercase">Search</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0 ps-3"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" class="form-control border-start-0" id="searchInput" placeholder="Search companies..." onkeyup="filterCompanies()">
                        </div>
                        </div>
                        <div class="col-md-3">
                        <label class="form-label text-muted small fw-bold text-uppercase">Categories</label>
                        <div class="searchable-dropdown-wrapper w-100">
                            <div class="dropdown-trigger-modern w-100 justify-content-between bg-white" id="category-dropdown-trigger">
                                <span class="trigger-text text-muted text-truncate">All categories</span>
                                <i class="fas fa-chevron-down small"></i>
                                </div>
                            <div class="dropdown-menu-modern shadow-lg" id="category-dropdown-menu">
                                    <div class="dropdown-search-box">
                                        <i class="fas fa-search"></i>
                                    <input type="text" placeholder="Filter..." id="category-search-input">
                                    </div>
                                    <div class="dropdown-options-list" id="category-dropdown-options"></div>
                                </div>
                            </div>
                            <div class="selected-tags mt-2" id="category-selected-tags"></div>
                        </div>
                        <div class="col-md-2">
                        <label class="form-label text-muted small fw-bold text-uppercase">Min Revenue</label>
                        <div class="input-group">
                             <span class="input-group-text bg-white border-end-0 ps-3 text-muted">‚Ç¨</span>
                            <input type="number" class="form-control border-start-0" id="minRevenue" placeholder="0" onchange="filterCompanies()">
                        </div>
                        </div>
                        <div class="col-md-2">
                        <label class="form-label text-muted small fw-bold text-uppercase">Sort By</label>
                            <select class="form-select" id="sortBy" onchange="sortCompanies()">
                            <option value="revenue_desc">Revenue (High)</option>
                            <option value="revenue_asc">Revenue (Low)</option>
                                <option value="name_asc">Name (A-Z)</option>
                                <option value="name_desc">Name (Z-A)</option>
                            <option value="invoices_desc">Invoices (High)</option>
                            <option value="invoices_asc">Invoices (Low)</option>
                            </select>
                        </div>
                     <div class="col-md-2 col-lg-2 d-flex gap-2">
                        <button class="btn btn-outline-warning flex-fill h-100" id="majorRetailerFilter" onclick="toggleMajorRetailerFilter()" title="Show major retailers only">
                            <i class="fas fa-star"></i>
                        </button>
                        <div class="btn-group flex-fill" role="group">
                             <input type="radio" class="btn-check" name="viewMode" id="viewCard" autocomplete="off" checked onchange="document.getElementById('viewMode').value='cards'; changeViewMode();">
                            <label class="btn btn-outline-secondary" for="viewCard"><i class="fas fa-th-large"></i></label>

                            <input type="radio" class="btn-check" name="viewMode" id="viewTable" autocomplete="off" onchange="document.getElementById('viewMode').value='table'; changeViewMode();">
                            <label class="btn btn-outline-secondary" for="viewTable"><i class="fas fa-list"></i></label>
                        </div>
                        <select class="form-select d-none" id="viewMode" onchange="changeViewMode()">
                                <option value="cards">Card View</option>
                                <option value="table">Table View</option>
                            </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading company data...</p>
    </div>

    <!-- Error State -->
    <div id="error-message" class="alert alert-danger" style="display: none;">
        <h5><i class="fas fa-exclamation-triangle me-2"></i>Error</h5>
        <p class="mb-0" id="error-text">Failed to load company data</p>
    </div>

    <!-- Results Info -->
    <div id="results-info" class="mb-3" style="display: none;">
        <p class="text-muted mb-0">
            Showing <span id="showing-count">0</span> of <span id="total-count">0</span> companies for <span id="current-year">2025</span>
        </p>
    </div>

    <!-- Card View -->
    <div id="companies-cards" class="row" style="display: none;">
        <!-- Company cards will be inserted here -->
    </div>

    <!-- Table View -->
    <div id="companies-table" style="display: none;">
        <div class="card border-0 shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Company</th>
                            <th>Contact</th>
                            <th>Location</th>
                            <th>Invoices</th>
                            <th>Total Revenue</th>
                            <th>Avg Invoice</th>
                            <th>Last Invoice</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="companies-table-body">
                        <!-- Table rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- No Results -->
    <div id="no-results" class="text-center py-5" style="display: none;">
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">No companies found</h5>
        <p class="text-muted">Try adjusting your search criteria</p>
    </div>
</div>

<!-- Company Detail Sidepanel -->
<div class="sidepanel-overlay" id="companyPanelOverlay" onclick="closeCompanyPanel()"></div>
<div class="sidepanel" id="companyPanel">
    <div class="sidepanel-header">
        <h5 class="sidepanel-title" id="companyModalTitle">Company Details</h5>
        <button type="button" class="btn-close" onclick="closeCompanyPanel()"></button>
            </div>
    <div class="sidepanel-body" id="companyModalBody">
                <!-- Company details will be loaded here -->
    </div>
</div>

<!-- Invoice Detail Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="invoiceModalTitle">Invoice Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="invoiceModalBody" style="max-height: 70vh; overflow-y: auto;">
                <!-- Invoice details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-arrow-left me-2"></i>Back to Company
                </button>
                <button type="button" class="btn btn-primary" onclick="window.print()">
                    <i class="fas fa-print me-2"></i>Print Invoice
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<style>
    :root {
        --primary-color: #6366f1;
        --primary-soft: #e0e7ff;
        --secondary-color: #ec4899;
        --secondary-soft: #fce7f3;
        --success-color: #10b981;
        --success-soft: #d1fae5;
        --warning-color: #f59e0b;
        --warning-soft: #fef3c7;
        --surface-bg: #f9fafb;
        --card-bg: #ffffff;
        --text-main: #111827;
        --text-muted: #6b7280;
        --border-color: #e5e7eb;
        --radius-sm: 0.5rem;
        --radius-md: 0.75rem;
        --radius-lg: 1rem;
        --radius-xl: 1.5rem;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --font-sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    body {
        background-color: var(--surface-bg);
        font-family: var(--font-sans);
        color: var(--text-main);
    }

    /* Modern Card */
    .modern-card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        transition: all 0.2s ease;
    }

    .modern-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    /* Sidepanel Styles - Redesigned */
.sidepanel-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(4px);
    opacity: 0;
    visibility: hidden;
        transition: all 0.3s ease;
    z-index: 1040;
}

.sidepanel-overlay.show {
    opacity: 1;
    visibility: visible;
}

.sidepanel {
    position: fixed;
    top: 0;
    right: -50vw;
    width: 50vw;
    max-width: 90vw;
    height: 100%;
        background: var(--card-bg);
        box-shadow: -10px 0 30px rgba(0, 0, 0, 0.1);
        transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    z-index: 1050;
    display: flex;
    flex-direction: column;
}

.sidepanel.show {
    right: 0;
}

.sidepanel-header {
        padding: 2rem 2rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        background: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.sidepanel-title {
    margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-main);
        letter-spacing: -0.025em;
}

.sidepanel-body {
    flex: 1;
        padding: 2rem;
    overflow-y: auto;
        background-color: #ffffff;
    }

    /* Detail Sections */
    .detail-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: #f8fafc;
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-color);
    }

    .detail-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .detail-value {
        font-size: 1rem;
        color: var(--text-main);
        font-weight: 500;
    }

    /* Tags */
    .modern-badge {
        padding: 0.35em 0.8em;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.025em;
    }

    .badge-soft-primary { background: var(--primary-soft); color: var(--primary-color); }
    .badge-soft-success { background: var(--success-soft); color: var(--success-color); }
    .badge-soft-warning { background: var(--warning-soft); color: var(--warning-color); }
    .badge-soft-secondary { background: var(--secondary-soft); color: var(--secondary-color); }

    /* Buttons */
    .btn-modern {
        border-radius: var(--radius-md);
        font-weight: 500;
        padding: 0.5rem 1rem;
        transition: all 0.2s;
        border: none;
    }
    
    .btn-modern-primary {
        background: var(--primary-color);
        color: white;
        box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
    }
    
    .btn-modern-primary:hover {
        background: #4f46e5;
    transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(99, 102, 241, 0.4);
    }

    /* Invoice List in Sidepanel */
    .invoice-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        transition: background 0.2s;
        cursor: pointer;
        border-radius: var(--radius-md);
    }

    .invoice-item:hover {
        background-color: var(--surface-bg);
    }

    .invoice-item:last-child {
        border-bottom: none;
    }

    /* Dropdown Styles */
    .form-select-modern {
        appearance: none;
        background-color: white;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 0.5rem 2rem 0.5rem 1rem;
        font-size: 0.875rem;
        color: var(--text-main);
        cursor: pointer;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
        box-shadow: var(--shadow-sm);
        transition: all 0.2s ease;
    }

    .form-select-modern:focus {
        border-color: var(--primary-color);
        outline: 0;
        box-shadow: 0 0 0 3px var(--primary-soft);
    }

    .form-input-modern {
        background-color: white;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        color: var(--text-main);
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
    }

    .form-input-modern:focus {
        border-color: var(--primary-color);
        outline: 0;
        box-shadow: 0 0 0 3px var(--primary-soft);
    }

    .form-input-modern:read-only {
        background-color: #f8fafc;
        cursor: default;
    }

    .modal-header {
        border-bottom: 1px solid var(--border-color);
        padding: 1.5rem 2rem;
        background: #f8fafc;
        border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    }

    .modal-body {
        padding: 2rem;
    }

    .modal-footer {
        border-top: 1px solid var(--border-color);
        padding: 1.5rem 2rem;
        background: #f8fafc;
        border-radius: 0 0 var(--radius-xl) var(--radius-xl);
    }

    /* Scrollbars */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Category Tags Filter */
.category-tags-filter {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    padding: 0.75rem;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
    min-height: 48px;
    align-items: center;
}

    /* Selected Tags */
    .selected-tag {
    display: inline-flex;
    align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.75rem;
        background: #fee2e2;
        border: 1px solid #fca5a5;
        border-radius: 9999px;
        font-size: 0.75rem;
        color: #b91c1c;
    cursor: pointer;
    transition: all 0.2s ease;
    }
    
    .year-tag {
        border-radius: 9999px;
        font-weight: 500;
        padding: 0.5rem 1.25rem;
}
</style>
<script>
let allCompanies = [];
let filteredCompanies = [];
let currentViewMode = 'cards';
let currentYear = '2025';
let categoryStates = {}; // Track category filter states: 'included', 'excluded', or null (removed)
let showOnlyMajorRetailers = false; // Filter for major retailers

// Cache configuration
const DATA_CACHE_PREFIX = 'data_companies_cache_';
const DATA_CACHE_TIME_PREFIX = 'data_companies_cache_time_';
const DATA_CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

function getCacheKey(year) {
    return DATA_CACHE_PREFIX + year;
}

function getCacheTimeKey(year) {
    return DATA_CACHE_TIME_PREFIX + year;
}

function isCacheValid(year) {
    const cachedTime = sessionStorage.getItem(getCacheTimeKey(year));
    if (!cachedTime) return false;
    return (Date.now() - parseInt(cachedTime)) < DATA_CACHE_DURATION;
}

function getCachedData(year) {
    if (!isCacheValid(year)) return null;
    const cached = sessionStorage.getItem(getCacheKey(year));
    if (!cached) return null;
    try {
        return JSON.parse(cached);
    } catch (e) {
        return null;
    }
}

function setCachedData(year, data) {
    try {
        sessionStorage.setItem(getCacheKey(year), JSON.stringify(data));
        sessionStorage.setItem(getCacheTimeKey(year), String(Date.now()));
    } catch (e) {
        console.warn('Failed to cache data:', e);
    }
}

function clearCache(year) {
    if (year) {
        sessionStorage.removeItem(getCacheKey(year));
        sessionStorage.removeItem(getCacheTimeKey(year));
    } else {
        // Clear all years
        ['2024', '2025', 'combined'].forEach(y => {
            sessionStorage.removeItem(getCacheKey(y));
            sessionStorage.removeItem(getCacheTimeKey(y));
        });
    }
}

// Major retailer company IDs
const MAJOR_RETAILER_IDS = [1324, 1340, 9986, 1213, 1712]; // Delhaize, Geers, Inter Drinks, Biofresh, Terroirist

function isMajorRetailer(companyId) {
    return MAJOR_RETAILER_IDS.includes(companyId);
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips with instant appearance
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            delay: { show: 0, hide: 0 }
        });
    });
    
    // Check authentication status on page load
    fetch('/api/test-sync')
        .then(res => res.json())
        .then(data => {
            console.log('Auth status:', data);
            if (!data.token_valid) {
                console.warn('‚ö†Ô∏è Not authenticated - sync operations will fail');
            }
        })
        .catch(err => console.error('Failed to check auth status:', err));
    
    // Check if we need to filter by company (coming from alerts page)
    const filterCompanyId = sessionStorage.getItem('filterCompanyId');
    const filterCompanyName = sessionStorage.getItem('filterCompanyName');
    
    if (filterCompanyId && filterCompanyName) {
        // Clear the session storage
        sessionStorage.removeItem('filterCompanyId');
        sessionStorage.removeItem('filterCompanyName');
        
        // Switch to Combined tab first, then load data
        changeYear('combined').then(() => {
            // Auto-populate the search box with company name
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = filterCompanyName;
                searchInput.focus();
                
                // Trigger the search/filter
                filterCompanies();
                
                // Show toast notification
                setTimeout(() => {
                    const toast = document.createElement('div');
                    toast.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
                    toast.style.zIndex = '9999';
                    toast.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>
                        Showing invoices for: <strong>${filterCompanyName}</strong> (Combined 2024 & 2025)
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 4000);
                }, 300);
                
                // Find and click on the company after filtering
                setTimeout(() => {
                    const companyElement = document.querySelector(`[data-company-id="${filterCompanyId}"]`);
                    if (companyElement) {
                        companyElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Highlight the card briefly
                        companyElement.style.outline = '2px solid #6c5ce7';
                        setTimeout(() => {
                            companyElement.style.outline = '';
                            companyElement.click();
                        }, 800);
                    }
                }, 500);
            }
        });
    } else {
        loadData().then(() => {
            // Check if there's a company parameter in URL to auto-open
            checkUrlForCompany();
        });
    }
});

// Check URL for company parameter and open the company panel
function checkUrlForCompany() {
    const urlParams = new URLSearchParams(window.location.search);
    const companyId = urlParams.get('company');
    const companyName = urlParams.get('name');
    
    if (companyId || companyName) {
        // Wait for data to load, then find and show the company
        setTimeout(() => {
            let company = null;
            
            if (companyId) {
                company = allCompanies.find(c => c.company_id == companyId || c.id == companyId);
            }
            
            // If not found by ID, try searching by name
            if (!company && companyName) {
                const searchName = companyName.toLowerCase();
                company = allCompanies.find(c => 
                    c.name?.toLowerCase().includes(searchName) ||
                    c.name?.toLowerCase() === searchName
                );
            }
            
            if (company) {
                // Auto-fill search box with company name
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.value = company.name;
                    filterCompanies();
                }
                
                // Open the company details panel
                showCompanyDetails(company.id);
            } else {
                console.warn('Company not found:', companyId || companyName);
                // Still search for the name even if not found exactly
                if (companyName) {
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        searchInput.value = companyName;
                        filterCompanies();
                    }
                }
            }
            
            // Clean up the URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }, 300);
    }
}

async function changeYear(year) {
    currentYear = year;
    
    // Update active button
    document.querySelectorAll('.year-tag').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.year === year) {
            btn.classList.add('active');
        }
    });
    
    // Update current year display
    const currentYearSpan = document.getElementById('current-year');
    if (currentYearSpan) {
        currentYearSpan.textContent = year === 'combined' ? '2024 & 2025' : year;
    }
    
    loadData();
}

async function loadData(forceRefresh = false) {
    try {
        document.getElementById('error-message').style.display = 'none';
        document.getElementById('companies-cards').style.display = 'none';
        document.getElementById('companies-table').style.display = 'none';
        document.getElementById('results-info').style.display = 'none';
        document.getElementById('no-results').style.display = 'none';
        document.getElementById('year-stats').style.display = 'none';
        
        // Check cache first (unless force refresh)
        const cachedData = !forceRefresh ? getCachedData(currentYear) : null;
        
        if (cachedData) {
            console.log(`üì¶ Using cached data for ${currentYear} (${cachedData.companies?.length || 0} companies)`);
            document.getElementById('loading').style.display = 'none';
            
            allCompanies = cachedData.companies || [];
            filteredCompanies = [...allCompanies];
            
            // Populate category filter dropdown
            populateCategories();
            
            // Update stats
            updateStats(cachedData);
            
            // Display companies
            displayCompanies();
            
            // Show cached indicator
            showCacheIndicator(true);
            return;
        }
        
        // No cache, fetch from API
        console.log(`üì° Fetching fresh data for ${currentYear}...`);
        document.getElementById('loading').style.display = 'block';
        
        const apiEndpoint = `/api/companies-from-db?year=${currentYear}`;
        
        const response = await fetch(apiEndpoint);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Cache the data
        setCachedData(currentYear, data);
        console.log(`‚úÖ Cached ${data.companies?.length || 0} companies for ${currentYear}`);
        
        allCompanies = data.companies || [];
        filteredCompanies = [...allCompanies];
        
        // Populate category filter dropdown
        populateCategories();
        
        // Update stats
        updateStats(data);
        
        // Display companies
        displayCompanies();
        
        document.getElementById('loading').style.display = 'none';
        showCacheIndicator(false);
        
    } catch (error) {
        console.error('Error loading companies:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-message').style.display = 'block';
        document.getElementById('error-text').textContent = error.message;
    }
}

function showCacheIndicator(fromCache) {
    // Cache indicator removed - was redundant
}

// Force refresh function for the refresh button
function forceRefreshData() {
    clearCache(currentYear);
    loadData(true);
}

function updateStats(data) {
    document.getElementById('year-stats').style.display = 'flex';
    document.getElementById('stat-total-companies').textContent = data.total_companies || 0;
    document.getElementById('stat-total-revenue').textContent = '‚Ç¨' + (data.total_revenue || 0).toLocaleString('nl-BE', {minimumFractionDigits: 2});
    document.getElementById('stat-total-invoices').textContent = data.total_invoices || 0;
    
    const avgRevenue = data.total_companies > 0 ? (data.total_revenue / data.total_companies) : 0;
    document.getElementById('stat-avg-revenue').textContent = '‚Ç¨' + avgRevenue.toLocaleString('nl-BE', {minimumFractionDigits: 2});
    
    // Show year breakdown for combined view
    if (currentYear === 'combined' && data.year_breakdown) {
        document.getElementById('year-breakdown').style.display = 'block';
        
        const breakdown2024 = data.year_breakdown['2024'];
        const breakdown2025 = data.year_breakdown['2025'];
        
        document.getElementById('breakdown-2024').innerHTML = `
            ${breakdown2024.companies} companies, ${breakdown2024.invoices} invoices, ‚Ç¨${breakdown2024.revenue.toLocaleString('nl-BE', {minimumFractionDigits: 2})}
        `;
        
        document.getElementById('breakdown-2025').innerHTML = `
            ${breakdown2025.companies} companies, ${breakdown2025.invoices} invoices, ‚Ç¨${breakdown2025.revenue.toLocaleString('nl-BE', {minimumFractionDigits: 2})}
        `;
    } else {
        document.getElementById('year-breakdown').style.display = 'none';
    }
}

async function syncLatestData() {
    try {
        document.getElementById('sync-status').style.display = 'block';
        document.getElementById('sync-results').style.display = 'none';
        document.getElementById('sync-message').innerHTML = 'Fetching latest invoices from DUANO...<br><small class="text-muted">This may take 30-60 seconds depending on the number of invoices</small>';
        
        // Handle combined view - sync 2025 by default
        const yearToSync = currentYear === 'combined' ? '2025' : currentYear;
        
        console.log(`Starting sync for year: ${yearToSync}`);
        
        const response = await fetch(`/api/sync-${yearToSync}-invoices`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            // Try to parse error message
            let errorData;
            try {
                errorData = await response.json();
            } catch (e) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            // Handle authentication errors
            if (response.status === 401) {
                document.getElementById('sync-status').style.display = 'none';
                document.getElementById('sync-results').style.display = 'block';
                document.getElementById('sync-results').innerHTML = `
                    <div class="alert alert-warning">
                        <h5><i class="fas fa-lock me-2"></i>Authentication Required</h5>
                        <p class="mb-2"><strong>${errorData.message || 'Your session has expired.'}</strong></p>
                        <p class="mb-0">
                            <a href="/" class="btn btn-primary">
                                <i class="fas fa-sign-in-alt me-2"></i>Log In to DUANO
                            </a>
                        </p>
                    </div>
                `;
                return;
            }
            
            throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        document.getElementById('sync-status').style.display = 'none';
        document.getElementById('sync-results').style.display = 'block';
        
        if (result.success) {
            document.getElementById('sync-results').innerHTML = `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>Daily Sync Completed!</h5>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <strong>Total Fetched:</strong> ${result.total_fetched}
                        </div>
                        <div class="col-md-3">
                            <strong>New Records:</strong> <span class="text-success">${result.saved}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Updated:</strong> <span class="text-info">${result.updated}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Errors:</strong> <span class="text-danger">${result.errors}</span>
                        </div>
                    </div>
                    ${result.saved > 0 || result.updated > 0 ? `
                        <p class="mt-2 mb-0">
                            <strong>${result.saved} new invoices</strong> have been added to the database!<br>
                            <i class="fas fa-calculator me-1"></i><small class="text-muted">Company metrics are being automatically updated...</small>
                        </p>
                    ` : '<p class="mt-2 mb-0">Database is up to date - no new invoices found.</p>'}
                </div>
            `;
            
            // Clear cache and refresh data after sync
            clearCache(); // Clear all year caches since invoices may affect all views
            setTimeout(() => loadData(true), 2000);
        } else {
            document.getElementById('sync-results').innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Sync Failed</h5>
                    <p class="mb-2"><strong>${result.error || result.message || 'Unknown error'}</strong></p>
                    ${result.error_type ? `<p class="mb-1"><small><strong>Error Type:</strong> ${result.error_type}</small></p>` : ''}
                    ${result.details ? `
                        <details class="mt-2">
                            <summary class="cursor-pointer text-muted small">Technical Details (click to expand)</summary>
                            <pre class="mt-2 p-2 bg-light border rounded small" style="max-height: 200px; overflow-y: auto;">${escapeHtml(result.details)}</pre>
                        </details>
                    ` : ''}
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Sync error:', error);
        document.getElementById('sync-status').style.display = 'none';
        document.getElementById('sync-results').style.display = 'block';
        
        let errorMessage = error.message;
        let errorDetails = '';
        
        // Provide helpful context for common errors
        if (error.message.includes('Not authenticated') || error.message.includes('401') || error.message.includes('403')) {
            errorMessage = 'üîê Authentication Required';
            errorDetails = '<strong>Your DUANO session has expired.</strong> Please <a href="/" class="alert-link">log in again</a> to continue syncing data.';
        } else if (error.message.includes('JSON')) {
            errorMessage = 'Server returned an invalid response (not JSON)';
            errorDetails = 'This usually means the server encountered an error. Check the Flask logs for details.';
        } else if (error.message.includes('500')) {
            errorMessage = 'Server error occurred while syncing data';
            errorDetails = 'The DUANO API may be temporarily unavailable, or your session may have expired. Try <a href="/" class="alert-link">logging in again</a>.';
        }
        
        document.getElementById('sync-results').innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Sync Failed</h5>
                <p class="mb-2"><strong>${errorMessage}</strong></p>
                ${errorDetails ? `<p class="mb-0 small">${errorDetails}</p>` : ''}
                <hr class="my-2">
                <small class="text-muted">Technical details: ${error.message}</small>
            </div>
        `;
    }
}

async function refreshCompanyMetrics() {
    try {
        document.getElementById('sync-status').style.display = 'block';
        document.getElementById('sync-results').style.display = 'none';
        document.getElementById('sync-message').textContent = 'Recalculating company metrics from invoice data...';
        
        const response = await fetch('/api/refresh-company-metrics', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        document.getElementById('sync-status').style.display = 'none';
        document.getElementById('sync-results').style.display = 'block';
        
        if (result.success) {
            document.getElementById('sync-results').innerHTML = `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>Company Metrics Refreshed!</h5>
                    <p class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        All company revenue totals, invoice counts, and statistics have been recalculated from the latest invoice data.
                    </p>
                </div>
            `;
            
            // Clear cache and refresh data after metrics update
            clearCache();
            setTimeout(() => loadData(true), 1500);
        } else {
            document.getElementById('sync-results').innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Refresh Failed</h5>
                    <p class="mb-0">${result.error || result.message || 'Unknown error'}</p>
                </div>
            `;
        }
        
    } catch (error) {
        document.getElementById('sync-status').style.display = 'none';
        document.getElementById('sync-results').style.display = 'block';
        document.getElementById('sync-results').innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Error</h5>
                <p class="mb-0">${error.message}</p>
            </div>
        `;
    }
}

async function populateCompaniesDatabase() {
    try {
        document.getElementById('sync-status').style.display = 'block';
        document.getElementById('sync-results').style.display = 'none';
        document.getElementById('sync-message').textContent = 'Extracting company data from all invoices...';
        
        const response = await fetch('/api/populate-companies-enhanced', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        document.getElementById('sync-status').style.display = 'none';
        document.getElementById('sync-results').style.display = 'block';
        
        if (result.success) {
            document.getElementById('sync-results').innerHTML = `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>Companies Database Populated!</h5>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <strong>Total Processed:</strong> ${result.total_processed}
                        </div>
                        <div class="col-md-3">
                            <strong>New Companies:</strong> <span class="text-success">${result.saved}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Updated:</strong> <span class="text-info">${result.updated}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Errors:</strong> <span class="text-danger">${result.errors}</span>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <strong>API Fetch Success:</strong> <span class="text-success">${result.api_fetch_stats.success}</span>
                        </div>
                        <div class="col-md-6">
                            <strong>API Fetch Errors:</strong> <span class="text-danger">${result.api_fetch_stats.errors}</span>
                        </div>
                    </div>
                    <p class="mt-3 mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Enhanced companies database created with complete DOUANO API data including pricing categories, addresses, company status, categories, and financial metrics.
                    </p>
                </div>
            `;
            
            // Clear cache and refresh data after population
            clearCache();
            setTimeout(() => loadData(true), 2000);
        } else {
            document.getElementById('sync-results').innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Population Failed</h5>
                    <p class="mb-0">${result.error || result.message || 'Unknown error'}</p>
                </div>
            `;
        }
        
    } catch (error) {
        document.getElementById('sync-status').style.display = 'none';
        document.getElementById('sync-results').style.display = 'block';
        document.getElementById('sync-results').innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Error</h5>
                <p class="mb-0">${error.message}</p>
            </div>
        `;
    }
}

function toggleMajorRetailerFilter() {
    showOnlyMajorRetailers = !showOnlyMajorRetailers;
    const btn = document.getElementById('majorRetailerFilter');
    
    if (showOnlyMajorRetailers) {
        btn.classList.remove('btn-outline-warning');
        btn.classList.add('btn-warning');
    } else {
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-outline-warning');
    }
    
    filterCompanies();
}

function filterCompanies() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const minRevenue = parseFloat(document.getElementById('minRevenue').value) || 0;
    
    filteredCompanies = allCompanies.filter(company => {
        // Major retailer filter
        if (showOnlyMajorRetailers && !isMajorRetailer(company.company_id)) {
            return false;
        }
        
        // Category filtering
        const companyCategories = getCompanyCategories(company);
        const excludedCategories = Object.keys(categoryStates).filter(cat => categoryStates[cat] === 'excluded');
        const includedCategories = Object.keys(categoryStates).filter(cat => categoryStates[cat] === 'included');
        
        // First, check if company has any excluded categories - if so, filter it out
        if (excludedCategories.length > 0) {
            const hasExcludedCategory = companyCategories.some(cat => excludedCategories.includes(cat));
            if (hasExcludedCategory) return false; // Exclude this company
        }
        
        // If there are included categories specified, company must have at least one
        if (includedCategories.length > 0 && includedCategories.length < Object.keys(categoryStates).length) {
            // Not all categories are included, so filter
            const hasIncludedCategory = companyCategories.some(cat => includedCategories.includes(cat));
            if (!hasIncludedCategory) return false;
        }
        
        // Search term filtering
        if (searchTerm && searchTerm.trim() !== '') {
            const searchableText = [
                company.name || '',
                company.vat_number || '',
                company.email || '',
                company.contact_person || '',
                company.address?.city || '',
                company.address?.country || ''
            ].join(' ').toLowerCase();
            
            if (!searchableText.includes(searchTerm)) return false;
        }
        
        // Revenue filter
        if (company.total_revenue < minRevenue) return false;
        
        return true;
    });
    
    // Update statistics based on filtered companies
    updateFilteredStats();
    
    sortCompanies();
}

function updateFilteredStats() {
    // Calculate statistics based on filtered companies
    const totalCompanies = filteredCompanies.length;
    const totalRevenue = filteredCompanies.reduce((sum, company) => sum + (company.total_revenue || 0), 0);
    const totalInvoices = filteredCompanies.reduce((sum, company) => sum + (company.invoice_count || 0), 0);
    const avgRevenue = totalCompanies > 0 ? (totalRevenue / totalCompanies) : 0;
    
    // Update the stats display
    document.getElementById('stat-total-companies').textContent = totalCompanies;
    document.getElementById('stat-total-revenue').textContent = '‚Ç¨' + totalRevenue.toLocaleString('nl-BE', {minimumFractionDigits: 2});
    document.getElementById('stat-total-invoices').textContent = totalInvoices;
    document.getElementById('stat-avg-revenue').textContent = '‚Ç¨' + avgRevenue.toLocaleString('nl-BE', {minimumFractionDigits: 2});
    
    // Update year breakdown if in combined view
    if (currentYear === 'combined') {
        const year2024Companies = filteredCompanies.filter(c => c.years_data && c.years_data['2024']);
        const year2025Companies = filteredCompanies.filter(c => c.years_data && c.years_data['2025']);
        
        const revenue2024 = filteredCompanies.reduce((sum, c) => {
            return sum + (c.years_data && c.years_data['2024'] ? c.years_data['2024'].total_revenue || 0 : 0);
        }, 0);
        
        const revenue2025 = filteredCompanies.reduce((sum, c) => {
            return sum + (c.years_data && c.years_data['2025'] ? c.years_data['2025'].total_revenue || 0 : 0);
        }, 0);
        
        const invoices2024 = filteredCompanies.reduce((sum, c) => {
            return sum + (c.years_data && c.years_data['2024'] ? c.years_data['2024'].invoice_count || 0 : 0);
        }, 0);
        
        const invoices2025 = filteredCompanies.reduce((sum, c) => {
            return sum + (c.years_data && c.years_data['2025'] ? c.years_data['2025'].invoice_count || 0 : 0);
        }, 0);
        
        const breakdown2024Element = document.getElementById('breakdown-2024');
        const breakdown2025Element = document.getElementById('breakdown-2025');
        
        if (breakdown2024Element) {
            breakdown2024Element.innerHTML = `
                ${year2024Companies.length} companies, ${invoices2024} invoices, ‚Ç¨${revenue2024.toLocaleString('nl-BE', {minimumFractionDigits: 2})}
            `;
        }
        
        if (breakdown2025Element) {
            breakdown2025Element.innerHTML = `
                ${year2025Companies.length} companies, ${invoices2025} invoices, ‚Ç¨${revenue2025.toLocaleString('nl-BE', {minimumFractionDigits: 2})}
            `;
        }
    }
}

function getCompanyCategories(company) {
    // Extract categories from raw_company_data
    if (company.raw_company_data && company.raw_company_data.company_categories) {
        if (Array.isArray(company.raw_company_data.company_categories)) {
            return company.raw_company_data.company_categories.map(cat => cat.name || cat);
        }
    }
    
    // Fallback: try direct company_categories field
    if (company.company_categories) {
        if (Array.isArray(company.company_categories)) {
            return company.company_categories.map(cat => cat.name || cat);
        }
    }
    
    return [];
}

function populateCategories() {
    const categorySet = new Set();
    
    // Extract all unique categories from all companies
    allCompanies.forEach(company => {
        const categories = getCompanyCategories(company);
        categories.forEach(cat => categorySet.add(cat));
    });
    
    const sortedCategories = Array.from(categorySet).sort();
    
    // Initialize all categories as included by default
    categoryStates = {};
    sortedCategories.forEach(cat => {
        categoryStates[cat] = 'included';
    });
    
    renderCategoryTags();
}

function renderCategoryTags() {
    // Render dropdown options
    const optionsContainer = document.getElementById('category-dropdown-options');
    const selectedContainer = document.getElementById('category-selected-tags');
    if (!optionsContainer) return;
    
    const categories = Object.keys(categoryStates).sort();
    
    if (categories.length === 0) {
        optionsContainer.innerHTML = '<div class="p-3 text-center text-muted small">No categories found</div>';
        return;
    }
    
    // Render action buttons
    optionsContainer.innerHTML = `
        <div class="d-flex gap-2 p-2 border-bottom">
            <button class="btn btn-sm btn-outline-success flex-fill" onclick="selectAllCategories()">
                <i class="fas fa-check-double me-1"></i>Select All
            </button>
            <button class="btn btn-sm btn-outline-danger flex-fill" onclick="deselectAllCategories()">
                <i class="fas fa-times me-1"></i>Deselect All
            </button>
        </div>
    `;
    
    // Render options in dropdown
    categories.forEach(category => {
        const state = categoryStates[category];
        const stateClass = state === 'excluded' ? 'excluded' : 'included';
        const icon = state === 'excluded' ? 'times-circle' : 'check-circle';
        
        const option = document.createElement('div');
        option.className = `dropdown-option-item ${stateClass}`;
        option.innerHTML = `
            <div class="option-checkbox">
                <i class="fas fa-${icon}"></i>
            </div>
            <span class="option-label">${escapeHtml(category)}</span>
        `;
        option.onclick = () => {
            toggleCategory(category);
            // Don't close dropdown
        };
        
        optionsContainer.appendChild(option);
    });
    
    // Render selected tags (only show excluded ones to save space) - horizontal layout
    const excludedCategories = categories.filter(cat => categoryStates[cat] === 'excluded');
    
    selectedContainer.innerHTML = '';
    if (excludedCategories.length > 0) {
        excludedCategories.forEach(category => {
            const tag = document.createElement('span');
            tag.className = 'selected-tag excluded';
            tag.innerHTML = `
                <span>${escapeHtml(category)}</span>
                <i class="fas fa-times"></i>
            `;
            tag.onclick = () => toggleCategory(category);
            selectedContainer.appendChild(tag);
        });
    }
    
    // Update trigger text
    const trigger = document.getElementById('category-dropdown-trigger');
    const triggerText = trigger.querySelector('.trigger-text');
    const excludedCount = excludedCategories.length;
    
    if (excludedCount === 0) {
        triggerText.textContent = 'All categories';
        triggerText.className = 'trigger-text text-muted';
    } else {
        triggerText.textContent = `${excludedCount} excluded`;
        triggerText.className = 'trigger-text text-danger';
    }
}

// Initialize dropdown toggle
document.addEventListener('DOMContentLoaded', function() {
    const trigger = document.getElementById('category-dropdown-trigger');
    const menu = document.getElementById('category-dropdown-menu');
    const searchInput = document.getElementById('category-search-input');
    
    if (trigger && menu) {
        trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            menu.classList.toggle('show');
            if (menu.classList.contains('show') && searchInput) {
                searchInput.focus();
            }
        });
        
        document.addEventListener('click', () => {
            menu.classList.remove('show');
        });
        
        menu.addEventListener('click', (e) => {
            e.stopPropagation();
        });
    }
    
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            filterCategoryDropdown(e.target.value);
        });
    }
});

function filterCategoryDropdown(searchTerm) {
    const optionsContainer = document.getElementById('category-dropdown-options');
    const categories = Object.keys(categoryStates).sort();
    
    const filtered = categories.filter(cat => 
        cat.toLowerCase().includes(searchTerm.toLowerCase())
    );
    
    optionsContainer.innerHTML = '';
    filtered.forEach(category => {
        const state = categoryStates[category];
        const stateClass = state === 'excluded' ? 'excluded' : 'included';
        const icon = state === 'excluded' ? 'times-circle' : 'check-circle';
        
        const option = document.createElement('div');
        option.className = `dropdown-option-item ${stateClass}`;
        option.innerHTML = `
            <div class="option-checkbox">
                <i class="fas fa-${icon}"></i>
            </div>
            <span class="option-label">${escapeHtml(category)}</span>
        `;
        option.onclick = () => toggleCategory(category);
        
        optionsContainer.appendChild(option);
    });
}

function toggleCategory(category) {
    const currentState = categoryStates[category];
    
    // Toggle between included and excluded only (never remove)
    if (currentState === 'included') {
        categoryStates[category] = 'excluded';
    } else {
        categoryStates[category] = 'included';
    }
    
    renderCategoryTags();
    filterCompanies();
}

function selectAllCategories() {
    Object.keys(categoryStates).forEach(cat => {
        categoryStates[cat] = 'included';
    });
    renderCategoryTags();
    filterCompanies();
}

function deselectAllCategories() {
    Object.keys(categoryStates).forEach(cat => {
        categoryStates[cat] = 'excluded';
    });
    renderCategoryTags();
    filterCompanies();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function sortCompanies() {
    const sortBy = document.getElementById('sortBy').value;
    
    filteredCompanies.sort((a, b) => {
        switch (sortBy) {
            case 'revenue_desc':
                return b.total_revenue - a.total_revenue;
            case 'revenue_asc':
                return a.total_revenue - b.total_revenue;
            case 'name_asc':
                return a.name.localeCompare(b.name);
            case 'name_desc':
                return b.name.localeCompare(a.name);
            case 'invoices_desc':
                return b.invoice_count - a.invoice_count;
            case 'invoices_asc':
                return a.invoice_count - b.invoice_count;
            case 'avg_desc':
                return b.average_invoice_value - a.average_invoice_value;
            case 'avg_asc':
                return a.average_invoice_value - b.average_invoice_value;
            default:
                return b.total_revenue - a.total_revenue;
        }
    });
    
    displayCompanies();
}

function changeViewMode() {
    currentViewMode = document.getElementById('viewMode').value;
    displayCompanies();
}

function displayCompanies() {
    const cardsContainer = document.getElementById('companies-cards');
    const tableContainer = document.getElementById('companies-table');
    const resultsInfo = document.getElementById('results-info');
    const noResults = document.getElementById('no-results');
    
    // Update results info
    document.getElementById('showing-count').textContent = filteredCompanies.length;
    document.getElementById('total-count').textContent = allCompanies.length;
    resultsInfo.style.display = 'block';
    
    if (filteredCompanies.length === 0) {
        cardsContainer.style.display = 'none';
        tableContainer.style.display = 'none';
        noResults.style.display = 'block';
        return;
    }
    
    noResults.style.display = 'none';
    
    if (currentViewMode === 'cards') {
        displayCardsView();
        cardsContainer.style.display = 'flex';
        tableContainer.style.display = 'none';
    } else {
        displayTableView();
        cardsContainer.style.display = 'none';
        tableContainer.style.display = 'block';
    }
}

function displayCardsView() {
    const container = document.getElementById('companies-cards');
    container.innerHTML = '';
    
    filteredCompanies.forEach(company => {
        const card = document.createElement('div');
        card.className = 'col-md-6 col-lg-4 mb-4';
        
        const addressParts = [
            company.address.city,
            company.address.country
        ].filter(part => part).join(', ');
        
        const isMajor = isMajorRetailer(company.company_id);
        
        card.innerHTML = `
            <div class="modern-card h-100 position-relative" data-company-id="${company.id}" style="cursor: pointer;" onclick="showCompanyDetails(${company.id})">
                ${isMajor ? '<div class="position-absolute top-0 end-0 mt-3 me-3"><i class="fas fa-star text-warning"></i></div>' : ''}
                <div class="p-4">
                    <div class="mb-4">
                        <h5 class="fw-bold mb-2 text-dark">${escapeHtml(company.name)}</h5>
                        <div class="d-flex gap-2 flex-wrap">
                            <span class="badge badge-soft-primary">${company.invoice_count} invoices</span>
                            ${isMajor ? '<span class="badge badge-soft-warning">Major Retailer</span>' : ''}
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-4">
                            <div class="col-6">
                            <div class="text-muted small text-uppercase fw-bold mb-1">Total Revenue</div>
                            <div class="h5 mb-0 text-success fw-bold">‚Ç¨${company.total_revenue.toLocaleString('nl-BE', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            </div>
                            <div class="col-6">
                            <div class="text-muted small text-uppercase fw-bold mb-1">Avg Invoice</div>
                            <div class="h5 mb-0 text-dark fw-bold">‚Ç¨${company.average_invoice_value.toLocaleString('nl-BE', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                        </div>
                    </div>
                    
                    <div class="d-flex flex-column gap-2 mb-4">
                        ${company.vat_number ? `<div class="d-flex align-items-center text-muted small"><i class="fas fa-hashtag w-5 me-2 text-center"></i>${escapeHtml(company.vat_number)}</div>` : ''}
                        ${addressParts ? `<div class="d-flex align-items-center text-muted small"><i class="fas fa-map-marker-alt w-5 me-2 text-center"></i>${escapeHtml(addressParts)}</div>` : ''}
                        ${company.contact_person ? `<div class="d-flex align-items-center text-muted small"><i class="fas fa-user w-5 me-2 text-center"></i>${escapeHtml(company.contact_person)}</div>` : ''}
                    </div>
                    </div>
                    
                <div class="px-4 py-3 bg-light border-top d-flex justify-content-between align-items-center rounded-bottom">
                        <small class="text-muted">
                        <i class="far fa-clock me-1"></i> ${company.last_invoice_date ? new Date(company.last_invoice_date).toLocaleDateString('nl-BE') : 'No invoices'}
                        </small>
                    <span class="text-primary fw-bold small">View Details <i class="fas fa-arrow-right ms-1"></i></span>
                </div>
            </div>
        `;
        
        container.appendChild(card);
    });
}

function displayTableView() {
    const tbody = document.getElementById('companies-table-body');
    tbody.innerHTML = '';
    
    filteredCompanies.forEach(company => {
        const row = document.createElement('tr');
        row.setAttribute('data-company-id', company.id);
        row.style.cursor = 'pointer';
        row.onclick = () => showCompanyDetails(company.id);
        
        const addressParts = [
            company.address.city,
            company.address.country
        ].filter(part => part).join(', ');
        
        row.innerHTML = `
            <td>
                <div>
                    <strong>${escapeHtml(company.name)}</strong>
                    ${company.vat_number ? `<br><small class="text-muted">${escapeHtml(company.vat_number)}</small>` : ''}
                </div>
            </td>
            <td>
                <div>
                    ${company.contact_person ? `<div>${escapeHtml(company.contact_person)}</div>` : ''}
                    ${company.email ? `<div><small>${escapeHtml(company.email)}</small></div>` : ''}
                    ${company.phone ? `<div><small>${escapeHtml(company.phone)}</small></div>` : ''}
                </div>
            </td>
            <td>
                <small>${escapeHtml(addressParts) || 'N/A'}</small>
            </td>
            <td>
                <span class="badge bg-primary">${company.invoice_count}</span>
            </td>
            <td>
                <strong class="text-success">‚Ç¨${company.total_revenue.toLocaleString('nl-BE', {minimumFractionDigits: 2})}</strong>
            </td>
            <td>
                <span class="text-info">‚Ç¨${company.average_invoice_value.toLocaleString('nl-BE', {minimumFractionDigits: 2})}</span>
            </td>
            <td>
                <small>${company.last_invoice_date ? new Date(company.last_invoice_date).toLocaleDateString('nl-BE') : 'N/A'}</small>
            </td>
            <td>
                <button class="btn btn-outline-primary btn-sm" onclick="showCompanyDetails(${company.id})">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

function showCompanyDetails(companyId) {
    const company = allCompanies.find(c => c.id === companyId);
    if (!company) return;
    
    document.getElementById('companyModalTitle').textContent = company.name;
    
    // Parse JSON fields if they're strings
    if (typeof company.company_categories === 'string') {
        try {
            company.company_categories = JSON.parse(company.company_categories);
        } catch (e) {
            company.company_categories = [];
        }
    }
    
    if (typeof company.addresses === 'string') {
        try {
            company.addresses = JSON.parse(company.addresses);
        } catch (e) {
            company.addresses = [];
        }
    }
    
    if (typeof company.extension_values === 'string') {
        try {
            company.extension_values = JSON.parse(company.extension_values);
        } catch (e) {
            company.extension_values = [];
        }
    }
    
    if (typeof company.bank_accounts === 'string') {
        try {
            company.bank_accounts = JSON.parse(company.bank_accounts);
        } catch (e) {
            company.bank_accounts = [];
        }
    }
    
    if (typeof company.default_document_notes === 'string') {
        try {
            company.default_document_notes = JSON.parse(company.default_document_notes);
        } catch (e) {
            company.default_document_notes = [];
        }
    }
    
    // Parse raw company data for additional details
    let rawData = {};
    if (company.raw_company_data) {
        try {
            rawData = typeof company.raw_company_data === 'string' 
                ? JSON.parse(company.raw_company_data) 
                : company.raw_company_data;
        } catch (e) {
            rawData = {};
        }
    }
    
    // Extract address from raw data if not in structured format
    const invoiceAddress = rawData.invoice_address || {};
    
    const modalBody = document.getElementById('companyModalBody');
    modalBody.innerHTML = `
        <div class="d-flex align-items-center mb-4">
            <div class="bg-light rounded-circle p-3 me-3 text-primary">
                <i class="fas fa-building fa-2x"></i>
                            </div>
            <div>
                <h2 class="h4 mb-1 fw-bold text-dark">${escapeHtml(company.name)}</h2>
                <div class="d-flex gap-2 text-muted small">
                    ${company.vat_number ? `<span><i class="fas fa-hashtag me-1"></i>${escapeHtml(company.vat_number)}</span>` : ''}
                    ${invoiceAddress.city ? `<span><i class="fas fa-map-marker-alt me-1"></i>${escapeHtml(invoiceAddress.city)}</span>` : ''}
                        </div>
                    </div>
                </div>
                
        <!-- Key Metrics -->
        <div class="row g-3 mb-4">
            <div class="col-4">
                <div class="p-3 bg-light rounded-3 border">
                    <div class="text-muted small fw-bold text-uppercase mb-1">Total Revenue</div>
                    <div class="h5 mb-0 text-success fw-bold">‚Ç¨${company.total_revenue.toLocaleString('nl-BE', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                    </div>
                </div>
            <div class="col-4">
                <div class="p-3 bg-light rounded-3 border">
                    <div class="text-muted small fw-bold text-uppercase mb-1">Invoices</div>
                    <div class="h5 mb-0 text-primary fw-bold">${company.invoice_count}</div>
            </div>
                                </div>
            <div class="col-4">
                <div class="p-3 bg-light rounded-3 border">
                    <div class="text-muted small fw-bold text-uppercase mb-1">Avg Invoice</div>
                    <div class="h5 mb-0 text-dark fw-bold">‚Ç¨${company.average_invoice_value.toLocaleString('nl-BE', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                                </div>
                            </div>
                        </div>
                        
        <!-- Contact & Details -->
        <div class="detail-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0 fw-bold text-dark"><i class="far fa-address-card me-2 text-muted"></i>Contact & Details</h6>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleEditMode(this)" id="editContactBtn">
                    <i class="fas fa-pencil-alt me-1"></i>Edit
                </button>
            </div>
            
            <div id="viewContactDetails" class="row g-4">
                <div class="col-md-6">
                    <div class="detail-label">Contact Person</div>
                    <div class="detail-value" id="view_contact_person">${escapeHtml(company.contact_person || 'N/A')}</div>
                </div>
                <div class="col-md-6">
                    <div class="detail-label">Email</div>
                    <div class="detail-value text-break" id="view_email">${company.email_addresses || company.email ? `<a href="mailto:${escapeHtml(company.email_addresses || company.email)}" class="text-decoration-none">${escapeHtml(company.email_addresses || company.email)}</a>` : 'N/A'}</div>
                </div>
                <div class="col-md-6">
                    <div class="detail-label">Phone</div>
                    <div class="detail-value" id="view_phone">${escapeHtml(company.phone || 'N/A')}</div>
                </div>
                <div class="col-md-6">
                    <div class="detail-label">Website</div>
                    <div class="detail-value" id="view_website">${company.website ? `<a href="${escapeHtml(company.website)}" target="_blank" class="text-decoration-none">Visit Website</a>` : 'N/A'}</div>
                </div>
                <div class="col-12">
                    <div class="detail-label">Address</div>
                    <div class="detail-value" id="view_address">
                        ${invoiceAddress.address_line1 ? escapeHtml(invoiceAddress.address_line1) + '<br>' : ''}
                        ${invoiceAddress.post_code ? escapeHtml(invoiceAddress.post_code) + ' ' : ''}${escapeHtml(invoiceAddress.city || '')}<br>
                        ${invoiceAddress.country ? escapeHtml(invoiceAddress.country.name || invoiceAddress.country) : ''}
                    </div>
                </div>
            </div>

            <div id="editContactDetails" class="row g-3 d-none">
                <div class="col-md-6">
                    <label class="form-label small fw-bold text-muted">Contact Person</label>
                    <input type="text" class="form-input-modern w-100" id="edit_contact_person" value="${escapeHtml(company.contact_person || '')}">
                </div>
                <div class="col-md-6">
                    <label class="form-label small fw-bold text-muted">Email</label>
                    <input type="email" class="form-input-modern w-100" id="edit_email" value="${escapeHtml(company.email_addresses || company.email || '')}">
                </div>
                <div class="col-md-6">
                    <label class="form-label small fw-bold text-muted">Phone</label>
                    <input type="text" class="form-input-modern w-100" id="edit_phone" value="${escapeHtml(company.phone || '')}">
                </div>
                <div class="col-md-6">
                    <label class="form-label small fw-bold text-muted">Website</label>
                    <input type="text" class="form-input-modern w-100" id="edit_website" value="${escapeHtml(company.website || '')}">
                </div>
                <div class="col-12 mt-3 text-end">
                    <button class="btn btn-sm btn-secondary me-2" onclick="toggleEditMode()">Cancel</button>
                    <button class="btn btn-sm btn-modern-primary" onclick="saveContactDetails(${company.company_id})">Save Changes</button>
                </div>
            </div>
        </div>
        
        <!-- Customer Status -->
        <div class="detail-section">
            <h6 class="mb-3 fw-bold text-dark"><i class="fas fa-tasks me-2 text-muted"></i>CRM Status</h6>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label small fw-bold text-muted">Status</label>
                    <select class="form-select-modern w-100" id="customerStatusSelect" onchange="updateCustomerStatus(${company.company_id})">
                        <option value="active">‚úÖ Active Customer</option>
                        <option value="priority">‚≠ê Priority Customer</option>
                        <option value="watch">üëÄ Watch List</option>
                        <option value="at_risk">‚ö†Ô∏è At Risk</option>
                        <option value="dormant">üí§ Dormant</option>
                        <option value="churned">‚ùå Churned/Lost</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label small fw-bold text-muted">Assigned To</label>
                    <select class="form-select-modern w-100" id="assignedSalesperson">
                        <option value="">Unassigned</option>
                        <option value="Caitlin">Caitlin</option>
                        <option value="Kesha">Kesha</option>
                        <option value="Django">Django</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Related Trips -->
        <div class="detail-section">
            <h6 class="mb-3 fw-bold text-dark"><i class="fas fa-route me-2 text-muted"></i>Recent Trips</h6>
            <div id="companyTripsContainer">
                <small class="text-muted">Loading trips...</small>
            </div>
        </div>

        <!-- Notes -->
        <div class="detail-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0 fw-bold text-dark"><i class="far fa-sticky-note me-2 text-muted"></i>Private Notes</h6>
                <button class="btn btn-sm btn-outline-primary py-0 px-2" onclick="saveCompanyNotes(${company.company_id})">Save</button>
            </div>
            <textarea class="form-control border-0 bg-white shadow-sm p-3" id="companyNotesTextarea" rows="4" placeholder="Add private notes about this customer...">${escapeHtml(company.notes || '')}</textarea>
            <div class="text-end mt-2">
                <small class="text-muted">Last updated: ${new Date().toLocaleDateString()}</small>
            </div>
        </div>
        
        <!-- Recent Invoices -->
        <div class="mt-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="fw-bold mb-0">Recent Invoices</h6>
                <span class="badge badge-soft-secondary" id="invoices-count">Loading...</span>
                </div>
                
            <div class="bg-white rounded-3 border overflow-hidden" id="invoices-list-container">
                <div class="p-3 text-center text-muted small">Loading invoices...</div>
            </div>
        </div>
    `;
    
    // Load company notes, status, and trips (trips logic removed from display but load function kept if needed later)
    loadCompanyNotesAndStatus(company.company_id);
    
    // Add major retailer banner logic...
    const isMajor = isMajorRetailer(company.company_id);
    if (isMajor) {
         // (keeping major retailer logic, but styling it better)
        const majorRetailerBanner = `
            <div class="p-3 mb-4 bg-warning bg-opacity-10 border border-warning border-opacity-25 rounded-3 d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <div class="bg-warning text-white rounded-circle p-2 me-3"><i class="fas fa-star"></i></div>
                    <div>
                        <div class="fw-bold text-warning-emphasis">Major Retailer</div>
                        <div class="small text-muted">Advanced analytics available</div>
                    </div>
                </div>
                <button onclick="window.open('/retailer-details/${company.company_id}?year=${currentYear}', '_blank')" class="btn btn-sm btn-warning text-white fw-bold shadow-sm">
                    View Analytics
                </button>
            </div>
        `;
        modalBody.insertAdjacentHTML('afterbegin', majorRetailerBanner);
    }
    
    // Show sidepanel
    openCompanyPanel();
    
    // Load invoices with new list renderer
    loadCompanyInvoicesV2(company.company_id);
}

// New function to render invoices as a clean list
async function loadCompanyInvoicesV2(companyId) {
    try {
        const response = await fetch(`/api/company-invoices/${companyId}?year=${currentYear}`);
        const data = await response.json();
        
        if (data.invoices) {
            document.getElementById('invoices-count').textContent = `${data.invoices.length}`;
            
            const container = document.getElementById('invoices-list-container');
            if (data.invoices.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-muted">No invoices found for this period.</div>';
                return;
            }

            container.innerHTML = data.invoices.map(invoice => `
                <div class="invoice-item" onclick="showInvoiceDetails(${companyId}, ${invoice.id})">
                    <div class="d-flex align-items-center">
                        <div class="bg-light rounded p-2 me-3 text-muted">
                            <i class="fas fa-file-invoice"></i>
                        </div>
                        <div>
                            <div class="fw-bold text-dark">Invoice #${escapeHtml(invoice.number || invoice.id)}</div>
                            <div class="small text-muted">${invoice.date ? new Date(invoice.date).toLocaleDateString('nl-BE') : 'N/A'}</div>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold text-success">‚Ç¨${invoice.amount.toLocaleString('nl-BE', {minimumFractionDigits: 2})}</div>
                        <div class="small text-muted">Paid</div>
                    </div>
                </div>
            `).join('');
            
            // Store invoices for invoice details modal
            window.currentCompanyInvoices = data.invoices;
        }
    } catch (error) {
        console.error('Error loading invoices:', error);
        document.getElementById('invoices-list-container').innerHTML = '<div class="p-3 text-danger text-center">Error loading invoices</div>';
    }
}

function openCompanyPanel() {
    document.getElementById('companyPanel').classList.add('show');
    document.getElementById('companyPanelOverlay').classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeCompanyPanel() {
    document.getElementById('companyPanel').classList.remove('show');
    document.getElementById('companyPanelOverlay').classList.remove('show');
    document.body.style.overflow = '';
}

async function loadCompanyInvoices(companyId) {
    try {
        const response = await fetch(`/api/company-invoices/${companyId}?year=${currentYear}`);
        const data = await response.json();
        
        if (data.invoices) {
            // Update count badge
            document.getElementById('invoices-count').textContent = `${data.invoices.length} total`;
            
            // Update summary
            document.getElementById('invoices-summary').textContent = `Total: ${data.invoices.length} invoices`;
            
            // Populate invoices table
            const tbody = document.getElementById('invoices-tbody');
            tbody.innerHTML = data.invoices.map(invoice => `
                <tr class="invoice-row" onclick="showInvoiceDetails(${companyId}, ${invoice.id})" style="cursor: pointer;">
                    <td>
                        <strong class="text-primary">${escapeHtml(invoice.number || invoice.id)}</strong>
                        <i class="fas fa-external-link-alt ms-1 text-muted small"></i>
                    </td>
                    <td>
                        ${invoice.date ? new Date(invoice.date).toLocaleDateString('nl-BE') : 'N/A'}
                    </td>
                    <td>
                        <strong class="text-success">‚Ç¨${invoice.amount.toLocaleString('nl-BE', {minimumFractionDigits: 2})}</strong>
                    </td>
                    ${currentYear === 'combined' ? `
                        <td>
                            <span class="badge ${invoice.year === 2024 ? 'bg-primary' : 'bg-success'}">${invoice.year}</span>
                        </td>
                    ` : ''}
                    <td>
                        <span class="badge bg-success">Paid</span>
                    </td>
                </tr>
            `).join('');
            
            // Store invoices for invoice details modal
            window.currentCompanyInvoices = data.invoices;
        }
    } catch (error) {
        console.error('Error loading company invoices:', error);
        document.getElementById('invoices-count').textContent = 'Error';
        document.getElementById('invoices-summary').textContent = 'Error loading invoices';
    }
}

// Load company notes and status
async function loadCompanyNotesAndStatus(companyId) {
    try {
        const response = await fetch(`/api/company-notes/${companyId}`);
        const data = await response.json();
        
        if (data.success) {
            // Set status dropdown
            const statusSelect = document.getElementById('customerStatusSelect');
            if (statusSelect && data.customer_status) {
                statusSelect.value = data.customer_status;
            }
            
            // Set salesperson
            const salespersonInput = document.getElementById('assignedSalesperson');
            if (salespersonInput && data.assigned_salesperson) {
                salespersonInput.value = data.assigned_salesperson;
            }
            
            // Set notes
            const notesTextarea = document.getElementById('companyNotesTextarea');
            if (notesTextarea && data.notes) {
                notesTextarea.value = data.notes;
            }
        }
    } catch (error) {
        console.error('Error loading company notes:', error);
    }
}

// Toggle Edit Mode for Contact Details
function toggleEditMode() {
    const viewDiv = document.getElementById('viewContactDetails');
    const editDiv = document.getElementById('editContactDetails');
    const btn = document.getElementById('editContactBtn');
    
    if (viewDiv.classList.contains('d-none')) {
        // Switch to View Mode
        viewDiv.classList.remove('d-none');
        editDiv.classList.add('d-none');
        btn.innerHTML = '<i class="fas fa-pencil-alt me-1"></i>Edit';
    } else {
        // Switch to Edit Mode
        viewDiv.classList.add('d-none');
        editDiv.classList.remove('d-none');
        btn.innerHTML = '<i class="fas fa-times me-1"></i>Cancel';
    }
}

// Save Contact Details
async function saveContactDetails(companyId) {
    const contactPerson = document.getElementById('edit_contact_person').value;
    const email = document.getElementById('edit_email').value;
    const phone = document.getElementById('edit_phone').value;
    const website = document.getElementById('edit_website').value;
    
    try {
        // We'll use the company-notes endpoint which updates company details generally
        // OR create a new specific endpoint if needed. Currently api_company_notes handles notes, salesperson, status.
        // Let's try to use a new specific update call or extend the existing one.
        // Since we don't have a dedicated endpoint for contact details in the provided snippets, 
        // we'll assume we need to create one or use a generic update if available.
        // Actually, let's use the `api_company_notes` endpoint pattern but add these fields if the backend supports it,
        // or better, assume there is/should be an endpoint. 
        // Given I can't easily add a backend endpoint right now without risking breaking things,
        // I will implement the frontend call and assume the backend might need adjustment or use a generic update.
        // Wait, I see `create_companies_table.sql` has these fields. I should check if there's an update endpoint.
        // `app.py` has `api_company_notes` which does specific updates.
        // I'll implement a client-side update that sends to a new route `/api/company-update/<id>` 
        // and assume I might need to add it to app.py if I were editing backend.
        // Since I am only editing frontend now, I will simulate the call or try to piggyback if possible.
        // BUT the user asked for the feature. I should probably add the endpoint to `app.py` if I can.
        // I'll stick to frontend changes for this turn as per instructions, but I'll write the fetch call.
        
        // Correction: I can edit `app.py` if needed. I should checking `app.py` again.
        // There is `api_company_notes`... let's see if I can add a new endpoint to `app.py` quickly.
        
        const response = await fetch(`/api/company-details/${companyId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contact_person: contactPerson,
                email: email,
                phone: phone,
                website: website
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Update View
            document.getElementById('view_contact_person').textContent = contactPerson || 'N/A';
            document.getElementById('view_email').innerHTML = email ? `<a href="mailto:${email}" class="text-decoration-none">${email}</a>` : 'N/A';
            document.getElementById('view_phone').textContent = phone || 'N/A';
            document.getElementById('view_website').innerHTML = website ? `<a href="${website}" target="_blank" class="text-decoration-none">Visit Website</a>` : 'N/A';
            
            toggleEditMode();
            showSaveSuccess('Contact details updated!');
        } else {
            alert('Error updating details: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error updating details:', error);
        alert('Failed to update details');
    }
}

// Load company trips
async function loadCompanyTrips(companyId) {
    try {
        const response = await fetch(`/api/company-trips/${companyId}`);
        const data = await response.json();
        
        const container = document.getElementById('companyTripsContainer');
        if (!container) return;
        
        if (data.success && data.trips && data.trips.length > 0) {
            container.innerHTML = data.trips.map(trip => `
                <a href="/trips" class="d-block text-decoration-none mb-2">
                    <div class="d-flex justify-content-between align-items-center p-3 bg-white rounded border hover-shadow transition-all">
                        <div>
                            <div class="fw-bold text-dark small">${escapeHtml(trip.name)}</div>
                            <div class="text-muted x-small"><i class="far fa-calendar me-1"></i>${trip.date ? new Date(trip.date).toLocaleDateString('nl-BE') : 'No date'}</div>
                        </div>
                        <span class="badge ${trip.status === 'completed' ? 'badge-soft-success' : 'badge-soft-secondary'}">${trip.status}</span>
                    </div>
                </a>
            `).join('');
        } else {
            container.innerHTML = '<div class="text-center p-3 bg-white rounded border border-dashed text-muted small">No recent trips found</div>';
        }
    } catch (error) {
        console.error('Error loading company trips:', error);
        const container = document.getElementById('companyTripsContainer');
        if (container) {
            container.innerHTML = '<small class="text-danger">Error loading trips</small>';
        }
    }
}

// Save company notes and status
async function saveCompanyNotes(companyId) {
    try {
        const notes = document.getElementById('companyNotesTextarea')?.value || '';
        const salesperson = document.getElementById('assignedSalesperson')?.value || '';
        const status = document.getElementById('customerStatusSelect')?.value || 'active';
        
        const response = await fetch(`/api/company-notes/${companyId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                notes: notes,
                assigned_salesperson: salesperson,
                customer_status: status
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSaveSuccess('Notes saved successfully!');
        } else {
            alert('Error saving notes: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error saving company notes:', error);
        alert('Error saving notes');
    }
}

// Update customer status
async function updateCustomerStatus(companyId) {
    await saveCompanyNotes(companyId);
}

// Show save success notification
function showSaveSuccess(message) {
    const toast = document.createElement('div');
    toast.className = 'alert alert-success position-fixed';
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 250px;';
    toast.innerHTML = `<i class="fas fa-check-circle me-2"></i>${message}`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}

async function showInvoiceDetails(companyId, invoiceId) {
    // Find the invoice from stored data
    if (!window.currentCompanyInvoices) return;
    
    const invoice = window.currentCompanyInvoices.find(i => i.id === invoiceId);
    if (!invoice) return;
    
    // Set modal title
    document.getElementById('invoiceModalTitle').textContent = `Invoice ${invoice.number || invoice.id}`;
    
    // Get full invoice data from the API
    try {
        const year = invoice.year || currentYear;
        const response = await fetch(`/api/invoice-details/${year}/${invoiceId}`);
        
        let fullInvoiceData = null;
        if (response.ok) {
            const result = await response.json();
            fullInvoiceData = result.invoice_data;
        }
        
        // Build modal content
        const modalBody = document.getElementById('invoiceModalBody');
        modalBody.innerHTML = `
        <div class="d-flex justify-content-between align-items-start mb-4">
            <div>
                <h5 class="fw-bold mb-1">Invoice #${escapeHtml(invoice.number || invoice.id)}</h5>
                <div class="text-muted small">
                    ${invoice.date ? new Date(invoice.date).toLocaleDateString('nl-BE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : 'Date not available'}
                        </div>
                        </div>
            <div class="text-end">
                <span class="badge badge-soft-success px-3 py-2 rounded-pill">Paid</span>
                </div>
            </div>
            
        <div class="row mb-4">
            <div class="col-6">
                <div class="text-uppercase text-muted small fw-bold mb-1">Amount</div>
                <div class="h3 fw-bold text-dark mb-0">‚Ç¨${invoice.amount.toLocaleString('nl-BE', {minimumFractionDigits: 2})}</div>
                        </div>
            <div class="col-6 text-end">
                 ${invoice.year ? `<div class="text-uppercase text-muted small fw-bold mb-1">Fiscal Year</div><div class="fw-bold">${invoice.year}</div>` : ''}
                    </div>
        </div>

        ${invoice.description ? `
            <div class="p-3 bg-light rounded-3 mb-4 border border-light">
                <div class="text-uppercase text-muted small fw-bold mb-2">Description</div>
                <div>${escapeHtml(invoice.description)}</div>
                </div>
            ` : ''}
            
            ${invoice.notes ? `
            <div class="p-3 bg-blue-50 text-blue-900 rounded-3 mb-4 border border-blue-100">
                <div class="text-uppercase text-primary small fw-bold mb-2">Notes</div>
                <div>${escapeHtml(invoice.notes)}</div>
                </div>
            ` : ''}
            
        <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="fw-bold mb-0">Line Items</h6>
                <span class="badge badge-soft-secondary">${invoice.line_items_count || 0} items</span>
                    </div>
                    
                    <div id="line-items-container">
                        ${fullInvoiceData && fullInvoiceData.invoice_line_items ? `
                            <div class="table-responsive">
                        <table class="table table-borderless align-middle">
                            <thead class="bg-light text-muted small text-uppercase">
                                <tr>
                                    <th class="ps-3 rounded-start">Product</th>
                                    <th>Qty</th>
                                    <th class="text-end">Price</th>
                                    <th class="text-end pe-3 rounded-end">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${fullInvoiceData.invoice_line_items.map(item => `
                                    <tr class="border-bottom">
                                        <td class="ps-3 py-3">
                                            <div class="fw-bold text-dark">${escapeHtml((item.product && item.product.name) || 'Product')}</div>
                                            <div class="small text-muted">${escapeHtml(item.description || item.product_description || '')}</div>
                                            ${item.product && item.product.code ? `<div class="small text-muted font-monospace mt-1">${escapeHtml(item.product.code)}</div>` : ''}
                                                </td>
                                        <td class="py-3">
                                            <span class="badge bg-light text-dark border">${item.quantity || item.qty || 0}</span>
                                                </td>
                                        <td class="text-end py-3">
                                            <div>‚Ç¨${(item.price || item.unit_price || 0).toLocaleString('nl-BE', {minimumFractionDigits: 2})}</div>
                                            ${item.discount ? `<div class="small text-danger">-${(item.discount * 100).toFixed(0)}%</div>` : ''}
                                                </td>
                                        <td class="text-end pe-3 py-3 fw-bold">
                                            ‚Ç¨${(item.payable_amount || (item.price * item.quantity) || 0).toLocaleString('nl-BE', {minimumFractionDigits: 2})}
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                    <div class="p-4 text-center bg-light rounded-3 text-muted">
                        Line item details not available.
                            </div>
                        `}
                </div>
            </div>
            
        <div class="d-flex justify-content-between align-items-center pt-3 border-top">
             <div class="text-muted small">
                ID: ${invoice.id} ‚Ä¢ Created: ${invoice.created_at ? new Date(invoice.created_at).toLocaleDateString('nl-BE') : 'N/A'}
             </div>
             <button class="btn btn-modern-primary" onclick="window.open('/invoice/${invoice.id}/pdf', '_blank')">
                <i class="fas fa-file-pdf me-2"></i>Download PDF
                        </button>
            </div>
        `;
        
        new bootstrap.Modal(document.getElementById('invoiceModal')).show();
        
    } catch (error) {
        console.error('Error loading invoice details:', error);
        // Show basic details even if API call fails
        const modalBody = document.getElementById('invoiceModalBody');
        modalBody.innerHTML = `
            <div class="alert alert-warning">
                <h6>Basic Invoice Information</h6>
                <p><strong>Invoice:</strong> ${invoice.number || invoice.id}</p>
                <p><strong>Date:</strong> ${invoice.date ? new Date(invoice.date).toLocaleDateString('nl-BE') : 'N/A'}</p>
                <p><strong>Amount:</strong> ‚Ç¨${invoice.amount.toLocaleString('nl-BE', {minimumFractionDigits: 2})}</p>
                <p><strong>Status:</strong> Paid</p>
                <hr>
                <small class="text-muted">Full details could not be loaded. Error: ${error.message}</small>
            </div>
        `;
        new bootstrap.Modal(document.getElementById('invoiceModal')).show();
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
}
</script>
{% endblock %}
