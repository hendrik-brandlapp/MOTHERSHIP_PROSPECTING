{% extends "base.html" %}

{% block title %}Companies - CRMinal{% endblock %}

{% block content %}
<!-- Mapbox GL JS for map view -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<div class="container-fluid px-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-5">
                <div>
                    <h2 class="fw-bold text-dark mb-1">Companies</h2>
                    <p class="text-muted mb-0">Your company directory and contacts</p>
                </div>
                <div class="d-flex gap-2">
                    {% if session.user_role == 'admin' %}
                    <button class="btn btn-modern btn-outline-secondary" onclick="syncLatestData()" 
                            data-bs-toggle="tooltip" data-bs-placement="bottom" 
                            title="Sync Latest Invoices">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-modern btn-outline-secondary" onclick="refreshCompanyMetrics()" 
                            data-bs-toggle="tooltip" data-bs-placement="bottom" 
                            title="Recalculate Metrics">
                        <i class="fas fa-calculator"></i>
                    </button>
                    <button class="btn btn-modern btn-outline-secondary" onclick="populateCompaniesDatabase()" 
                            data-bs-toggle="tooltip" data-bs-placement="bottom" 
                            title="Build Companies Database">
                        <i class="fas fa-database"></i>
                    </button>
                    {% endif %}
                    <button class="btn btn-modern-primary" onclick="forceRefreshData()" 
                            data-bs-toggle="tooltip" data-bs-placement="bottom" 
                            title="Refresh Data">
                        <i class="fas fa-refresh me-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Company Count Stats -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center gap-3" id="year-stats" style="display: none;">
                <div class="d-flex align-items-center gap-2">
                    <div class="h4 fw-bold text-primary mb-0" id="stat-total-companies">-</div>
                    <span class="text-muted">companies</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Sync Status -->
    <div id="sync-status" class="alert alert-info" style="display: none;">
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-3" role="status">
                <span class="visually-hidden">Syncing...</span>
            </div>
            <div>
                <strong>Syncing latest data...</strong>
                <p class="mb-0" id="sync-message">Fetching latest invoices from DOUANO...</p>
            </div>
        </div>
    </div>

    <!-- Sync Results -->
    <div id="sync-results" style="display: none;"></div>

    <!-- Filters and Search -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="filter-card">
                <div class="filter-grid">
                    <!-- Search -->
                    <div class="filter-item filter-search">
                        <label class="filter-label">Search</label>
                        <div class="filter-input-wrapper">
                            <i class="fas fa-search filter-input-icon"></i>
                            <input type="text" class="filter-input" id="searchInput" placeholder="Search companies..." onkeyup="filterCompanies()">
                        </div>
                    </div>
                    
                    <!-- Categories -->
                    <div class="filter-item filter-categories">
                        <label class="filter-label">Categories</label>
                            <div class="searchable-dropdown-wrapper">
                            <div class="filter-dropdown-trigger" id="category-dropdown-trigger">
                                <span class="trigger-text">All categories</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                            <div class="filter-dropdown-menu" id="category-dropdown-menu">
                                    <div class="dropdown-search-box">
                                        <i class="fas fa-search"></i>
                                    <input type="text" placeholder="Filter..." id="category-search-input">
                                    </div>
                                    <div class="dropdown-options-list" id="category-dropdown-options"></div>
                                </div>
                            </div>
                            <div class="selected-tags mt-2" id="category-selected-tags"></div>
                        </div>

                    <!-- Flavours Filter -->
                    <div class="filter-item filter-flavours">
                        <label class="filter-label">Flavours</label>
                        <div class="searchable-dropdown-wrapper">
                            <div class="filter-dropdown-trigger" id="flavour-dropdown-trigger">
                                <span class="trigger-text">All flavours</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="filter-dropdown-menu" id="flavour-dropdown-menu">
                                <div class="dropdown-options-list" id="flavour-dropdown-options"></div>
                            </div>
                        </div>
                        <div class="selected-tags mt-2" id="flavour-selected-tags"></div>
                    </div>

                    <!-- Alert Filter -->
                    <div class="filter-item filter-alerts">
                        <label class="filter-label">Alerts</label>
                        <select class="filter-select no-custom" id="alertFilter" onchange="filterCompanies()">
                            <option value="">All companies</option>
                            <option value="any">Has any alert</option>
                            <option value="PATTERN_DISRUPTION">Pattern Break</option>
                            <option value="HIGH_VALUE_AT_RISK">High Value Risk</option>
                            <option value="DORMANT_CUSTOMER">Dormant</option>
                            <option value="DECLINING_VALUE">Declining</option>
                            <option value="INCREASING_GAP">Less Frequent</option>
                            <option value="ONE_TIME_CUSTOMER">One-Timer</option>
                        </select>
                    </div>

                    <!-- Sort By -->
                    <div class="filter-item filter-sort">
                        <label class="filter-label">Sort By</label>
                        <select class="filter-select" id="sortBy" onchange="sortCompanies()">
                            <option value="revenue_desc">Revenue ↓</option>
                            <option value="revenue_asc">Revenue ↑</option>
                            <option value="name_asc">Name A-Z</option>
                            <option value="name_desc">Name Z-A</option>
                            <option value="invoices_desc">Invoices ↓</option>
                            <option value="invoices_asc">Invoices ↑</option>
                        </select>
                    </div>

                    <!-- View Toggle -->
                    <div class="filter-item">
                        <label class="filter-label">View</label>
                        <div class="view-toggle-group">
                            <button class="view-toggle-btn active" data-view="cards" onclick="switchToView('cards')">
                                <i class="fas fa-th-large"></i> Cards
                            </button>
                            <button class="view-toggle-btn" data-view="map" onclick="switchToView('map')">
                                <i class="fas fa-map-marker-alt"></i> Map
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading company data...</p>
    </div>

    <!-- Error State -->
    <div id="error-message" class="alert alert-danger" style="display: none;">
        <h5><i class="fas fa-exclamation-triangle me-2"></i>Error</h5>
        <p class="mb-0" id="error-text">Failed to load company data</p>
    </div>

    <!-- Results Info -->
    <div id="results-info" class="mb-3" style="display: none;">
        <p class="text-muted mb-0">
            Showing <span id="showing-count">0</span> of <span id="total-count">0</span> companies for <span id="current-year">2025</span>
        </p>
    </div>

    <!-- Card View -->
    <div id="companies-cards" class="row" style="display: none;">
        <!-- Company cards will be inserted here -->
    </div>

    <!-- Map View -->
    <div id="companies-map" class="d-none" style="height: calc(100vh - 280px); border-radius: 12px; overflow: hidden; border: 1px solid #e9ecef;">
        <div id="map-container" style="width: 100%; height: 100%;"></div>
    </div>

    <!-- Table View -->
    <div id="companies-table" style="display: none;">
        <div class="card border-0 shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Company</th>
                            <th>Contact</th>
                            <th>Location</th>
                            <th>Invoices</th>
                            <th>Total Revenue</th>
                            <th>Avg Invoice</th>
                            <th>Last Invoice</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="companies-table-body">
                        <!-- Table rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- No Results -->
    <div id="no-results" class="text-center py-5" style="display: none;">
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">No companies found</h5>
        <p class="text-muted">Try adjusting your search criteria</p>
    </div>
</div>

<!-- Company Detail Sidepanel -->
<div class="sidepanel-overlay" id="companyPanelOverlay" onclick="closeCompanyPanel()"></div>
<div class="sidepanel" id="companyPanel">
    <div class="sidepanel-header">
        <h5 class="sidepanel-title" id="companyModalTitle">Company Details</h5>
        <button type="button" class="btn-close" onclick="closeCompanyPanel()"></button>
            </div>
    <div class="sidepanel-body" id="companyModalBody">
                <!-- Company details will be loaded here -->
    </div>
</div>

<!-- Invoice Detail Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="invoiceModalTitle">Invoice Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="invoiceModalBody" style="max-height: 70vh; overflow-y: auto;">
                <!-- Invoice details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-arrow-left me-2"></i>Back to Company
                </button>
                <button type="button" class="btn btn-primary" onclick="window.print()">
                    <i class="fas fa-print me-2"></i>Print Invoice
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<style>
    :root {
        --primary-color: #6366f1;
        --primary-soft: #e0e7ff;
        --secondary-color: #ec4899;
        --secondary-soft: #fce7f3;
        --success-color: #10b981;
        --success-soft: #d1fae5;
        --warning-color: #f59e0b;
        --warning-soft: #fef3c7;
        --surface-bg: #f9fafb;
        --card-bg: #ffffff;
        --text-main: #111827;
        --text-muted: #6b7280;
        --border-color: #e5e7eb;
        --radius-sm: 0.5rem;
        --radius-md: 0.75rem;
        --radius-lg: 1rem;
        --radius-xl: 1.5rem;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --font-sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    body {
        background-color: var(--surface-bg);
        font-family: var(--font-sans);
        color: var(--text-main);
    }

    /* View Toggle */
    .view-toggle-group {
        display: flex;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #e9ecef;
    }

    .view-toggle-btn {
        padding: 8px 14px;
        border: none;
        background: #f8f9fa;
        color: #6c757d;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
        transition: all 0.15s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .view-toggle-btn:hover {
        background: #e9ecef;
        color: #495057;
    }

    .view-toggle-btn.active {
        background: #5B5FEF;
        color: white;
    }

    .view-toggle-btn i {
        font-size: 0.85rem;
    }

    /* Map Popup Styles */
    .mapboxgl-popup-content {
        padding: 12px 16px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        font-family: var(--font-sans);
    }

    .mapboxgl-popup-close-button {
        font-size: 18px;
        padding: 4px 8px;
    }

    .map-marker:hover {
        transform: scale(1.15);
    }

    /* Modern Card */
    .modern-card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        transition: all 0.2s ease;
    }

    .modern-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    /* Sidepanel Styles - Redesigned */
.sidepanel-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(4px);
    opacity: 0;
    visibility: hidden;
        transition: all 0.3s ease;
    z-index: 1040;
}

.sidepanel-overlay.show {
    opacity: 1;
    visibility: visible;
}

.sidepanel {
    position: fixed;
    top: 0;
    right: -100vw;
    width: 100vw;
    max-width: 100vw;
    height: 100%;
    background: var(--card-bg);
    box-shadow: -10px 0 30px rgba(0, 0, 0, 0.1);
    transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    z-index: 1050;
    display: flex;
    flex-direction: column;
}

.sidepanel.show {
    right: 0;
}

.sidepanel-header {
        padding: 2rem 2rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        background: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.sidepanel-title {
    margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-main);
        letter-spacing: -0.025em;
}

.sidepanel-body {
    flex: 1;
    padding: 2rem;
    overflow-y: auto;
    background-color: #ffffff;
}

.sidepanel-content {
    max-width: 800px;
    margin: 0 auto;
}

    /* Detail Sections */
    .detail-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: #f8fafc;
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-color);
    }

    .detail-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .detail-value {
        font-size: 1rem;
        color: var(--text-main);
        font-weight: 500;
    }

    /* Tags */
    .modern-badge {
        padding: 0.35em 0.8em;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.025em;
    }

    .badge-soft-primary { background: var(--primary-soft); color: var(--primary-color); }
    .badge-soft-success { background: var(--success-soft); color: var(--success-color); }
    .badge-soft-warning { background: var(--warning-soft); color: var(--warning-color); }
    .badge-soft-secondary { background: var(--secondary-soft); color: var(--secondary-color); }

    /* Buttons */
    .btn-modern {
        border-radius: var(--radius-md);
        font-weight: 500;
        padding: 0.5rem 1rem;
        transition: all 0.2s;
        border: none;
    }
    
    .btn-modern-primary {
        background: var(--primary-color);
        color: white;
        box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
    }
    
    .btn-modern-primary:hover {
        background: #4f46e5;
    transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(99, 102, 241, 0.4);
    }

    /* Invoice List in Sidepanel */
    .invoice-item {
    display: flex;
        justify-content: space-between;
    align-items: center;
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        transition: background 0.2s;
        cursor: pointer;
        border-radius: var(--radius-md);
    }

    .invoice-item:hover {
        background-color: var(--surface-bg);
    }

    .invoice-item:last-child {
        border-bottom: none;
    }

    /* Dropdown Styles */
    .form-select-modern {
        appearance: none;
        background-color: white;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 0.5rem 2rem 0.5rem 1rem;
        font-size: 0.875rem;
        color: var(--text-main);
    cursor: pointer;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
        box-shadow: var(--shadow-sm);
    transition: all 0.2s ease;
    }

    .form-select-modern:focus {
        border-color: var(--primary-color);
        outline: 0;
        box-shadow: 0 0 0 3px var(--primary-soft);
    }

    .form-input-modern {
        background-color: white;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        color: var(--text-main);
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
    }

    .form-input-modern:focus {
        border-color: var(--primary-color);
        outline: 0;
        box-shadow: 0 0 0 3px var(--primary-soft);
    }

    .form-input-modern:read-only {
        background-color: #f8fafc;
        cursor: default;
    }

    .modal-header {
        border-bottom: 1px solid var(--border-color);
        padding: 1.5rem 2rem;
        background: #f8fafc;
        border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    }

    .modal-body {
        padding: 2rem;
    }

    .modal-footer {
        border-top: 1px solid var(--border-color);
        padding: 1.5rem 2rem;
        background: #f8fafc;
        border-radius: 0 0 var(--radius-xl) var(--radius-xl);
    }

    /* Scrollbars */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* =====================================================
       FILTER CARD - Clean Grid Layout
       ===================================================== */
    .filter-card {
        background: white;
        border-radius: var(--radius-xl);
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        border: 1px solid var(--border-color);
    }
    
    .filter-grid {
        display: grid;
        grid-template-columns: 2fr 1.5fr 1fr 1fr auto;
        gap: 1rem;
        align-items: start;
    }
    
    @media (max-width: 1200px) {
        .filter-grid {
            grid-template-columns: 1fr 1fr 1fr;
        }
        .filter-search { grid-column: span 2; }
        .filter-actions { grid-column: span 1; }
    }
    
    @media (max-width: 768px) {
        .filter-grid {
            grid-template-columns: 1fr;
        }
        .filter-search, .filter-categories, .filter-revenue, 
        .filter-sort, .filter-actions { grid-column: span 1; }
    }
    
    .filter-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .filter-label {
        font-size: 0.7rem;
    font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
    }
    
    .filter-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }
    
    .filter-input-icon {
        position: absolute;
        left: 0.875rem;
        color: var(--text-muted);
        font-size: 0.875rem;
        pointer-events: none;
    }
    
    .filter-input {
        width: 100%;
        padding: 0.625rem 0.875rem 0.625rem 2.5rem;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        background: white;
    transition: all 0.2s ease;
}

    .filter-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    .filter-dropdown-trigger:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }
    
    .filter-select {
        width: 100%;
        padding: 0.625rem 2rem 0.625rem 0.875rem;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        background: white url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e") no-repeat right 0.75rem center/12px 12px;
        appearance: none;
        cursor: pointer;
    transition: all 0.2s ease;
}

    .filter-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-soft);
    }
    
    /* Filter Dropdown */
    .filter-dropdown-trigger {
    display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.625rem 0.875rem;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        background: white;
        cursor: pointer;
        font-size: 0.875rem;
        color: var(--text-muted);
        transition: all 0.2s ease;
    }
    
    .filter-dropdown-trigger:hover {
        border-color: var(--primary-color);
    }
    
    .filter-dropdown-trigger .trigger-text {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .filter-dropdown-trigger i {
        font-size: 0.625rem;
        margin-left: 0.5rem;
        flex-shrink: 0;
    }
    
    .filter-dropdown-menu {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        z-index: 1050;
        max-height: 320px;
        overflow: hidden;
        display: none;
    }
    
    .filter-dropdown-menu.show {
        display: block;
        animation: dropdownSlideIn 0.2s ease;
    }
    
    @keyframes dropdownSlideIn {
        from { opacity: 0; transform: translateY(-8px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .searchable-dropdown-wrapper {
        position: relative;
    }
    
    .dropdown-search-box {
    padding: 0.75rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
    align-items: center;
        gap: 0.5rem;
        background: #f8fafc;
    }
    
    .dropdown-search-box i { color: var(--text-muted); }
    
    .dropdown-search-box input {
        flex: 1;
        border: none;
        outline: none;
        font-size: 0.875rem;
        background: transparent;
    }
    
    .dropdown-options-list {
        max-height: 240px;
        overflow-y: auto;
        padding: 0.5rem;
    }
    
    .dropdown-option-item {
        display: flex;
    align-items: center;
    gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.15s ease;
        font-size: 0.875rem;
    }
    
    .dropdown-option-item:hover { background: var(--surface-bg); }
    .dropdown-option-item.included { background: var(--success-soft); }
    .dropdown-option-item.included .option-checkbox { color: var(--success-color); }
    .dropdown-option-item.excluded { background: #fee2e2; }
    .dropdown-option-item.excluded .option-checkbox { color: #dc2626; }
    .dropdown-option-item.selected { background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%); }
    .dropdown-option-item.selected .option-checkbox { color: #00695c; }
    
    .option-checkbox {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Filter Actions */
    .filter-actions-row {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .filter-btn {
        padding: 0.625rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        background: white;
    cursor: pointer;
    transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .filter-btn:hover {
        background: var(--surface-bg);
    }
    
    .filter-btn-star {
        color: var(--text-muted);
    }
    
    .filter-btn-star.active {
        background: var(--warning-soft);
        border-color: var(--warning-color);
        color: var(--warning-color);
    }
    
    .filter-view-toggle {
        display: flex;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        overflow: hidden;
    }
    
    .filter-view-toggle input {
        display: none;
    }
    
    .filter-view-toggle label {
        padding: 0.625rem 0.875rem;
        cursor: pointer;
        background: white;
        color: var(--text-muted);
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .filter-view-toggle label:first-of-type {
        border-right: 1px solid var(--border-color);
    }
    
    .filter-view-toggle input:checked + label {
        background: var(--primary-color);
        color: white;
    }

    /* Selected Tags */
    .selected-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.375rem;
        min-height: 0;
    }

    .selected-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.375rem 0.75rem;
        background: var(--primary-soft);
        border: 1px solid var(--primary-color);
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--primary-color);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .selected-tag:hover {
        background: var(--primary-color);
        color: white;
    }

    .selected-tag.excluded {
        background: #fee2e2;
        border-color: #fca5a5;
        color: #b91c1c;
    }

    .selected-tag.excluded:hover {
        background: #fca5a5;
        color: #7f1d1d;
    }

    .selected-tag.flavour-selected {
        background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%);
        border-color: #00695c;
        color: #00695c;
    }

    .selected-tag.flavour-selected:hover {
        background: #00695c;
        color: white;
    }

    .year-tag {
        border-radius: 9999px;
        font-weight: 500;
        padding: 0.5rem 1.25rem;
    }

    /* =====================================================
       COMPANY CARDS - Modern Redesign
       ===================================================== */
    .company-card-modern {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 0;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .company-card-modern:hover {
        border-color: var(--primary-color);
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .company-header {
        padding: 1.25rem 1.25rem 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .company-flavours {
        padding: 0 1.25rem 0.75rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.375rem;
    }

    .flavour-tag {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.625rem;
        background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%);
        color: #00695c;
        font-size: 0.6875rem;
        font-weight: 600;
        border-radius: 999px;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        border: 1px solid rgba(0, 105, 92, 0.2);
    }

    .flavour-tag-lg {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.875rem;
        background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%);
        color: #00695c;
        font-size: 0.8125rem;
        font-weight: 600;
        border-radius: 999px;
        letter-spacing: 0.02em;
        border: 1px solid rgba(0, 105, 92, 0.2);
    }

    /* Flavour Pricing */
    .flavour-pricing-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .flavour-price-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.625rem 0.875rem;
        background: #f8f9fa;
        border-radius: 0.5rem;
        border: 1px solid #e9ecef;
    }

    .flavour-name {
        font-weight: 500;
        color: #212529;
        font-size: 0.875rem;
    }

    .price-input-wrapper {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .price-input-wrapper .currency {
        color: #6c757d;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .flavour-price-input {
        width: 80px;
        text-align: right;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }

    .flavour-price-input:focus {
        border-color: #5B5FEF;
        box-shadow: 0 0 0 3px rgba(91, 95, 239, 0.1);
        outline: none;
    }

    /* Company Note Blocks */
    .note-blocks-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .note-block {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 0.75rem;
        padding: 1rem;
        position: relative;
    }

    .note-block:hover {
        border-color: #dee2e6;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .note-block-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }

    .note-block-meta {
        font-size: 0.75rem;
        color: #6c757d;
    }

    .note-block-actions {
        display: flex;
        gap: 0.25rem;
        opacity: 0;
        transition: opacity 0.15s ease;
    }

    .note-block:hover .note-block-actions {
        opacity: 1;
    }

    .note-block-actions button {
        width: 28px;
        height: 28px;
        border-radius: 0.375rem;
        border: none;
        background: #f8f9fa;
        color: #6c757d;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
    }

    .note-block-actions button:hover {
        background: #e9ecef;
        color: #333;
    }

    .note-block-actions button.delete-note:hover {
        background: #fee2e2;
        color: #dc3545;
    }

    .note-block-text {
        color: #333;
        line-height: 1.5;
        margin-bottom: 0.75rem;
        white-space: pre-wrap;
    }

    .note-block-images {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
    }

    .note-block-image {
        position: relative;
        aspect-ratio: 1;
        border-radius: 0.5rem;
        overflow: hidden;
        cursor: pointer;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
    }

    .note-block-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.2s ease;
    }

    .note-block-image:hover img {
        transform: scale(1.05);
    }

    .note-block-image .delete-img-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        border: none;
        font-size: 0.65rem;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .note-block-image:hover .delete-img-btn {
        display: flex;
    }

    .note-block-image .delete-img-btn:hover {
        background: #dc3545;
    }

    /* Add Note Form */
    .add-note-form {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 0.75rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .add-note-form textarea {
        width: 100%;
        border: 1px solid #e9ecef;
        border-radius: 0.5rem;
        padding: 0.75rem;
        font-size: 0.9rem;
        resize: vertical;
        min-height: 80px;
    }

    .add-note-form textarea:focus {
        border-color: #5B5FEF;
        outline: none;
        box-shadow: 0 0 0 3px rgba(91, 95, 239, 0.1);
    }

    .add-note-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.75rem;
    }

    .add-note-images-preview {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .add-note-images-preview .preview-img {
        width: 48px;
        height: 48px;
        border-radius: 0.375rem;
        object-fit: cover;
        border: 1px solid #e9ecef;
    }

    .notes-empty {
        text-align: center;
        padding: 2rem 1rem;
        color: #6c757d;
        background: #f8f9fa;
        border-radius: 0.5rem;
        border: 2px dashed #dee2e6;
    }

    .notes-empty i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        display: block;
        opacity: 0.5;
    }

    /* Photo Lightbox */
    .photo-lightbox {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }

    .photo-lightbox img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 0.5rem;
    }

    .photo-lightbox .close-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: none;
        font-size: 1.25rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .photo-lightbox .close-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    /* Alert Tags */
    .company-alerts {
        padding: 0 1.25rem 0.5rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.375rem;
    }

    .alert-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        font-size: 0.6875rem;
        font-weight: 600;
        border-radius: 999px;
        text-transform: uppercase;
        letter-spacing: 0.02em;
    }

    .alert-tag.high {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #dc2626;
        border: 1px solid rgba(220, 38, 38, 0.2);
    }

    .alert-tag.medium {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        color: #d97706;
        border: 1px solid rgba(217, 119, 6, 0.2);
    }

    .alert-tag.low {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #2563eb;
        border: 1px solid rgba(37, 99, 235, 0.2);
    }

    .alert-tag i {
        font-size: 0.625rem;
    }

    /* Alert Detail Cards for Sidepanel */
    .alert-details-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .alert-detail-card {
        padding: 0.875rem;
        border-radius: var(--radius-md);
        border-left: 4px solid;
    }

    .alert-detail-card.alert-high {
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        border-left-color: #dc2626;
    }

    .alert-detail-card.alert-medium {
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        border-left-color: #d97706;
    }

    .alert-detail-card.alert-low {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border-left-color: #2563eb;
    }

    .alert-detail-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .alert-detail-icon {
        font-size: 1rem;
    }

    .alert-detail-title {
        font-weight: 600;
        font-size: 0.875rem;
        flex: 1;
    }

    .alert-detail-priority {
        font-size: 0.6875rem;
        font-weight: 600;
        padding: 0.125rem 0.5rem;
        border-radius: 999px;
        text-transform: uppercase;
    }

    .badge-high {
        background: #dc2626;
        color: white;
    }

    .badge-medium {
        background: #d97706;
        color: white;
    }

    .badge-low {
        background: #2563eb;
        color: white;
    }

    .alert-detail-description {
        font-size: 0.8125rem;
        color: var(--text-secondary);
        margin: 0;
        line-height: 1.5;
    }

    .company-name {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-main);
        margin: 0;
        line-height: 1.3;
    }

    .company-contact {
        padding: 0 1.25rem 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        flex: 1;
    }

    .contact-item {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        font-size: 0.8125rem;
        color: var(--text-muted);
    }

    .contact-item.clickable {
        cursor: pointer;
        transition: color 0.15s ease;
    }

    .contact-item.clickable:hover {
        color: var(--primary-color);
    }

    .contact-item i {
        width: 16px;
        text-align: center;
        font-size: 0.75rem;
        flex-shrink: 0;
    }

    .contact-item span {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Quick Action Buttons */
    .company-actions {
        display: flex;
        gap: 0.375rem;
        padding: 0.875rem 1.25rem;
        background: var(--surface-bg);
        border-top: 1px solid var(--border-color);
        margin-top: auto;
    }

    .action-btn {
        width: 34px;
        height: 34px;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        background: white;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.15s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
    }

    .action-btn:hover:not(:disabled) {
        background: var(--primary-soft);
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .action-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .action-btn.whatsapp:hover:not(:disabled) {
        background: #dcf8c6;
        border-color: #25d366;
        color: #25d366;
    }

    .action-btn.primary {
        flex: 1;
        width: auto;
        padding: 0 0.75rem;
        background: var(--primary-color);
        color: white;
        border: none;
        font-weight: 500;
        gap: 0.375rem;
    }

    .action-btn.primary:hover {
        background: #4f46e5;
    }

    /* =====================================================
       SIDEPANEL - Simplified Layout
       ===================================================== */
    .company-profile-header {
        text-align: center;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 1.5rem;
    }

    .company-avatar {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: var(--primary-soft);
        color: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin: 0 auto 1rem;
    }

    .quick-actions-row {
        display: flex;
        justify-content: center;
        gap: 0.75rem;
        margin-top: 0.5rem;
    }

    .quick-action {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: var(--surface-bg);
        border: 1px solid var(--border-color);
        color: var(--text-muted);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        transition: all 0.2s ease;
        text-decoration: none;
    }

    .quick-action:hover:not(.disabled) {
        background: var(--primary-soft);
        border-color: var(--primary-color);
        color: var(--primary-color);
        transform: scale(1.05);
    }

    .quick-action.whatsapp:hover:not(.disabled) {
        background: #dcf8c6;
        border-color: #25d366;
        color: #25d366;
    }

    .quick-action.disabled {
        opacity: 0.4;
        cursor: not-allowed;
        pointer-events: none;
    }
</style>
<script>
let allCompanies = [];
let filteredCompanies = [];
let currentViewMode = 'cards';
let currentYear = 'combined'; // Always load all companies
let categoryStates = {}; // Track category filter states: 'included', 'excluded', or null (removed)
let selectedFlavours = []; // Track selected flavours for filtering
let showOnlyMajorRetailers = false; // Filter for major retailers

// Map variables
let map = null;
let mapMarkers = [];
const MAPBOX_TOKEN = '{{ mapbox_api_key }}';

// Shared cache configuration (same keys as map.html for sharing)
const CACHE_KEY = 'companies_shared_cache';
const CACHE_TIME_KEY = 'companies_shared_cache_time';
const DATA_CACHE_DURATION = 10 * 60 * 1000; // 10 minutes

function getCacheKey(year) {
    return CACHE_KEY; // Always use shared cache
}

function getCacheTimeKey(year) {
    return CACHE_TIME_KEY;
}

function isCacheValid(year) {
    const cachedTime = localStorage.getItem(getCacheTimeKey(year));
    if (!cachedTime) return false;
    return (Date.now() - parseInt(cachedTime)) < DATA_CACHE_DURATION;
}

function getCachedData(year) {
    if (!isCacheValid(year)) return null;
    const cached = localStorage.getItem(getCacheKey(year));
    if (!cached) return null;
    try {
        return JSON.parse(cached);
    } catch (e) {
        return null;
    }
}

function setCachedData(year, data) {
    try {
        localStorage.setItem(getCacheKey(year), JSON.stringify(data));
        localStorage.setItem(getCacheTimeKey(year), String(Date.now()));
    } catch (e) {
        console.warn('Failed to cache data:', e);
    }
}

function clearCache(year) {
    localStorage.removeItem(CACHE_KEY);
    localStorage.removeItem(CACHE_TIME_KEY);
}

// Major retailer company IDs
const MAJOR_RETAILER_IDS = [1324, 1340, 9986, 1213, 1712]; // Delhaize, Geers, Inter Drinks, Biofresh, Terroirist

function isMajorRetailer(companyId) {
    return MAJOR_RETAILER_IDS.includes(companyId);
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips with instant appearance
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            delay: { show: 0, hide: 0 }
        });
    });
    
    // Check authentication status on page load
    fetch('/api/test-sync')
        .then(res => res.json())
        .then(data => {
            console.log('Auth status:', data);
            if (!data.token_valid) {
                console.warn('⚠️ Not authenticated - sync operations will fail');
            }
        })
        .catch(err => console.error('Failed to check auth status:', err));
    
    // Check if we need to filter by company (coming from alerts page)
    const filterCompanyId = sessionStorage.getItem('filterCompanyId');
    const filterCompanyName = sessionStorage.getItem('filterCompanyName');
    
    if (filterCompanyId && filterCompanyName) {
        // Clear the session storage
        sessionStorage.removeItem('filterCompanyId');
        sessionStorage.removeItem('filterCompanyName');
        
        // Switch to Combined tab first, then load data
        changeYear('combined').then(() => {
            // Auto-populate the search box with company name
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = filterCompanyName;
                searchInput.focus();
                
                // Trigger the search/filter
                filterCompanies();
                
                // Show toast notification
                setTimeout(() => {
                    const toast = document.createElement('div');
                    toast.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
                    toast.style.zIndex = '9999';
                    toast.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>
                        Showing invoices for: <strong>${filterCompanyName}</strong> (Combined 2024 & 2025)
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 4000);
                }, 300);
                
                // Find and click on the company after filtering
                setTimeout(() => {
                    const companyElement = document.querySelector(`[data-company-id="${filterCompanyId}"]`);
                    if (companyElement) {
                        companyElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Highlight the card briefly
                        companyElement.style.outline = '2px solid #6c5ce7';
                        setTimeout(() => {
                            companyElement.style.outline = '';
                            companyElement.click();
                        }, 800);
                    }
                }, 500);
            }
        });
    } else {
        loadData().then(() => {
            // Check if there's a company parameter in URL to auto-open
            checkUrlForCompany();
        });
    }
});

// Check URL for company parameter and open the company panel
function checkUrlForCompany() {
    const urlParams = new URLSearchParams(window.location.search);
    const companyId = urlParams.get('company');
    const companyName = urlParams.get('name');
    
    if (companyId || companyName) {
        // Wait for data to load, then find and show the company
        setTimeout(() => {
            let company = null;
            
            if (companyId) {
                company = allCompanies.find(c => c.company_id == companyId || c.id == companyId);
            }
            
            // If not found by ID, try searching by name
            if (!company && companyName) {
                const searchName = companyName.toLowerCase();
                company = allCompanies.find(c => 
                    c.name?.toLowerCase().includes(searchName) ||
                    c.name?.toLowerCase() === searchName
                );
            }
            
            if (company) {
                // Auto-fill search box with company name
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.value = company.name;
                    filterCompanies();
                }
                
                // Open the company details panel
                showCompanyDetails(company.id);
            } else {
                console.warn('Company not found:', companyId || companyName);
                // Still search for the name even if not found exactly
                if (companyName) {
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        searchInput.value = companyName;
                        filterCompanies();
                    }
                }
            }
            
            // Clean up the URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }, 300);
    }
}

async function loadData(forceRefresh = false) {
    try {
        document.getElementById('error-message').style.display = 'none';
        document.getElementById('companies-cards').style.display = 'none';
        document.getElementById('companies-table').style.display = 'none';
        document.getElementById('results-info').style.display = 'none';
        document.getElementById('no-results').style.display = 'none';
        document.getElementById('year-stats').style.display = 'none';
        
        // Check cache first (unless force refresh)
        const cachedData = !forceRefresh ? getCachedData(currentYear) : null;
        
        if (cachedData) {
            console.log(`📦 Using cached data for ${currentYear} (${cachedData.companies?.length || 0} companies)`);
            document.getElementById('loading').style.display = 'none';
            
            allCompanies = cachedData.companies || [];
            filteredCompanies = [...allCompanies];
            
            // Populate filter dropdowns
            populateCategories();
            populateFlavours();

            // Update stats
            updateStats(cachedData);
            
            // Display companies
            displayCompanies();
            
            // Show cached indicator
            showCacheIndicator(true);
            return;
        }
        
        // No cache, fetch from API
        console.log(`📡 Fetching fresh data for ${currentYear}...`);
        document.getElementById('loading').style.display = 'block';
        
        const apiEndpoint = `/api/companies-from-db?year=${currentYear}`;
        
        const response = await fetch(apiEndpoint);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Cache the data
        setCachedData(currentYear, data);
        console.log(`✅ Cached ${data.companies?.length || 0} companies for ${currentYear}`);
        
        allCompanies = data.companies || [];
        filteredCompanies = [...allCompanies];
        
        // Populate filter dropdowns
        populateCategories();
        populateFlavours();

        // Update stats
        updateStats(data);
        
        // Display companies
        displayCompanies();
        
        document.getElementById('loading').style.display = 'none';
        showCacheIndicator(false);
        
    } catch (error) {
        console.error('Error loading companies:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-message').style.display = 'block';
        document.getElementById('error-text').textContent = error.message;
    }
}

function showCacheIndicator(fromCache) {
    // Cache indicator removed - was redundant
}

// Force refresh function for the refresh button
function forceRefreshData() {
    clearCache(currentYear);
    loadData(true);
}

function updateStats(data) {
    document.getElementById('year-stats').style.display = 'flex';
    document.getElementById('stat-total-companies').textContent = data.total_companies || 0;
}

async function syncLatestData(fullSync = false) {
    // If not specified, ask user
    if (!fullSync) {
        const choice = confirm(
            "Choose sync type:\n\n" +
            "OK = Full Sync (all invoices - takes longer)\n" +
            "Cancel = Quick Sync (only new invoices since last sync)"
        );
        fullSync = choice;
    }

    try {
        document.getElementById('sync-status').style.display = 'block';
        document.getElementById('sync-results').style.display = 'none';

        // Use unified sync endpoint - it auto-detects year from invoice dates
        console.log(`Starting ${fullSync ? 'FULL' : 'incremental'} sync`);

        let totalFetched = 0;
        let totalSaved = 0;
        let totalErrors = 0;
        let currentPage = 1;
        let batchCount = 0;
        const maxBatches = fullSync ? 100 : 20; // More batches for full sync

        // Loop through batches until complete
        while (batchCount < maxBatches) {
            batchCount++;
            document.getElementById('sync-message').innerHTML = `${fullSync ? 'Full sync' : 'Syncing'} invoices from DUANO...<br><small class="text-muted">Batch ${batchCount} - ${totalSaved} invoices synced so far</small>`;

        const response = await fetch('/api/sync-invoices', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify({ page: currentPage, full_sync: fullSync })
        });
        
        if (!response.ok) {
            let errorData;
            try {
                errorData = await response.json();
            } catch (e) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            if (response.status === 401) {
                document.getElementById('sync-status').style.display = 'none';
                document.getElementById('sync-results').style.display = 'block';
                document.getElementById('sync-results').innerHTML = `
                    <div class="alert alert-warning">
                        <h5><i class="fas fa-lock me-2"></i>Authentication Required</h5>
                        <p class="mb-2"><strong>${errorData.message || 'Your session has expired.'}</strong></p>
                        <p class="mb-0">
                            <a href="/" class="btn btn-primary">
                                <i class="fas fa-sign-in-alt me-2"></i>Log In to DUANO
                            </a>
                        </p>
                    </div>
                `;
                return;
            }
            
            throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error || result.message || 'Sync failed');
            }
            
            totalFetched += result.total_fetched || 0;
            totalSaved += result.saved || 0;
            totalErrors += result.errors || 0;
            
            console.log(`Batch ${batchCount}: fetched=${result.total_fetched}, saved=${result.saved}, complete=${result.complete}, next=${result.next_page}`);
            
            // Check if sync is complete
            if (result.complete || !result.next_page) {
                break;
            }
            
            // Continue with next page
            currentPage = result.next_page;
            
            // Small delay between batches
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        document.getElementById('sync-status').style.display = 'none';
        document.getElementById('sync-results').style.display = 'block';
        
            document.getElementById('sync-results').innerHTML = `
                <div class="alert alert-success">
                <h5><i class="fas fa-check-circle me-2"></i>Sync Completed!</h5>
                    <div class="row mt-3">
                    <div class="col-md-4">
                        <strong>Batches:</strong> ${batchCount}
                        </div>
                    <div class="col-md-4">
                        <strong>Invoices Synced:</strong> <span class="text-success">${totalSaved}</span>
                        </div>
                    <div class="col-md-4">
                        <strong>Errors:</strong> <span class="text-danger">${totalErrors}</span>
                        </div>
                        </div>
                ${totalSaved > 0 ? `
                        <p class="mt-2 mb-0">
                        <strong>${totalSaved} invoices</strong> have been synced to the database!
                        </p>
                    ` : '<p class="mt-2 mb-0">Database is up to date - no new invoices found.</p>'}
                </div>
            `;
            
            // Clear cache and refresh data after sync
        clearCache();
            setTimeout(() => loadData(true), 2000);
        
    } catch (error) {
        console.error('Sync error:', error);
        document.getElementById('sync-status').style.display = 'none';
        document.getElementById('sync-results').style.display = 'block';
        
        let errorMessage = error.message;
        let errorDetails = '';
        
        // Provide helpful context for common errors
        if (error.message.includes('Not authenticated') || error.message.includes('401') || error.message.includes('403')) {
            errorMessage = '🔐 Authentication Required';
            errorDetails = '<strong>Your DUANO session has expired.</strong> Please <a href="/" class="alert-link">log in again</a> to continue syncing data.';
        } else if (error.message.includes('JSON')) {
            errorMessage = 'Server returned an invalid response (not JSON)';
            errorDetails = 'This usually means the server encountered an error. Check the Flask logs for details.';
        } else if (error.message.includes('500')) {
            errorMessage = 'Server error occurred while syncing data';
            errorDetails = 'The DUANO API may be temporarily unavailable, or your session may have expired. Try <a href="/" class="alert-link">logging in again</a>.';
        }
        
        document.getElementById('sync-results').innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Sync Failed</h5>
                <p class="mb-2"><strong>${errorMessage}</strong></p>
                ${errorDetails ? `<p class="mb-0 small">${errorDetails}</p>` : ''}
                <hr class="my-2">
                <small class="text-muted">Technical details: ${error.message}</small>
            </div>
        `;
    }
}

async function refreshCompanyMetrics() {
    try {
        document.getElementById('sync-status').style.display = 'block';
        document.getElementById('sync-results').style.display = 'none';
        document.getElementById('sync-message').textContent = 'Recalculating company metrics from invoice data...';
        
        const response = await fetch('/api/refresh-company-metrics', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        document.getElementById('sync-status').style.display = 'none';
        document.getElementById('sync-results').style.display = 'block';
        
        if (result.success) {
            document.getElementById('sync-results').innerHTML = `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>Company Metrics Refreshed!</h5>
                    <p class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        All company revenue totals, invoice counts, and statistics have been recalculated from the latest invoice data.
                    </p>
                </div>
            `;
            
            // Clear cache and refresh data after metrics update
            clearCache();
            setTimeout(() => loadData(true), 1500);
        } else {
            document.getElementById('sync-results').innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Refresh Failed</h5>
                    <p class="mb-0">${result.error || result.message || 'Unknown error'}</p>
                </div>
            `;
        }
        
    } catch (error) {
        document.getElementById('sync-status').style.display = 'none';
        document.getElementById('sync-results').style.display = 'block';
        document.getElementById('sync-results').innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Error</h5>
                <p class="mb-0">${error.message}</p>
            </div>
        `;
    }
}

async function populateCompaniesDatabase() {
    try {
        document.getElementById('sync-status').style.display = 'block';
        document.getElementById('sync-results').style.display = 'none';
        document.getElementById('sync-message').textContent = 'Extracting company data from all invoices...';
        
        const response = await fetch('/api/populate-companies-enhanced', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        document.getElementById('sync-status').style.display = 'none';
        document.getElementById('sync-results').style.display = 'block';
        
        if (result.success) {
            document.getElementById('sync-results').innerHTML = `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>Companies Database Populated!</h5>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <strong>Total Processed:</strong> ${result.total_processed}
                        </div>
                        <div class="col-md-3">
                            <strong>New Companies:</strong> <span class="text-success">${result.saved}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Updated:</strong> <span class="text-info">${result.updated}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Errors:</strong> <span class="text-danger">${result.errors}</span>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <strong>API Fetch Success:</strong> <span class="text-success">${result.api_fetch_stats.success}</span>
                        </div>
                        <div class="col-md-6">
                            <strong>API Fetch Errors:</strong> <span class="text-danger">${result.api_fetch_stats.errors}</span>
                        </div>
                    </div>
                    <p class="mt-3 mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Enhanced companies database created with complete DOUANO API data including pricing categories, addresses, company status, categories, and financial metrics.
                    </p>
                </div>
            `;
            
            // Clear cache and refresh data after population
            clearCache();
            setTimeout(() => loadData(true), 2000);
        } else {
            document.getElementById('sync-results').innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Population Failed</h5>
                    <p class="mb-0">${result.error || result.message || 'Unknown error'}</p>
                </div>
            `;
        }
        
    } catch (error) {
        document.getElementById('sync-status').style.display = 'none';
        document.getElementById('sync-results').style.display = 'block';
        document.getElementById('sync-results').innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Error</h5>
                <p class="mb-0">${error.message}</p>
            </div>
        `;
    }
}

function toggleMajorRetailerFilter() {
    showOnlyMajorRetailers = !showOnlyMajorRetailers;
    const btn = document.getElementById('majorRetailerFilter');
    
    if (showOnlyMajorRetailers) {
        btn.classList.remove('btn-outline-warning');
        btn.classList.add('btn-warning');
    } else {
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-outline-warning');
    }
    
    filterCompanies();
}

function filterCompanies() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const alertFilter = document.getElementById('alertFilter').value;

    filteredCompanies = allCompanies.filter(company => {
        // Category filtering
        const companyCategories = getCompanyCategories(company);
        const excludedCategories = Object.keys(categoryStates).filter(cat => categoryStates[cat] === 'excluded');
        const includedCategories = Object.keys(categoryStates).filter(cat => categoryStates[cat] === 'included');

        // First, check if company has any excluded categories - if so, filter it out
        if (excludedCategories.length > 0) {
            const hasExcludedCategory = companyCategories.some(cat => excludedCategories.includes(cat));
            if (hasExcludedCategory) return false; // Exclude this company
        }

        // If there are included categories specified, company must have at least one
        if (includedCategories.length > 0 && includedCategories.length < Object.keys(categoryStates).length) {
            // Not all categories are included, so filter
            const hasIncludedCategory = companyCategories.some(cat => includedCategories.includes(cat));
            if (!hasIncludedCategory) return false;
        }

        // Flavour filtering - if flavours selected, company must have at least one of them
        if (selectedFlavours.length > 0) {
            const companyFlavours = company.current_flavours || [];
            const hasSelectedFlavour = companyFlavours.some(f => selectedFlavours.includes(f));
            if (!hasSelectedFlavour) return false;
        }

        // Alert filtering
        if (alertFilter) {
            const companyAlerts = company.alerts || [];
            if (alertFilter === 'any') {
                if (companyAlerts.length === 0) return false;
            } else {
                const hasAlertType = companyAlerts.some(a => a.type === alertFilter);
                if (!hasAlertType) return false;
            }
        }

        // Search term filtering
        if (searchTerm && searchTerm.trim() !== '') {
            const searchableText = [
                company.name || '',
                company.vat_number || '',
                company.email || '',
                company.contact_person || '',
                company.address?.city || '',
                company.address?.country || ''
            ].join(' ').toLowerCase();

            if (!searchableText.includes(searchTerm)) return false;
        }

        return true;
    });

    // Update statistics based on filtered companies
    updateFilteredStats();

    sortCompanies();
}

function updateFilteredStats() {
    // Calculate statistics based on filtered companies
    const totalCompanies = filteredCompanies.length;

    // Update the stats display (only update elements that exist)
    const statCompaniesEl = document.getElementById('stat-total-companies');
    if (statCompaniesEl) statCompaniesEl.textContent = totalCompanies;
    
    // Update year breakdown if in combined view
    if (currentYear === 'combined') {
        const year2024Companies = filteredCompanies.filter(c => c.years_data && c.years_data['2024'] && c.years_data['2024'].invoice_count > 0);
        const year2025Companies = filteredCompanies.filter(c => c.years_data && c.years_data['2025'] && c.years_data['2025'].invoice_count > 0);
        const year2026Companies = filteredCompanies.filter(c => c.years_data && c.years_data['2026'] && c.years_data['2026'].invoice_count > 0);

        const revenue2024 = filteredCompanies.reduce((sum, c) => {
            return sum + (c.years_data && c.years_data['2024'] ? c.years_data['2024'].total_revenue || 0 : 0);
        }, 0);

        const revenue2025 = filteredCompanies.reduce((sum, c) => {
            return sum + (c.years_data && c.years_data['2025'] ? c.years_data['2025'].total_revenue || 0 : 0);
        }, 0);

        const revenue2026 = filteredCompanies.reduce((sum, c) => {
            return sum + (c.years_data && c.years_data['2026'] ? c.years_data['2026'].total_revenue || 0 : 0);
        }, 0);

        const invoices2024 = filteredCompanies.reduce((sum, c) => {
            return sum + (c.years_data && c.years_data['2024'] ? c.years_data['2024'].invoice_count || 0 : 0);
        }, 0);

        const invoices2025 = filteredCompanies.reduce((sum, c) => {
            return sum + (c.years_data && c.years_data['2025'] ? c.years_data['2025'].invoice_count || 0 : 0);
        }, 0);

        const invoices2026 = filteredCompanies.reduce((sum, c) => {
            return sum + (c.years_data && c.years_data['2026'] ? c.years_data['2026'].invoice_count || 0 : 0);
        }, 0);

        const breakdown2024Element = document.getElementById('breakdown-2024');
        const breakdown2025Element = document.getElementById('breakdown-2025');
        const breakdown2026Element = document.getElementById('breakdown-2026');

        if (breakdown2024Element) {
            breakdown2024Element.innerHTML = `
                ${year2024Companies.length} companies, ${invoices2024} invoices, €${revenue2024.toLocaleString('nl-BE', {minimumFractionDigits: 2})}
            `;
        }

        if (breakdown2025Element) {
            breakdown2025Element.innerHTML = `
                ${year2025Companies.length} companies, ${invoices2025} invoices, €${revenue2025.toLocaleString('nl-BE', {minimumFractionDigits: 2})}
            `;
        }

        if (breakdown2026Element) {
            breakdown2026Element.innerHTML = `
                ${year2026Companies.length} companies, ${invoices2026} invoices, €${revenue2026.toLocaleString('nl-BE', {minimumFractionDigits: 2})}
            `;
        }
    }
}

function getCompanyCategories(company) {
    // Extract categories from raw_company_data
    if (company.raw_company_data && company.raw_company_data.company_categories) {
        if (Array.isArray(company.raw_company_data.company_categories)) {
            return company.raw_company_data.company_categories.map(cat => cat.name || cat);
        }
    }

    // Fallback: try direct company_categories field
    if (company.company_categories) {
        if (Array.isArray(company.company_categories)) {
            return company.company_categories.map(cat => cat.name || cat);
        }
    }

    return [];
}

function isHorecaCompany(company) {
    // Check if company belongs to Horeca category
    const categories = getCompanyCategories(company);
    return categories.some(cat => cat.toLowerCase() === 'horeca');
}

function populateCategories() {
    const categorySet = new Set();
    
    // Extract all unique categories from all companies
    allCompanies.forEach(company => {
        const categories = getCompanyCategories(company);
        categories.forEach(cat => categorySet.add(cat));
    });
    
    const sortedCategories = Array.from(categorySet).sort();
    
    // Initialize all categories as included by default
    categoryStates = {};
    sortedCategories.forEach(cat => {
        categoryStates[cat] = 'included';
    });
    
    renderCategoryTags();
}

function renderCategoryTags() {
    // Render dropdown options
    const optionsContainer = document.getElementById('category-dropdown-options');
    const selectedContainer = document.getElementById('category-selected-tags');
    if (!optionsContainer) return;
    
    const categories = Object.keys(categoryStates).sort();
    
    if (categories.length === 0) {
        optionsContainer.innerHTML = '<div class="p-3 text-center text-muted small">No categories found</div>';
        return;
    }
    
    // Render action buttons
    optionsContainer.innerHTML = `
        <div class="d-flex gap-2 p-2 border-bottom">
            <button class="btn btn-sm btn-outline-success flex-fill" onclick="selectAllCategories()">
                <i class="fas fa-check-double me-1"></i>Select All
            </button>
            <button class="btn btn-sm btn-outline-danger flex-fill" onclick="deselectAllCategories()">
                <i class="fas fa-times me-1"></i>Deselect All
            </button>
        </div>
    `;
    
    // Render options in dropdown
    categories.forEach(category => {
        const state = categoryStates[category];
        const stateClass = state === 'excluded' ? 'excluded' : 'included';
        const icon = state === 'excluded' ? 'times-circle' : 'check-circle';
        
        const option = document.createElement('div');
        option.className = `dropdown-option-item ${stateClass}`;
        option.innerHTML = `
            <div class="option-checkbox">
                <i class="fas fa-${icon}"></i>
            </div>
            <span class="option-label">${escapeHtml(category)}</span>
        `;
        option.onclick = () => {
            toggleCategory(category);
            // Don't close dropdown
        };
        
        optionsContainer.appendChild(option);
    });
    
    // Render selected tags (only show excluded ones to save space) - horizontal layout
    const excludedCategories = categories.filter(cat => categoryStates[cat] === 'excluded');
    
    selectedContainer.innerHTML = '';
    if (excludedCategories.length > 0) {
        excludedCategories.forEach(category => {
            const tag = document.createElement('span');
            tag.className = 'selected-tag excluded';
            tag.innerHTML = `
                <span>${escapeHtml(category)}</span>
                <i class="fas fa-times"></i>
            `;
            tag.onclick = () => toggleCategory(category);
            selectedContainer.appendChild(tag);
        });
    }
    
    // Update trigger text
    const trigger = document.getElementById('category-dropdown-trigger');
    const triggerText = trigger.querySelector('.trigger-text');
    const excludedCount = excludedCategories.length;
    
    if (excludedCount === 0) {
        triggerText.textContent = 'All categories';
        triggerText.className = 'trigger-text text-muted';
    } else {
        triggerText.textContent = `${excludedCount} excluded`;
        triggerText.className = 'trigger-text text-danger';
    }
}

// Initialize dropdown toggle
document.addEventListener('DOMContentLoaded', function() {
    const trigger = document.getElementById('category-dropdown-trigger');
    const menu = document.getElementById('category-dropdown-menu');
    const searchInput = document.getElementById('category-search-input');
    
    if (trigger && menu) {
        trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            menu.classList.toggle('show');
            if (menu.classList.contains('show') && searchInput) {
                searchInput.focus();
            }
        });
        
        document.addEventListener('click', () => {
            menu.classList.remove('show');
        });
        
        menu.addEventListener('click', (e) => {
            e.stopPropagation();
        });
    }
    
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            filterCategoryDropdown(e.target.value);
        });
    }
});

function filterCategoryDropdown(searchTerm) {
    const optionsContainer = document.getElementById('category-dropdown-options');
    const categories = Object.keys(categoryStates).sort();
    
    const filtered = categories.filter(cat => 
        cat.toLowerCase().includes(searchTerm.toLowerCase())
    );
    
    optionsContainer.innerHTML = '';
    filtered.forEach(category => {
        const state = categoryStates[category];
        const stateClass = state === 'excluded' ? 'excluded' : 'included';
        const icon = state === 'excluded' ? 'times-circle' : 'check-circle';
        
        const option = document.createElement('div');
        option.className = `dropdown-option-item ${stateClass}`;
        option.innerHTML = `
            <div class="option-checkbox">
                <i class="fas fa-${icon}"></i>
            </div>
            <span class="option-label">${escapeHtml(category)}</span>
        `;
        option.onclick = () => toggleCategory(category);
        
        optionsContainer.appendChild(option);
    });
}

function toggleCategory(category) {
    const currentState = categoryStates[category];
    
    // Toggle between included and excluded only (never remove)
    if (currentState === 'included') {
        categoryStates[category] = 'excluded';
    } else {
        categoryStates[category] = 'included';
    }
    
    renderCategoryTags();
    filterCompanies();
}

function selectAllCategories() {
    Object.keys(categoryStates).forEach(cat => {
        categoryStates[cat] = 'included';
    });
    renderCategoryTags();
    filterCompanies();
}

function deselectAllCategories() {
    Object.keys(categoryStates).forEach(cat => {
        categoryStates[cat] = 'excluded';
    });
    renderCategoryTags();
    filterCompanies();
}

// =====================================================
// FLAVOUR FILTER FUNCTIONS
// =====================================================

function populateFlavours() {
    const flavourSet = new Set();

    // Extract all unique flavours from all companies
    allCompanies.forEach(company => {
        if (company.current_flavours && Array.isArray(company.current_flavours)) {
            company.current_flavours.forEach(f => flavourSet.add(f));
        }
    });

    const sortedFlavours = Array.from(flavourSet).sort();

    // Clear selected flavours
    selectedFlavours = [];

    renderFlavourDropdown(sortedFlavours);
}

function renderFlavourDropdown(allFlavours) {
    const optionsContainer = document.getElementById('flavour-dropdown-options');
    const selectedContainer = document.getElementById('flavour-selected-tags');
    if (!optionsContainer) return;

    if (allFlavours.length === 0) {
        optionsContainer.innerHTML = '<div class="p-3 text-center text-muted small">No flavours found</div>';
        return;
    }

    // Render options in dropdown
    optionsContainer.innerHTML = '';
    allFlavours.forEach(flavour => {
        const isSelected = selectedFlavours.includes(flavour);

        const option = document.createElement('div');
        option.className = `dropdown-option-item ${isSelected ? 'selected' : ''}`;
        option.innerHTML = `
            <div class="option-checkbox">
                <i class="fas fa-${isSelected ? 'check-circle' : 'circle'}"></i>
            </div>
            <span class="option-label">${escapeHtml(flavour)}</span>
        `;
        option.onclick = () => toggleFlavour(flavour);

        optionsContainer.appendChild(option);
    });

    // Render selected tags
    selectedContainer.innerHTML = '';
    selectedFlavours.forEach(flavour => {
        const tag = document.createElement('span');
        tag.className = 'selected-tag flavour-selected';
        tag.innerHTML = `
            <span>${escapeHtml(flavour)}</span>
            <i class="fas fa-times"></i>
        `;
        tag.onclick = () => toggleFlavour(flavour);
        selectedContainer.appendChild(tag);
    });

    // Update trigger text
    const trigger = document.getElementById('flavour-dropdown-trigger');
    const triggerText = trigger?.querySelector('.trigger-text');

    if (triggerText) {
        if (selectedFlavours.length === 0) {
            triggerText.textContent = 'All flavours';
            triggerText.className = 'trigger-text text-muted';
        } else {
            triggerText.textContent = `${selectedFlavours.length} selected`;
            triggerText.className = 'trigger-text text-success';
        }
    }
}

function toggleFlavour(flavour) {
    const index = selectedFlavours.indexOf(flavour);
    if (index === -1) {
        selectedFlavours.push(flavour);
    } else {
        selectedFlavours.splice(index, 1);
    }

    // Get all flavours for re-render
    const flavourSet = new Set();
    allCompanies.forEach(company => {
        if (company.current_flavours && Array.isArray(company.current_flavours)) {
            company.current_flavours.forEach(f => flavourSet.add(f));
        }
    });

    renderFlavourDropdown(Array.from(flavourSet).sort());
    filterCompanies();
}

// Initialize flavour dropdown toggle
document.addEventListener('DOMContentLoaded', function() {
    const flavourTrigger = document.getElementById('flavour-dropdown-trigger');
    const flavourMenu = document.getElementById('flavour-dropdown-menu');

    if (flavourTrigger && flavourMenu) {
        flavourTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            flavourMenu.classList.toggle('show');
        });

        document.addEventListener('click', () => {
            flavourMenu.classList.remove('show');
        });

        flavourMenu.addEventListener('click', (e) => {
            e.stopPropagation();
        });
    }
});

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function sortCompanies() {
    const sortByEl = document.getElementById('sortBy');
    const sortBy = sortByEl ? sortByEl.value : 'revenue_desc';

    filteredCompanies.sort((a, b) => {
        switch (sortBy) {
            case 'revenue_desc':
                return (b.total_revenue || 0) - (a.total_revenue || 0);
            case 'revenue_asc':
                return (a.total_revenue || 0) - (b.total_revenue || 0);
            case 'name_asc':
                return (a.name || '').localeCompare(b.name || '');
            case 'name_desc':
                return (b.name || '').localeCompare(a.name || '');
            case 'invoices_desc':
                return (b.invoice_count || 0) - (a.invoice_count || 0);
            case 'invoices_asc':
                return (a.invoice_count || 0) - (b.invoice_count || 0);
            case 'avg_desc':
                return (b.average_invoice_value || 0) - (a.average_invoice_value || 0);
            case 'avg_asc':
                return (a.average_invoice_value || 0) - (b.average_invoice_value || 0);
            default:
                return (b.total_revenue || 0) - (a.total_revenue || 0);
        }
    });

    displayCompanies();
}

function changeViewMode() {
    currentViewMode = document.getElementById('viewMode').value;
    displayCompanies();
}

// Switch between cards and map view
function switchToView(view) {
    const cardsContainer = document.getElementById('companies-cards');
    const mapContainer = document.getElementById('companies-map');
    const tableContainer = document.getElementById('companies-table');

    // Update toggle buttons
    document.querySelectorAll('.view-toggle-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
    });

    // Hide all containers first
    cardsContainer.style.display = 'none';
    mapContainer.classList.add('d-none');
    tableContainer.style.display = 'none';

    currentViewMode = view;

    if (view === 'map') {
        mapContainer.classList.remove('d-none');
        initMapIfNeeded();
        // Wait for map to be ready before updating markers
        if (map && map.loaded()) {
            updateMapMarkers();
        } else if (map) {
            map.once('load', updateMapMarkers);
        }
    } else {
        displayCompanies();
    }
}

// Initialize map if not already done
function initMapIfNeeded() {
    if (map) return;

    mapboxgl.accessToken = MAPBOX_TOKEN;
    map = new mapboxgl.Map({
        container: 'map-container',
        style: 'mapbox://styles/mapbox/light-v11',
        center: [4.3517, 50.8503], // Belgium
        zoom: 7
    });

    map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    map.on('load', function() {
        updateMapMarkers();
    });
}

// Update map markers based on filteredCompanies
function updateMapMarkers() {
    if (!map) return;

    // Clear existing markers
    mapMarkers.forEach(m => m.remove());
    mapMarkers = [];

    let validMarkerCount = 0;
    const bounds = new mapboxgl.LngLatBounds();

    // Add markers for filtered companies
    filteredCompanies.forEach(company => {
        const lat = parseFloat(company.latitude);
        const lng = parseFloat(company.longitude);

        if (!lat || !lng || isNaN(lat) || isNaN(lng)) return;

        validMarkerCount++;
        bounds.extend([lng, lat]);

        const hasAlerts = company.alerts && company.alerts.length > 0;
        const markerColor = hasAlerts ? '#dc3545' : '#28a745';

        // Create marker element
        const el = document.createElement('div');
        el.className = 'map-marker';
        el.style.cssText = `
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: ${markerColor};
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        `;
        el.innerHTML = '<i class="fas fa-building" style="color:white;font-size:11px;"></i>';

        // Create popup content
        const city = company.address?.city || '';
        const alertBadges = hasAlerts ? company.alerts.map(a =>
            `<span style="display:inline-block;background:#fee2e2;color:#dc3545;padding:2px 6px;border-radius:4px;font-size:10px;margin-right:4px;">${getAlertLabel(a.type)}</span>`
        ).join('') : '';

        const popupContent = `
            <div style="min-width:180px;">
                <strong style="font-size:14px;">${escapeHtml(company.name || company.public_name || 'Unknown')}</strong>
                <div style="color:#6c757d;font-size:12px;margin:4px 0;">${escapeHtml(city)}</div>
                ${alertBadges ? `<div style="margin-top:6px;">${alertBadges}</div>` : ''}
                <button onclick="showCompanyDetails(${company.company_id})"
                        style="margin-top:8px;width:100%;padding:6px;background:#5B5FEF;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;">
                    View Details
                </button>
            </div>
        `;

        const popup = new mapboxgl.Popup({ offset: 25, closeButton: true })
            .setHTML(popupContent);

        const marker = new mapboxgl.Marker(el)
            .setLngLat([lng, lat])
            .setPopup(popup)
            .addTo(map);

        mapMarkers.push(marker);
    });

    // Fit bounds if markers exist
    if (validMarkerCount > 0) {
        map.fitBounds(bounds, { padding: 60, maxZoom: 12 });
    }

    console.log(`Map: Showing ${validMarkerCount} of ${filteredCompanies.length} companies with valid coordinates`);
}

// Helper to get alert label
function getAlertLabel(type) {
    const labels = {
        'PATTERN_DISRUPTION': 'Pattern Break',
        'HIGH_VALUE_AT_RISK': 'High Value Risk',
        'DORMANT_CUSTOMER': 'Dormant',
        'DECLINING_VALUE': 'Declining',
        'INCREASING_GAP': 'Less Frequent',
        'ONE_TIME_CUSTOMER': 'One-Timer'
    };
    return labels[type] || type;
}

function displayCompanies() {
    const cardsContainer = document.getElementById('companies-cards');
    const tableContainer = document.getElementById('companies-table');
    const mapContainer = document.getElementById('companies-map');
    const resultsInfo = document.getElementById('results-info');
    const noResults = document.getElementById('no-results');

    // Update results info
    document.getElementById('showing-count').textContent = filteredCompanies.length;
    document.getElementById('total-count').textContent = allCompanies.length;
    resultsInfo.style.display = 'block';

    if (filteredCompanies.length === 0) {
        cardsContainer.style.display = 'none';
        tableContainer.style.display = 'none';
        mapContainer.classList.add('d-none');
        noResults.style.display = 'block';
        return;
    }

    noResults.style.display = 'none';

    if (currentViewMode === 'map') {
        cardsContainer.style.display = 'none';
        tableContainer.style.display = 'none';
        mapContainer.classList.remove('d-none');
        if (map) updateMapMarkers();
    } else if (currentViewMode === 'cards') {
        displayCardsView();
        cardsContainer.style.display = 'flex';
        tableContainer.style.display = 'none';
        mapContainer.classList.add('d-none');
    } else {
        displayTableView();
        cardsContainer.style.display = 'none';
        tableContainer.style.display = 'block';
        mapContainer.classList.add('d-none');
    }
}

function displayCardsView() {
    const container = document.getElementById('companies-cards');
    container.innerHTML = '';

    filteredCompanies.forEach(company => {
        const card = document.createElement('div');
        card.className = 'col-md-6 col-lg-4 mb-4';

        const addressParts = [
            company.address?.city,
            company.address?.country
        ].filter(part => part).join(', ');

        // Parse raw_company_data for email and contact person
        let rawData = {};
        if (company.raw_company_data) {
            try {
                rawData = typeof company.raw_company_data === 'string'
                    ? JSON.parse(company.raw_company_data)
                    : company.raw_company_data;
            } catch (e) {
                rawData = {};
            }
        }

        // Extract email from raw_company_data (can be string or array)
        let emailFromRaw = '';
        if (rawData.email_addresses) {
            if (Array.isArray(rawData.email_addresses) && rawData.email_addresses.length > 0) {
                emailFromRaw = rawData.email_addresses[0];
            } else if (typeof rawData.email_addresses === 'string') {
                emailFromRaw = rawData.email_addresses;
            }
        }

        // Get contact person (not from rawData.name - that's company name)
        const contactPerson = company.contact_person || '';

        // Get email and phone (prioritize raw_company_data)
        const email = emailFromRaw || company.email_addresses || company.email || '';
        const phone = company.phone || '';
        const cleanPhone = phone.replace(/\s+/g, '').replace(/[^\d+]/g, '');

        const displayName = company.public_name || company.name;

        // Build alert tags HTML
        const alertTagsHtml = buildAlertTags(company.alerts || []);

        card.innerHTML = `
            <div class="company-card-modern h-100" data-company-id="${company.id}">
                <div class="company-header">
                    <h5 class="company-name">${escapeHtml(displayName)}</h5>
                    ${company.customer_status ? `<span class="badge badge-soft-${getStatusColor(company.customer_status)}">${escapeHtml(company.customer_status)}</span>` : ''}
                </div>

                ${alertTagsHtml ? `<div class="company-alerts">${alertTagsHtml}</div>` : ''}

                <div class="company-contact">
                    ${addressParts ? `<div class="contact-item"><i class="fas fa-map-marker-alt"></i><span>${escapeHtml(addressParts)}</span></div>` : ''}
                    ${phone ? `<div class="contact-item clickable" onclick="event.stopPropagation(); callCompany('${escapeHtml(cleanPhone)}')"><i class="fas fa-phone"></i><span>${escapeHtml(phone)}</span></div>` : ''}
                    ${email ? `<div class="contact-item clickable" onclick="event.stopPropagation(); emailCompany('${escapeHtml(email)}')"><i class="fas fa-envelope"></i><span>${escapeHtml(email)}</span></div>` : ''}
                    ${contactPerson ? `<div class="contact-item"><i class="fas fa-user"></i><span>${escapeHtml(contactPerson)}</span></div>` : ''}
                    ${company.vat_number ? `<div class="contact-item"><i class="fas fa-hashtag"></i><span>${escapeHtml(company.vat_number)}</span></div>` : ''}
                </div>

                <div class="company-actions">
                    <button class="action-btn" title="Call" onclick="event.stopPropagation(); callCompany('${escapeHtml(cleanPhone)}')" ${!phone ? 'disabled' : ''}>
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="action-btn" title="Email" onclick="event.stopPropagation(); emailCompany('${escapeHtml(email)}')" ${!email ? 'disabled' : ''}>
                        <i class="fas fa-envelope"></i>
                    </button>
                    <button class="action-btn whatsapp" title="WhatsApp" onclick="event.stopPropagation(); whatsappCompany('${escapeHtml(cleanPhone)}')" ${!phone ? 'disabled' : ''}>
                        <i class="fab fa-whatsapp"></i>
                    </button>
                    <button class="action-btn" title="Add to Trip" onclick="event.stopPropagation(); addToTrip(${company.id}, '${escapeHtml(displayName)}')">
                        <i class="fas fa-route"></i>
                    </button>
                    <button class="action-btn" title="Create Task" onclick="event.stopPropagation(); createTask(${company.id}, '${escapeHtml(displayName)}')">
                        <i class="fas fa-tasks"></i>
                    </button>
                    <button class="action-btn primary" onclick="showCompanyDetails(${company.id})">
                        <i class="fas fa-eye"></i> View
                    </button>
                </div>
            </div>
        `;

        container.appendChild(card);
    });
}

// Helper function for status badge colors
function getStatusColor(status) {
    const colors = {
        'active': 'success',
        'priority': 'primary',
        'watch': 'warning',
        'at_risk': 'danger',
        'dormant': 'secondary',
        'churned': 'dark'
    };
    return colors[status] || 'secondary';
}

// Alert type definitions
const ALERT_DEFINITIONS = {
    'PATTERN_DISRUPTION': {
        icon: '<i class="fas fa-chart-line text-danger"></i>',
        label: 'Pattern Break',
        description: 'This customer has broken their usual ordering pattern. They may have stopped ordering or significantly changed their behavior.'
    },
    'HIGH_VALUE_AT_RISK': {
        icon: '<i class="fas fa-gem text-warning"></i>',
        label: 'High Value Risk',
        description: 'A high-value customer showing signs of reduced engagement. Immediate attention recommended to prevent churn.'
    },
    'DORMANT_CUSTOMER': {
        icon: '<i class="fas fa-moon text-secondary"></i>',
        label: 'Dormant',
        description: 'This customer has not placed an order in an extended period. Consider reaching out to re-engage them.'
    },
    'DECLINING_VALUE': {
        icon: '<i class="fas fa-arrow-trend-down text-danger"></i>',
        label: 'Declining',
        description: 'Order values from this customer have been decreasing over recent orders. May indicate dissatisfaction or competitive pressure.'
    },
    'INCREASING_GAP': {
        icon: '<i class="fas fa-clock text-warning"></i>',
        label: 'Less Frequent',
        description: 'The time between orders is increasing. This customer is ordering less frequently than before.'
    },
    'ONE_TIME_CUSTOMER': {
        icon: '<i class="fas fa-user text-info"></i>',
        label: 'One-Timer',
        description: 'This customer has only placed one order. Follow up to convert them into a repeat customer.'
    }
};

// Get alert icon HTML
function getAlertIcon(type) {
    return ALERT_DEFINITIONS[type]?.icon || '<i class="fas fa-exclamation text-muted"></i>';
}

// Get alert label
function getAlertLabel(type) {
    return ALERT_DEFINITIONS[type]?.label || type;
}

// Get alert description
function getAlertDescription(type) {
    return ALERT_DEFINITIONS[type]?.description || 'No description available.';
}

// Build alert tags HTML from alerts array
function buildAlertTags(alerts) {
    if (!alerts || alerts.length === 0) return '';

    return alerts.map(alert => {
        const info = ALERT_DEFINITIONS[alert.type] || { icon: '<i class="fas fa-exclamation"></i>', label: alert.type };
        const priorityClass = (alert.priority || 'medium').toLowerCase();
        const iconClass = alert.type === 'PATTERN_DISRUPTION' ? 'fa-chart-line' :
                         alert.type === 'HIGH_VALUE_AT_RISK' ? 'fa-gem' :
                         alert.type === 'DORMANT_CUSTOMER' ? 'fa-moon' :
                         alert.type === 'DECLINING_VALUE' ? 'fa-arrow-trend-down' :
                         alert.type === 'INCREASING_GAP' ? 'fa-clock' :
                         alert.type === 'ONE_TIME_CUSTOMER' ? 'fa-user' : 'fa-exclamation';
        return `<span class="alert-tag ${priorityClass}" title="${escapeHtml(alert.description || getAlertDescription(alert.type))}">
            <i class="fas ${iconClass}"></i>
            ${info.label}
        </span>`;
    }).join('');
}

function displayTableView() {
    const tbody = document.getElementById('companies-table-body');
    tbody.innerHTML = '';
    
    filteredCompanies.forEach(company => {
        const row = document.createElement('tr');
        row.setAttribute('data-company-id', company.id);
        row.style.cursor = 'pointer';
        row.onclick = () => showCompanyDetails(company.id);
        
        const addressParts = [
            company.address.city,
            company.address.country
        ].filter(part => part).join(', ');
        
        row.innerHTML = `
            <td>
                <div>
                    <strong>${escapeHtml(company.name)}</strong>
                    ${company.vat_number ? `<br><small class="text-muted">${escapeHtml(company.vat_number)}</small>` : ''}
                </div>
            </td>
            <td>
                <div>
                    ${company.contact_person ? `<div>${escapeHtml(company.contact_person)}</div>` : ''}
                    ${company.email ? `<div><small>${escapeHtml(company.email)}</small></div>` : ''}
                    ${company.phone ? `<div><small>${escapeHtml(company.phone)}</small></div>` : ''}
                </div>
            </td>
            <td>
                <small>${escapeHtml(addressParts) || 'N/A'}</small>
            </td>
            <td>
                <span class="badge bg-primary">${company.invoice_count}</span>
            </td>
            <td>
                <strong class="text-success">€${company.total_revenue.toLocaleString('nl-BE', {minimumFractionDigits: 2})}</strong>
            </td>
            <td>
                <span class="text-info">€${company.average_invoice_value.toLocaleString('nl-BE', {minimumFractionDigits: 2})}</span>
            </td>
            <td>
                <small>${company.last_invoice_date ? new Date(company.last_invoice_date).toLocaleDateString('nl-BE') : 'N/A'}</small>
            </td>
            <td>
                <button class="btn btn-outline-primary btn-sm" onclick="showCompanyDetails(${company.id})">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

function showCompanyDetails(companyId) {
    const company = allCompanies.find(c => c.id === companyId);
    if (!company) return;

    const displayName = company.public_name || company.name;
    document.getElementById('companyModalTitle').textContent = displayName;
    
    // Parse JSON fields if they're strings
    if (typeof company.company_categories === 'string') {
        try {
            company.company_categories = JSON.parse(company.company_categories);
        } catch (e) {
            company.company_categories = [];
        }
    }
    
    if (typeof company.addresses === 'string') {
        try {
            company.addresses = JSON.parse(company.addresses);
        } catch (e) {
            company.addresses = [];
        }
    }
    
    if (typeof company.extension_values === 'string') {
        try {
            company.extension_values = JSON.parse(company.extension_values);
        } catch (e) {
            company.extension_values = [];
        }
    }
    
    if (typeof company.bank_accounts === 'string') {
        try {
            company.bank_accounts = JSON.parse(company.bank_accounts);
        } catch (e) {
            company.bank_accounts = [];
        }
    }
    
    if (typeof company.default_document_notes === 'string') {
        try {
            company.default_document_notes = JSON.parse(company.default_document_notes);
        } catch (e) {
            company.default_document_notes = [];
        }
    }
    
    // Parse raw company data for additional details
    let rawData = {};
    if (company.raw_company_data) {
        try {
            rawData = typeof company.raw_company_data === 'string' 
                ? JSON.parse(company.raw_company_data) 
                : company.raw_company_data;
        } catch (e) {
            rawData = {};
        }
    }
    
    // Extract address from raw data if not in structured format
    const invoiceAddress = rawData.invoice_address || {};

    // Extract email_addresses from raw_company_data (can be string or array)
    let emailFromRaw = '';
    if (rawData.email_addresses) {
        if (Array.isArray(rawData.email_addresses) && rawData.email_addresses.length > 0) {
            emailFromRaw = rawData.email_addresses[0];
        } else if (typeof rawData.email_addresses === 'string') {
            emailFromRaw = rawData.email_addresses;
        }
    }

    // Get email and phone for quick actions (prioritize raw_company_data)
    const email = emailFromRaw || company.email_addresses || company.email || '';
    const contactPerson = company.contact_person || '';
    const phone = company.phone || '';
    const cleanPhone = phone.replace(/\s+/g, '').replace(/[^\d+]/g, '');

    const modalBody = document.getElementById('companyModalBody');
    // Format customer_since date
    const customerSinceFormatted = company.customer_since
        ? new Date(company.customer_since).toLocaleDateString('nl-BE', {day: 'numeric', month: 'long', year: 'numeric'})
        : null;

    modalBody.innerHTML = `
        <div class="sidepanel-content">
            <!-- Company Header -->
            <div class="company-profile-header">
                <div class="company-avatar">
                    <i class="fas fa-building"></i>
                </div>
                <h2 class="h4 mb-1 fw-bold text-dark">${escapeHtml(displayName)}</h2>
                ${customerSinceFormatted ? `<div class="text-muted small mb-2"><i class="fas fa-calendar-check me-1"></i>Customer since ${customerSinceFormatted}</div>` : ''}
                <div class="d-flex justify-content-center gap-2 text-muted small mb-3">
                    ${company.vat_number ? `<span><i class="fas fa-hashtag me-1"></i>${escapeHtml(company.vat_number)}</span>` : ''}
                    ${invoiceAddress.city ? `<span><i class="fas fa-map-marker-alt me-1"></i>${escapeHtml(invoiceAddress.city)}</span>` : ''}
                </div>

                <!-- Quick Actions Row -->
                <div class="quick-actions-row">
                    <a href="tel:${escapeHtml(cleanPhone)}" class="quick-action ${!phone ? 'disabled' : ''}" title="Call">
                        <i class="fas fa-phone"></i>
                    </a>
                    <a href="mailto:${escapeHtml(email)}" class="quick-action ${!email ? 'disabled' : ''}" title="Email">
                        <i class="fas fa-envelope"></i>
                    </a>
                    <a href="https://wa.me/${cleanPhone.replace(/[^\d]/g, '')}" target="_blank" class="quick-action whatsapp ${!phone ? 'disabled' : ''}" title="WhatsApp">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                    <a href="/trips?add_company=${company.id}" class="quick-action" title="Add to Trip">
                        <i class="fas fa-route"></i>
                    </a>
                    <a href="/tasks?create_for=${company.id}" class="quick-action" title="Create Task">
                        <i class="fas fa-tasks"></i>
                    </a>
                </div>
            </div>

            <!-- Active Alerts -->
            ${company.alerts && company.alerts.length > 0 ? `
            <div class="mb-4">
                <h6 class="fw-bold text-muted small text-uppercase mb-2"><i class="fas fa-bell me-2"></i>Active Alerts</h6>
                <div class="alert-details-list">
                    ${company.alerts.map(alert => `
                        <div class="alert-detail-card alert-${(alert.priority || 'medium').toLowerCase()}">
                            <div class="alert-detail-header">
                                <span class="alert-detail-icon">${getAlertIcon(alert.type)}</span>
                                <span class="alert-detail-title">${getAlertLabel(alert.type)}</span>
                                <span class="alert-detail-priority badge-${(alert.priority || 'medium').toLowerCase()}">${alert.priority || 'Medium'}</span>
                            </div>
                            <p class="alert-detail-description">${escapeHtml(alert.description || getAlertDescription(alert.type))}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}

            <!-- Flavour Pricing (Horeca only) -->
            ${company.current_flavours && company.current_flavours.length > 0 && isHorecaCompany(company) ? `
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold text-muted small text-uppercase mb-0"><i class="fas fa-tag me-2"></i>Flavour Pricing</h6>
                    <button class="btn btn-sm btn-primary" onclick="saveFlavourPrices(${company.company_id})">
                        <i class="fas fa-save me-1"></i>Save
                    </button>
                </div>
                <div class="flavour-pricing-list">
                    ${company.current_flavours.map(f => `
                        <div class="flavour-price-row">
                            <span class="flavour-name">${escapeHtml(f)}</span>
                            <div class="price-input-wrapper">
                                <span class="currency">&euro;</span>
                                <input type="number" step="0.01" min="0"
                                       class="form-control form-control-sm flavour-price-input"
                                       data-flavour="${escapeHtml(f)}"
                                       value="${company.flavour_prices && company.flavour_prices[f] ? company.flavour_prices[f] : ''}"
                                       placeholder="0.00">
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}

            <!-- Key Metrics (All Time) -->
            <div class="row g-3 mb-4">
                <div class="col-4">
                    <div class="p-3 bg-light rounded-3 border text-center">
                        <div class="text-muted small fw-bold text-uppercase mb-1">Total Revenue</div>
                        <div class="h5 mb-0 text-success fw-bold">€${company.total_revenue.toLocaleString('nl-BE', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="p-3 bg-light rounded-3 border text-center">
                        <div class="text-muted small fw-bold text-uppercase mb-1">Total Orders</div>
                        <div class="h5 mb-0 text-primary fw-bold">${company.invoice_count}</div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="p-3 bg-light rounded-3 border text-center">
                        <div class="text-muted small fw-bold text-uppercase mb-1">Last Order</div>
                        <div class="h6 mb-0 text-dark fw-bold">${company.last_invoice_date ? new Date(company.last_invoice_date).toLocaleDateString('nl-BE', {day: 'numeric', month: 'short'}) : 'N/A'}</div>
                    </div>
                </div>
            </div>

            <!-- Year Breakdown -->
            ${company.years_data ? `
            <div class="mb-4">
                <div class="d-flex gap-2 flex-wrap mb-3">
                    <span class="badge bg-light text-dark border px-3 py-2">
                        <strong class="text-info">2026:</strong> €${(company.years_data['2026']?.total_revenue || 0).toLocaleString('nl-BE')} (${company.years_data['2026']?.invoice_count || 0} orders)
                    </span>
                    <span class="badge bg-light text-dark border px-3 py-2">
                        <strong class="text-success">2025:</strong> €${(company.years_data['2025']?.total_revenue || 0).toLocaleString('nl-BE')} (${company.years_data['2025']?.invoice_count || 0} orders)
                    </span>
                    <span class="badge bg-light text-dark border px-3 py-2">
                        <strong class="text-primary">2024:</strong> €${(company.years_data['2024']?.total_revenue || 0).toLocaleString('nl-BE')} (${company.years_data['2024']?.invoice_count || 0} orders)
                    </span>
                </div>
            </div>
            ` : ''}
                        
            <!-- Contact & Details (Editable) -->
            <div class="detail-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0 fw-bold text-dark"><i class="far fa-address-card me-2 text-muted"></i>Contact Details</h6>
                    <button class="btn btn-sm btn-primary" onclick="saveContactDetails(${company.company_id})" id="saveContactBtn">
                        <i class="fas fa-save me-1"></i>Save
                    </button>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">Contact Person</label>
                        <input type="text" class="form-control form-control-sm" id="editContactPerson"
                               value="${escapeHtml(contactPerson || '')}" placeholder="Enter contact name">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">Email</label>
                        <input type="email" class="form-control form-control-sm" id="editEmail"
                               value="${escapeHtml(email || '')}" placeholder="Enter email">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">Phone</label>
                        <input type="tel" class="form-control form-control-sm" id="editPhone"
                               value="${escapeHtml(phone || '')}" placeholder="Enter phone number">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">Website</label>
                        <input type="url" class="form-control form-control-sm" id="editWebsite"
                               value="${escapeHtml(company.website || '')}" placeholder="https://example.com">
                    </div>
                    <div class="col-12">
                        <label class="form-label small fw-bold text-muted">Address</label>
                        <div class="form-control-plaintext small text-muted">
                            ${invoiceAddress.address_line1 ? escapeHtml(invoiceAddress.address_line1) + '<br>' : ''}
                            ${invoiceAddress.post_code ? escapeHtml(invoiceAddress.post_code) + ' ' : ''}${escapeHtml(invoiceAddress.city || '')}<br>
                            ${invoiceAddress.country ? escapeHtml(invoiceAddress.country.name || invoiceAddress.country) : ''}
                        </div>
                    </div>
                </div>
            </div>
        
        <!-- Customer Status -->
        <div class="detail-section">
            <h6 class="mb-3 fw-bold text-dark"><i class="fas fa-tasks me-2 text-muted"></i>CRM Status</h6>
            <div class="row g-3">
            <div class="col-md-6">
                    <label class="form-label small fw-bold text-muted">Status</label>
                    <select class="form-select-modern w-100" id="customerStatusSelect" onchange="updateCustomerStatus(${company.company_id})">
                            <option value="active">✅ Active Customer</option>
                            <option value="priority">⭐ Priority Customer</option>
                            <option value="watch">👀 Watch List</option>
                            <option value="at_risk">⚠️ At Risk</option>
                            <option value="dormant">💤 Dormant</option>
                            <option value="churned">❌ Churned/Lost</option>
                        </select>
                        </div>
                <div class="col-md-6">
                    <label class="form-label small fw-bold text-muted">Assigned To</label>
                    <select class="form-select-modern w-100" id="assignedSalesperson" onchange="updateAssignedSalesperson(${company.company_id})">
                        <option value="" ${!company.assigned_salesperson ? 'selected' : ''}>Unassigned</option>
                        <option value="Caitlin" ${company.assigned_salesperson === 'Caitlin' ? 'selected' : ''}>Caitlin</option>
                        <option value="Kesha" ${company.assigned_salesperson === 'Kesha' ? 'selected' : ''}>Kesha</option>
                        <option value="Django" ${company.assigned_salesperson === 'Django' ? 'selected' : ''}>Django</option>
                    </select>
                    </div>
                </div>
            </div>

        <!-- Notes (unified notes with images) -->
        <div class="detail-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0 fw-bold text-dark"><i class="far fa-sticky-note me-2 text-muted"></i>Notes</h6>
            </div>

            <!-- Add Note Form -->
            <div class="add-note-form" id="add-note-form-${company.company_id}">
                <textarea id="new-note-text-${company.company_id}" placeholder="Add a note about this customer..." rows="2"></textarea>
                <div class="add-note-footer">
                    <div class="d-flex align-items-center gap-2">
                        <label class="btn btn-sm btn-outline-secondary mb-0" title="Attach images">
                            <i class="fas fa-image me-1"></i>Add Images
                            <input type="file" accept="image/*" multiple hidden id="new-note-images-${company.company_id}" onchange="previewNoteImages(${company.company_id})">
                        </label>
                        <div class="add-note-images-preview" id="new-note-preview-${company.company_id}"></div>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="createCompanyNote(${company.company_id})">
                        <i class="fas fa-plus me-1"></i>Add Note
                    </button>
                </div>
            </div>

            <!-- Notes List -->
            <div class="note-blocks-container" id="company-notes-${company.company_id}">
                <div class="text-center text-muted py-3">
                    <i class="fas fa-spinner fa-spin me-2"></i>Loading notes...
                </div>
            </div>
        </div>

        <!-- Related Trips -->
        <div class="detail-section">
            <h6 class="mb-3 fw-bold text-dark"><i class="fas fa-route me-2 text-muted"></i>Recent Trips</h6>
            <div id="companyTripsContainer">
                            <small class="text-muted">Loading trips...</small>
            </div>
        </div>

            <!-- Recent Invoices -->
            <div class="mt-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold mb-0">Orders</h6>
                    <div class="d-flex align-items-center gap-2">
                        <div class="btn-group btn-group-sm" role="group" id="invoices-year-filter">
                            <button type="button" class="btn btn-outline-secondary active" onclick="filterInvoicesByYear(${company.company_id}, 'all')">All</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="filterInvoicesByYear(${company.company_id}, '2026')">2026</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="filterInvoicesByYear(${company.company_id}, '2025')">2025</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="filterInvoicesByYear(${company.company_id}, '2024')">2024</button>
                        </div>
                        <span class="badge badge-soft-secondary" id="invoices-count">Loading...</span>
                    </div>
                </div>

                <div class="bg-white rounded-3 border overflow-hidden" id="invoices-list-container">
                    <div class="p-3 text-center text-muted small">Loading orders...</div>
                </div>
            </div>
        </div>
    `;
    
    // Load company notes, status, and trips (trips logic removed from display but load function kept if needed later)
    loadCompanyNotesAndStatus(company.company_id);
    
    // Add major retailer banner logic...
    const isMajor = isMajorRetailer(company.company_id);
    if (isMajor) {
         // (keeping major retailer logic, but styling it better)
        const majorRetailerBanner = `
            <div class="p-3 mb-4 bg-warning bg-opacity-10 border border-warning border-opacity-25 rounded-3 d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <div class="bg-warning text-white rounded-circle p-2 me-3"><i class="fas fa-star"></i></div>
                    <div>
                        <div class="fw-bold text-warning-emphasis">Major Retailer</div>
                        <div class="small text-muted">Advanced analytics available</div>
                    </div>
                </div>
                <button onclick="window.open('/retailer-details/${company.company_id}?year=${currentYear}', '_blank')" class="btn btn-sm btn-warning text-white fw-bold shadow-sm">
                    View Analytics
                </button>
            </div>
        `;
        modalBody.insertAdjacentHTML('afterbegin', majorRetailerBanner);
    }
    
    // Show sidepanel
    openCompanyPanel();
    
    // Load invoices with new list renderer (all years by default)
    loadCompanyInvoicesV2(company.company_id, 'combined');
    
    // Load trips related to this company
    loadCompanyTrips(company.company_id);

    // Load notes for this company (unified notes with images)
    loadCompanyNotes(company.company_id);
}

// Filter invoices by year in sidepanel
function filterInvoicesByYear(companyId, year) {
    // Update active button
    const filterGroup = document.getElementById('invoices-year-filter');
    if (filterGroup) {
        filterGroup.querySelectorAll('button').forEach(btn => {
            btn.classList.remove('active');
            if ((year === 'all' && btn.textContent === 'All') || btn.textContent === year) {
                btn.classList.add('active');
            }
        });
    }
    // Load invoices for selected year
    loadCompanyInvoicesV2(companyId, year === 'all' ? 'combined' : year);
}

// New function to render invoices as a clean list
async function loadCompanyInvoicesV2(companyId, year = 'combined') {
    try {
        const response = await fetch(`/api/company-invoices/${companyId}?year=${year}`);
        const data = await response.json();
        
        if (data.invoices) {
            document.getElementById('invoices-count').textContent = `${data.invoices.length}`;
            
            const container = document.getElementById('invoices-list-container');
            if (data.invoices.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-muted">No invoices found for this period.</div>';
                return;
            }

            container.innerHTML = data.invoices.map(invoice => `
                <div class="invoice-item" onclick="showInvoiceDetails(${companyId}, ${invoice.id})">
                    <div class="d-flex align-items-center">
                        <div class="bg-light rounded p-2 me-3 text-muted">
                            <i class="fas fa-file-invoice"></i>
                        </div>
                        <div>
                            <div class="fw-bold text-dark">Invoice #${escapeHtml(invoice.number || invoice.id)}</div>
                            <div class="small text-muted">${invoice.date ? new Date(invoice.date).toLocaleDateString('nl-BE') : 'N/A'}</div>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold text-success">€${invoice.amount.toLocaleString('nl-BE', {minimumFractionDigits: 2})}</div>
                        <div class="small text-muted">Paid</div>
                    </div>
                </div>
            `).join('');
            
            // Store invoices for invoice details modal
            window.currentCompanyInvoices = data.invoices;
        }
    } catch (error) {
        console.error('Error loading invoices:', error);
        document.getElementById('invoices-list-container').innerHTML = '<div class="p-3 text-danger text-center">Error loading invoices</div>';
    }
}

function openCompanyPanel() {
    document.getElementById('companyPanel').classList.add('show');
    document.getElementById('companyPanelOverlay').classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeCompanyPanel() {
    document.getElementById('companyPanel').classList.remove('show');
    document.getElementById('companyPanelOverlay').classList.remove('show');
    document.body.style.overflow = '';
}

async function loadCompanyInvoices(companyId) {
    try {
        const response = await fetch(`/api/company-invoices/${companyId}?year=${currentYear}`);
        const data = await response.json();
        
        if (data.invoices) {
            // Update count badge
            document.getElementById('invoices-count').textContent = `${data.invoices.length} total`;
            
            // Update summary
            document.getElementById('invoices-summary').textContent = `Total: ${data.invoices.length} invoices`;
            
            // Populate invoices table
            const tbody = document.getElementById('invoices-tbody');
            tbody.innerHTML = data.invoices.map(invoice => `
                <tr class="invoice-row" onclick="showInvoiceDetails(${companyId}, ${invoice.id})" style="cursor: pointer;">
                    <td>
                        <strong class="text-primary">${escapeHtml(invoice.number || invoice.id)}</strong>
                        <i class="fas fa-external-link-alt ms-1 text-muted small"></i>
                    </td>
                    <td>
                        ${invoice.date ? new Date(invoice.date).toLocaleDateString('nl-BE') : 'N/A'}
                    </td>
                    <td>
                        <strong class="text-success">€${invoice.amount.toLocaleString('nl-BE', {minimumFractionDigits: 2})}</strong>
                    </td>
                    ${currentYear === 'combined' ? `
                        <td>
                            <span class="badge ${invoice.year === 2024 ? 'bg-primary' : 'bg-success'}">${invoice.year}</span>
                        </td>
                    ` : ''}
                    <td>
                        <span class="badge bg-success">Paid</span>
                    </td>
                </tr>
            `).join('');
            
            // Store invoices for invoice details modal
            window.currentCompanyInvoices = data.invoices;
        }
    } catch (error) {
        console.error('Error loading company invoices:', error);
        document.getElementById('invoices-count').textContent = 'Error';
        document.getElementById('invoices-summary').textContent = 'Error loading invoices';
    }
}

// Load company notes and status
async function loadCompanyNotesAndStatus(companyId) {
    try {
        const response = await fetch(`/api/company-notes/${companyId}`);
        const data = await response.json();
        
        if (data.success) {
            // Set status dropdown
            const statusSelect = document.getElementById('customerStatusSelect');
            if (statusSelect && data.customer_status) {
                statusSelect.value = data.customer_status;
            }
            
            // Set salesperson
            const salespersonInput = document.getElementById('assignedSalesperson');
            if (salespersonInput && data.assigned_salesperson) {
                salespersonInput.value = data.assigned_salesperson;
            }
            
            // Set notes
            const notesTextarea = document.getElementById('companyNotesTextarea');
            if (notesTextarea && data.notes) {
                notesTextarea.value = data.notes;
            }
        }
    } catch (error) {
        console.error('Error loading company notes:', error);
    }
}

// Toggle Edit Mode for Contact Details
function toggleEditMode() {
    const viewDiv = document.getElementById('viewContactDetails');
    const editDiv = document.getElementById('editContactDetails');
    const btn = document.getElementById('editContactBtn');
    
    if (viewDiv.classList.contains('d-none')) {
        // Switch to View Mode
        viewDiv.classList.remove('d-none');
        editDiv.classList.add('d-none');
        btn.innerHTML = '<i class="fas fa-pencil-alt me-1"></i>Edit';
    } else {
        // Switch to Edit Mode
        viewDiv.classList.add('d-none');
        editDiv.classList.remove('d-none');
        btn.innerHTML = '<i class="fas fa-times me-1"></i>Cancel';
    }
}

// Save Contact Details
async function saveContactDetails(companyId) {
    const contactPerson = document.getElementById('edit_contact_person').value;
    const email = document.getElementById('edit_email').value;
    const phone = document.getElementById('edit_phone').value;
    const website = document.getElementById('edit_website').value;
    
    try {
        // We'll use the company-notes endpoint which updates company details generally
        // OR create a new specific endpoint if needed. Currently api_company_notes handles notes, salesperson, status.
        // Let's try to use a new specific update call or extend the existing one.
        // Since we don't have a dedicated endpoint for contact details in the provided snippets, 
        // we'll assume we need to create one or use a generic update if available.
        // Actually, let's use the `api_company_notes` endpoint pattern but add these fields if the backend supports it,
        // or better, assume there is/should be an endpoint. 
        // Given I can't easily add a backend endpoint right now without risking breaking things,
        // I will implement the frontend call and assume the backend might need adjustment or use a generic update.
        // Wait, I see `create_companies_table.sql` has these fields. I should check if there's an update endpoint.
        // `app.py` has `api_company_notes` which does specific updates.
        // I'll implement a client-side update that sends to a new route `/api/company-update/<id>` 
        // and assume I might need to add it to app.py if I were editing backend.
        // Since I am only editing frontend now, I will simulate the call or try to piggyback if possible.
        // BUT the user asked for the feature. I should probably add the endpoint to `app.py` if I can.
        // I'll stick to frontend changes for this turn as per instructions, but I'll write the fetch call.
        
        // Correction: I can edit `app.py` if needed. I should checking `app.py` again.
        // There is `api_company_notes`... let's see if I can add a new endpoint to `app.py` quickly.
        
        const response = await fetch(`/api/company-details/${companyId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contact_person: contactPerson,
                email: email,
                phone: phone,
                website: website
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Update View
            document.getElementById('view_contact_person').textContent = contactPerson || 'N/A';
            document.getElementById('view_email').innerHTML = email ? `<a href="mailto:${email}" class="text-decoration-none">${email}</a>` : 'N/A';
            document.getElementById('view_phone').textContent = phone || 'N/A';
            document.getElementById('view_website').innerHTML = website ? `<a href="${website}" target="_blank" class="text-decoration-none">Visit Website</a>` : 'N/A';
            
            toggleEditMode();
            showSaveSuccess('Contact details updated!');
        } else {
            alert('Error updating details: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error updating details:', error);
        alert('Failed to update details');
    }
}

// Load company trips
async function loadCompanyTrips(companyId) {
    try {
        const response = await fetch(`/api/company-trips/${companyId}`);
        const data = await response.json();
        
        const container = document.getElementById('companyTripsContainer');
        if (!container) return;
        
        if (data.success && data.trips && data.trips.length > 0) {
            container.innerHTML = data.trips.map(trip => {
                const tripDate = trip.date ? new Date(trip.date) : null;
                const isPast = tripDate && tripDate < new Date();
                const isUpcoming = tripDate && tripDate >= new Date();
                
                let statusClass = 'bg-secondary';
                let statusText = trip.status || 'planned';
                
                if (trip.status === 'completed') {
                    statusClass = 'bg-success';
                    statusText = 'Completed';
                } else if (trip.status === 'in_progress') {
                    statusClass = 'bg-warning';
                    statusText = 'In Progress';
                } else if (isUpcoming) {
                    statusClass = 'bg-info';
                    statusText = 'Upcoming';
                } else if (isPast && trip.status === 'planned') {
                    statusClass = 'bg-secondary';
                    statusText = 'Planned';
                }
                
                return `
                    <a href="/trips?trip=${trip.id}" class="d-block text-decoration-none mb-2 trip-item">
                        <div class="d-flex justify-content-between align-items-center p-3 bg-white rounded-3 border hover-shadow transition-all">
                            <div class="flex-grow-1">
                                <div class="fw-bold text-dark small mb-1">${escapeHtml(trip.name)}</div>
                                <div class="d-flex align-items-center gap-3 text-muted x-small">
                                    <span><i class="far fa-calendar me-1"></i>${tripDate ? tripDate.toLocaleDateString('nl-BE', { day: 'numeric', month: 'short', year: 'numeric' }) : 'No date'}</span>
                                    ${trip.stops_count ? `<span><i class="fas fa-map-marker-alt me-1"></i>${trip.stops_count} stops</span>` : ''}
                                    ${trip.distance_km ? `<span><i class="fas fa-road me-1"></i>${trip.distance_km} km</span>` : ''}
                        </div>
                            </div>
                            <span class="badge ${statusClass} rounded-pill">${statusText}</span>
                    </div>
                </a>
                `;
            }).join('');
        } else {
            container.innerHTML = `
                <div class="text-center p-4 bg-light rounded-3 border border-dashed">
                    <i class="fas fa-route text-muted mb-2" style="font-size: 2rem; opacity: 0.5;"></i>
                    <div class="text-muted small">No trips scheduled for this company</div>
                    <a href="/planning" class="btn btn-sm btn-outline-primary mt-2">
                        <i class="fas fa-plus me-1"></i>Plan a Trip
                    </a>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading company trips:', error);
        const container = document.getElementById('companyTripsContainer');
        if (container) {
            container.innerHTML = '<small class="text-danger">Error loading trips</small>';
        }
    }
}

// Save company notes and status
async function saveCompanyNotes(companyId) {
    try {
        const notes = document.getElementById('companyNotesTextarea')?.value || '';
        const salesperson = document.getElementById('assignedSalesperson')?.value || '';
        const status = document.getElementById('customerStatusSelect')?.value || 'active';
        
        const response = await fetch(`/api/company-notes/${companyId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                notes: notes,
                assigned_salesperson: salesperson,
                customer_status: status
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSaveSuccess('Notes saved successfully!');
        } else {
            alert('Error saving notes: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error saving company notes:', error);
        alert('Error saving notes');
    }
}

// Update customer status
async function updateCustomerStatus(companyId) {
    await saveCompanyNotes(companyId);
}

// Show save success notification
function showSaveSuccess(message) {
    const toast = document.createElement('div');
    toast.className = 'alert alert-success position-fixed';
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 250px;';
    toast.innerHTML = `<i class="fas fa-check-circle me-2"></i>${message}`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}

// =====================================================
// FLAVOUR PRICING FUNCTIONS
// =====================================================

// Save flavour prices for a company
async function saveFlavourPrices(companyId) {
    try {
        const inputs = document.querySelectorAll('.flavour-price-input');
        const prices = {};
        inputs.forEach(input => {
            const flavour = input.dataset.flavour;
            if (input.value && input.value.trim() !== '') {
                prices[flavour] = input.value.trim();
            }
        });

        const response = await fetch(`/api/company-flavour-prices/${companyId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prices })
        });

        const data = await response.json();

        if (data.success) {
            showSaveSuccess('Prices saved!');
            // Update local company data
            const company = allCompanies.find(c => c.company_id === companyId);
            if (company) {
                company.flavour_prices = prices;
            }
        } else {
            alert('Error saving prices: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error saving flavour prices:', error);
        alert('Error saving prices');
    }
}

// =====================================================
// COMPANY NOTES FUNCTIONS (unified notes with images)
// =====================================================

// Load notes for a company
async function loadCompanyNotes(companyId) {
    const container = document.getElementById(`company-notes-${companyId}`);
    if (!container) return;

    try {
        const response = await fetch(`/api/company-notes/${companyId}`);
        const data = await response.json();

        if (data.success && data.notes) {
            if (data.notes.length === 0) {
                container.innerHTML = `
                    <div class="notes-empty">
                        <i class="far fa-sticky-note"></i>
                        <div>No notes yet</div>
                        <small>Add a note or photo above</small>
                    </div>
                `;
            } else {
                container.innerHTML = data.notes.map(note => renderNoteBlock(note, companyId)).join('');
            }
        } else {
            container.innerHTML = `<div class="text-muted text-center py-3">Could not load notes</div>`;
        }
    } catch (error) {
        console.error('Error loading notes:', error);
        container.innerHTML = `<div class="text-muted text-center py-3">Error loading notes</div>`;
    }
}

// Render a single note block
function renderNoteBlock(note, companyId) {
    const dateStr = note.created_at ? new Date(note.created_at).toLocaleDateString('en-GB', {
        day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
    }) : '';

    const hasText = note.note_text && note.note_text.trim();
    const hasImages = note.attachments && note.attachments.length > 0;

    return `
        <div class="note-block" data-note-id="${note.id}">
            <div class="note-block-header">
                <div class="note-block-meta">
                    ${dateStr}${note.created_by ? ` • ${escapeHtml(note.created_by)}` : ''}
                </div>
                <div class="note-block-actions">
                    <button class="add-img-to-note" onclick="triggerAddImageToNote(${note.id}, ${companyId})" title="Add image">
                        <i class="fas fa-image"></i>
                    </button>
                    <button class="delete-note" onclick="deleteCompanyNote(${note.id}, ${companyId})" title="Delete note">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            ${hasText ? `<div class="note-block-text">${escapeHtml(note.note_text)}</div>` : ''}
            ${hasImages ? `
                <div class="note-block-images">
                    ${note.attachments.map(att => `
                        <div class="note-block-image" onclick="openPhotoLightbox('${att.url}')">
                            <img src="${att.url}" alt="${escapeHtml(att.file_name)}" loading="lazy">
                            <button class="delete-img-btn" onclick="event.stopPropagation(); deleteNoteImage(${att.id}, ${companyId})" title="Delete image">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
        </div>
    `;
}

// Preview images before creating note
function previewNoteImages(companyId) {
    const input = document.getElementById(`new-note-images-${companyId}`);
    const preview = document.getElementById(`new-note-preview-${companyId}`);
    if (!input || !preview) return;

    preview.innerHTML = '';
    const files = input.files;
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (file.type.startsWith('image/')) {
            const img = document.createElement('img');
            img.className = 'preview-img';
            img.src = URL.createObjectURL(file);
            preview.appendChild(img);
        }
    }
}

// Create a new note (with optional images)
async function createCompanyNote(companyId) {
    const textInput = document.getElementById(`new-note-text-${companyId}`);
    const imageInput = document.getElementById(`new-note-images-${companyId}`);
    const preview = document.getElementById(`new-note-preview-${companyId}`);

    const noteText = textInput ? textInput.value.trim() : '';
    const files = imageInput ? imageInput.files : [];

    // Need at least text or images
    if (!noteText && files.length === 0) {
        alert('Please add some text or images to the note');
        return;
    }

    const formData = new FormData();
    formData.append('note_text', noteText);
    for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
    }

    try {
        const response = await fetch(`/api/company-notes/${companyId}`, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            showSaveSuccess('Note added!');
            // Clear the form
            if (textInput) textInput.value = '';
            if (imageInput) imageInput.value = '';
            if (preview) preview.innerHTML = '';
            // Reload notes
            await loadCompanyNotes(companyId);
        } else {
            alert('Error creating note: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error creating note:', error);
        alert('Error creating note');
    }
}

// Delete a note
async function deleteCompanyNote(noteId, companyId) {
    if (!confirm('Delete this note and all its images?')) return;

    try {
        const response = await fetch(`/api/company-notes/${noteId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            showSaveSuccess('Note deleted');
            await loadCompanyNotes(companyId);
        } else {
            alert('Error deleting note: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error deleting note:', error);
        alert('Error deleting note');
    }
}

// Trigger file input to add image to existing note
function triggerAddImageToNote(noteId, companyId) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = () => addImageToNote(noteId, companyId, input.files[0]);
    input.click();
}

// Add image to an existing note
async function addImageToNote(noteId, companyId, file) {
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch(`/api/company-notes/${noteId}/attachment`, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            showSaveSuccess('Image added!');
            await loadCompanyNotes(companyId);
        } else {
            alert('Error adding image: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error adding image:', error);
        alert('Error adding image');
    }
}

// Delete a single image from a note
async function deleteNoteImage(attachmentId, companyId) {
    if (!confirm('Delete this image?')) return;

    try {
        const response = await fetch(`/api/company-attachments/${attachmentId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            showSaveSuccess('Image deleted');
            await loadCompanyNotes(companyId);
        } else {
            alert('Error deleting image: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error deleting image:', error);
        alert('Error deleting image');
    }
}

// Open photo in lightbox
function openPhotoLightbox(imageUrl) {
    const lightbox = document.createElement('div');
    lightbox.className = 'photo-lightbox';
    lightbox.onclick = () => lightbox.remove();
    lightbox.innerHTML = `
        <button class="close-btn" onclick="event.stopPropagation(); this.parentElement.remove();">
            <i class="fas fa-times"></i>
        </button>
        <img src="${imageUrl}" alt="Photo" onclick="event.stopPropagation();">
    `;
    document.body.appendChild(lightbox);

    // Close on Escape key
    const handleEscape = (e) => {
        if (e.key === 'Escape') {
            lightbox.remove();
            document.removeEventListener('keydown', handleEscape);
        }
    };
    document.addEventListener('keydown', handleEscape);
}

// Save contact details to Supabase
async function saveContactDetails(companyId) {
    const btn = document.getElementById('saveContactBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
    btn.disabled = true;

    try {
        const contactData = {
            contact_person_name: document.getElementById('editContactPerson')?.value || '',
            email: document.getElementById('editEmail')?.value || '',
            phone_number: document.getElementById('editPhone')?.value || '',
            website: document.getElementById('editWebsite')?.value || ''
        };

        const response = await fetch(`/api/companies/${companyId}/contact`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(contactData)
        });

        const result = await response.json();

        if (response.ok) {
            showSaveSuccess('Contact details saved!');
            // Update local data
            const company = allCompanies.find(c => c.company_id === companyId);
            if (company) {
                company.contact_person = contactData.contact_person_name;
                company.email = contactData.email;
                company.phone = contactData.phone_number;
                company.website = contactData.website;
            }
        } else {
            alert('Error saving: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error saving contact details:', error);
        alert('Error saving contact details');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// Update assigned salesperson
async function updateAssignedSalesperson(companyId) {
    const salesperson = document.getElementById('assignedSalesperson')?.value || '';

    try {
        const response = await fetch(`/api/companies/${companyId}/contact`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ assigned_salesperson: salesperson })
        });

        const result = await response.json();

        if (response.ok) {
            showSaveSuccess('Salesperson updated!');
            // Update local data
            const company = allCompanies.find(c => c.company_id === companyId);
            if (company) {
                company.assigned_salesperson = salesperson;
            }
        } else {
            alert('Error updating: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error updating salesperson:', error);
        alert('Error updating salesperson');
    }
}

async function showInvoiceDetails(companyId, invoiceId) {
    // Find the invoice from stored data
    if (!window.currentCompanyInvoices) return;
    
    const invoice = window.currentCompanyInvoices.find(i => i.id === invoiceId);
    if (!invoice) return;
    
    // Set modal title
    document.getElementById('invoiceModalTitle').textContent = `Invoice ${invoice.number || invoice.id}`;
    
    // Get full invoice data from the API
    try {
        const year = invoice.year || currentYear;
        const response = await fetch(`/api/invoice-details/${year}/${invoiceId}`);
        
        let fullInvoiceData = null;
        if (response.ok) {
            const result = await response.json();
            fullInvoiceData = result.invoice_data;
        }
        
        // Build modal content
        const modalBody = document.getElementById('invoiceModalBody');
        modalBody.innerHTML = `
        <div class="d-flex justify-content-between align-items-start mb-4">
            <div>
                <h5 class="fw-bold mb-1">Invoice #${escapeHtml(invoice.number || invoice.id)}</h5>
                <div class="text-muted small">
                    ${invoice.date ? new Date(invoice.date).toLocaleDateString('nl-BE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : 'Date not available'}
                        </div>
                        </div>
            <div class="text-end">
                <span class="badge badge-soft-success px-3 py-2 rounded-pill">Paid</span>
                </div>
            </div>
            
        <div class="row mb-4">
            <div class="col-6">
                <div class="text-uppercase text-muted small fw-bold mb-1">Amount</div>
                <div class="h3 fw-bold text-dark mb-0">€${invoice.amount.toLocaleString('nl-BE', {minimumFractionDigits: 2})}</div>
                        </div>
            <div class="col-6 text-end">
                 ${invoice.year ? `<div class="text-uppercase text-muted small fw-bold mb-1">Fiscal Year</div><div class="fw-bold">${invoice.year}</div>` : ''}
                    </div>
        </div>

        ${invoice.description ? `
            <div class="p-3 bg-light rounded-3 mb-4 border border-light">
                <div class="text-uppercase text-muted small fw-bold mb-2">Description</div>
                <div>${escapeHtml(invoice.description)}</div>
                </div>
            ` : ''}
            
            ${invoice.notes ? `
            <div class="p-3 bg-blue-50 text-blue-900 rounded-3 mb-4 border border-blue-100">
                <div class="text-uppercase text-primary small fw-bold mb-2">Notes</div>
                <div>${escapeHtml(invoice.notes)}</div>
                </div>
            ` : ''}
            
        <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="fw-bold mb-0">Line Items</h6>
                <span class="badge badge-soft-secondary">${invoice.line_items_count || 0} items</span>
                    </div>
                    
                    <div id="line-items-container">
                        ${fullInvoiceData && fullInvoiceData.invoice_line_items ? `
                            <div class="table-responsive">
                        <table class="table table-borderless align-middle">
                            <thead class="bg-light text-muted small text-uppercase">
                                <tr>
                                    <th class="ps-3 rounded-start">Product</th>
                                    <th>Qty</th>
                                    <th class="text-end">Price</th>
                                    <th class="text-end pe-3 rounded-end">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${fullInvoiceData.invoice_line_items.map(item => `
                                    <tr class="border-bottom">
                                        <td class="ps-3 py-3">
                                            <div class="fw-bold text-dark">${escapeHtml((item.product && item.product.name) || 'Product')}</div>
                                            <div class="small text-muted">${escapeHtml(item.description || item.product_description || '')}</div>
                                            ${item.product && item.product.code ? `<div class="small text-muted font-monospace mt-1">${escapeHtml(item.product.code)}</div>` : ''}
                                                </td>
                                        <td class="py-3">
                                            <span class="badge bg-light text-dark border">${item.quantity || item.qty || 0}</span>
                                                </td>
                                        <td class="text-end py-3">
                                            <div>€${(item.price || item.unit_price || 0).toLocaleString('nl-BE', {minimumFractionDigits: 2})}</div>
                                            ${item.discount ? `<div class="small text-danger">-${(item.discount * 100).toFixed(0)}%</div>` : ''}
                                                </td>
                                        <td class="text-end pe-3 py-3 fw-bold">
                                            €${(item.payable_amount || (item.price * item.quantity) || 0).toLocaleString('nl-BE', {minimumFractionDigits: 2})}
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                    <div class="p-4 text-center bg-light rounded-3 text-muted">
                        Line item details not available.
                            </div>
                        `}
                </div>
            </div>
            
        <div class="d-flex justify-content-between align-items-center pt-3 border-top">
             <div class="text-muted small">
                ID: ${invoice.id} • Created: ${invoice.created_at ? new Date(invoice.created_at).toLocaleDateString('nl-BE') : 'N/A'}
             </div>
             <button class="btn btn-modern-primary" onclick="window.open('/invoice/${invoice.id}/pdf', '_blank')">
                <i class="fas fa-file-pdf me-2"></i>Download PDF
                        </button>
            </div>
        `;
        
        new bootstrap.Modal(document.getElementById('invoiceModal')).show();
        
    } catch (error) {
        console.error('Error loading invoice details:', error);
        // Show basic details even if API call fails
        const modalBody = document.getElementById('invoiceModalBody');
        modalBody.innerHTML = `
            <div class="alert alert-warning">
                <h6>Basic Invoice Information</h6>
                <p><strong>Invoice:</strong> ${invoice.number || invoice.id}</p>
                <p><strong>Date:</strong> ${invoice.date ? new Date(invoice.date).toLocaleDateString('nl-BE') : 'N/A'}</p>
                <p><strong>Amount:</strong> €${invoice.amount.toLocaleString('nl-BE', {minimumFractionDigits: 2})}</p>
                <p><strong>Status:</strong> Paid</p>
                <hr>
                <small class="text-muted">Full details could not be loaded. Error: ${error.message}</small>
            </div>
        `;
        new bootstrap.Modal(document.getElementById('invoiceModal')).show();
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
}

// =====================================================
// QUICK ACTION FUNCTIONS
// =====================================================

function callCompany(phone) {
    if (phone) {
        window.location.href = `tel:${phone}`;
    }
}

function emailCompany(email) {
    if (email) {
        window.location.href = `mailto:${email}`;
    }
}

function whatsappCompany(phone) {
    if (phone) {
        // Remove any leading + and non-digit characters for WhatsApp URL
        const cleanNumber = phone.replace(/[^\d]/g, '');
        window.open(`https://wa.me/${cleanNumber}`, '_blank');
    }
}

function addToTrip(companyId, companyName) {
    // Open trip selector modal or redirect to trips page with company pre-selected
    const tripModal = document.getElementById('addToTripModal');
    if (tripModal) {
        document.getElementById('tripCompanyId').value = companyId;
        document.getElementById('tripCompanyName').textContent = companyName;
        new bootstrap.Modal(tripModal).show();
    } else {
        // Redirect to trips page with company parameter
        window.location.href = `/trips?add_company=${companyId}`;
    }
}

function createTask(companyId, companyName) {
    // Open task creation modal or redirect to tasks page
    const taskModal = document.getElementById('createTaskModal');
    if (taskModal) {
        document.getElementById('taskCompanyId').value = companyId;
        document.getElementById('taskCompanyName').textContent = companyName;
        new bootstrap.Modal(taskModal).show();
    } else {
        // Redirect to tasks page with company parameter
        window.location.href = `/tasks?create_for=${companyId}`;
    }
}

</script>
{% endblock %}
